<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="介绍了相机的成像原理以及简单的ISP流程和算法"><title>相机成像与ISP</title>
<link rel=canonical href=https://RoboticsChen.github.io/articles/camera-isp/><link rel=stylesheet href=/scss/style.min.91ab85d910aadfc4aedff71064d967b220a64d57791d2f588dc44b40735bb8c4.css><meta property='og:title' content="相机成像与ISP"><meta property='og:description' content="介绍了相机的成像原理以及简单的ISP流程和算法"><meta property='og:url' content='https://RoboticsChen.github.io/articles/camera-isp/'><meta property='og:site_name' content="RoboticsChen's Blog"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='ISP'><meta property='article:tag' content='传感器'><meta property='article:published_time' content='2024-11-11T10:35:55+00:00'><meta property='article:modified_time' content='2024-11-11T10:35:55+00:00'><meta property='og:image' content='https://RoboticsChen.github.io/articles/camera-isp/raw_image.png'><meta name=twitter:title content="相机成像与ISP"><meta name=twitter:description content="介绍了相机的成像原理以及简单的ISP流程和算法"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://RoboticsChen.github.io/articles/camera-isp/raw_image.png'><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_344c707452b06f8f.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>🦾</span></figure><div class=site-meta><h1 class=site-name><a href=/>RoboticsChen's Blog</a></h1><h2 class=site-description>一个机器人工程师的成长笔记</h2></div></header><ol class=menu-social><li><a href=https://github.com target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com target=_blank title=Twitter rel=me><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li><li><a href=https://www.emojisearch.app/ target=_blank title=serach-emojis rel=me><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg></a></li><li><a href=https://cn.piliapp.com/symbol/ target=_blank title=serach-symbals rel=me><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#相机成像>相机成像</a><ol><li><a href=#ccd-vs-cmos>CCD vs CMOS</a></li><li><a href=#bayer阵列与raw图像>Bayer阵列与RAW图像</a></li></ol></li><li><a href=#image-signal-processisp>Image Signal Process（ISP）</a><ol><li><a href=#坏点校正dead-pixel-correction-dpc>坏点校正（Dead Pixel Correction, DPC）</a></li><li><a href=#暗电流校正black-level-correctionblc>暗电流校正（Black level Correction，BLC）</a></li><li><a href=#镜头阴影校正lens-shading-correctionlsc>镜头阴影校正（Lens Shading Correction，LSC）</a><ol><li><a href=#亮度luma阴影>亮度（Luma）阴影</a></li><li><a href=#色彩chroma阴影>色彩（Chroma）阴影</a></li><li><a href=#校正算法>校正算法</a></li></ol></li><li><a href=#抗锯齿滤波anti-aliasing-filteringaaf>抗锯齿滤波（Anti-aliasing Filtering，AAF）</a></li><li><a href=#自动白平衡auto-white-balanceawb>自动白平衡（Auto White Balance，AWB）</a></li><li><a href=#去马赛克demosaicing>去马赛克（Demosaicing）</a></li><li><a href=#色彩校正color-correction>色彩校正（Color Correction）</a></li><li><a href=#伽马矫正gamma-correction>伽马矫正（Gamma Correction）</a></li></ol></li><li><a href=#其他图像处理算法>其他图像处理算法</a><ol><li><a href=#直方图均衡化histogram-equalization>直方图均衡化（Histogram Equalization）</a></li><li><a href=#颜色空间转换color-space-conversion>颜色空间转换（Color Space Conversion）</a></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/articles/camera-isp/><img src=/articles/camera-isp/raw_image_hu_ae5784b1d6a4eb6e.png srcset="/articles/camera-isp/raw_image_hu_ae5784b1d6a4eb6e.png 800w, /articles/camera-isp/raw_image_hu_cace48e75a15f6d2.png 1600w" width=800 height=320 loading=lazy alt="Featured image of post 相机成像与ISP"></a></div><div class=article-details><header class=article-category><a href=/categories/%E8%A7%86%E8%A7%89%E4%BC%A0%E6%84%9F%E5%99%A8/>视觉传感器</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/articles/camera-isp/>相机成像与ISP</a></h2><h3 class=article-subtitle>介绍了相机的成像原理以及简单的ISP流程和算法</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Nov 11, 2024</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长: 22 分钟</time></div></footer></div></header><section class=article-content><h1 id=相机成像与isp>相机成像与ISP</h1><h2 id=相机成像>相机成像</h2><h3 id=ccd-vs-cmos>CCD vs CMOS</h3><ul><li>CCD：全称Charge Coupled Device，即电荷耦合器件</li><li>CMOS：全称Complementary Metal Oxide Semiconductor，即互补金属氧化物半导体</li></ul><p>这两种传感器都由多个光电二极管组成的阵列，每个光电二极管的作用是将接收到的光信号转化为电荷。两者的基本工作原理相似，传感器接收光信号并通过一定时间的电荷积累实现曝光，进而获得每个像素的光强度数据。最后，这些电荷经模数转换被转换为电压并经过放大处理，最终生成原始的RAW图像数据。</p><p>在具体的实现方式上，两者有一定的区别：</p><ul><li>CCD：每个像素点的电荷会被传输到一个单独的输出节点，通过这一节点将电荷转化为电压信号，即一行行读出。这种方式有助于实现较低的噪声和较高的图像质量，但由于传输过程中需要大量的电子元件和复杂的电路设计，CCD传感器的功耗较高，且读出速度较慢。</li><li>CMOS：每个像素点都具有一个独立的放大器，能够在传感器内直接将电荷转化为电压信号并进行放大处理。这种方式使得每个像素的电荷转换过程相对独立，能更快速地读取图像数据，降低功耗，但在低光照环境下可能会产生较多噪声。</li></ul><p><img src=/articles/camera-isp/CCD_vs_CMOS.gif width=477 height=212 srcset="/articles/camera-isp/CCD_vs_CMOS_hu_7219fee36517f58e.gif 480w, /articles/camera-isp/CCD_vs_CMOS_hu_b66332599cf6688f.gif 1024w" loading=lazy alt="图1 CDDvsCMOS工作原理" class=gallery-image data-flex-grow=225 data-flex-basis=540px></p><p>总的来看，CMOS传感器相比于CCD传感器，工艺简单、成本更低，随着CMOS技术的不断进步，尤其是在降低噪声、提高低光照性能和增强图像质量方面的提升，CMOS传感器已经逐渐取代了传统的CCD传感器，成为主流选择。当今CCD传感器的应用主要局限于一些对图像质量要求极高的专业领域。</p><h3 id=bayer阵列与raw图像>Bayer阵列与RAW图像</h3><p>1.1节中提到，sensor通过将光强信号转化为电压信号，从而得到了RAW图像，因此，如果不加任何处理，得到的raw图将是只有亮度的黑白图像。</p><p>为了合成彩色图像，则需要得到每一个像素点处的RGB三通道的亮度值。要获得某个通道的亮度值，可以在光电二极管前加上只允许红/绿/蓝色光通过的滤光片。于是我们可以采用这样一种排列方式，四个滤光片依次按R、G、G、B排列。为什么是两个绿色呢，因为人眼对绿色更为敏感，所以这里使用两个绿色来增强绿色的解析力。这种排列方式又称Bayer阵列（Bayer Pattern），于1974由柯达的工程师Bayer提出。</p><p><img src=/articles/camera-isp/bayer_pattern.jpg width=477 height=401 srcset="/articles/camera-isp/bayer_pattern_hu_70fb1c15a1cdd384.jpg 480w, /articles/camera-isp/bayer_pattern_hu_ab411708a6a4bbcd.jpg 1024w" loading=lazy alt="图2 Bayer阵列(局部)" class=gallery-image data-flex-grow=118 data-flex-basis=285px> <img src=/articles/camera-isp/bayer_image.png width=899 height=766 srcset="/articles/camera-isp/bayer_image_hu_f699a8f475338be6.png 480w, /articles/camera-isp/bayer_image_hu_7cc7b7f88b29dedc.png 1024w" loading=lazy alt="图3 Bayer阵列(整体)" class=gallery-image data-flex-grow=117 data-flex-basis=281px></p><p>除了最常用的Bayer阵列，一些厂商也采用了其他的排列方式，如索尼的REGB(红青绿蓝)，华为的RYYB(红黄黄蓝)，富士的乱七八糟排列（bushi</p><p><img src=/articles/camera-isp/sony_pattern.png width=1151 height=629 srcset="/articles/camera-isp/sony_pattern_hu_3bb02ad4485c1f72.png 480w, /articles/camera-isp/sony_pattern_hu_34ff9f7c8012b1d9.png 1024w" loading=lazy alt="图4 索尼REGB" class=gallery-image data-flex-grow=182 data-flex-basis=439px> <img src=/articles/camera-isp/huawei_pattern.png width=721 height=659 srcset="/articles/camera-isp/huawei_pattern_hu_a6d58b1e763a578d.png 480w, /articles/camera-isp/huawei_pattern_hu_87de3680480748c2.png 1024w" loading=lazy alt="图5 华为RYYB" class=gallery-image data-flex-grow=109 data-flex-basis=262px> <img src=/articles/camera-isp/fushi_pattern.png width=1212 height=754 srcset="/articles/camera-isp/fushi_pattern_hu_dc30a2e08079202d.png 480w, /articles/camera-isp/fushi_pattern_hu_49bce126439f69b5.png 1024w" loading=lazy alt="图6 富士排列" class=gallery-image data-flex-grow=160 data-flex-basis=385px></p><p>如果此时，我们将这些bayer排列的电信号转换成数字信号，并保存下来，就可以得到RAW图像。</p><p><img src=/articles/camera-isp/raw_image.png width=3070 height=1227 srcset="/articles/camera-isp/raw_image_hu_16bc9f03463ec477.png 480w, /articles/camera-isp/raw_image_hu_743a520db2515086.png 1024w" loading=lazy alt="图7 RAW图像" class=gallery-image data-flex-grow=250 data-flex-basis=600px></p><p>此时的图像依旧是黑白的，并且如果放大局部，会发现图像会呈现马赛克一样的效果，为了得到最终的图像，需要完成一系列图像信号处理，即Image Signal Processing(ISP)。</p><h2 id=image-signal-processisp>Image Signal Process（ISP）</h2><h3 id=坏点校正dead-pixel-correction-dpc>坏点校正（Dead Pixel Correction, DPC）</h3><p>根据是否会发生变化，坏点可以分为静态坏点和动态坏点。</p><ul><li>静态坏点：不随着时间、增益等改变，通常是sensor制造时因工艺原因产生的坏点。</li><li>动态坏点：因为增益、温度等引起的坏点，会随着时间变化而改变。</li></ul><p>在 ISP 处理阶段，需要对图像中的坏点进行校正。静态坏点通常在传感器生产线上标定，其位置会被记录到 OTP（One Time Programmable）存储器中，用于后续校正。</p><p>动态坏点的校正则发生在静态坏点校正完成之后。校正过程中，通过逐一检查每个像素点与其周围一定范围内的像素值，如果发现某个像素的值与周围像素的值差异超过设定阈值，则判定为坏点。对于这些坏点，通常使用同通道内周围像素的平均值来替代进行校正，从而恢复图像的完整性和质量。</p><p><img src=/articles/camera-isp/image.png width=244 height=120 srcset="/articles/camera-isp/image_hu_bee2f62f7221ee4d.png 480w, /articles/camera-isp/image_hu_3bee4c8fd20ed109.png 1024w" loading=lazy alt="图8 坏点校正" class=gallery-image data-flex-grow=203 data-flex-basis=488px></p><details class=popup-details><summary>示例代码</summary><div class=popup-content><button class=close-btn>✖</button><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @brief Performs dead pixel correction (DPC) on RAW image data by identifying
</span></span></span><span class=line><span class=cl><span class=cm> * and correcting pixels that differ significantly from their neighbors.
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param raw       Reference to the input RAW image data.
</span></span></span><span class=line><span class=cl><span class=cm> * @param thres     Threshold value for detecting dead pixels. A pixel is
</span></span></span><span class=line><span class=cl><span class=cm> * considered dead if it deviates from its neighboring pixels by more than this
</span></span></span><span class=line><span class=cl><span class=cm> * threshold.
</span></span></span><span class=line><span class=cl><span class=cm> * @param mode      DPC correction mode. Options are:
</span></span></span><span class=line><span class=cl><span class=cm> *                  - DPC_MODE_MEAN: Replaces the dead pixel value with the
</span></span></span><span class=line><span class=cl><span class=cm> * average of its immediate neighbors.
</span></span></span><span class=line><span class=cl><span class=cm> *                  - DPC_MODE_GRADIENT: Replaces the dead pixel based on the
</span></span></span><span class=line><span class=cl><span class=cm> * smallest gradient among neighboring pixels.
</span></span></span><span class=line><span class=cl><span class=cm> *                  - DPC_MODE_UNKNOWN: Throws an error if the mode is
</span></span></span><span class=line><span class=cl><span class=cm> * unrecognized.
</span></span></span><span class=line><span class=cl><span class=cm> * @param clip      Maximum allowable pixel value after correction. Values
</span></span></span><span class=line><span class=cl><span class=cm> * exceeding this are clipped.
</span></span></span><span class=line><span class=cl><span class=cm>**/</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>DPC</span><span class=p>(</span><span class=n>ImageRaw</span><span class=o>&amp;</span> <span class=n>raw</span><span class=p>,</span> <span class=kt>uint16_t</span> <span class=n>thres</span><span class=p>,</span> <span class=n>DPC_MODE</span> <span class=n>mode</span><span class=p>,</span> <span class=kt>uint16_t</span> <span class=n>clip</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>ImageRaw</span><span class=o>*</span> <span class=n>raw_pad</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ImageRaw</span><span class=p>(</span><span class=n>raw</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>raw_pad</span><span class=o>-&gt;</span><span class=n>padding</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=n>PADDING_MODE_REFLECT</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>y</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>y</span> <span class=o>&lt;</span> <span class=n>raw_pad</span><span class=o>-&gt;</span><span class=n>getHeight</span><span class=p>()</span> <span class=o>-</span> <span class=mi>4</span><span class=p>;</span> <span class=n>y</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>x</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>x</span> <span class=o>&lt;</span> <span class=n>raw_pad</span><span class=o>-&gt;</span><span class=n>getWidth</span><span class=p>()</span> <span class=o>-</span> <span class=mi>4</span><span class=p>;</span> <span class=n>x</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=kt>uint16_t</span> <span class=n>p0</span><span class=p>,</span> <span class=n>p1</span><span class=p>,</span> <span class=n>p2</span><span class=p>,</span> <span class=n>p3</span><span class=p>,</span> <span class=n>p4</span><span class=p>,</span> <span class=n>p5</span><span class=p>,</span> <span class=n>p6</span><span class=p>,</span> <span class=n>p7</span><span class=p>,</span> <span class=n>p8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=kt>uint16_t</span> <span class=n>dv</span><span class=p>,</span> <span class=n>dh</span><span class=p>,</span> <span class=n>ddl</span><span class=p>,</span> <span class=n>ddr</span><span class=p>,</span> <span class=n>minimal</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=n>p0</span> <span class=o>=</span> <span class=n>raw_pad</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>2</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=n>p1</span> <span class=o>=</span> <span class=n>raw_pad</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=n>p2</span> <span class=o>=</span> <span class=n>raw_pad</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=n>p3</span> <span class=o>=</span> <span class=n>raw_pad</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=n>p4</span> <span class=o>=</span> <span class=n>raw_pad</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>2</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=n>p5</span> <span class=o>=</span> <span class=n>raw_pad</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>2</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=n>p6</span> <span class=o>=</span> <span class=n>raw_pad</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>4</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=n>p7</span> <span class=o>=</span> <span class=n>raw_pad</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>4</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=n>p8</span> <span class=o>=</span> <span class=n>raw_pad</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>4</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>((</span><span class=n>ABS</span><span class=p>(</span><span class=n>p1</span> <span class=o>-</span> <span class=n>p0</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>thres</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>ABS</span><span class=p>(</span><span class=n>p2</span> <span class=o>-</span> <span class=n>p0</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>thres</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>ABS</span><span class=p>(</span><span class=n>p3</span> <span class=o>-</span> <span class=n>p0</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>thres</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>ABS</span><span class=p>(</span><span class=n>p4</span> <span class=o>-</span> <span class=n>p0</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>thres</span><span class=p>)</span> <span class=o>&amp;&amp;</span> 
</span></span><span class=line><span class=cl>				<span class=p>(</span><span class=n>ABS</span><span class=p>(</span><span class=n>p5</span> <span class=o>-</span> <span class=n>p0</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>thres</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>ABS</span><span class=p>(</span><span class=n>p6</span> <span class=o>-</span> <span class=n>p0</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>thres</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>ABS</span><span class=p>(</span><span class=n>p7</span> <span class=o>-</span> <span class=n>p0</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>thres</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>ABS</span><span class=p>(</span><span class=n>p8</span> <span class=o>-</span> <span class=n>p0</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>thres</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>switch</span> <span class=p>(</span><span class=n>mode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>case</span> <span class=nl>DPC_MODE_MEAN</span><span class=p>:</span>
</span></span><span class=line><span class=cl>					<span class=n>p0</span> <span class=o>=</span> <span class=p>(</span><span class=n>p2</span> <span class=o>+</span> <span class=n>p4</span> <span class=o>+</span> <span class=n>p5</span> <span class=o>+</span> <span class=n>p7</span><span class=p>)</span> <span class=o>/</span> <span class=mi>4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>					<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=k>case</span> <span class=nl>DPC_MODE_GRADIENT</span><span class=p>:</span>
</span></span><span class=line><span class=cl>					<span class=n>dv</span>			<span class=o>=</span> <span class=n>ABS</span><span class=p>(</span><span class=mi>2</span> <span class=o>*</span> <span class=n>p0</span> <span class=o>-</span> <span class=n>p2</span> <span class=o>-</span> <span class=n>p7</span><span class=p>);</span>
</span></span><span class=line><span class=cl>					<span class=n>dh</span>			<span class=o>=</span> <span class=n>ABS</span><span class=p>(</span><span class=mi>2</span> <span class=o>*</span> <span class=n>p0</span> <span class=o>-</span> <span class=n>p4</span> <span class=o>-</span> <span class=n>p5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>					<span class=n>ddl</span>		<span class=o>=</span> <span class=n>ABS</span><span class=p>(</span><span class=mi>2</span> <span class=o>*</span> <span class=n>p0</span> <span class=o>-</span> <span class=n>p1</span> <span class=o>-</span> <span class=n>p8</span><span class=p>);</span>
</span></span><span class=line><span class=cl>					<span class=n>ddr</span>		<span class=o>=</span> <span class=n>ABS</span><span class=p>(</span><span class=mi>2</span> <span class=o>*</span> <span class=n>p0</span> <span class=o>-</span> <span class=n>p3</span> <span class=o>-</span> <span class=n>p6</span><span class=p>);</span>
</span></span><span class=line><span class=cl>					<span class=n>minimal</span>	<span class=o>=</span> <span class=n>MIN</span><span class=p>(</span><span class=n>MIN</span><span class=p>(</span><span class=n>MIN</span><span class=p>(</span><span class=n>dv</span><span class=p>,</span> <span class=n>dh</span><span class=p>),</span> <span class=n>ddl</span><span class=p>),</span> <span class=n>ddr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>					<span class=k>if</span> <span class=p>(</span><span class=n>minimal</span> <span class=o>==</span> <span class=n>dv</span><span class=p>)</span>			<span class=n>p0</span> <span class=o>=</span> <span class=p>(</span><span class=n>p2</span> <span class=o>+</span> <span class=n>p7</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>/</span> <span class=mi>2</span><span class=p>;</span>  <span class=c1>// Adding +1 here helps prevent rounding errors in integer division.
</span></span></span><span class=line><span class=cl><span class=c1></span>					<span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>minimal</span> <span class=o>==</span> <span class=n>dh</span><span class=p>)</span>		<span class=n>p0</span> <span class=o>=</span> <span class=p>(</span><span class=n>p4</span> <span class=o>+</span> <span class=n>p5</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>/</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>					<span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>minimal</span> <span class=o>==</span> <span class=n>ddl</span><span class=p>)</span>	<span class=n>p0</span> <span class=o>=</span> <span class=p>(</span><span class=n>p1</span> <span class=o>+</span> <span class=n>p8</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>/</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>					<span class=k>else</span>						<span class=n>p0</span> <span class=o>=</span> <span class=p>(</span><span class=n>p3</span> <span class=o>+</span> <span class=n>p6</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>/</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>					<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=k>case</span> <span class=nl>DPC_MODE_UNKNOWN</span><span class=p>:</span>
</span></span><span class=line><span class=cl>					<span class=n>TRACE_DEBUG_LOG_ERROR</span><span class=p>(</span><span class=s>&#34;Unknown DPC Mode:%s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>mode</span><span class=p>);</span>
</span></span><span class=line><span class=cl>					<span class=k>throw</span> <span class=s>&#34;Unknown DPC mode&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>					<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>					<span class=n>TRACE_DEBUG_LOG_ERROR</span><span class=p>(</span><span class=s>&#34;Unknown DPC Mode:%s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>mode</span><span class=p>);</span>
</span></span><span class=line><span class=cl>					<span class=k>throw</span> <span class=s>&#34;Unknown DPC mode&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>					<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span> <span class=o>=</span> <span class=n>p0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=n>raw</span><span class=p>.</span><span class=n>clip</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>clip</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>delete</span> <span class=n>raw_pad</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></details><h3 id=暗电流校正black-level-correctionblc>暗电流校正（Black level Correction，BLC）</h3><p>暗电流校正又称“黑度校正”。在相机工作过程中，即使没有接收到光信号，传感器也会由于某些因素产生一定的暗电流，从而导致输出的电压信号存在偏移，图像的“黑度”与真实情况存在差异。这个偏移值的来源有两方面，其一是模数转换千的增益，其二是温度等物理原因导致的传感器偏移。黑电平校正模块就是通过标定的方式，确定这个偏移量的具体值。后续的 ISP 处理模块，需要先减掉该偏移值，才能保证图像的准确性。</p><ul><li><em>模拟信号很微弱时，有可能不被 A/D 转换出来，导致光线很暗时，图像细节丢失。因此，Sesnor 会在 A/D 转换前，给模拟信号一个固定的偏移量，保证输出的数字信号保留更多的图像细节。</em></li></ul><p>通常的校正方法是在传感器完全遮光的情况下捕获“暗帧”。然后记录每个像素的数字输出，计算该图像的平均值（有时使用中值）。这个平均值或中值表示传感器的整体黑电平偏移。接下来，将该值从传感器生成的图像中的每个像素值中减去，以校正暗电流引起的偏移，恢复图像的真实亮度。</p><p><img src=/articles/camera-isp/image-1.png width=510 height=273 srcset="/articles/camera-isp/image-1_hu_9103516c5f35fb9.png 480w, /articles/camera-isp/image-1_hu_d65cbbe4dd9e3ae4.png 1024w" loading=lazy alt="图9 暗电流校正" class=gallery-image data-flex-grow=186 data-flex-basis=448px></p><details class=popup-details><summary>示例代码</summary><div class=popup-content><button class=close-btn>✖</button><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @brief Performs black level correction (BLC) on RAW image data based on the
</span></span></span><span class=line><span class=cl><span class=cm> * specified Bayer pattern.
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param raw          Reference to the input RAW image data.
</span></span></span><span class=line><span class=cl><span class=cm> * @param r            Black level correction value for the red channel.
</span></span></span><span class=line><span class=cl><span class=cm> * @param gr           Black level correction value for the green channel (red
</span></span></span><span class=line><span class=cl><span class=cm> * row).
</span></span></span><span class=line><span class=cl><span class=cm> * @param gb           Black level correction value for the green channel (blue
</span></span></span><span class=line><span class=cl><span class=cm> * row).
</span></span></span><span class=line><span class=cl><span class=cm> * @param b            Black level correction value for the blue channel.
</span></span></span><span class=line><span class=cl><span class=cm> * @param alpha        Alpha coefficient for adjusting the green channel (red
</span></span></span><span class=line><span class=cl><span class=cm> * row).
</span></span></span><span class=line><span class=cl><span class=cm> * @param beta         Beta coefficient for adjusting the green channel (blue
</span></span></span><span class=line><span class=cl><span class=cm> * row).
</span></span></span><span class=line><span class=cl><span class=cm> * @param bayer_pattern The Bayer pattern used in the RAW data (e.g., RGGB,
</span></span></span><span class=line><span class=cl><span class=cm> * BGGR, GBRG, GRBG).
</span></span></span><span class=line><span class=cl><span class=cm> * @param clip         Maximum allowable pixel value after correction. Values
</span></span></span><span class=line><span class=cl><span class=cm> * exceeding this are clipped.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>BLC</span><span class=p>(</span><span class=n>ImageRaw</span><span class=o>&amp;</span> <span class=n>raw</span><span class=p>,</span> <span class=kt>uint16_t</span> <span class=n>r</span><span class=p>,</span> <span class=kt>uint16_t</span> <span class=n>gr</span><span class=p>,</span> <span class=kt>uint16_t</span> <span class=n>gb</span><span class=p>,</span> <span class=kt>uint16_t</span> <span class=n>b</span><span class=p>,</span> <span class=kt>float</span> <span class=n>alpha</span><span class=p>,</span> <span class=kt>float</span> <span class=n>beta</span><span class=p>,</span> <span class=n>BAYER_PATTERN</span> <span class=n>bayer_pattern</span><span class=p>,</span> <span class=kt>uint16_t</span> <span class=n>clip</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>switch</span> <span class=p>(</span><span class=n>bayer_pattern</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=nl>BAYER_PATTERN_RGGB</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>y</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>y</span> <span class=o>&lt;</span> <span class=n>raw</span><span class=p>.</span><span class=n>getHeight</span><span class=p>();</span> <span class=n>y</span><span class=o>+=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>x</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>x</span> <span class=o>&lt;</span> <span class=n>raw</span><span class=p>.</span><span class=n>getWidth</span><span class=p>();</span> <span class=n>x</span><span class=o>+=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span>			<span class=o>+=</span> <span class=n>r</span><span class=p>;</span>									<span class=c1>// r
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>	<span class=o>+=</span> <span class=n>b</span><span class=p>;</span>									<span class=c1>// b
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>		<span class=o>+=</span> <span class=n>gr</span> <span class=o>+</span> <span class=n>alpha</span> <span class=o>*</span> <span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span>			<span class=c1>// gr
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span>		<span class=o>+=</span> <span class=n>gb</span> <span class=o>+</span> <span class=n>beta</span> <span class=o>*</span> <span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>	<span class=c1>// gb
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=nl>BAYER_PATTERN_BGGR</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>y</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>y</span> <span class=o>&lt;</span> <span class=n>raw</span><span class=p>.</span><span class=n>getHeight</span><span class=p>();</span> <span class=n>y</span><span class=o>+=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>x</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>x</span> <span class=o>&lt;</span> <span class=n>raw</span><span class=p>.</span><span class=n>getWidth</span><span class=p>();</span> <span class=n>x</span><span class=o>+=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span> <span class=o>+=</span> <span class=n>b</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>+=</span> <span class=n>r</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>+=</span> <span class=n>gb</span> <span class=o>+</span> <span class=n>beta</span> <span class=o>*</span> <span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span> <span class=o>+=</span> <span class=n>gr</span> <span class=o>+</span> <span class=n>alpha</span> <span class=o>*</span> <span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=nl>BAYER_PATTERN_GBRG</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>y</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>y</span> <span class=o>&lt;</span> <span class=n>raw</span><span class=p>.</span><span class=n>getHeight</span><span class=p>();</span> <span class=n>y</span><span class=o>+=</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>x</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>x</span> <span class=o>&lt;</span> <span class=n>raw</span><span class=p>.</span><span class=n>getWidth</span><span class=p>();</span> <span class=n>x</span><span class=o>+=</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>+=</span> <span class=n>b</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span> <span class=o>+=</span> <span class=n>r</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span> <span class=o>+=</span> <span class=n>gb</span> <span class=o>+</span> <span class=n>beta</span> <span class=o>*</span> <span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>+=</span> <span class=n>gr</span> <span class=o>+</span> <span class=n>alpha</span> <span class=o>*</span> <span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=nl>BAYER_PATTERN_GRBG</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>y</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>y</span> <span class=o>&lt;</span> <span class=n>raw</span><span class=p>.</span><span class=n>getHeight</span><span class=p>();</span> <span class=n>y</span><span class=o>+=</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>x</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>x</span> <span class=o>&lt;</span> <span class=n>raw</span><span class=p>.</span><span class=n>getWidth</span><span class=p>();</span> <span class=n>x</span><span class=o>+=</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span> <span class=o>+=</span> <span class=n>b</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>+=</span> <span class=n>r</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>+=</span> <span class=n>gb</span> <span class=o>+</span> <span class=n>beta</span> <span class=o>*</span> <span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span>	
</span></span><span class=line><span class=cl>				<span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span> <span class=o>+=</span> <span class=n>gr</span> <span class=o>+</span> <span class=n>alpha</span> <span class=o>*</span> <span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=nl>BAYER_PATTERN_UNKNOWN</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	<span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>		<span class=n>TRACE_DEBUG_LOG_ERROR</span><span class=p>(</span><span class=s>&#34;Unknown Bayer Pattern:%s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>bayer_pattern</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>throw</span> <span class=s>&#34;Unknown bayer pattern&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=n>raw</span><span class=p>.</span><span class=n>clip</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>clip</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></details><h3 id=镜头阴影校正lens-shading-correctionlsc>镜头阴影校正（Lens Shading Correction，LSC）</h3><p>Lens Shading 是相机成像过程中一种由镜头与图像传感器的光学特性引起的现象。具体表现为图像亮度和颜色在视场（Field of View，FOV）中的分布不均匀，通常是图像中心亮度较高，而边缘亮度较低，并可能伴随颜色偏移。它是暗角现象（Vignetting）的扩展，包含了亮度（Luma Shading）和色彩（Chroma Shading）的不均匀性。</p><h4 id=亮度luma阴影>亮度（Luma）阴影</h4><p>Luma Shading 也被称为渐晕（Vignetting），由于透镜组的光学特性，入射光偏离光轴角度较大时，部分光就会受光阑的影响而无法在感光平面上成像，从而导致越靠近边缘的像素亮度越低。</p><p><img src=/articles/camera-isp/image-3.png width=1204 height=549 srcset="/articles/camera-isp/image-3_hu_a524348aa9407e67.png 480w, /articles/camera-isp/image-3_hu_1c6e1c25e18069b9.png 1024w" loading=lazy alt="图10 镜头入射光传递路径图" class=gallery-image data-flex-grow=219 data-flex-basis=526px> <img src=/articles/camera-isp/image-2.png width=373 height=293 srcset="/articles/camera-isp/image-2_hu_19aa7f6afedb7342.png 480w, /articles/camera-isp/image-2_hu_3365ea2281cd10db.png 1024w" loading=lazy alt="图11 Lens shading导致的暗角现象" class=gallery-image data-flex-grow=127 data-flex-basis=305px></p><p>此外,对于FSI工艺的sensor，Luma shading的主要成因还包括边缘像素焦点错位，解决这个问题可以通过边缘微透镜的偏移来修正，即从中心像素开始，微透镜的直径都略小于成像面，这样越接近边缘，微透镜与成像面之间的偏移就越大，从而可以补偿入射光线角度过大导致的焦点偏移，使微透镜的CRA增大，从而光线可以更好地汇聚到感光平面上。</p><p><img src=/articles/camera-isp/image-4.png width=720 height=624 srcset="/articles/camera-isp/image-4_hu_fdbded3af74685a1.png 480w, /articles/camera-isp/image-4_hu_b4515cd166d56e81.png 1024w" loading=lazy alt="图12 焦点错位导致能量损失" class=gallery-image data-flex-grow=115 data-flex-basis=276px> <img src=/articles/camera-isp/image-5.png width=1874 height=1537 srcset="/articles/camera-isp/image-5_hu_9b71dc9fbc484130.png 480w, /articles/camera-isp/image-5_hu_6cb378edefb77766.png 1024w" loading=lazy alt="图13 边缘微透镜与成像面偏移补偿焦点错位" class=gallery-image data-flex-grow=121 data-flex-basis=292px></p><p>扩展阅读： <a class=link href=https://www.voltrium.com.sg/en/bsi-vs-fsi-sensors-which-sensor-suits-your-needs/ target=_blank rel=noopener>FSI vs BSI</a> 、 <a class=link href=https://blog.csdn.net/weixin_39839293/article/details/82118991 target=_blank rel=noopener>什么是CRA</a></p><h4 id=色彩chroma阴影>色彩（Chroma）阴影</h4><p>Chroma Shading是Lens Shading的一种特殊情况，主要表现为从中心向边缘的色晕。</p><p><img src=/articles/camera-isp/image-6.png width=416 height=289 srcset="/articles/camera-isp/image-6_hu_de92d8c1d45423ec.png 480w, /articles/camera-isp/image-6_hu_d1c55e22776b7ae.png 1024w" loading=lazy alt="图14 Chroma Shading色晕" class=gallery-image data-flex-grow=143 data-flex-basis=345px></p><p>Chroma Shading的成因，看了很多博客以及文章，众说纷纭，总结起来主要两个原因：</p><ol><li>对不同波长的光具有不同的折射率，因此在成像时不同色光的焦平面并不重合，从而产生了色差。</li><li>由于干涉型红外滤光片（IR-Filter）对不同入射角度的红外光的阻隔效果不同，从而导致部分大角度入射的近红外光没有被阻隔，从而产生了从中心向边缘的色晕。</li></ol><p><img src=/articles/camera-isp/image-7.png width=1200 height=617 srcset="/articles/camera-isp/image-7_hu_1b09c7f8c60223cb.png 480w, /articles/camera-isp/image-7_hu_e9b3d4401fa4deb9.png 1024w" loading=lazy alt="图15 不同色光的焦平面不重合" class=gallery-image data-flex-grow=194 data-flex-basis=466px> <img src=/articles/camera-isp/image-9.png width=560 height=393 srcset="/articles/camera-isp/image-9_hu_12189aa4831e5459.png 480w, /articles/camera-isp/image-9_hu_67f340cc7f8ace83.png 1024w" loading=lazy alt="图16 不同色光不同入射角的IR-Filter通过率" class=gallery-image data-flex-grow=142 data-flex-basis=341px></p><h4 id=校正算法>校正算法</h4><p>目前常用的镜头阴影校正算法是增益法。由于存储每个像素点的校正系数会占用大量存储空间，实际实现中通常对图像进行n×n 网格划分（一般选择 16×16 的网格），仅存储这些网格点处的校正系数。对于网格之间的其他像素点，其校正系数通过四次余弦插值计算得到。</p><p>四次余弦定律：$I_\theta = I_0 \cos^4 \theta$，即对于一个成像镜头系统，离光轴的像素亮度会随着离轴视场角$\theta$的增大按$\cos^4\theta$的比例下降。这种光学现象是镜头阴影效应的理论基础，校正时需要通过插值计算来补偿亮度。</p><p>而要得到该nxn个格点处的校正系数，在均匀光源下采集参考图像，记录每个像素的实际亮度值，并与理想亮度进行对比，后者与前者的比值即为校正系数。</p>$$G(i,j)=\frac{I_{\mathrm{ideal}}(i,j)}{I_{\mathrm{observed}}(i,j)}$$<p><img src=/articles/camera-isp/image-10.png width=1410 height=490 srcset="/articles/camera-isp/image-10_hu_bb0e02a8db0cea30.png 480w, /articles/camera-isp/image-10_hu_3534a449d14989e2.png 1024w" loading=lazy alt="图17 镜头阴影校正前后对比图" class=gallery-image data-flex-grow=287 data-flex-basis=690px></p><details class=popup-details><summary>示例代码：Luma Shading Correction</summary><div class=popup-content><button class=close-btn>✖</button><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>* @brief Performs lens shading correction (LSC) on RAW image data to compensate
</span></span></span><span class=line><span class=cl><span class=cm>* for brightness falloff towards the edges.
</span></span></span><span class=line><span class=cl><span class=cm>*
</span></span></span><span class=line><span class=cl><span class=cm>* @param raw       Reference to the input RAW image data.
</span></span></span><span class=line><span class=cl><span class=cm>* @param intensity Intensity of the lens shading correction. Higher values
</span></span></span><span class=line><span class=cl><span class=cm>* apply stronger correction.
</span></span></span><span class=line><span class=cl><span class=cm>* @param minR      Minimum radius (distance from the center) for applying
</span></span></span><span class=line><span class=cl><span class=cm>* correction. If less than 0, defaults to 0.
</span></span></span><span class=line><span class=cl><span class=cm>* @param maxR      Maximum radius (distance from the center) for applying
</span></span></span><span class=line><span class=cl><span class=cm>* correction. If less than 0, defaults to the distance from the center to the
</span></span></span><span class=line><span class=cl><span class=cm>* farthest corner of the image.
</span></span></span><span class=line><span class=cl><span class=cm>* @param clip      Maximum allowable pixel value after correction. Values
</span></span></span><span class=line><span class=cl><span class=cm>* exceeding this are clipped.
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>LSC</span><span class=p>(</span><span class=n>ImageRaw</span><span class=o>&amp;</span> <span class=n>raw</span><span class=p>,</span> <span class=kt>uint16_t</span> <span class=n>intensity</span><span class=p>,</span> <span class=kt>int</span> <span class=n>minR</span><span class=p>,</span> <span class=kt>int</span> <span class=n>maxR</span><span class=p>,</span> <span class=kt>uint16_t</span> <span class=n>clip</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>minR</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=n>minR</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>maxR</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=n>maxR</span> <span class=o>=</span> <span class=n>sqrt</span><span class=p>(</span><span class=n>pow</span><span class=p>(</span><span class=n>raw</span><span class=p>.</span><span class=n>getHeight</span><span class=p>()</span> <span class=o>/</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span> <span class=o>+</span> <span class=n>pow</span><span class=p>(</span><span class=n>raw</span><span class=p>.</span><span class=n>getWidth</span><span class=p>()</span> <span class=o>/</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>y</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>y</span> <span class=o>&lt;</span> <span class=n>raw</span><span class=p>.</span><span class=n>getHeight</span><span class=p>();</span> <span class=n>y</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>  	<span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>x</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>x</span> <span class=o>&lt;</span> <span class=n>raw</span><span class=p>.</span><span class=n>getWidth</span><span class=p>();</span> <span class=n>x</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  	<span class=p>{</span>
</span></span><span class=line><span class=cl>  		<span class=kt>int</span> <span class=n>r</span> <span class=o>=</span> <span class=n>sqrt</span><span class=p>(</span><span class=n>pow</span><span class=p>((</span><span class=n>y</span> <span class=o>-</span> <span class=n>raw</span><span class=p>.</span><span class=n>getHeight</span><span class=p>()</span> <span class=o>/</span> <span class=mi>2</span><span class=p>),</span> <span class=mi>2</span><span class=p>)</span> <span class=o>+</span> <span class=n>pow</span><span class=p>((</span><span class=n>x</span> <span class=o>-</span> <span class=n>raw</span><span class=p>.</span><span class=n>getWidth</span><span class=p>()</span> <span class=o>/</span> <span class=mi>2</span><span class=p>),</span> <span class=mi>2</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  		<span class=kt>float</span> <span class=n>factor</span> <span class=o>=</span> <span class=p>(</span><span class=n>r</span> <span class=o>-</span> <span class=n>minR</span><span class=p>)</span> <span class=o>/</span> <span class=p>(</span><span class=n>maxR</span> <span class=o>-</span> <span class=n>minR</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  		<span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span> <span class=o>=</span> <span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>intensity</span> <span class=o>*</span> <span class=p>(</span><span class=n>factor</span> <span class=o>+</span> <span class=mf>0.5</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  	<span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=n>raw</span><span class=p>.</span><span class=n>clip</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>clip</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></details><details class=popup-details><summary>示例代码：Chroma Shading Correction</summary><div class=popup-content><button class=close-btn>✖</button><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>float</span> <span class=nf>__cnc</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>is_color</span><span class=p>,</span> <span class=kt>float</span> <span class=n>center</span><span class=p>,</span> <span class=kt>float</span> <span class=n>avgG</span><span class=p>,</span> <span class=kt>float</span> <span class=n>avgC1</span><span class=p>,</span> <span class=kt>float</span> <span class=n>avgC2</span><span class=p>,</span> <span class=kt>float</span> <span class=n>r_gain</span><span class=p>,</span> <span class=kt>float</span> <span class=n>gr_gain</span><span class=p>,</span> <span class=kt>float</span> <span class=n>gb_gain</span><span class=p>,</span> <span class=kt>float</span> <span class=n>b_gain</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>float</span> <span class=n>dampFactor</span> <span class=o>=</span> <span class=mf>1.0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>float</span> <span class=n>signalGap</span> <span class=o>=</span> <span class=n>center</span> <span class=o>-</span> <span class=n>MAX</span><span class=p>(</span><span class=n>avgG</span><span class=p>,</span> <span class=n>avgC2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>strcmp</span><span class=p>(</span><span class=n>is_color</span><span class=p>,</span> <span class=s>&#34;r&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>  	<span class=k>if</span> <span class=p>(</span><span class=n>r_gain</span> <span class=o>&lt;=</span> <span class=mf>1.0</span><span class=p>)</span> <span class=n>dampFactor</span> <span class=o>=</span> <span class=mf>1.0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  	<span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>r_gain</span> <span class=o>&gt;</span> <span class=mf>1.0</span> <span class=o>&amp;&amp;</span> <span class=n>r_gain</span> <span class=o>&lt;=</span> <span class=mf>1.2</span><span class=p>)</span> <span class=n>dampFactor</span> <span class=o>=</span> <span class=mf>0.5</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  	<span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>r_gain</span> <span class=o>&gt;</span> <span class=mf>1.2</span><span class=p>)</span> <span class=n>dampFactor</span> <span class=o>=</span> <span class=mf>0.3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>strcmp</span><span class=p>(</span><span class=n>is_color</span><span class=p>,</span> <span class=s>&#34;b&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>  	<span class=k>if</span> <span class=p>(</span><span class=n>b_gain</span> <span class=o>&lt;=</span> <span class=mf>1.0</span><span class=p>)</span> <span class=n>dampFactor</span> <span class=o>=</span> <span class=mf>1.0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  	<span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>b_gain</span> <span class=o>&gt;</span> <span class=mf>1.0</span> <span class=o>&amp;&amp;</span> <span class=n>b_gain</span> <span class=o>&lt;=</span> <span class=mf>1.2</span><span class=p>)</span> <span class=n>dampFactor</span> <span class=o>=</span> <span class=mf>0.5</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  	<span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>b_gain</span> <span class=o>&gt;</span> <span class=mf>1.2</span><span class=p>)</span> <span class=n>dampFactor</span> <span class=o>=</span> <span class=mf>0.3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kt>float</span> <span class=n>chromaCorrected</span> <span class=o>=</span> <span class=n>MAX</span><span class=p>(</span><span class=n>avgG</span><span class=p>,</span> <span class=n>avgC2</span><span class=p>)</span> <span class=o>+</span> <span class=n>dampFactor</span> <span class=o>*</span> <span class=n>signalGap</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>float</span> <span class=n>signalMeter</span> <span class=o>=</span> <span class=mf>0.299</span> <span class=o>*</span> <span class=n>avgC2</span> <span class=o>+</span> <span class=mf>0.587</span> <span class=o>*</span> <span class=n>avgG</span> <span class=o>+</span> <span class=mf>0.144</span> <span class=o>*</span> <span class=n>avgC1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>strcmp</span><span class=p>(</span><span class=n>is_color</span><span class=p>,</span> <span class=s>&#34;r&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=n>signalMeter</span> <span class=o>=</span> <span class=mf>0.299</span> <span class=o>*</span> <span class=n>avgC1</span> <span class=o>+</span> <span class=mf>0.587</span> <span class=o>*</span> <span class=n>avgG</span> <span class=o>+</span> <span class=mf>0.144</span> <span class=o>*</span> <span class=n>avgC2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>strcmp</span><span class=p>(</span><span class=n>is_color</span><span class=p>,</span> <span class=s>&#34;b&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=n>signalMeter</span> <span class=o>=</span> <span class=mf>0.299</span> <span class=o>*</span> <span class=n>avgC2</span> <span class=o>+</span> <span class=mf>0.587</span> <span class=o>*</span> <span class=n>avgG</span> <span class=o>+</span> <span class=mf>0.144</span> <span class=o>*</span> <span class=n>avgC1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>float</span> <span class=n>fade1</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>fade2</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>signalMeter</span> <span class=o>&lt;=</span> <span class=mi>30</span><span class=p>)</span> <span class=n>fade1</span> <span class=o>=</span> <span class=mf>1.0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>signalMeter</span> <span class=o>&gt;</span> <span class=mi>30</span> <span class=o>&amp;&amp;</span> <span class=n>signalMeter</span> <span class=o>&lt;=</span> <span class=mi>50</span><span class=p>)</span> <span class=n>fade1</span> <span class=o>=</span> <span class=mf>0.9</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>signalMeter</span> <span class=o>&gt;</span> <span class=mi>50</span> <span class=o>&amp;&amp;</span> <span class=n>signalMeter</span> <span class=o>&lt;=</span> <span class=mi>70</span><span class=p>)</span> <span class=n>fade1</span> <span class=o>=</span> <span class=mf>0.8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>signalMeter</span> <span class=o>&gt;</span> <span class=mi>70</span> <span class=o>&amp;&amp;</span> <span class=n>signalMeter</span> <span class=o>&lt;=</span> <span class=mi>100</span><span class=p>)</span> <span class=n>fade1</span> <span class=o>=</span> <span class=mf>0.7</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>signalMeter</span> <span class=o>&gt;</span> <span class=mi>100</span> <span class=o>&amp;&amp;</span> <span class=n>signalMeter</span> <span class=o>&lt;=</span> <span class=mi>150</span><span class=p>)</span> <span class=n>fade1</span> <span class=o>=</span> <span class=mf>0.6</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>signalMeter</span> <span class=o>&gt;</span> <span class=mi>150</span> <span class=o>&amp;&amp;</span> <span class=n>signalMeter</span> <span class=o>&lt;=</span> <span class=mi>200</span><span class=p>)</span> <span class=n>fade1</span> <span class=o>=</span> <span class=mf>0.3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>signalMeter</span> <span class=o>&gt;</span> <span class=mi>200</span> <span class=o>&amp;&amp;</span> <span class=n>signalMeter</span> <span class=o>&lt;=</span> <span class=mi>250</span><span class=p>)</span> <span class=n>fade1</span> <span class=o>=</span> <span class=mf>0.1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=n>fade1</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>avgC1</span> <span class=o>&lt;=</span> <span class=mi>30</span><span class=p>)</span> <span class=n>fade2</span> <span class=o>=</span> <span class=mf>1.0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>avgC1</span> <span class=o>&gt;</span> <span class=mi>30</span> <span class=o>&amp;&amp;</span> <span class=n>avgC1</span> <span class=o>&lt;=</span> <span class=mi>50</span><span class=p>)</span> <span class=n>fade2</span> <span class=o>=</span> <span class=mf>0.9</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>avgC1</span> <span class=o>&gt;</span> <span class=mi>50</span> <span class=o>&amp;&amp;</span> <span class=n>avgC1</span> <span class=o>&lt;=</span> <span class=mi>70</span><span class=p>)</span> <span class=n>fade2</span> <span class=o>=</span> <span class=mf>0.8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>avgC1</span> <span class=o>&gt;</span> <span class=mi>70</span> <span class=o>&amp;&amp;</span> <span class=n>avgC1</span> <span class=o>&lt;=</span> <span class=mi>100</span><span class=p>)</span> <span class=n>fade2</span> <span class=o>=</span> <span class=mf>0.6</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>avgC1</span> <span class=o>&gt;</span> <span class=mi>100</span> <span class=o>&amp;&amp;</span> <span class=n>avgC1</span> <span class=o>&lt;=</span> <span class=mi>150</span><span class=p>)</span> <span class=n>fade2</span> <span class=o>=</span> <span class=mf>0.5</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>avgC1</span> <span class=o>&gt;</span> <span class=mi>150</span> <span class=o>&amp;&amp;</span> <span class=n>avgC1</span> <span class=o>&lt;=</span> <span class=mi>200</span><span class=p>)</span> <span class=n>fade2</span> <span class=o>=</span> <span class=mf>0.3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=n>fade2</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>float</span> <span class=n>fadeTot</span> <span class=o>=</span> <span class=n>fade1</span> <span class=o>*</span> <span class=n>fade2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>fadeTot</span><span class=p>)</span> <span class=o>*</span> <span class=n>center</span> <span class=o>+</span> <span class=n>fadeTot</span> <span class=o>*</span> <span class=n>chromaCorrected</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>__cnd</span><span class=p>(</span><span class=kt>int</span> <span class=n>y</span><span class=p>,</span> <span class=kt>int</span> <span class=n>x</span><span class=p>,</span> <span class=n>ImageRaw</span><span class=o>*</span> <span class=n>img</span><span class=p>,</span> <span class=kt>float</span> <span class=n>thres</span><span class=p>,</span> <span class=kt>int</span><span class=o>&amp;</span> <span class=n>is_noise</span><span class=p>,</span> <span class=kt>float</span><span class=o>&amp;</span> <span class=n>avgG</span><span class=p>,</span> <span class=kt>float</span><span class=o>&amp;</span> <span class=n>avgC1</span><span class=p>,</span> <span class=kt>float</span><span class=o>&amp;</span> <span class=n>avgC2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>avgG</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>avgC1</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>avgC2</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>is_noise</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>y</span> <span class=o>-</span> <span class=mi>4</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>y</span> <span class=o>+</span> <span class=mi>4</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>  	<span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=n>x</span> <span class=o>-</span> <span class=mi>4</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>4</span><span class=p>;</span> <span class=n>j</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  	<span class=p>{</span>
</span></span><span class=line><span class=cl>  		<span class=k>if</span> <span class=p>((</span><span class=n>i</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>j</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>==</span> <span class=mi>0</span><span class=p>))</span>		<span class=n>avgG</span> <span class=o>=</span> <span class=n>avgG</span> <span class=o>+</span> <span class=n>img</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>j</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  		<span class=k>else</span> <span class=k>if</span> <span class=p>((</span><span class=n>i</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>j</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>==</span> <span class=mi>1</span><span class=p>))</span>	<span class=n>avgG</span> <span class=o>=</span> <span class=n>avgG</span> <span class=o>+</span> <span class=n>img</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>j</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  		<span class=k>else</span> <span class=k>if</span> <span class=p>((</span><span class=n>i</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>j</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>==</span> <span class=mi>0</span><span class=p>))</span>	<span class=n>avgC1</span> <span class=o>=</span> <span class=n>avgC1</span> <span class=o>+</span> <span class=n>img</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>j</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  		<span class=k>else</span> <span class=k>if</span> <span class=p>((</span><span class=n>i</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>j</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>==</span> <span class=mi>1</span><span class=p>))</span>	<span class=n>avgC2</span> <span class=o>=</span> <span class=n>avgC2</span> <span class=o>+</span> <span class=n>img</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>j</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  	<span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=n>avgG</span> <span class=o>=</span> <span class=n>avgG</span> <span class=o>/</span> <span class=mi>40</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>avgC1</span> <span class=o>=</span> <span class=n>avgC1</span> <span class=o>/</span> <span class=mi>25</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>avgC2</span> <span class=o>=</span> <span class=n>avgC2</span> <span class=o>/</span> <span class=mi>16</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>float</span> <span class=n>center</span> <span class=o>=</span> <span class=n>img</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>((</span><span class=n>center</span> <span class=o>&gt;</span> <span class=n>avgG</span> <span class=o>+</span> <span class=n>thres</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>center</span> <span class=o>&gt;</span> <span class=n>avgC2</span> <span class=o>+</span> <span class=n>thres</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>  	<span class=k>if</span> <span class=p>((</span><span class=n>avgC1</span> <span class=o>&gt;</span> <span class=n>avgG</span> <span class=o>+</span> <span class=n>thres</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>avgC1</span> <span class=o>&gt;</span> <span class=n>avgC2</span> <span class=o>+</span> <span class=n>thres</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  	<span class=p>{</span>
</span></span><span class=line><span class=cl>  		<span class=n>is_noise</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  	<span class=p>}</span>
</span></span><span class=line><span class=cl>  	<span class=k>else</span>
</span></span><span class=line><span class=cl>  	<span class=p>{</span>
</span></span><span class=line><span class=cl>  		<span class=n>is_noise</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  	<span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>  	<span class=n>is_noise</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>float</span> <span class=nf>__cnf</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>is_color</span><span class=p>,</span> <span class=kt>int</span> <span class=n>y</span><span class=p>,</span> <span class=kt>int</span> <span class=n>x</span><span class=p>,</span> <span class=n>ImageRaw</span><span class=o>*</span> <span class=n>img</span><span class=p>,</span> <span class=kt>float</span> <span class=n>thres</span><span class=p>,</span> <span class=kt>float</span> <span class=n>r_gain</span><span class=p>,</span> <span class=kt>float</span> <span class=n>gr_gain</span><span class=p>,</span> <span class=kt>float</span> <span class=n>gb_gain</span><span class=p>,</span> <span class=kt>float</span> <span class=n>b_gain</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>is_noise</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>float</span> <span class=n>avgG</span><span class=p>,</span> <span class=n>avgC1</span><span class=p>,</span> <span class=n>avgC2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>__cnd</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>img</span><span class=p>,</span> <span class=n>thres</span><span class=p>,</span> <span class=n>is_noise</span><span class=p>,</span> <span class=n>avgG</span><span class=p>,</span> <span class=n>avgC1</span><span class=p>,</span> <span class=n>avgC2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>float</span> <span class=n>pix_out</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>is_noise</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>  	<span class=n>pix_out</span> <span class=o>=</span> <span class=n>__cnc</span><span class=p>(</span><span class=n>is_color</span><span class=p>,</span> <span class=n>img</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>),</span> <span class=n>avgG</span><span class=p>,</span> <span class=n>avgC1</span><span class=p>,</span> <span class=n>avgC2</span><span class=p>,</span> <span class=n>r_gain</span><span class=p>,</span> <span class=n>gr_gain</span><span class=p>,</span> <span class=n>gb_gain</span><span class=p>,</span> <span class=n>b_gain</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>  	<span class=n>pix_out</span> <span class=o>=</span> <span class=n>img</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>pix_out</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>CNF</span><span class=p>(</span><span class=n>ImageRaw</span><span class=o>&amp;</span> <span class=n>img</span><span class=p>,</span> <span class=n>BAYER_PATTERN</span> <span class=n>bayer_pattern</span><span class=p>,</span> <span class=kt>float</span> <span class=n>threshold</span><span class=p>,</span> <span class=kt>float</span> <span class=n>r_gain</span><span class=p>,</span> <span class=kt>float</span> <span class=n>gr_gain</span><span class=p>,</span> <span class=kt>float</span> <span class=n>gb_gain</span><span class=p>,</span> <span class=kt>float</span> <span class=n>b_gain</span><span class=p>,</span> <span class=kt>uint16_t</span> <span class=n>clip</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>ImageRaw</span><span class=o>*</span> <span class=n>img_pad</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ImageRaw</span><span class=p>(</span><span class=n>img</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>img_pad</span><span class=o>-&gt;</span><span class=n>padding</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=n>PADDING_MODE_REFLECT</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>uint16_t</span> <span class=n>r</span><span class=p>,</span> <span class=n>gr</span><span class=p>,</span> <span class=n>gb</span><span class=p>,</span> <span class=n>b</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>y</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>y</span> <span class=o>&lt;</span> <span class=n>img_pad</span><span class=o>-&gt;</span><span class=n>getHeight</span><span class=p>()</span> <span class=o>-</span> <span class=mi>8</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span> <span class=n>y</span> <span class=o>+=</span> <span class=mi>2</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  	<span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>x</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>x</span> <span class=o>&lt;</span> <span class=n>img_pad</span><span class=o>-&gt;</span><span class=n>getWidth</span><span class=p>()</span> <span class=o>-</span> <span class=mi>8</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span> <span class=n>x</span> <span class=o>+=</span> <span class=mi>2</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  		<span class=k>switch</span> <span class=p>(</span><span class=n>bayer_pattern</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  		<span class=k>case</span> <span class=nl>BAYER_PATTERN_RGGB</span><span class=p>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  			<span class=n>r</span> <span class=o>=</span> <span class=n>img_pad</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>4</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  			<span class=n>gr</span> <span class=o>=</span> <span class=n>img_pad</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>4</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  			<span class=n>gb</span> <span class=o>=</span> <span class=n>img_pad</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>5</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  			<span class=n>b</span> <span class=o>=</span> <span class=n>img_pad</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>5</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  			<span class=n>img</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span> <span class=o>=</span> <span class=n>__cnf</span><span class=p>(</span><span class=s>&#34;r&#34;</span><span class=p>,</span> <span class=n>y</span> <span class=o>+</span> <span class=mi>4</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>4</span><span class=p>,</span> <span class=n>img_pad</span><span class=p>,</span> <span class=n>threshold</span><span class=p>,</span> <span class=n>r_gain</span><span class=p>,</span> <span class=n>gr_gain</span><span class=p>,</span> <span class=n>gb_gain</span><span class=p>,</span> <span class=n>b_gain</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  			<span class=n>img</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>=</span> <span class=n>gr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  			<span class=n>img</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span> <span class=o>=</span> <span class=n>gb</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  			<span class=n>img</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>=</span> <span class=n>__cnf</span><span class=p>(</span><span class=s>&#34;b&#34;</span><span class=p>,</span> <span class=n>y</span> <span class=o>+</span> <span class=mi>5</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>5</span><span class=p>,</span> <span class=n>img_pad</span><span class=p>,</span> <span class=n>threshold</span><span class=p>,</span> <span class=n>r_gain</span><span class=p>,</span> <span class=n>gr_gain</span><span class=p>,</span> <span class=n>gb_gain</span><span class=p>,</span> <span class=n>b_gain</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  			<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  		<span class=k>case</span> <span class=nl>BAYER_PATTERN_BGGR</span><span class=p>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  			<span class=n>b</span> <span class=o>=</span> <span class=n>img_pad</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>4</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  			<span class=n>gb</span> <span class=o>=</span> <span class=n>img_pad</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>4</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  			<span class=n>gr</span> <span class=o>=</span> <span class=n>img_pad</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>5</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  			<span class=n>r</span> <span class=o>=</span> <span class=n>img_pad</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>5</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  			<span class=n>img</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span> <span class=o>=</span> <span class=n>__cnf</span><span class=p>(</span><span class=s>&#34;b&#34;</span><span class=p>,</span> <span class=n>y</span> <span class=o>+</span> <span class=mi>4</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>4</span><span class=p>,</span> <span class=n>img_pad</span><span class=p>,</span> <span class=n>threshold</span><span class=p>,</span> <span class=n>r_gain</span><span class=p>,</span> <span class=n>gr_gain</span><span class=p>,</span> <span class=n>gb_gain</span><span class=p>,</span> <span class=n>b_gain</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  			<span class=n>img</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>=</span> <span class=n>gb</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  			<span class=n>img</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span> <span class=o>=</span> <span class=n>gr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  			<span class=n>img</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>=</span> <span class=n>__cnf</span><span class=p>(</span><span class=s>&#34;r&#34;</span><span class=p>,</span> <span class=n>y</span> <span class=o>+</span> <span class=mi>5</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>5</span><span class=p>,</span> <span class=n>img_pad</span><span class=p>,</span> <span class=n>threshold</span><span class=p>,</span> <span class=n>r_gain</span><span class=p>,</span> <span class=n>gr_gain</span><span class=p>,</span> <span class=n>gb_gain</span><span class=p>,</span> <span class=n>b_gain</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  			<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  		<span class=k>case</span> <span class=nl>BAYER_PATTERN_GBRG</span><span class=p>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  			<span class=n>gb</span> <span class=o>=</span> <span class=n>img_pad</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>4</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  			<span class=n>b</span> <span class=o>=</span> <span class=n>img_pad</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>4</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  			<span class=n>r</span> <span class=o>=</span> <span class=n>img_pad</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>5</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  			<span class=n>gr</span> <span class=o>=</span> <span class=n>img_pad</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>5</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  			<span class=n>img</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span> <span class=o>=</span> <span class=n>gb</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  			<span class=n>img</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>=</span> <span class=n>__cnf</span><span class=p>(</span><span class=s>&#34;b&#34;</span><span class=p>,</span> <span class=n>y</span> <span class=o>+</span> <span class=mi>4</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>5</span><span class=p>,</span> <span class=n>img_pad</span><span class=p>,</span> <span class=n>threshold</span><span class=p>,</span> <span class=n>r_gain</span><span class=p>,</span> <span class=n>gr_gain</span><span class=p>,</span> <span class=n>gb_gain</span><span class=p>,</span> <span class=n>b_gain</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  			<span class=n>img</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span> <span class=o>=</span> <span class=n>__cnf</span><span class=p>(</span><span class=s>&#34;r&#34;</span><span class=p>,</span> <span class=n>y</span> <span class=o>+</span> <span class=mi>5</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>4</span><span class=p>,</span> <span class=n>img_pad</span><span class=p>,</span> <span class=n>threshold</span><span class=p>,</span> <span class=n>r_gain</span><span class=p>,</span> <span class=n>gr_gain</span><span class=p>,</span> <span class=n>gb_gain</span><span class=p>,</span> <span class=n>b_gain</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  			<span class=n>img</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>=</span> <span class=n>gr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  			<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  		<span class=k>case</span> <span class=nl>BAYER_PATTERN_GRBG</span><span class=p>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  			<span class=n>gr</span> <span class=o>=</span> <span class=n>img_pad</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>4</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  			<span class=n>r</span> <span class=o>=</span> <span class=n>img_pad</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>4</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  			<span class=n>b</span> <span class=o>=</span> <span class=n>img_pad</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>5</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  			<span class=n>gb</span> <span class=o>=</span> <span class=n>img_pad</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>5</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  			<span class=n>img</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span> <span class=o>=</span> <span class=n>gr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  			<span class=n>img</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>=</span> <span class=n>__cnf</span><span class=p>(</span><span class=s>&#34;r&#34;</span><span class=p>,</span> <span class=n>y</span> <span class=o>+</span> <span class=mi>4</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>5</span><span class=p>,</span> <span class=n>img_pad</span><span class=p>,</span> <span class=n>threshold</span><span class=p>,</span> <span class=n>r_gain</span><span class=p>,</span> <span class=n>gr_gain</span><span class=p>,</span> <span class=n>gb_gain</span><span class=p>,</span> <span class=n>b_gain</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  			<span class=n>img</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span> <span class=o>=</span> <span class=n>__cnf</span><span class=p>(</span><span class=s>&#34;b&#34;</span><span class=p>,</span> <span class=n>y</span> <span class=o>+</span> <span class=mi>5</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>4</span><span class=p>,</span> <span class=n>img_pad</span><span class=p>,</span> <span class=n>threshold</span><span class=p>,</span> <span class=n>r_gain</span><span class=p>,</span> <span class=n>gr_gain</span><span class=p>,</span> <span class=n>gb_gain</span><span class=p>,</span> <span class=n>b_gain</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  			<span class=n>img</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>=</span> <span class=n>gb</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  			<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  		<span class=k>case</span> <span class=nl>BAYER_PATTERN_UNKNOWN</span><span class=p>:</span>
</span></span><span class=line><span class=cl>  		<span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>  			<span class=n>TRACE_DEBUG_LOG_ERROR</span><span class=p>(</span><span class=s>&#34;Unknown Bayer Pattern:%s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>bayer_pattern</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  			<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  		<span class=p>}</span>
</span></span><span class=line><span class=cl>  	<span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>img</span><span class=p>.</span><span class=n>clip</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>clip</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>delete</span> <span class=n>img_pad</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></details><h3 id=抗锯齿滤波anti-aliasing-filteringaaf>抗锯齿滤波（Anti-aliasing Filtering，AAF）</h3><p>如果拍摄的图像中含有大量高频成分，在降采样时就会产生锯齿（aliasing），要去除锯齿，需要对原图像进行平滑。常用的方法有高斯滤波器（Gaussian Filter）和双边滤波器（Bilateral Filter）。</p><ol><li>高斯滤波器
$$G(x,y)=\frac1{2\pi\sigma^2}\exp\left(-\frac{x^2+y^2}{2\sigma^2}\right)$$<br>其中:<br>$\bullet\quad G(x,y)$是高斯核在坐标(x,y)的值;<br>$\bullet\quad \sigma$是高斯分布的标准差,决定滤波器的平滑强度;<br>$\bullet\quad x,y$是距离核中心的坐标。</li><li>双边滤波器
$$W(p,q)=\exp\left(-\frac{\|p-q\|^2}{2\sigma_s^2}\right)\cdot\exp\left(-\frac{|I(p)-I(q)|^2}{2\sigma_r^2}\right)$$<br>其中:<br>$\bullet\quad W(p,q)$是像素q对p的权重;<br>$\bullet\quad|p-q|$是两像素在空间上的距离;<br>$\bullet\quad|I(p)-I(q)|$是两像素灰度值的差异;<br>$\bullet\quad\sigma_s$是空间域高斯标准差;<br>$\bullet\quad\sigma_r$是强度域高斯标准差。<br>滤波结果:<br>$$I^{\prime} (p)=\frac{\sum_{q\in S}W(p,q)\cdot I(q)}{\sum_{q\in S}W(p,q)}$$<br>其中:S是滤波窗口,$I^{\prime}(p)$是像素p的滤波值。</li></ol><p>两者对比：</p><div class=table-wrapper><table><thead><tr><th>特性</th><th>高斯滤波器</th><th>双边滤波器</th></tr></thead><tbody><tr><td>性质</td><td>线性滤波</td><td>非线性滤波</td></tr><tr><td>边缘保留</td><td>不保留边缘，模糊边缘</td><td>保留边缘，对边缘影响较小</td></tr><tr><td>计算复杂度</td><td>低</td><td>高</td></tr><tr><td>实现难度</td><td>简单</td><td>较复杂</td></tr><tr><td>适用场景</td><td>快速平滑、高频噪声较少的场景</td><td>高质量抗锯齿，保留纹理和边缘</td></tr></tbody></table></div><p><img src=/articles/camera-isp/image-8.png width=579 height=377 srcset="/articles/camera-isp/image-8_hu_21ff595838d09d20.png 480w, /articles/camera-isp/image-8_hu_3e8c4bc12fca94b4.png 1024w" loading=lazy alt="图18 锯齿滤波前" class=gallery-image data-flex-grow=153 data-flex-basis=368px> <img src=/articles/camera-isp/image-11.png width=579 height=377 srcset="/articles/camera-isp/image-11_hu_50581154a7c93451.png 480w, /articles/camera-isp/image-11_hu_c010aec987189e7c.png 1024w" loading=lazy alt="图19 锯齿滤波后" class=gallery-image data-flex-grow=153 data-flex-basis=368px></p><details class=popup-details><summary>示例代码（双边滤波器</summary><div class=popup-content><button class=close-btn>✖</button><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @brief Computes the Gaussian weight for a given difference.
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @param x The difference (distance in space or intensity).
</span></span></span><span class=line><span class=cl><span class=cm> * @param sigma The standard deviation of the Gaussian function.
</span></span></span><span class=line><span class=cl><span class=cm> * @return The computed Gaussian weight.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kt>double</span> <span class=nf>gaussian</span><span class=p>(</span><span class=kt>double</span> <span class=n>x</span><span class=p>,</span> <span class=kt>double</span> <span class=n>sigma</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>std</span><span class=o>::</span><span class=n>exp</span><span class=p>(</span><span class=o>-</span><span class=n>x</span> <span class=o>*</span> <span class=n>x</span> <span class=o>/</span> <span class=p>(</span><span class=mf>2.0</span> <span class=o>*</span> <span class=n>sigma</span> <span class=o>*</span> <span class=n>sigma</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @brief Applies a bilateral filter to an ImageRaw object.
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @param src Input image.
</span></span></span><span class=line><span class=cl><span class=cm> * @param dst Output image (should be pre-initialized to the same size as src).
</span></span></span><span class=line><span class=cl><span class=cm> * @param d The diameter of the filter kernel (must be an odd number).
</span></span></span><span class=line><span class=cl><span class=cm> * @param sigmaColor The standard deviation in the intensity space.
</span></span></span><span class=line><span class=cl><span class=cm> * @param sigmaSpace The standard deviation in the spatial space.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>applyBilateralFilter</span><span class=p>(</span><span class=k>const</span> <span class=n>ImageRaw</span><span class=o>&amp;</span> <span class=n>src</span><span class=p>,</span> <span class=n>ImageRaw</span><span class=o>&amp;</span> <span class=n>dst</span><span class=p>,</span> <span class=kt>int</span> <span class=n>d</span><span class=p>,</span> <span class=kt>double</span> <span class=n>sigmaColor</span><span class=p>,</span> <span class=kt>double</span> <span class=n>sigmaSpace</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>height</span> <span class=o>=</span> <span class=n>src</span><span class=p>.</span><span class=n>getHeight</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>width</span> <span class=o>=</span> <span class=n>src</span><span class=p>.</span><span class=n>getWidth</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// Ensure kernel size is odd
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>d</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=n>std</span><span class=o>::</span><span class=n>invalid_argument</span><span class=p>(</span><span class=s>&#34;Kernel size must be odd.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Precompute spatial Gaussian weights
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int</span> <span class=n>radius</span> <span class=o>=</span> <span class=n>d</span> <span class=o>/</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>double</span><span class=o>&gt;&gt;</span> <span class=n>spatialKernel</span><span class=p>(</span><span class=n>d</span><span class=p>,</span> <span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>double</span><span class=o>&gt;</span><span class=p>(</span><span class=n>d</span><span class=p>,</span> <span class=mf>0.0</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=o>-</span><span class=n>radius</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>radius</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=o>-</span><span class=n>radius</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;=</span> <span class=n>radius</span><span class=p>;</span> <span class=o>++</span><span class=n>j</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>spatialKernel</span><span class=p>[</span><span class=n>i</span> <span class=o>+</span> <span class=n>radius</span><span class=p>][</span><span class=n>j</span> <span class=o>+</span> <span class=n>radius</span><span class=p>]</span> <span class=o>=</span> <span class=n>gaussian</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>sqrt</span><span class=p>(</span><span class=n>i</span> <span class=o>*</span> <span class=n>i</span> <span class=o>+</span> <span class=n>j</span> <span class=o>*</span> <span class=n>j</span><span class=p>),</span> <span class=n>sigmaSpace</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Perform bilateral filtering
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>height</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>width</span><span class=p>;</span> <span class=o>++</span><span class=n>j</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>double</span> <span class=n>weightedSum</span> <span class=o>=</span> <span class=mf>0.0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=kt>double</span> <span class=n>normalizationFactor</span> <span class=o>=</span> <span class=mf>0.0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=kt>uint16_t</span> <span class=n>centerPixel</span> <span class=o>=</span> <span class=n>src</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>j</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>ki</span> <span class=o>=</span> <span class=o>-</span><span class=n>radius</span><span class=p>;</span> <span class=n>ki</span> <span class=o>&lt;=</span> <span class=n>radius</span><span class=p>;</span> <span class=o>++</span><span class=n>ki</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>kj</span> <span class=o>=</span> <span class=o>-</span><span class=n>radius</span><span class=p>;</span> <span class=n>kj</span> <span class=o>&lt;=</span> <span class=n>radius</span><span class=p>;</span> <span class=o>++</span><span class=n>kj</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=kt>int</span> <span class=n>ni</span> <span class=o>=</span> <span class=n>i</span> <span class=o>+</span> <span class=n>ki</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=kt>int</span> <span class=n>nj</span> <span class=o>=</span> <span class=n>j</span> <span class=o>+</span> <span class=n>kj</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=c1>// Skip out-of-bound pixels
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=k>if</span> <span class=p>(</span><span class=n>ni</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=o>||</span> <span class=n>ni</span> <span class=o>&gt;=</span> <span class=n>height</span> <span class=o>||</span> <span class=n>nj</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=o>||</span> <span class=n>nj</span> <span class=o>&gt;=</span> <span class=n>width</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=kt>uint16_t</span> <span class=n>neighborPixel</span> <span class=o>=</span> <span class=n>src</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>ni</span><span class=p>,</span> <span class=n>nj</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=c1>// Compute intensity Gaussian weight
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=kt>double</span> <span class=n>intensityWeight</span> <span class=o>=</span> <span class=n>gaussian</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>abs</span><span class=p>((</span><span class=kt>int</span><span class=p>)</span><span class=n>centerPixel</span> <span class=o>-</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=n>neighborPixel</span><span class=p>),</span> <span class=n>sigmaColor</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=c1>// Compute final weight
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=kt>double</span> <span class=n>weight</span> <span class=o>=</span> <span class=n>spatialKernel</span><span class=p>[</span><span class=n>ki</span> <span class=o>+</span> <span class=n>radius</span><span class=p>][</span><span class=n>kj</span> <span class=o>+</span> <span class=n>radius</span><span class=p>]</span> <span class=o>*</span> <span class=n>intensityWeight</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=c1>// Accumulate weighted sum and normalization factor
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=n>weightedSum</span> <span class=o>+=</span> <span class=n>neighborPixel</span> <span class=o>*</span> <span class=n>weight</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=n>normalizationFactor</span> <span class=o>+=</span> <span class=n>weight</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// Assign the filtered value to the destination image
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>dst</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>j</span><span class=p>)</span> <span class=o>=</span> <span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>uint16_t</span><span class=o>&gt;</span><span class=p>(</span><span class=n>weightedSum</span> <span class=o>/</span> <span class=n>normalizationFactor</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></details><h3 id=自动白平衡auto-white-balanceawb>自动白平衡（Auto White Balance，AWB）</h3><p>人的视觉和神经系统具有色彩恒常性，在看到白色物体的时候基本不受环境光源变化的影响。但是image sensor并不能像人的视觉系统一样自动调节，在不同色温光源下，拍出的照片中白色会出现偏色的情况。自动白平衡就是用来模拟人类的色彩恒常能力，在图像中去除光源引起的偏色，从而还原自然的色彩。</p><p>自动白平衡算法根据技术路线可以归结为几大类，分别是：</p><ul><li>场景假设模型：灰度世界、完美反射</li><li>点统计模型：白色点估计、分块权重</li></ul><ol><li>灰度世界算法<br>该算法假设：对于一副有着丰富色彩的图片，图像上R、G、B三个通道的平均值应该等于一个被称为“灰色”的值$K$。至于“灰色”值K的选择，一种方法是将待处理图片三个通道均值的均值作为“灰色”值$K$。当确定了灰色值K之后，待处理图片各个通道的校正系数分别为：$k_r=K/R_{mean}，k_g=K/G_{mean}，k_b=K/B_{mean}$，其中$R_{mean}，G_{mean}和B_{mean}$分别为图像R、G、B通道的均值。</li></ol><details class=popup-details><summary>示例代码</summary><div class=popup-content><button class=close-btn>✖</button><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;iostream&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;vector&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;numeric&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdexcept&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @brief Apply the Gray World Algorithm to an ImageRaw.
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * This algorithm adjusts the R, G, and B channels of the input image so that their
</span></span></span><span class=line><span class=cl><span class=cm> * mean values are equal to a common gray level \( K \). This corrects the overall
</span></span></span><span class=line><span class=cl><span class=cm> * color balance of the image.
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @param src Input image. Must have 3 channels (RGB format).
</span></span></span><span class=line><span class=cl><span class=cm> * @param dst Output image. Must have the same size as the input image.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>grayWorldAlgorithm</span><span class=p>(</span><span class=k>const</span> <span class=n>ImageRaw</span><span class=o>&amp;</span> <span class=n>src</span><span class=p>,</span> <span class=n>ImageRaw</span><span class=o>&amp;</span> <span class=n>dst</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Validate input image dimensions
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>src</span><span class=p>.</span><span class=n>getWidth</span><span class=p>()</span> <span class=o>!=</span> <span class=n>dst</span><span class=p>.</span><span class=n>getWidth</span><span class=p>()</span> <span class=o>||</span> <span class=n>src</span><span class=p>.</span><span class=n>getHeight</span><span class=p>()</span> <span class=o>!=</span> <span class=n>dst</span><span class=p>.</span><span class=n>getHeight</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=n>std</span><span class=o>::</span><span class=n>invalid_argument</span><span class=p>(</span><span class=s>&#34;Input and output images must have the same dimensions.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>width</span> <span class=o>=</span> <span class=n>src</span><span class=p>.</span><span class=n>getWidth</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>height</span> <span class=o>=</span> <span class=n>src</span><span class=p>.</span><span class=n>getHeight</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Accumulators for R, G, B channel sums
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>uint64_t</span> <span class=n>sumR</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>sumG</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>sumB</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>numPixels</span> <span class=o>=</span> <span class=n>width</span> <span class=o>*</span> <span class=n>height</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Compute channel-wise sums
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>height</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>width</span><span class=p>;</span> <span class=o>++</span><span class=n>j</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>uint16_t</span> <span class=n>r</span> <span class=o>=</span> <span class=n>src</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>j</span> <span class=o>*</span> <span class=mi>3</span><span class=p>);</span>     <span class=c1>// Assume RGB channels are stored in sequence
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=kt>uint16_t</span> <span class=n>g</span> <span class=o>=</span> <span class=n>src</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>j</span> <span class=o>*</span> <span class=mi>3</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=kt>uint16_t</span> <span class=n>b</span> <span class=o>=</span> <span class=n>src</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>j</span> <span class=o>*</span> <span class=mi>3</span> <span class=o>+</span> <span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>sumR</span> <span class=o>+=</span> <span class=n>r</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>sumG</span> <span class=o>+=</span> <span class=n>g</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>sumB</span> <span class=o>+=</span> <span class=n>b</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Compute mean values for each channel
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>double</span> <span class=n>meanR</span> <span class=o>=</span> <span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>double</span><span class=o>&gt;</span><span class=p>(</span><span class=n>sumR</span><span class=p>)</span> <span class=o>/</span> <span class=n>numPixels</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>double</span> <span class=n>meanG</span> <span class=o>=</span> <span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>double</span><span class=o>&gt;</span><span class=p>(</span><span class=n>sumG</span><span class=p>)</span> <span class=o>/</span> <span class=n>numPixels</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>double</span> <span class=n>meanB</span> <span class=o>=</span> <span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>double</span><span class=o>&gt;</span><span class=p>(</span><span class=n>sumB</span><span class=p>)</span> <span class=o>/</span> <span class=n>numPixels</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Compute the target gray value \( K \) as the average of all channel means
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>double</span> <span class=n>K</span> <span class=o>=</span> <span class=p>(</span><span class=n>meanR</span> <span class=o>+</span> <span class=n>meanG</span> <span class=o>+</span> <span class=n>meanB</span><span class=p>)</span> <span class=o>/</span> <span class=mf>3.0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Compute correction factors
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>double</span> <span class=n>kR</span> <span class=o>=</span> <span class=n>K</span> <span class=o>/</span> <span class=n>meanR</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>double</span> <span class=n>kG</span> <span class=o>=</span> <span class=n>K</span> <span class=o>/</span> <span class=n>meanG</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>double</span> <span class=n>kB</span> <span class=o>=</span> <span class=n>K</span> <span class=o>/</span> <span class=n>meanB</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Apply correction to each pixel
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>height</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>width</span><span class=p>;</span> <span class=o>++</span><span class=n>j</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>uint16_t</span> <span class=n>r</span> <span class=o>=</span> <span class=n>src</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>j</span> <span class=o>*</span> <span class=mi>3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=kt>uint16_t</span> <span class=n>g</span> <span class=o>=</span> <span class=n>src</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>j</span> <span class=o>*</span> <span class=mi>3</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=kt>uint16_t</span> <span class=n>b</span> <span class=o>=</span> <span class=n>src</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>j</span> <span class=o>*</span> <span class=mi>3</span> <span class=o>+</span> <span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// Adjust each channel and clip the values to the valid range
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>dst</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>j</span> <span class=o>*</span> <span class=mi>3</span><span class=p>)</span> <span class=o>=</span> <span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>uint16_t</span><span class=o>&gt;</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>min</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>max</span><span class=p>(</span><span class=n>r</span> <span class=o>*</span> <span class=n>kR</span><span class=p>,</span> <span class=mf>0.0</span><span class=p>),</span> <span class=mf>65535.0</span><span class=p>));</span>
</span></span><span class=line><span class=cl>            <span class=n>dst</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>j</span> <span class=o>*</span> <span class=mi>3</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>=</span> <span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>uint16_t</span><span class=o>&gt;</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>min</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>max</span><span class=p>(</span><span class=n>g</span> <span class=o>*</span> <span class=n>kG</span><span class=p>,</span> <span class=mf>0.0</span><span class=p>),</span> <span class=mf>65535.0</span><span class=p>));</span>
</span></span><span class=line><span class=cl>            <span class=n>dst</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>j</span> <span class=o>*</span> <span class=mi>3</span> <span class=o>+</span> <span class=mi>2</span><span class=p>)</span> <span class=o>=</span> <span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>uint16_t</span><span class=o>&gt;</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>min</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>max</span><span class=p>(</span><span class=n>b</span> <span class=o>*</span> <span class=n>kB</span><span class=p>,</span> <span class=mf>0.0</span><span class=p>),</span> <span class=mf>65535.0</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></details><ol start=2><li>完美反射法
该算法假设：“镜面”可以完全发射光源照射在物体上面的光线。因此，如果图像中存在一个“镜面”的话，那么在特定光源下，可以将所获得的“镜面”的色彩信息认为是当前光源的信息。在进行白平衡校准的时候，假设图片上存在一个可以完全反射光源的“镜面”，那么在经典光源下图片中就应该存在一个三刺激值为[255,255,255]纯白色像素点（有多种白色点定义，这是一种），此时待处理图片各个通道的校正系数分别为：$k_r=255/R_{max}，k_g=255/G_{max}，k_b=255/B_{max}$，其中$R_{max}，G_{max}和B_{max}$分别为图像R、G、B通道的最大值。</li></ol><details class=popup-details><summary>示例代码-完美反射法</summary><div class=popup-content><button class=close-btn>✖</button><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp></code></pre></td></tr></table></div></div></div></details><ol start=3><li>统计加权白点法（通常在需要比较高图像质量时使用）
该算法首先需要对传感器进行光源标定得到色温曲线。折线上的点是在产线上针对不同光源(D65, A光，H光等)使用标准白/灰卡纸拍出照片算出来的$R_{gain}=R_{mean}/G_{mean}$和$B_{gain}=B_{mean}/G_{mean}$坐标。校准时将图片分为M块，分别计算每块的$R_{gain}$和$B_{gain}$和，作为一个“白点”，将值靠近折线区域(红色)的“白点”权重加高，远离的(蓝色)权重降低，再计算出加权平均值得到最终“白点”的$R_{gain}$和$B_{gain}$，使用折线上的不同点做插值计算出一个最终$R_{gain}$和$B_{gain}$值。</li></ol><p><img src=/articles/camera-isp/image-12.png width=640 height=371 srcset="/articles/camera-isp/image-12_hu_9ee28044553d68c9.png 480w, /articles/camera-isp/image-12_hu_9122bf4fa42403f5.png 1024w" loading=lazy alt="图20 色温增益曲线" class=gallery-image data-flex-grow=172 data-flex-basis=414px></p><details class=popup-details><summary>示例代码-统计加权白点法</summary><div class=popup-content><button class=close-btn>✖</button><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp></code></pre></td></tr></table></div></div></div></details><h3 id=去马赛克demosaicing>去马赛克（Demosaicing）</h3><p>之前提到了普通的CMOS图像传感器无法“捕获”色彩信息，解决方法是通过Bayer阵列的带有不同颜色滤光片的像素点记录对应通道的亮度值，最后插值得到每个像素点的RGB三通道值。由于通过CMOS得到的Bayer格式的RAW图放大看起来就像马赛克，这个从灰度图片还原图片色彩的过程又叫去马赛克。（Demosaicing）</p><p><img src=/articles/camera-isp/raw_mask.gif width=450 height=337 srcset="/articles/camera-isp/raw_mask_hu_8a4c574e3f433800.gif 480w, /articles/camera-isp/raw_mask_hu_e20c410c4cd3ec3e.gif 1024w" loading=lazy alt="图21 RAW图放大" class=gallery-image data-flex-grow=133 data-flex-basis=320px> <img src=/articles/camera-isp/table.jpg width=4096 height=3072 srcset="/articles/camera-isp/table_hu_cfbebec0347767d.jpg 480w, /articles/camera-isp/table_hu_f197998cc7dc4988.jpg 1024w" loading=lazy alt="图22 Jpeg图" class=gallery-image data-flex-grow=133 data-flex-basis=320px></p><p>Demosiac的插值一般遵循以下几个原则：<br>1.先对G分量进行插值，因为G通道的像素数量是GB通道的两倍<br>2.插值时采用方向性插值，即如果是垂直的边缘，则采用上下的像素插值，而不选用左右<br>3.哈密尔顿(Hamilton)色差恒定原理，$R(i,j)-G(i,j)=R(i,j+1)-G(i,j+1)$，即相邻点色差相同<br>4.各个颜色分量在同一像素点处的高频分量可认为是相同的</p><p>具体而言，一个简单的去马赛克流程可以是：<br>1.获取图像中的物体的边缘
2.根据边缘信息插值重建G分量
3.根据哈密尔顿提出的色差恒定理论，根据色差插值重建R和B分量
4.一些后处理，包括伪彩色抑制（pseudocolor suppression）和拉链效应抑制（zipper cancelling）等</p><p>扩展阅读：<a class=link href=https://zhuanlan.zhihu.com/p/563755436 target=_blank rel=noopener>低成本边缘与色差插值去马赛克算法（LED）</a></p><details class=popup-details><summary>示例代码-LED法</summary><div class=popup-content><button class=close-btn>✖</button><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>// 示例代码：去马赛克算法实现（基于方向性插值和色差恒定理论）
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;vector&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;cmath&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;algorithm&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=k>using</span> <span class=k>namespace</span> <span class=n>std</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 获取梯度信息
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=nf>compute_gradients</span><span class=p>(</span><span class=k>const</span> <span class=n>vector</span><span class=o>&lt;</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;&gt;&amp;</span> <span class=n>image</span><span class=p>,</span> <span class=n>vector</span><span class=o>&lt;</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;&gt;&amp;</span> <span class=n>grad_h</span><span class=p>,</span> <span class=n>vector</span><span class=o>&lt;</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;&gt;&amp;</span> <span class=n>grad_v</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>rows</span> <span class=o>=</span> <span class=n>image</span><span class=p>.</span><span class=n>size</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>cols</span> <span class=o>=</span> <span class=n>image</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>size</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>grad_h</span><span class=p>.</span><span class=n>resize</span><span class=p>(</span><span class=n>rows</span><span class=p>,</span> <span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=p>(</span><span class=n>cols</span><span class=p>,</span> <span class=mi>0</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=n>grad_v</span><span class=p>.</span><span class=n>resize</span><span class=p>(</span><span class=n>rows</span><span class=p>,</span> <span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=p>(</span><span class=n>cols</span><span class=p>,</span> <span class=mi>0</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>rows</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>cols</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span> <span class=o>++</span><span class=n>j</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>grad_h</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=n>abs</span><span class=p>(</span><span class=n>image</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span> <span class=o>+</span> <span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=n>image</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>            <span class=n>grad_v</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=n>abs</span><span class=p>(</span><span class=n>image</span><span class=p>[</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>-</span> <span class=n>image</span><span class=p>[</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>][</span><span class=n>j</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 方向性插值重建G分量
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=nf>reconstruct_green</span><span class=p>(</span><span class=k>const</span> <span class=n>vector</span><span class=o>&lt;</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;&gt;&amp;</span> <span class=n>bayer</span><span class=p>,</span> <span class=n>vector</span><span class=o>&lt;</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;&gt;&amp;</span> <span class=n>green</span><span class=p>,</span> <span class=k>const</span> <span class=n>vector</span><span class=o>&lt;</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;&gt;&amp;</span> <span class=n>grad_h</span><span class=p>,</span> <span class=k>const</span> <span class=n>vector</span><span class=o>&lt;</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;&gt;&amp;</span> <span class=n>grad_v</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>rows</span> <span class=o>=</span> <span class=n>bayer</span><span class=p>.</span><span class=n>size</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>cols</span> <span class=o>=</span> <span class=n>bayer</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>size</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>green</span> <span class=o>=</span> <span class=n>bayer</span><span class=p>;</span> <span class=c1>// 初始为 Bayer 图像
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>rows</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>cols</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span> <span class=o>++</span><span class=n>j</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>((</span><span class=n>i</span> <span class=o>+</span> <span class=n>j</span><span class=p>)</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span> <span class=c1>// 当前像素不是 G
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>if</span> <span class=p>(</span><span class=n>grad_h</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>grad_v</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>green</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>bayer</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]</span> <span class=o>+</span> <span class=n>bayer</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span> <span class=o>+</span> <span class=mi>1</span><span class=p>])</span> <span class=o>/</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>green</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>bayer</span><span class=p>[</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>+</span> <span class=n>bayer</span><span class=p>[</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>][</span><span class=n>j</span><span class=p>])</span> <span class=o>/</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 根据色差恒定理论重建 R 和 B 分量
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=nf>reconstruct_red_blue</span><span class=p>(</span><span class=k>const</span> <span class=n>vector</span><span class=o>&lt;</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;&gt;&amp;</span> <span class=n>bayer</span><span class=p>,</span> <span class=k>const</span> <span class=n>vector</span><span class=o>&lt;</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;&gt;&amp;</span> <span class=n>green</span><span class=p>,</span> <span class=n>vector</span><span class=o>&lt;</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;&gt;&amp;</span> <span class=n>red</span><span class=p>,</span> <span class=n>vector</span><span class=o>&lt;</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;&gt;&amp;</span> <span class=n>blue</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>rows</span> <span class=o>=</span> <span class=n>bayer</span><span class=p>.</span><span class=n>size</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>cols</span> <span class=o>=</span> <span class=n>bayer</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>size</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>red</span> <span class=o>=</span> <span class=n>bayer</span><span class=p>;</span> <span class=c1>// 初始为 Bayer 图像
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>blue</span> <span class=o>=</span> <span class=n>bayer</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>rows</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>cols</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span> <span class=o>++</span><span class=n>j</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>((</span><span class=n>i</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>j</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span> <span class=o>||</span> <span class=p>(</span><span class=n>i</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>==</span> <span class=mi>1</span> <span class=o>&amp;&amp;</span> <span class=n>j</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>==</span> <span class=mi>0</span><span class=p>))</span> <span class=p>{</span> <span class=c1>// 当前像素是 G
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>red</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=n>green</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>+</span> <span class=p>(</span><span class=n>bayer</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span> <span class=o>+</span> <span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=n>green</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span> <span class=o>+</span> <span class=mi>1</span><span class=p>]</span> <span class=o>+</span> <span class=n>bayer</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=n>green</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span> <span class=o>-</span> <span class=mi>1</span><span class=p>])</span> <span class=o>/</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>blue</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=n>green</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>+</span> <span class=p>(</span><span class=n>bayer</span><span class=p>[</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>-</span> <span class=n>green</span><span class=p>[</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>+</span> <span class=n>bayer</span><span class=p>[</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>-</span> <span class=n>green</span><span class=p>[</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>][</span><span class=n>j</span><span class=p>])</span> <span class=o>/</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>((</span><span class=n>i</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>j</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>==</span> <span class=mi>0</span><span class=p>))</span> <span class=p>{</span> <span class=c1>// 当前像素是 B
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>red</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=n>green</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>+</span> <span class=p>(</span><span class=n>bayer</span><span class=p>[</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>][</span><span class=n>j</span> <span class=o>+</span> <span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=n>green</span><span class=p>[</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>][</span><span class=n>j</span> <span class=o>+</span> <span class=mi>1</span><span class=p>]</span> <span class=o>+</span> <span class=n>bayer</span><span class=p>[</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>][</span><span class=n>j</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=n>green</span><span class=p>[</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>][</span><span class=n>j</span> <span class=o>-</span> <span class=mi>1</span><span class=p>])</span> <span class=o>/</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span> <span class=c1>// 当前像素是 R
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>blue</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=n>green</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>+</span> <span class=p>(</span><span class=n>bayer</span><span class=p>[</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>][</span><span class=n>j</span> <span class=o>+</span> <span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=n>green</span><span class=p>[</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>][</span><span class=n>j</span> <span class=o>+</span> <span class=mi>1</span><span class=p>]</span> <span class=o>+</span> <span class=n>bayer</span><span class=p>[</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>][</span><span class=n>j</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=n>green</span><span class=p>[</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>][</span><span class=n>j</span> <span class=o>-</span> <span class=mi>1</span><span class=p>])</span> <span class=o>/</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 伪彩色抑制与拉链效应去除的后处理
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=nf>post_process</span><span class=p>(</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;&gt;&amp;</span> <span class=n>red</span><span class=p>,</span> <span class=n>vector</span><span class=o>&lt;</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;&gt;&amp;</span> <span class=n>green</span><span class=p>,</span> <span class=n>vector</span><span class=o>&lt;</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;&gt;&amp;</span> <span class=n>blue</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>rows</span> <span class=o>=</span> <span class=n>red</span><span class=p>.</span><span class=n>size</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>cols</span> <span class=o>=</span> <span class=n>red</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>size</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>rows</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>cols</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span> <span class=o>++</span><span class=n>j</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>red</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=n>min</span><span class=p>(</span><span class=n>max</span><span class=p>(</span><span class=n>red</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>],</span> <span class=mi>0</span><span class=p>),</span> <span class=mi>255</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>green</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=n>min</span><span class=p>(</span><span class=n>max</span><span class=p>(</span><span class=n>green</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>],</span> <span class=mi>0</span><span class=p>),</span> <span class=mi>255</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>blue</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=n>min</span><span class=p>(</span><span class=n>max</span><span class=p>(</span><span class=n>blue</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>],</span> <span class=mi>0</span><span class=p>),</span> <span class=mi>255</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 主函数：去马赛克
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=nf>demosaic</span><span class=p>(</span><span class=k>const</span> <span class=n>vector</span><span class=o>&lt;</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;&gt;&amp;</span> <span class=n>bayer</span><span class=p>,</span> <span class=n>vector</span><span class=o>&lt;</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;&gt;&amp;</span> <span class=n>red</span><span class=p>,</span> <span class=n>vector</span><span class=o>&lt;</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;&gt;&amp;</span> <span class=n>green</span><span class=p>,</span> <span class=n>vector</span><span class=o>&lt;</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;&gt;&amp;</span> <span class=n>blue</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>vector</span><span class=o>&lt;</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;&gt;</span> <span class=n>grad_h</span><span class=p>,</span> <span class=n>grad_v</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>compute_gradients</span><span class=p>(</span><span class=n>bayer</span><span class=p>,</span> <span class=n>grad_h</span><span class=p>,</span> <span class=n>grad_v</span><span class=p>);</span> <span class=c1>// 计算梯度
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>reconstruct_green</span><span class=p>(</span><span class=n>bayer</span><span class=p>,</span> <span class=n>green</span><span class=p>,</span> <span class=n>grad_h</span><span class=p>,</span> <span class=n>grad_v</span><span class=p>);</span> <span class=c1>// 重建 G 分量
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>reconstruct_red_blue</span><span class=p>(</span><span class=n>bayer</span><span class=p>,</span> <span class=n>green</span><span class=p>,</span> <span class=n>red</span><span class=p>,</span> <span class=n>blue</span><span class=p>);</span> <span class=c1>// 重建 R 和 B 分量
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>post_process</span><span class=p>(</span><span class=n>red</span><span class=p>,</span> <span class=n>green</span><span class=p>,</span> <span class=n>blue</span><span class=p>);</span> <span class=c1>// 后处理
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></details><h3 id=色彩校正color-correction>色彩校正（Color Correction）</h3>$$\begin{bmatrix}R'\\G'\\B'\end{bmatrix}=\begin{bmatrix}m_{11}&m_{12}&m_{13}\\m_{21}&m_{22}&m_{23}\\m_{31}&m_{32}&m_{33}\end{bmatrix}\begin{bmatrix}R\\G\\B\end{bmatrix}$$<p>其中R&rsquo;G&rsquo;B&rsquo;是校正后的颜色值，RGB是传感器捕获的原始颜色值。</p><p><img src=/articles/camera-isp/image-14.png width=671 height=237 srcset="/articles/camera-isp/image-14_hu_2063ad73fa5b9e16.png 480w, /articles/camera-isp/image-14_hu_87444d92213ff484.png 1024w" loading=lazy alt="图23 色彩校正示例" class=gallery-image data-flex-grow=283 data-flex-basis=679px></p><details class=popup-details><summary>示例代码</summary><div class=popup-content><button class=close-btn>✖</button><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;vector&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;array&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1>// 色彩校正矩阵定义
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>const</span> <span class=n>std</span><span class=o>::</span><span class=n>array</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>array</span><span class=o>&lt;</span><span class=kt>float</span><span class=p>,</span> <span class=mi>3</span><span class=o>&gt;</span><span class=p>,</span> <span class=mi>3</span><span class=o>&gt;</span> <span class=n>CCM</span> <span class=o>=</span> <span class=p>{{</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=mf>1.2f</span><span class=p>,</span> <span class=o>-</span><span class=mf>0.1f</span><span class=p>,</span> <span class=o>-</span><span class=mf>0.1f</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=o>-</span><span class=mf>0.2f</span><span class=p>,</span> <span class=mf>1.3f</span><span class=p>,</span> <span class=o>-</span><span class=mf>0.1f</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=o>-</span><span class=mf>0.1f</span><span class=p>,</span> <span class=o>-</span><span class=mf>0.2f</span><span class=p>,</span> <span class=mf>1.4f</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 对单个像素点进行色彩校正
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>std</span><span class=o>::</span><span class=n>array</span><span class=o>&lt;</span><span class=kt>float</span><span class=p>,</span> <span class=mi>3</span><span class=o>&gt;</span> <span class=n>colorCorrection</span><span class=p>(</span><span class=k>const</span> <span class=n>std</span><span class=o>::</span><span class=n>array</span><span class=o>&lt;</span><span class=kt>float</span><span class=p>,</span> <span class=mi>3</span><span class=o>&gt;&amp;</span> <span class=n>input</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>array</span><span class=o>&lt;</span><span class=kt>float</span><span class=p>,</span> <span class=mi>3</span><span class=o>&gt;</span> <span class=n>output</span> <span class=o>=</span> <span class=p>{</span><span class=mf>0.0f</span><span class=p>,</span> <span class=mf>0.0f</span><span class=p>,</span> <span class=mf>0.0f</span><span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>3</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=mi>3</span><span class=p>;</span> <span class=o>++</span><span class=n>j</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>output</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>+=</span> <span class=n>CCM</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>*</span> <span class=n>input</span><span class=p>[</span><span class=n>j</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>output</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></details><p>色彩校正后，也可以根据需求对校正后的颜色进一步调节,例如色彩增强或风格化</p><h3 id=伽马矫正gamma-correction>伽马矫正（Gamma Correction）</h3><p>人类对亮度的感知并非线性，而是接近幂函数$L\propto I^{0.43}$。这意味着我们对暗部细节更加敏感，对亮部变化的感知能力较弱。为了高效利用有限的位深（bit数），优化编码效率，图像编码会按照人类的视觉特性进行非线性变换，将更多的编码精度分配到暗部（人类更敏感的部分），减少亮部（人类较不敏感部分）的精度。这种非线性编码通常被称为gamma编码。基于这种编码特性，显示设备（如显示器）为了使图像在视觉上看起来正确，会执行“反Gamma”操作$I_{output}=I_{input}^{\frac1\gamma}，\gamma$常取2.2，即将编码图像的非线性亮度还原为线性亮度。</p><p>为什么需要Gamma编码：<br>如果直接对图像进行线性编码并存储或传输，暗部细节会被过度压缩，造成重要的视觉信息丢失。同时，显示设备的反Gamma校正会进一步放大这种现象，使得图像暗部显示更差。因此，为了保证在显示设备上保持预期的亮度和对比度，拍摄的图像需要在编码阶段进行Gamma编码。</p><p><img src=/articles/camera-isp/image-13.png width=1953 height=688 srcset="/articles/camera-isp/image-13_hu_d79d5363d6dc289b.png 480w, /articles/camera-isp/image-13_hu_63402a34e289d2ba.png 1024w" loading=lazy alt="图24 图像编码前为什么要进行gamma校正" class=gallery-image data-flex-grow=283 data-flex-basis=681px></p><details class=popup-details><summary>示例代码</summary><div class=popup-content><button class=close-btn>✖</button><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;cmath&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1>// 伽马矫正函数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>float</span> <span class=nf>gammaCorrection</span><span class=p>(</span><span class=kt>float</span> <span class=n>value</span><span class=p>,</span> <span class=kt>float</span> <span class=n>gamma</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>std</span><span class=o>::</span><span class=n>pow</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=n>gamma</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 对整幅图像进行伽马矫正
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=nf>processImageGammaCorrection</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>array</span><span class=o>&lt;</span><span class=kt>float</span><span class=p>,</span> <span class=mi>3</span><span class=o>&gt;&gt;&amp;</span> <span class=n>image</span><span class=p>,</span> <span class=kt>float</span> <span class=n>gamma</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=k>auto</span><span class=o>&amp;</span> <span class=nl>pixel</span> <span class=p>:</span> <span class=n>image</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>3</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>pixel</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>gammaCorrection</span><span class=p>(</span><span class=n>pixel</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>gamma</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></details><h2 id=其他图像处理算法>其他图像处理算法</h2><h3 id=直方图均衡化histogram-equalization>直方图均衡化（Histogram Equalization）</h3><p>直方图均衡化是一种图像处理技术，通过调整图像的灰度级分布，使得图像的对比度得到改善，但如果对高对比度图像使用时可能导致细节丢失或噪声增强。直方图均衡化更适用于曝光不足、对比度低的图像，如医学影像、卫星图像或计算机视觉中的图像预处理。</p><p><img src=/articles/camera-isp/image-18.png width=311 height=162 srcset="/articles/camera-isp/image-18_hu_b33a4b92a37a4667.png 480w, /articles/camera-isp/image-18_hu_19d2daf123450fc5.png 1024w" loading=lazy alt="图25 直方图均衡化" class=gallery-image data-flex-grow=191 data-flex-basis=460px><details class=popup-details><summary>示例代码</summary><div class=popup-content><button class=close-btn>✖</button><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;vector&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;algorithm&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;numeric&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1>// 计算累积分布函数（CDF）
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>float</span><span class=o>&gt;</span> <span class=n>calculateCDF</span><span class=p>(</span><span class=k>const</span> <span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;&amp;</span> <span class=n>histogram</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>float</span><span class=o>&gt;</span> <span class=n>cdf</span><span class=p>(</span><span class=n>histogram</span><span class=p>.</span><span class=n>size</span><span class=p>(),</span> <span class=mf>0.0f</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>partial_sum</span><span class=p>(</span><span class=n>histogram</span><span class=p>.</span><span class=n>begin</span><span class=p>(),</span> <span class=n>histogram</span><span class=p>.</span><span class=n>end</span><span class=p>(),</span> <span class=n>cdf</span><span class=p>.</span><span class=n>begin</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>maxValue</span> <span class=o>=</span> <span class=n>cdf</span><span class=p>.</span><span class=n>back</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>float</span><span class=o>&amp;</span> <span class=nl>val</span> <span class=p>:</span> <span class=n>cdf</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>val</span> <span class=o>/=</span> <span class=n>maxValue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>cdf</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 应用直方图均衡化
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=nf>histogramEqualization</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;&gt;&amp;</span> <span class=n>image</span><span class=p>,</span> <span class=kt>int</span> <span class=n>maxValue</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span> <span class=n>histogram</span><span class=p>(</span><span class=n>maxValue</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 统计直方图
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=p>(</span><span class=k>const</span> <span class=k>auto</span><span class=o>&amp;</span> <span class=nl>row</span> <span class=p>:</span> <span class=n>image</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=nl>value</span> <span class=p>:</span> <span class=n>row</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=o>++</span><span class=n>histogram</span><span class=p>[</span><span class=n>value</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 计算CDF
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>float</span><span class=o>&gt;</span> <span class=n>cdf</span> <span class=o>=</span> <span class=n>calculateCDF</span><span class=p>(</span><span class=n>histogram</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 应用均衡化
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=p>(</span><span class=k>auto</span><span class=o>&amp;</span> <span class=nl>row</span> <span class=p>:</span> <span class=n>image</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span><span class=o>&amp;</span> <span class=nl>value</span> <span class=p>:</span> <span class=n>row</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>value</span> <span class=o>=</span> <span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=p>(</span><span class=n>cdf</span><span class=p>[</span><span class=n>value</span><span class=p>]</span> <span class=o>*</span> <span class=n>maxValue</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></details></p><h3 id=颜色空间转换color-space-conversion>颜色空间转换（Color Space Conversion）</h3><p>■ RGB(Red, Green, Blue)是一种基于加色模型的颜色空间，表示红色、绿色和蓝色三个颜色通道的强度。RGB模型广泛用于显示设备（如计算机显示器、电视等），它通过不同强度的红、绿、蓝光的组合来生成各种颜色。颜色的混合方式是加法的，即所有通道的光强度加起来会使颜色变得更亮。</p><p>■ CMYK(Cyan, Magenta, Yellow, Black)表示印刷上用的四种颜色，是RGB的补色。由于在实际应用中，青色、洋红色和黄色很难叠加形成真正的黑色，因此引入了K——黑色。黑色的作用是强化暗调，加深暗部色彩。</p><p><img src=/articles/camera-isp/image-16.png width=558 height=333 srcset="/articles/camera-isp/image-16_hu_3aa56ef5a59f5d0.png 480w, /articles/camera-isp/image-16_hu_7b7afa7f710babd8.png 1024w" loading=lazy alt="图26 RGB与CMYK" class=gallery-image data-flex-grow=167 data-flex-basis=402px></p><p>■ YUV(Y, U, V)是一种基于亮度和色度分量的颜色空间，通常用于视频压缩和广播中。在YUV模型中，Y表示亮度分量（即灰度信息），U和V表示色度分量（即颜色信息，U表示蓝色投影，V表示红色投影）。YUV的好处在于，它能够将亮度和色度分开处理，这对于图像和视频压缩很有帮助，因为人眼对亮度的敏感度远高于色度，因此可以对色度分量进行较高的压缩而不显著影响视觉质量。</p><details class=popup-details><summary>RGB-YUV 转换公式</summary><div class=popup-content><button class=close-btn>✖</button>
$$\begin{aligned}
&Y=W_RR^{\prime}+W_GG^{\prime}+W_BB^{\prime}=0.299R^{\prime}+0.587G^{\prime}+0.114B^{\prime} \\
&U=U_{\mathrm{max}}\frac{B^{\prime}-Y^{\prime}}{1-W_{B}}\approx0.492(B^{\prime}-Y^{\prime}) \\
&V=V_{\mathrm{max}}\frac{R^{\prime}-Y^{\prime}}{1-W_{R}}\approx0.877(R^{\prime}-Y^{\prime}) \\
&\Rightarrow \begin{bmatrix}Y\\U\\V\end{bmatrix}=\begin{bmatrix}0.299&0.587&0.114\\-0.14713&-0.28886&0.436\\0.615&-0.51499&-0.10001\end{bmatrix}\begin{bmatrix}R'\\G'\\B'\end{bmatrix} \\
&R^{\prime}=Y^{\prime}+V\frac{1-W_{R}}{V_{\mathrm{max}}}=Y^{\prime}+\frac{V}{0.877}=Y^{\prime}+1.14V \\
&B^{\prime}=Y^{\prime}+U\frac{1-W_{B}}{U_{\max}}=Y^{\prime}+\frac{U}{0.492}=Y^{\prime}+2.033U \\
&G^{\prime}=\frac{Y'-W_RR'-W_BB'}{W_G} \\
&\Rightarrow \begin{bmatrix}R'\\G'\\B'\end{bmatrix}=\begin{bmatrix}1&0&1.13983\\1&-0.39465&-0.58060\\1&2.03211&0\end{bmatrix}\begin{bmatrix}Y\\U\\V\end{bmatrix}
\end{aligned}$$</div></details><p>■ HSV(Hue, Saturation, Value)是根据颜色的直观特性由A. R. Smith在1978年创建的一种颜色空间, 也称六角锥体模型(Hexcone Model)。这个模型中颜色的参数分别是：色调（H），饱和度（S），明度（V）。</p><p>■ HSL(Hue, Saturation, Lightness)是HSV模型的变体，也是由色调、饱和度和亮度三个参数来描述颜色的。与HSV不同，HSL中的亮度（Lightness）指的是从黑色到白色的亮度程度，位于0到100之间，而HSV中的明度（Value）则是从黑色到最亮的颜色的亮度程度。HSL模型常用于计算机图形和图像处理领域，因为它与人眼对颜色的感知更为接近。</p><p>RGB到HSV和HSL的转换比较复杂，参考wiki百科<a class=link href=https://en.wikipedia.org/wiki/HSL_and_HSV target=_blank rel=noopener>HSL_and_HSV</a></p><p><img src=/articles/camera-isp/image-17.png width=2147 height=489 srcset="/articles/camera-isp/image-17_hu_c8fbd39b109031de.png 480w, /articles/camera-isp/image-17_hu_9d99160c08e5941e.png 1024w" loading=lazy alt="图27 色彩空间模型" class=gallery-image data-flex-grow=439 data-flex-basis=1053px></p><p><img src=/articles/camera-isp/image-15.png width=452 height=768 srcset="/articles/camera-isp/image-15_hu_efd744f546c2142d.png 480w, /articles/camera-isp/image-15_hu_5aaa7138faf304b3.png 1024w" loading=lazy alt="图28 色彩空间模型的几何关系" class=gallery-image data-flex-grow=58 data-flex-basis=141px></p><details class=popup-details><summary>示例代码</summary><div class=popup-content><button class=close-btn>✖</button><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>// RGB 转 YUV
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>std</span><span class=o>::</span><span class=n>array</span><span class=o>&lt;</span><span class=kt>float</span><span class=p>,</span> <span class=mi>3</span><span class=o>&gt;</span> <span class=n>rgbToYuv</span><span class=p>(</span><span class=k>const</span> <span class=n>std</span><span class=o>::</span><span class=n>array</span><span class=o>&lt;</span><span class=kt>float</span><span class=p>,</span> <span class=mi>3</span><span class=o>&gt;&amp;</span> <span class=n>rgb</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>y</span> <span class=o>=</span> <span class=mf>0.299f</span> <span class=o>*</span> <span class=n>rgb</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>+</span> <span class=mf>0.587f</span> <span class=o>*</span> <span class=n>rgb</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>+</span> <span class=mf>0.114f</span> <span class=o>*</span> <span class=n>rgb</span><span class=p>[</span><span class=mi>2</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>u</span> <span class=o>=</span> <span class=mf>0.492f</span> <span class=o>*</span> <span class=p>(</span><span class=n>rgb</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>-</span> <span class=n>y</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>v</span> <span class=o>=</span> <span class=mf>0.877f</span> <span class=o>*</span> <span class=p>(</span><span class=n>rgb</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>-</span> <span class=n>y</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=n>y</span><span class=p>,</span> <span class=n>u</span><span class=p>,</span> <span class=n>v</span><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// YUV 转 RGB
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>std</span><span class=o>::</span><span class=n>array</span><span class=o>&lt;</span><span class=kt>float</span><span class=p>,</span> <span class=mi>3</span><span class=o>&gt;</span> <span class=n>yuvToRgb</span><span class=p>(</span><span class=k>const</span> <span class=n>std</span><span class=o>::</span><span class=n>array</span><span class=o>&lt;</span><span class=kt>float</span><span class=p>,</span> <span class=mi>3</span><span class=o>&gt;&amp;</span> <span class=n>yuv</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>r</span> <span class=o>=</span> <span class=n>yuv</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>+</span> <span class=mf>1.14f</span> <span class=o>*</span> <span class=n>yuv</span><span class=p>[</span><span class=mi>2</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>g</span> <span class=o>=</span> <span class=n>yuv</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>-</span> <span class=mf>0.394f</span> <span class=o>*</span> <span class=n>yuv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=mf>0.581f</span> <span class=o>*</span> <span class=n>yuv</span><span class=p>[</span><span class=mi>2</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>b</span> <span class=o>=</span> <span class=n>yuv</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>+</span> <span class=mf>2.032f</span> <span class=o>*</span> <span class=n>yuv</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=n>r</span><span class=p>,</span> <span class=n>g</span><span class=p>,</span> <span class=n>b</span><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></details><blockquote><p><strong>Refference：</strong></p><p><a class=link href=https://www.qinxing.xyz/posts/506138d8/ target=_blank rel=noopener>https://www.qinxing.xyz/posts/506138d8/</a></p><p><a class=link href=https://github.com/yuqing-liu-dut/ISPLab target=_blank rel=noopener>https://github.com/yuqing-liu-dut/ISPLab</a></p><p><a class=link href=https://www.bilibili.com/video/BV1LA4m1N78h target=_blank rel=noopener>https://www.bilibili.com/video/BV1LA4m1N78h</a></p><p><a class=link href=https://www.wpgdadatong.com.cn/blog/detail/42592 target=_blank rel=noopener>https://www.wpgdadatong.com.cn/blog/detail/42592</a></p><p><a class=link href=https://www.cnblogs.com/lanlancky/p/17498055.html#_label2_0 target=_blank rel=noopener>https://www.cnblogs.com/lanlancky/p/17498055.html#_label2_0</a></p><p><a class=link href=https://www.cnblogs.com/wnwin/p/11985194.html target=_blank rel=noopener>https://www.cnblogs.com/wnwin/p/11985194.html</a></p><p><a class=link href=https://www.cnblogs.com/sunny-li/p/8641767.html target=_blank rel=noopener>https://www.cnblogs.com/sunny-li/p/8641767.html</a></p><p><a class=link href=https://blog.csdn.net/hhy321/article/details/120896015 target=_blank rel=noopener>https://blog.csdn.net/hhy321/article/details/120896015</a></p></blockquote></section><footer class=article-footer><section class=article-tags><a href=/tags/isp/>ISP</a>
<a href=/tags/%E4%BC%A0%E6%84%9F%E5%99%A8/>传感器</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css integrity=sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js integrity=sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8 crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{const e=document.querySelector(".main-article");renderMathInElement(e,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],ignoredClasses:["gist"]})})</script></article><footer class=site-footer><section class=copyright>&copy;
2024 -
2025 RoboticsChen's Blog</section><section class=powerby>一个机器人工程师的成长笔记<br>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script type=text/javascript src=/ts/custom.ab98a087394b20c3627bde9d8672bce1b06ea80e7eb4746e409fccaa1c39dd7b.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>