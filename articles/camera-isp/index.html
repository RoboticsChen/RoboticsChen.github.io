<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="ä»‹ç»äº†ç›¸æœºçš„æˆåƒåŸç†ä»¥åŠç®€å•çš„ISPæµç¨‹å’Œç®—æ³•"><title>ç›¸æœºæˆåƒä¸ISP</title>
<link rel=canonical href=https://RoboticsChen.github.io/articles/camera-isp/><link rel=stylesheet href=/scss/style.min.91ab85d910aadfc4aedff71064d967b220a64d57791d2f588dc44b40735bb8c4.css><meta property='og:title' content="ç›¸æœºæˆåƒä¸ISP"><meta property='og:description' content="ä»‹ç»äº†ç›¸æœºçš„æˆåƒåŸç†ä»¥åŠç®€å•çš„ISPæµç¨‹å’Œç®—æ³•"><meta property='og:url' content='https://RoboticsChen.github.io/articles/camera-isp/'><meta property='og:site_name' content="RoboticsChen's Blog"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='ISP'><meta property='article:tag' content='ä¼ æ„Ÿå™¨'><meta property='article:published_time' content='2024-11-11T10:35:55+00:00'><meta property='article:modified_time' content='2024-11-11T10:35:55+00:00'><meta property='og:image' content='https://RoboticsChen.github.io/articles/camera-isp/raw_image.png'><meta name=twitter:title content="ç›¸æœºæˆåƒä¸ISP"><meta name=twitter:description content="ä»‹ç»äº†ç›¸æœºçš„æˆåƒåŸç†ä»¥åŠç®€å•çš„ISPæµç¨‹å’Œç®—æ³•"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://RoboticsChen.github.io/articles/camera-isp/raw_image.png'><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=åˆ‡æ¢èœå•>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_344c707452b06f8f.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>ğŸ¦¾</span></figure><div class=site-meta><h1 class=site-name><a href=/>RoboticsChen's Blog</a></h1><h2 class=site-description>ä¸€ä¸ªæœºå™¨äººå·¥ç¨‹å¸ˆçš„æˆé•¿ç¬”è®°</h2></div></header><ol class=menu-social><li><a href=https://github.com target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com target=_blank title=Twitter rel=me><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li><li><a href=https://www.emojisearch.app/ target=_blank title=serach-emojis rel=me><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg></a></li><li><a href=https://cn.piliapp.com/symbol/ target=_blank title=serach-symbals rel=me><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>æš—è‰²æ¨¡å¼</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">ç›®å½•</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#ç›¸æœºæˆåƒ>ç›¸æœºæˆåƒ</a><ol><li><a href=#ccd-vs-cmos>CCD vs CMOS</a></li><li><a href=#bayeré˜µåˆ—ä¸rawå›¾åƒ>Bayeré˜µåˆ—ä¸RAWå›¾åƒ</a></li></ol></li><li><a href=#image-signal-processisp>Image Signal Processï¼ˆISPï¼‰</a><ol><li><a href=#åç‚¹æ ¡æ­£dead-pixel-correction-dpc>åç‚¹æ ¡æ­£ï¼ˆDead Pixel Correction, DPCï¼‰</a></li><li><a href=#æš—ç”µæµæ ¡æ­£black-level-correctionblc>æš—ç”µæµæ ¡æ­£ï¼ˆBlack level Correctionï¼ŒBLCï¼‰</a></li><li><a href=#é•œå¤´é˜´å½±æ ¡æ­£lens-shading-correctionlsc>é•œå¤´é˜´å½±æ ¡æ­£ï¼ˆLens Shading Correctionï¼ŒLSCï¼‰</a><ol><li><a href=#äº®åº¦lumaé˜´å½±>äº®åº¦ï¼ˆLumaï¼‰é˜´å½±</a></li><li><a href=#è‰²å½©chromaé˜´å½±>è‰²å½©ï¼ˆChromaï¼‰é˜´å½±</a></li><li><a href=#æ ¡æ­£ç®—æ³•>æ ¡æ­£ç®—æ³•</a></li></ol></li><li><a href=#æŠ—é”¯é½¿æ»¤æ³¢anti-aliasing-filteringaaf>æŠ—é”¯é½¿æ»¤æ³¢ï¼ˆAnti-aliasing Filteringï¼ŒAAFï¼‰</a></li><li><a href=#è‡ªåŠ¨ç™½å¹³è¡¡auto-white-balanceawb>è‡ªåŠ¨ç™½å¹³è¡¡ï¼ˆAuto White Balanceï¼ŒAWBï¼‰</a></li><li><a href=#å»é©¬èµ›å…‹demosaicing>å»é©¬èµ›å…‹ï¼ˆDemosaicingï¼‰</a></li><li><a href=#è‰²å½©æ ¡æ­£color-correction>è‰²å½©æ ¡æ­£ï¼ˆColor Correctionï¼‰</a></li><li><a href=#ä¼½é©¬çŸ«æ­£gamma-correction>ä¼½é©¬çŸ«æ­£ï¼ˆGamma Correctionï¼‰</a></li></ol></li><li><a href=#å…¶ä»–å›¾åƒå¤„ç†ç®—æ³•>å…¶ä»–å›¾åƒå¤„ç†ç®—æ³•</a><ol><li><a href=#ç›´æ–¹å›¾å‡è¡¡åŒ–histogram-equalization>ç›´æ–¹å›¾å‡è¡¡åŒ–ï¼ˆHistogram Equalizationï¼‰</a></li><li><a href=#é¢œè‰²ç©ºé—´è½¬æ¢color-space-conversion>é¢œè‰²ç©ºé—´è½¬æ¢ï¼ˆColor Space Conversionï¼‰</a></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/articles/camera-isp/><img src=/articles/camera-isp/raw_image_hu_ae5784b1d6a4eb6e.png srcset="/articles/camera-isp/raw_image_hu_ae5784b1d6a4eb6e.png 800w, /articles/camera-isp/raw_image_hu_cace48e75a15f6d2.png 1600w" width=800 height=320 loading=lazy alt="Featured image of post ç›¸æœºæˆåƒä¸ISP"></a></div><div class=article-details><header class=article-category><a href=/categories/%E8%A7%86%E8%A7%89%E4%BC%A0%E6%84%9F%E5%99%A8/>è§†è§‰ä¼ æ„Ÿå™¨</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/articles/camera-isp/>ç›¸æœºæˆåƒä¸ISP</a></h2><h3 class=article-subtitle>ä»‹ç»äº†ç›¸æœºçš„æˆåƒåŸç†ä»¥åŠç®€å•çš„ISPæµç¨‹å’Œç®—æ³•</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Nov 11, 2024</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>é˜…è¯»æ—¶é•¿: 22 åˆ†é’Ÿ</time></div></footer></div></header><section class=article-content><h1 id=ç›¸æœºæˆåƒä¸isp>ç›¸æœºæˆåƒä¸ISP</h1><h2 id=ç›¸æœºæˆåƒ>ç›¸æœºæˆåƒ</h2><h3 id=ccd-vs-cmos>CCD vs CMOS</h3><ul><li>CCDï¼šå…¨ç§°Charge Coupled Deviceï¼Œå³ç”µè·è€¦åˆå™¨ä»¶</li><li>CMOSï¼šå…¨ç§°Complementary Metal Oxide Semiconductorï¼Œå³äº’è¡¥é‡‘å±æ°§åŒ–ç‰©åŠå¯¼ä½“</li></ul><p>è¿™ä¸¤ç§ä¼ æ„Ÿå™¨éƒ½ç”±å¤šä¸ªå…‰ç”µäºŒæç®¡ç»„æˆçš„é˜µåˆ—ï¼Œæ¯ä¸ªå…‰ç”µäºŒæç®¡çš„ä½œç”¨æ˜¯å°†æ¥æ”¶åˆ°çš„å…‰ä¿¡å·è½¬åŒ–ä¸ºç”µè·ã€‚ä¸¤è€…çš„åŸºæœ¬å·¥ä½œåŸç†ç›¸ä¼¼ï¼Œä¼ æ„Ÿå™¨æ¥æ”¶å…‰ä¿¡å·å¹¶é€šè¿‡ä¸€å®šæ—¶é—´çš„ç”µè·ç§¯ç´¯å®ç°æ›å…‰ï¼Œè¿›è€Œè·å¾—æ¯ä¸ªåƒç´ çš„å…‰å¼ºåº¦æ•°æ®ã€‚æœ€åï¼Œè¿™äº›ç”µè·ç»æ¨¡æ•°è½¬æ¢è¢«è½¬æ¢ä¸ºç”µå‹å¹¶ç»è¿‡æ”¾å¤§å¤„ç†ï¼Œæœ€ç»ˆç”ŸæˆåŸå§‹çš„RAWå›¾åƒæ•°æ®ã€‚</p><p>åœ¨å…·ä½“çš„å®ç°æ–¹å¼ä¸Šï¼Œä¸¤è€…æœ‰ä¸€å®šçš„åŒºåˆ«ï¼š</p><ul><li>CCDï¼šæ¯ä¸ªåƒç´ ç‚¹çš„ç”µè·ä¼šè¢«ä¼ è¾“åˆ°ä¸€ä¸ªå•ç‹¬çš„è¾“å‡ºèŠ‚ç‚¹ï¼Œé€šè¿‡è¿™ä¸€èŠ‚ç‚¹å°†ç”µè·è½¬åŒ–ä¸ºç”µå‹ä¿¡å·ï¼Œå³ä¸€è¡Œè¡Œè¯»å‡ºã€‚è¿™ç§æ–¹å¼æœ‰åŠ©äºå®ç°è¾ƒä½çš„å™ªå£°å’Œè¾ƒé«˜çš„å›¾åƒè´¨é‡ï¼Œä½†ç”±äºä¼ è¾“è¿‡ç¨‹ä¸­éœ€è¦å¤§é‡çš„ç”µå­å…ƒä»¶å’Œå¤æ‚çš„ç”µè·¯è®¾è®¡ï¼ŒCCDä¼ æ„Ÿå™¨çš„åŠŸè€—è¾ƒé«˜ï¼Œä¸”è¯»å‡ºé€Ÿåº¦è¾ƒæ…¢ã€‚</li><li>CMOSï¼šæ¯ä¸ªåƒç´ ç‚¹éƒ½å…·æœ‰ä¸€ä¸ªç‹¬ç«‹çš„æ”¾å¤§å™¨ï¼Œèƒ½å¤Ÿåœ¨ä¼ æ„Ÿå™¨å†…ç›´æ¥å°†ç”µè·è½¬åŒ–ä¸ºç”µå‹ä¿¡å·å¹¶è¿›è¡Œæ”¾å¤§å¤„ç†ã€‚è¿™ç§æ–¹å¼ä½¿å¾—æ¯ä¸ªåƒç´ çš„ç”µè·è½¬æ¢è¿‡ç¨‹ç›¸å¯¹ç‹¬ç«‹ï¼Œèƒ½æ›´å¿«é€Ÿåœ°è¯»å–å›¾åƒæ•°æ®ï¼Œé™ä½åŠŸè€—ï¼Œä½†åœ¨ä½å…‰ç…§ç¯å¢ƒä¸‹å¯èƒ½ä¼šäº§ç”Ÿè¾ƒå¤šå™ªå£°ã€‚</li></ul><p><img src=/articles/camera-isp/CCD_vs_CMOS.gif width=477 height=212 srcset="/articles/camera-isp/CCD_vs_CMOS_hu_7219fee36517f58e.gif 480w, /articles/camera-isp/CCD_vs_CMOS_hu_b66332599cf6688f.gif 1024w" loading=lazy alt="å›¾1 CDDvsCMOSå·¥ä½œåŸç†" class=gallery-image data-flex-grow=225 data-flex-basis=540px></p><p>æ€»çš„æ¥çœ‹ï¼ŒCMOSä¼ æ„Ÿå™¨ç›¸æ¯”äºCCDä¼ æ„Ÿå™¨ï¼Œå·¥è‰ºç®€å•ã€æˆæœ¬æ›´ä½ï¼Œéšç€CMOSæŠ€æœ¯çš„ä¸æ–­è¿›æ­¥ï¼Œå°¤å…¶æ˜¯åœ¨é™ä½å™ªå£°ã€æé«˜ä½å…‰ç…§æ€§èƒ½å’Œå¢å¼ºå›¾åƒè´¨é‡æ–¹é¢çš„æå‡ï¼ŒCMOSä¼ æ„Ÿå™¨å·²ç»é€æ¸å–ä»£äº†ä¼ ç»Ÿçš„CCDä¼ æ„Ÿå™¨ï¼Œæˆä¸ºä¸»æµé€‰æ‹©ã€‚å½“ä»ŠCCDä¼ æ„Ÿå™¨çš„åº”ç”¨ä¸»è¦å±€é™äºä¸€äº›å¯¹å›¾åƒè´¨é‡è¦æ±‚æé«˜çš„ä¸“ä¸šé¢†åŸŸã€‚</p><h3 id=bayeré˜µåˆ—ä¸rawå›¾åƒ>Bayeré˜µåˆ—ä¸RAWå›¾åƒ</h3><p>1.1èŠ‚ä¸­æåˆ°ï¼Œsensoré€šè¿‡å°†å…‰å¼ºä¿¡å·è½¬åŒ–ä¸ºç”µå‹ä¿¡å·ï¼Œä»è€Œå¾—åˆ°äº†RAWå›¾åƒï¼Œå› æ­¤ï¼Œå¦‚æœä¸åŠ ä»»ä½•å¤„ç†ï¼Œå¾—åˆ°çš„rawå›¾å°†æ˜¯åªæœ‰äº®åº¦çš„é»‘ç™½å›¾åƒã€‚</p><p>ä¸ºäº†åˆæˆå½©è‰²å›¾åƒï¼Œåˆ™éœ€è¦å¾—åˆ°æ¯ä¸€ä¸ªåƒç´ ç‚¹å¤„çš„RGBä¸‰é€šé“çš„äº®åº¦å€¼ã€‚è¦è·å¾—æŸä¸ªé€šé“çš„äº®åº¦å€¼ï¼Œå¯ä»¥åœ¨å…‰ç”µäºŒæç®¡å‰åŠ ä¸Šåªå…è®¸çº¢/ç»¿/è“è‰²å…‰é€šè¿‡çš„æ»¤å…‰ç‰‡ã€‚äºæ˜¯æˆ‘ä»¬å¯ä»¥é‡‡ç”¨è¿™æ ·ä¸€ç§æ’åˆ—æ–¹å¼ï¼Œå››ä¸ªæ»¤å…‰ç‰‡ä¾æ¬¡æŒ‰Rã€Gã€Gã€Bæ’åˆ—ã€‚ä¸ºä»€ä¹ˆæ˜¯ä¸¤ä¸ªç»¿è‰²å‘¢ï¼Œå› ä¸ºäººçœ¼å¯¹ç»¿è‰²æ›´ä¸ºæ•æ„Ÿï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨ä¸¤ä¸ªç»¿è‰²æ¥å¢å¼ºç»¿è‰²çš„è§£æåŠ›ã€‚è¿™ç§æ’åˆ—æ–¹å¼åˆç§°Bayeré˜µåˆ—ï¼ˆBayer Patternï¼‰ï¼Œäº1974ç”±æŸ¯è¾¾çš„å·¥ç¨‹å¸ˆBayeræå‡ºã€‚</p><p><img src=/articles/camera-isp/bayer_pattern.jpg width=477 height=401 srcset="/articles/camera-isp/bayer_pattern_hu_70fb1c15a1cdd384.jpg 480w, /articles/camera-isp/bayer_pattern_hu_ab411708a6a4bbcd.jpg 1024w" loading=lazy alt="å›¾2 Bayeré˜µåˆ—(å±€éƒ¨)" class=gallery-image data-flex-grow=118 data-flex-basis=285px> <img src=/articles/camera-isp/bayer_image.png width=899 height=766 srcset="/articles/camera-isp/bayer_image_hu_f699a8f475338be6.png 480w, /articles/camera-isp/bayer_image_hu_7cc7b7f88b29dedc.png 1024w" loading=lazy alt="å›¾3 Bayeré˜µåˆ—(æ•´ä½“)" class=gallery-image data-flex-grow=117 data-flex-basis=281px></p><p>é™¤äº†æœ€å¸¸ç”¨çš„Bayeré˜µåˆ—ï¼Œä¸€äº›å‚å•†ä¹Ÿé‡‡ç”¨äº†å…¶ä»–çš„æ’åˆ—æ–¹å¼ï¼Œå¦‚ç´¢å°¼çš„REGB(çº¢é’ç»¿è“)ï¼Œåä¸ºçš„RYYB(çº¢é»„é»„è“)ï¼Œå¯Œå£«çš„ä¹±ä¸ƒå…«ç³Ÿæ’åˆ—ï¼ˆbushi</p><p><img src=/articles/camera-isp/sony_pattern.png width=1151 height=629 srcset="/articles/camera-isp/sony_pattern_hu_3bb02ad4485c1f72.png 480w, /articles/camera-isp/sony_pattern_hu_34ff9f7c8012b1d9.png 1024w" loading=lazy alt="å›¾4 ç´¢å°¼REGB" class=gallery-image data-flex-grow=182 data-flex-basis=439px> <img src=/articles/camera-isp/huawei_pattern.png width=721 height=659 srcset="/articles/camera-isp/huawei_pattern_hu_a6d58b1e763a578d.png 480w, /articles/camera-isp/huawei_pattern_hu_87de3680480748c2.png 1024w" loading=lazy alt="å›¾5 åä¸ºRYYB" class=gallery-image data-flex-grow=109 data-flex-basis=262px> <img src=/articles/camera-isp/fushi_pattern.png width=1212 height=754 srcset="/articles/camera-isp/fushi_pattern_hu_dc30a2e08079202d.png 480w, /articles/camera-isp/fushi_pattern_hu_49bce126439f69b5.png 1024w" loading=lazy alt="å›¾6 å¯Œå£«æ’åˆ—" class=gallery-image data-flex-grow=160 data-flex-basis=385px></p><p>å¦‚æœæ­¤æ—¶ï¼Œæˆ‘ä»¬å°†è¿™äº›bayeræ’åˆ—çš„ç”µä¿¡å·è½¬æ¢æˆæ•°å­—ä¿¡å·ï¼Œå¹¶ä¿å­˜ä¸‹æ¥ï¼Œå°±å¯ä»¥å¾—åˆ°RAWå›¾åƒã€‚</p><p><img src=/articles/camera-isp/raw_image.png width=3070 height=1227 srcset="/articles/camera-isp/raw_image_hu_16bc9f03463ec477.png 480w, /articles/camera-isp/raw_image_hu_743a520db2515086.png 1024w" loading=lazy alt="å›¾7 RAWå›¾åƒ" class=gallery-image data-flex-grow=250 data-flex-basis=600px></p><p>æ­¤æ—¶çš„å›¾åƒä¾æ—§æ˜¯é»‘ç™½çš„ï¼Œå¹¶ä¸”å¦‚æœæ”¾å¤§å±€éƒ¨ï¼Œä¼šå‘ç°å›¾åƒä¼šå‘ˆç°é©¬èµ›å…‹ä¸€æ ·çš„æ•ˆæœï¼Œä¸ºäº†å¾—åˆ°æœ€ç»ˆçš„å›¾åƒï¼Œéœ€è¦å®Œæˆä¸€ç³»åˆ—å›¾åƒä¿¡å·å¤„ç†ï¼Œå³Image Signal Processing(ISP)ã€‚</p><h2 id=image-signal-processisp>Image Signal Processï¼ˆISPï¼‰</h2><h3 id=åç‚¹æ ¡æ­£dead-pixel-correction-dpc>åç‚¹æ ¡æ­£ï¼ˆDead Pixel Correction, DPCï¼‰</h3><p>æ ¹æ®æ˜¯å¦ä¼šå‘ç”Ÿå˜åŒ–ï¼Œåç‚¹å¯ä»¥åˆ†ä¸ºé™æ€åç‚¹å’ŒåŠ¨æ€åç‚¹ã€‚</p><ul><li>é™æ€åç‚¹ï¼šä¸éšç€æ—¶é—´ã€å¢ç›Šç­‰æ”¹å˜ï¼Œé€šå¸¸æ˜¯sensoråˆ¶é€ æ—¶å› å·¥è‰ºåŸå› äº§ç”Ÿçš„åç‚¹ã€‚</li><li>åŠ¨æ€åç‚¹ï¼šå› ä¸ºå¢ç›Šã€æ¸©åº¦ç­‰å¼•èµ·çš„åç‚¹ï¼Œä¼šéšç€æ—¶é—´å˜åŒ–è€Œæ”¹å˜ã€‚</li></ul><p>åœ¨ ISP å¤„ç†é˜¶æ®µï¼Œéœ€è¦å¯¹å›¾åƒä¸­çš„åç‚¹è¿›è¡Œæ ¡æ­£ã€‚é™æ€åç‚¹é€šå¸¸åœ¨ä¼ æ„Ÿå™¨ç”Ÿäº§çº¿ä¸Šæ ‡å®šï¼Œå…¶ä½ç½®ä¼šè¢«è®°å½•åˆ° OTPï¼ˆOne Time Programmableï¼‰å­˜å‚¨å™¨ä¸­ï¼Œç”¨äºåç»­æ ¡æ­£ã€‚</p><p>åŠ¨æ€åç‚¹çš„æ ¡æ­£åˆ™å‘ç”Ÿåœ¨é™æ€åç‚¹æ ¡æ­£å®Œæˆä¹‹åã€‚æ ¡æ­£è¿‡ç¨‹ä¸­ï¼Œé€šè¿‡é€ä¸€æ£€æŸ¥æ¯ä¸ªåƒç´ ç‚¹ä¸å…¶å‘¨å›´ä¸€å®šèŒƒå›´å†…çš„åƒç´ å€¼ï¼Œå¦‚æœå‘ç°æŸä¸ªåƒç´ çš„å€¼ä¸å‘¨å›´åƒç´ çš„å€¼å·®å¼‚è¶…è¿‡è®¾å®šé˜ˆå€¼ï¼Œåˆ™åˆ¤å®šä¸ºåç‚¹ã€‚å¯¹äºè¿™äº›åç‚¹ï¼Œé€šå¸¸ä½¿ç”¨åŒé€šé“å†…å‘¨å›´åƒç´ çš„å¹³å‡å€¼æ¥æ›¿ä»£è¿›è¡Œæ ¡æ­£ï¼Œä»è€Œæ¢å¤å›¾åƒçš„å®Œæ•´æ€§å’Œè´¨é‡ã€‚</p><p><img src=/articles/camera-isp/image.png width=244 height=120 srcset="/articles/camera-isp/image_hu_bee2f62f7221ee4d.png 480w, /articles/camera-isp/image_hu_3bee4c8fd20ed109.png 1024w" loading=lazy alt="å›¾8 åç‚¹æ ¡æ­£" class=gallery-image data-flex-grow=203 data-flex-basis=488px></p><details class=popup-details><summary>ç¤ºä¾‹ä»£ç </summary><div class=popup-content><button class=close-btn>âœ–</button><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @brief Performs dead pixel correction (DPC) on RAW image data by identifying
</span></span></span><span class=line><span class=cl><span class=cm> * and correcting pixels that differ significantly from their neighbors.
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param raw       Reference to the input RAW image data.
</span></span></span><span class=line><span class=cl><span class=cm> * @param thres     Threshold value for detecting dead pixels. A pixel is
</span></span></span><span class=line><span class=cl><span class=cm> * considered dead if it deviates from its neighboring pixels by more than this
</span></span></span><span class=line><span class=cl><span class=cm> * threshold.
</span></span></span><span class=line><span class=cl><span class=cm> * @param mode      DPC correction mode. Options are:
</span></span></span><span class=line><span class=cl><span class=cm> *                  - DPC_MODE_MEAN: Replaces the dead pixel value with the
</span></span></span><span class=line><span class=cl><span class=cm> * average of its immediate neighbors.
</span></span></span><span class=line><span class=cl><span class=cm> *                  - DPC_MODE_GRADIENT: Replaces the dead pixel based on the
</span></span></span><span class=line><span class=cl><span class=cm> * smallest gradient among neighboring pixels.
</span></span></span><span class=line><span class=cl><span class=cm> *                  - DPC_MODE_UNKNOWN: Throws an error if the mode is
</span></span></span><span class=line><span class=cl><span class=cm> * unrecognized.
</span></span></span><span class=line><span class=cl><span class=cm> * @param clip      Maximum allowable pixel value after correction. Values
</span></span></span><span class=line><span class=cl><span class=cm> * exceeding this are clipped.
</span></span></span><span class=line><span class=cl><span class=cm>**/</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>DPC</span><span class=p>(</span><span class=n>ImageRaw</span><span class=o>&amp;</span> <span class=n>raw</span><span class=p>,</span> <span class=kt>uint16_t</span> <span class=n>thres</span><span class=p>,</span> <span class=n>DPC_MODE</span> <span class=n>mode</span><span class=p>,</span> <span class=kt>uint16_t</span> <span class=n>clip</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>ImageRaw</span><span class=o>*</span> <span class=n>raw_pad</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ImageRaw</span><span class=p>(</span><span class=n>raw</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>raw_pad</span><span class=o>-&gt;</span><span class=n>padding</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=n>PADDING_MODE_REFLECT</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>y</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>y</span> <span class=o>&lt;</span> <span class=n>raw_pad</span><span class=o>-&gt;</span><span class=n>getHeight</span><span class=p>()</span> <span class=o>-</span> <span class=mi>4</span><span class=p>;</span> <span class=n>y</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>x</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>x</span> <span class=o>&lt;</span> <span class=n>raw_pad</span><span class=o>-&gt;</span><span class=n>getWidth</span><span class=p>()</span> <span class=o>-</span> <span class=mi>4</span><span class=p>;</span> <span class=n>x</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=kt>uint16_t</span> <span class=n>p0</span><span class=p>,</span> <span class=n>p1</span><span class=p>,</span> <span class=n>p2</span><span class=p>,</span> <span class=n>p3</span><span class=p>,</span> <span class=n>p4</span><span class=p>,</span> <span class=n>p5</span><span class=p>,</span> <span class=n>p6</span><span class=p>,</span> <span class=n>p7</span><span class=p>,</span> <span class=n>p8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=kt>uint16_t</span> <span class=n>dv</span><span class=p>,</span> <span class=n>dh</span><span class=p>,</span> <span class=n>ddl</span><span class=p>,</span> <span class=n>ddr</span><span class=p>,</span> <span class=n>minimal</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=n>p0</span> <span class=o>=</span> <span class=n>raw_pad</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>2</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=n>p1</span> <span class=o>=</span> <span class=n>raw_pad</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=n>p2</span> <span class=o>=</span> <span class=n>raw_pad</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=n>p3</span> <span class=o>=</span> <span class=n>raw_pad</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=n>p4</span> <span class=o>=</span> <span class=n>raw_pad</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>2</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=n>p5</span> <span class=o>=</span> <span class=n>raw_pad</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>2</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=n>p6</span> <span class=o>=</span> <span class=n>raw_pad</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>4</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=n>p7</span> <span class=o>=</span> <span class=n>raw_pad</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>4</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=n>p8</span> <span class=o>=</span> <span class=n>raw_pad</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>4</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>((</span><span class=n>ABS</span><span class=p>(</span><span class=n>p1</span> <span class=o>-</span> <span class=n>p0</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>thres</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>ABS</span><span class=p>(</span><span class=n>p2</span> <span class=o>-</span> <span class=n>p0</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>thres</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>ABS</span><span class=p>(</span><span class=n>p3</span> <span class=o>-</span> <span class=n>p0</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>thres</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>ABS</span><span class=p>(</span><span class=n>p4</span> <span class=o>-</span> <span class=n>p0</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>thres</span><span class=p>)</span> <span class=o>&amp;&amp;</span> 
</span></span><span class=line><span class=cl>				<span class=p>(</span><span class=n>ABS</span><span class=p>(</span><span class=n>p5</span> <span class=o>-</span> <span class=n>p0</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>thres</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>ABS</span><span class=p>(</span><span class=n>p6</span> <span class=o>-</span> <span class=n>p0</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>thres</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>ABS</span><span class=p>(</span><span class=n>p7</span> <span class=o>-</span> <span class=n>p0</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>thres</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>ABS</span><span class=p>(</span><span class=n>p8</span> <span class=o>-</span> <span class=n>p0</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>thres</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>switch</span> <span class=p>(</span><span class=n>mode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>case</span> <span class=nl>DPC_MODE_MEAN</span><span class=p>:</span>
</span></span><span class=line><span class=cl>					<span class=n>p0</span> <span class=o>=</span> <span class=p>(</span><span class=n>p2</span> <span class=o>+</span> <span class=n>p4</span> <span class=o>+</span> <span class=n>p5</span> <span class=o>+</span> <span class=n>p7</span><span class=p>)</span> <span class=o>/</span> <span class=mi>4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>					<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=k>case</span> <span class=nl>DPC_MODE_GRADIENT</span><span class=p>:</span>
</span></span><span class=line><span class=cl>					<span class=n>dv</span>			<span class=o>=</span> <span class=n>ABS</span><span class=p>(</span><span class=mi>2</span> <span class=o>*</span> <span class=n>p0</span> <span class=o>-</span> <span class=n>p2</span> <span class=o>-</span> <span class=n>p7</span><span class=p>);</span>
</span></span><span class=line><span class=cl>					<span class=n>dh</span>			<span class=o>=</span> <span class=n>ABS</span><span class=p>(</span><span class=mi>2</span> <span class=o>*</span> <span class=n>p0</span> <span class=o>-</span> <span class=n>p4</span> <span class=o>-</span> <span class=n>p5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>					<span class=n>ddl</span>		<span class=o>=</span> <span class=n>ABS</span><span class=p>(</span><span class=mi>2</span> <span class=o>*</span> <span class=n>p0</span> <span class=o>-</span> <span class=n>p1</span> <span class=o>-</span> <span class=n>p8</span><span class=p>);</span>
</span></span><span class=line><span class=cl>					<span class=n>ddr</span>		<span class=o>=</span> <span class=n>ABS</span><span class=p>(</span><span class=mi>2</span> <span class=o>*</span> <span class=n>p0</span> <span class=o>-</span> <span class=n>p3</span> <span class=o>-</span> <span class=n>p6</span><span class=p>);</span>
</span></span><span class=line><span class=cl>					<span class=n>minimal</span>	<span class=o>=</span> <span class=n>MIN</span><span class=p>(</span><span class=n>MIN</span><span class=p>(</span><span class=n>MIN</span><span class=p>(</span><span class=n>dv</span><span class=p>,</span> <span class=n>dh</span><span class=p>),</span> <span class=n>ddl</span><span class=p>),</span> <span class=n>ddr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>					<span class=k>if</span> <span class=p>(</span><span class=n>minimal</span> <span class=o>==</span> <span class=n>dv</span><span class=p>)</span>			<span class=n>p0</span> <span class=o>=</span> <span class=p>(</span><span class=n>p2</span> <span class=o>+</span> <span class=n>p7</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>/</span> <span class=mi>2</span><span class=p>;</span>  <span class=c1>// Adding +1 here helps prevent rounding errors in integer division.
</span></span></span><span class=line><span class=cl><span class=c1></span>					<span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>minimal</span> <span class=o>==</span> <span class=n>dh</span><span class=p>)</span>		<span class=n>p0</span> <span class=o>=</span> <span class=p>(</span><span class=n>p4</span> <span class=o>+</span> <span class=n>p5</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>/</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>					<span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>minimal</span> <span class=o>==</span> <span class=n>ddl</span><span class=p>)</span>	<span class=n>p0</span> <span class=o>=</span> <span class=p>(</span><span class=n>p1</span> <span class=o>+</span> <span class=n>p8</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>/</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>					<span class=k>else</span>						<span class=n>p0</span> <span class=o>=</span> <span class=p>(</span><span class=n>p3</span> <span class=o>+</span> <span class=n>p6</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>/</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>					<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=k>case</span> <span class=nl>DPC_MODE_UNKNOWN</span><span class=p>:</span>
</span></span><span class=line><span class=cl>					<span class=n>TRACE_DEBUG_LOG_ERROR</span><span class=p>(</span><span class=s>&#34;Unknown DPC Mode:%s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>mode</span><span class=p>);</span>
</span></span><span class=line><span class=cl>					<span class=k>throw</span> <span class=s>&#34;Unknown DPC mode&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>					<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>					<span class=n>TRACE_DEBUG_LOG_ERROR</span><span class=p>(</span><span class=s>&#34;Unknown DPC Mode:%s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>mode</span><span class=p>);</span>
</span></span><span class=line><span class=cl>					<span class=k>throw</span> <span class=s>&#34;Unknown DPC mode&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>					<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span> <span class=o>=</span> <span class=n>p0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=n>raw</span><span class=p>.</span><span class=n>clip</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>clip</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>delete</span> <span class=n>raw_pad</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></details><h3 id=æš—ç”µæµæ ¡æ­£black-level-correctionblc>æš—ç”µæµæ ¡æ­£ï¼ˆBlack level Correctionï¼ŒBLCï¼‰</h3><p>æš—ç”µæµæ ¡æ­£åˆç§°â€œé»‘åº¦æ ¡æ­£â€ã€‚åœ¨ç›¸æœºå·¥ä½œè¿‡ç¨‹ä¸­ï¼Œå³ä½¿æ²¡æœ‰æ¥æ”¶åˆ°å…‰ä¿¡å·ï¼Œä¼ æ„Ÿå™¨ä¹Ÿä¼šç”±äºæŸäº›å› ç´ äº§ç”Ÿä¸€å®šçš„æš—ç”µæµï¼Œä»è€Œå¯¼è‡´è¾“å‡ºçš„ç”µå‹ä¿¡å·å­˜åœ¨åç§»ï¼Œå›¾åƒçš„â€œé»‘åº¦â€ä¸çœŸå®æƒ…å†µå­˜åœ¨å·®å¼‚ã€‚è¿™ä¸ªåç§»å€¼çš„æ¥æºæœ‰ä¸¤æ–¹é¢ï¼Œå…¶ä¸€æ˜¯æ¨¡æ•°è½¬æ¢åƒçš„å¢ç›Šï¼Œå…¶äºŒæ˜¯æ¸©åº¦ç­‰ç‰©ç†åŸå› å¯¼è‡´çš„ä¼ æ„Ÿå™¨åç§»ã€‚é»‘ç”µå¹³æ ¡æ­£æ¨¡å—å°±æ˜¯é€šè¿‡æ ‡å®šçš„æ–¹å¼ï¼Œç¡®å®šè¿™ä¸ªåç§»é‡çš„å…·ä½“å€¼ã€‚åç»­çš„ ISP å¤„ç†æ¨¡å—ï¼Œéœ€è¦å…ˆå‡æ‰è¯¥åç§»å€¼ï¼Œæ‰èƒ½ä¿è¯å›¾åƒçš„å‡†ç¡®æ€§ã€‚</p><ul><li><em>æ¨¡æ‹Ÿä¿¡å·å¾ˆå¾®å¼±æ—¶ï¼Œæœ‰å¯èƒ½ä¸è¢« A/D è½¬æ¢å‡ºæ¥ï¼Œå¯¼è‡´å…‰çº¿å¾ˆæš—æ—¶ï¼Œå›¾åƒç»†èŠ‚ä¸¢å¤±ã€‚å› æ­¤ï¼ŒSesnor ä¼šåœ¨ A/D è½¬æ¢å‰ï¼Œç»™æ¨¡æ‹Ÿä¿¡å·ä¸€ä¸ªå›ºå®šçš„åç§»é‡ï¼Œä¿è¯è¾“å‡ºçš„æ•°å­—ä¿¡å·ä¿ç•™æ›´å¤šçš„å›¾åƒç»†èŠ‚ã€‚</em></li></ul><p>é€šå¸¸çš„æ ¡æ­£æ–¹æ³•æ˜¯åœ¨ä¼ æ„Ÿå™¨å®Œå…¨é®å…‰çš„æƒ…å†µä¸‹æ•è·â€œæš—å¸§â€ã€‚ç„¶åè®°å½•æ¯ä¸ªåƒç´ çš„æ•°å­—è¾“å‡ºï¼Œè®¡ç®—è¯¥å›¾åƒçš„å¹³å‡å€¼ï¼ˆæœ‰æ—¶ä½¿ç”¨ä¸­å€¼ï¼‰ã€‚è¿™ä¸ªå¹³å‡å€¼æˆ–ä¸­å€¼è¡¨ç¤ºä¼ æ„Ÿå™¨çš„æ•´ä½“é»‘ç”µå¹³åç§»ã€‚æ¥ä¸‹æ¥ï¼Œå°†è¯¥å€¼ä»ä¼ æ„Ÿå™¨ç”Ÿæˆçš„å›¾åƒä¸­çš„æ¯ä¸ªåƒç´ å€¼ä¸­å‡å»ï¼Œä»¥æ ¡æ­£æš—ç”µæµå¼•èµ·çš„åç§»ï¼Œæ¢å¤å›¾åƒçš„çœŸå®äº®åº¦ã€‚</p><p><img src=/articles/camera-isp/image-1.png width=510 height=273 srcset="/articles/camera-isp/image-1_hu_9103516c5f35fb9.png 480w, /articles/camera-isp/image-1_hu_d65cbbe4dd9e3ae4.png 1024w" loading=lazy alt="å›¾9 æš—ç”µæµæ ¡æ­£" class=gallery-image data-flex-grow=186 data-flex-basis=448px></p><details class=popup-details><summary>ç¤ºä¾‹ä»£ç </summary><div class=popup-content><button class=close-btn>âœ–</button><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @brief Performs black level correction (BLC) on RAW image data based on the
</span></span></span><span class=line><span class=cl><span class=cm> * specified Bayer pattern.
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param raw          Reference to the input RAW image data.
</span></span></span><span class=line><span class=cl><span class=cm> * @param r            Black level correction value for the red channel.
</span></span></span><span class=line><span class=cl><span class=cm> * @param gr           Black level correction value for the green channel (red
</span></span></span><span class=line><span class=cl><span class=cm> * row).
</span></span></span><span class=line><span class=cl><span class=cm> * @param gb           Black level correction value for the green channel (blue
</span></span></span><span class=line><span class=cl><span class=cm> * row).
</span></span></span><span class=line><span class=cl><span class=cm> * @param b            Black level correction value for the blue channel.
</span></span></span><span class=line><span class=cl><span class=cm> * @param alpha        Alpha coefficient for adjusting the green channel (red
</span></span></span><span class=line><span class=cl><span class=cm> * row).
</span></span></span><span class=line><span class=cl><span class=cm> * @param beta         Beta coefficient for adjusting the green channel (blue
</span></span></span><span class=line><span class=cl><span class=cm> * row).
</span></span></span><span class=line><span class=cl><span class=cm> * @param bayer_pattern The Bayer pattern used in the RAW data (e.g., RGGB,
</span></span></span><span class=line><span class=cl><span class=cm> * BGGR, GBRG, GRBG).
</span></span></span><span class=line><span class=cl><span class=cm> * @param clip         Maximum allowable pixel value after correction. Values
</span></span></span><span class=line><span class=cl><span class=cm> * exceeding this are clipped.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>BLC</span><span class=p>(</span><span class=n>ImageRaw</span><span class=o>&amp;</span> <span class=n>raw</span><span class=p>,</span> <span class=kt>uint16_t</span> <span class=n>r</span><span class=p>,</span> <span class=kt>uint16_t</span> <span class=n>gr</span><span class=p>,</span> <span class=kt>uint16_t</span> <span class=n>gb</span><span class=p>,</span> <span class=kt>uint16_t</span> <span class=n>b</span><span class=p>,</span> <span class=kt>float</span> <span class=n>alpha</span><span class=p>,</span> <span class=kt>float</span> <span class=n>beta</span><span class=p>,</span> <span class=n>BAYER_PATTERN</span> <span class=n>bayer_pattern</span><span class=p>,</span> <span class=kt>uint16_t</span> <span class=n>clip</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>switch</span> <span class=p>(</span><span class=n>bayer_pattern</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=nl>BAYER_PATTERN_RGGB</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>y</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>y</span> <span class=o>&lt;</span> <span class=n>raw</span><span class=p>.</span><span class=n>getHeight</span><span class=p>();</span> <span class=n>y</span><span class=o>+=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>x</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>x</span> <span class=o>&lt;</span> <span class=n>raw</span><span class=p>.</span><span class=n>getWidth</span><span class=p>();</span> <span class=n>x</span><span class=o>+=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span>			<span class=o>+=</span> <span class=n>r</span><span class=p>;</span>									<span class=c1>// r
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>	<span class=o>+=</span> <span class=n>b</span><span class=p>;</span>									<span class=c1>// b
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>		<span class=o>+=</span> <span class=n>gr</span> <span class=o>+</span> <span class=n>alpha</span> <span class=o>*</span> <span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span>			<span class=c1>// gr
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span>		<span class=o>+=</span> <span class=n>gb</span> <span class=o>+</span> <span class=n>beta</span> <span class=o>*</span> <span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>	<span class=c1>// gb
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=nl>BAYER_PATTERN_BGGR</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>y</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>y</span> <span class=o>&lt;</span> <span class=n>raw</span><span class=p>.</span><span class=n>getHeight</span><span class=p>();</span> <span class=n>y</span><span class=o>+=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>x</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>x</span> <span class=o>&lt;</span> <span class=n>raw</span><span class=p>.</span><span class=n>getWidth</span><span class=p>();</span> <span class=n>x</span><span class=o>+=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span> <span class=o>+=</span> <span class=n>b</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>+=</span> <span class=n>r</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>+=</span> <span class=n>gb</span> <span class=o>+</span> <span class=n>beta</span> <span class=o>*</span> <span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span> <span class=o>+=</span> <span class=n>gr</span> <span class=o>+</span> <span class=n>alpha</span> <span class=o>*</span> <span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=nl>BAYER_PATTERN_GBRG</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>y</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>y</span> <span class=o>&lt;</span> <span class=n>raw</span><span class=p>.</span><span class=n>getHeight</span><span class=p>();</span> <span class=n>y</span><span class=o>+=</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>x</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>x</span> <span class=o>&lt;</span> <span class=n>raw</span><span class=p>.</span><span class=n>getWidth</span><span class=p>();</span> <span class=n>x</span><span class=o>+=</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>+=</span> <span class=n>b</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span> <span class=o>+=</span> <span class=n>r</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span> <span class=o>+=</span> <span class=n>gb</span> <span class=o>+</span> <span class=n>beta</span> <span class=o>*</span> <span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>+=</span> <span class=n>gr</span> <span class=o>+</span> <span class=n>alpha</span> <span class=o>*</span> <span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=nl>BAYER_PATTERN_GRBG</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>y</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>y</span> <span class=o>&lt;</span> <span class=n>raw</span><span class=p>.</span><span class=n>getHeight</span><span class=p>();</span> <span class=n>y</span><span class=o>+=</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>x</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>x</span> <span class=o>&lt;</span> <span class=n>raw</span><span class=p>.</span><span class=n>getWidth</span><span class=p>();</span> <span class=n>x</span><span class=o>+=</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span> <span class=o>+=</span> <span class=n>b</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>+=</span> <span class=n>r</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>+=</span> <span class=n>gb</span> <span class=o>+</span> <span class=n>beta</span> <span class=o>*</span> <span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span>	
</span></span><span class=line><span class=cl>				<span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span> <span class=o>+=</span> <span class=n>gr</span> <span class=o>+</span> <span class=n>alpha</span> <span class=o>*</span> <span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=nl>BAYER_PATTERN_UNKNOWN</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	<span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>		<span class=n>TRACE_DEBUG_LOG_ERROR</span><span class=p>(</span><span class=s>&#34;Unknown Bayer Pattern:%s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>bayer_pattern</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>throw</span> <span class=s>&#34;Unknown bayer pattern&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=n>raw</span><span class=p>.</span><span class=n>clip</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>clip</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></details><h3 id=é•œå¤´é˜´å½±æ ¡æ­£lens-shading-correctionlsc>é•œå¤´é˜´å½±æ ¡æ­£ï¼ˆLens Shading Correctionï¼ŒLSCï¼‰</h3><p>Lens Shading æ˜¯ç›¸æœºæˆåƒè¿‡ç¨‹ä¸­ä¸€ç§ç”±é•œå¤´ä¸å›¾åƒä¼ æ„Ÿå™¨çš„å…‰å­¦ç‰¹æ€§å¼•èµ·çš„ç°è±¡ã€‚å…·ä½“è¡¨ç°ä¸ºå›¾åƒäº®åº¦å’Œé¢œè‰²åœ¨è§†åœºï¼ˆField of Viewï¼ŒFOVï¼‰ä¸­çš„åˆ†å¸ƒä¸å‡åŒ€ï¼Œé€šå¸¸æ˜¯å›¾åƒä¸­å¿ƒäº®åº¦è¾ƒé«˜ï¼Œè€Œè¾¹ç¼˜äº®åº¦è¾ƒä½ï¼Œå¹¶å¯èƒ½ä¼´éšé¢œè‰²åç§»ã€‚å®ƒæ˜¯æš—è§’ç°è±¡ï¼ˆVignettingï¼‰çš„æ‰©å±•ï¼ŒåŒ…å«äº†äº®åº¦ï¼ˆLuma Shadingï¼‰å’Œè‰²å½©ï¼ˆChroma Shadingï¼‰çš„ä¸å‡åŒ€æ€§ã€‚</p><h4 id=äº®åº¦lumaé˜´å½±>äº®åº¦ï¼ˆLumaï¼‰é˜´å½±</h4><p>Luma Shading ä¹Ÿè¢«ç§°ä¸ºæ¸æ™•ï¼ˆVignettingï¼‰ï¼Œç”±äºé€é•œç»„çš„å…‰å­¦ç‰¹æ€§ï¼Œå…¥å°„å…‰åç¦»å…‰è½´è§’åº¦è¾ƒå¤§æ—¶ï¼Œéƒ¨åˆ†å…‰å°±ä¼šå—å…‰é˜‘çš„å½±å“è€Œæ— æ³•åœ¨æ„Ÿå…‰å¹³é¢ä¸Šæˆåƒï¼Œä»è€Œå¯¼è‡´è¶Šé è¿‘è¾¹ç¼˜çš„åƒç´ äº®åº¦è¶Šä½ã€‚</p><p><img src=/articles/camera-isp/image-3.png width=1204 height=549 srcset="/articles/camera-isp/image-3_hu_a524348aa9407e67.png 480w, /articles/camera-isp/image-3_hu_1c6e1c25e18069b9.png 1024w" loading=lazy alt="å›¾10 é•œå¤´å…¥å°„å…‰ä¼ é€’è·¯å¾„å›¾" class=gallery-image data-flex-grow=219 data-flex-basis=526px> <img src=/articles/camera-isp/image-2.png width=373 height=293 srcset="/articles/camera-isp/image-2_hu_19aa7f6afedb7342.png 480w, /articles/camera-isp/image-2_hu_3365ea2281cd10db.png 1024w" loading=lazy alt="å›¾11 Lens shadingå¯¼è‡´çš„æš—è§’ç°è±¡" class=gallery-image data-flex-grow=127 data-flex-basis=305px></p><p>æ­¤å¤–,å¯¹äºFSIå·¥è‰ºçš„sensorï¼ŒLuma shadingçš„ä¸»è¦æˆå› è¿˜åŒ…æ‹¬è¾¹ç¼˜åƒç´ ç„¦ç‚¹é”™ä½ï¼Œè§£å†³è¿™ä¸ªé—®é¢˜å¯ä»¥é€šè¿‡è¾¹ç¼˜å¾®é€é•œçš„åç§»æ¥ä¿®æ­£ï¼Œå³ä»ä¸­å¿ƒåƒç´ å¼€å§‹ï¼Œå¾®é€é•œçš„ç›´å¾„éƒ½ç•¥å°äºæˆåƒé¢ï¼Œè¿™æ ·è¶Šæ¥è¿‘è¾¹ç¼˜ï¼Œå¾®é€é•œä¸æˆåƒé¢ä¹‹é—´çš„åç§»å°±è¶Šå¤§ï¼Œä»è€Œå¯ä»¥è¡¥å¿å…¥å°„å…‰çº¿è§’åº¦è¿‡å¤§å¯¼è‡´çš„ç„¦ç‚¹åç§»ï¼Œä½¿å¾®é€é•œçš„CRAå¢å¤§ï¼Œä»è€Œå…‰çº¿å¯ä»¥æ›´å¥½åœ°æ±‡èšåˆ°æ„Ÿå…‰å¹³é¢ä¸Šã€‚</p><p><img src=/articles/camera-isp/image-4.png width=720 height=624 srcset="/articles/camera-isp/image-4_hu_fdbded3af74685a1.png 480w, /articles/camera-isp/image-4_hu_b4515cd166d56e81.png 1024w" loading=lazy alt="å›¾12 ç„¦ç‚¹é”™ä½å¯¼è‡´èƒ½é‡æŸå¤±" class=gallery-image data-flex-grow=115 data-flex-basis=276px> <img src=/articles/camera-isp/image-5.png width=1874 height=1537 srcset="/articles/camera-isp/image-5_hu_9b71dc9fbc484130.png 480w, /articles/camera-isp/image-5_hu_6cb378edefb77766.png 1024w" loading=lazy alt="å›¾13 è¾¹ç¼˜å¾®é€é•œä¸æˆåƒé¢åç§»è¡¥å¿ç„¦ç‚¹é”™ä½" class=gallery-image data-flex-grow=121 data-flex-basis=292px></p><p>æ‰©å±•é˜…è¯»ï¼š <a class=link href=https://www.voltrium.com.sg/en/bsi-vs-fsi-sensors-which-sensor-suits-your-needs/ target=_blank rel=noopener>FSI vs BSI</a> ã€ <a class=link href=https://blog.csdn.net/weixin_39839293/article/details/82118991 target=_blank rel=noopener>ä»€ä¹ˆæ˜¯CRA</a></p><h4 id=è‰²å½©chromaé˜´å½±>è‰²å½©ï¼ˆChromaï¼‰é˜´å½±</h4><p>Chroma Shadingæ˜¯Lens Shadingçš„ä¸€ç§ç‰¹æ®Šæƒ…å†µï¼Œä¸»è¦è¡¨ç°ä¸ºä»ä¸­å¿ƒå‘è¾¹ç¼˜çš„è‰²æ™•ã€‚</p><p><img src=/articles/camera-isp/image-6.png width=416 height=289 srcset="/articles/camera-isp/image-6_hu_de92d8c1d45423ec.png 480w, /articles/camera-isp/image-6_hu_d1c55e22776b7ae.png 1024w" loading=lazy alt="å›¾14 Chroma Shadingè‰²æ™•" class=gallery-image data-flex-grow=143 data-flex-basis=345px></p><p>Chroma Shadingçš„æˆå› ï¼Œçœ‹äº†å¾ˆå¤šåšå®¢ä»¥åŠæ–‡ç« ï¼Œä¼—è¯´çº·çº­ï¼Œæ€»ç»“èµ·æ¥ä¸»è¦ä¸¤ä¸ªåŸå› ï¼š</p><ol><li>å¯¹ä¸åŒæ³¢é•¿çš„å…‰å…·æœ‰ä¸åŒçš„æŠ˜å°„ç‡ï¼Œå› æ­¤åœ¨æˆåƒæ—¶ä¸åŒè‰²å…‰çš„ç„¦å¹³é¢å¹¶ä¸é‡åˆï¼Œä»è€Œäº§ç”Ÿäº†è‰²å·®ã€‚</li><li>ç”±äºå¹²æ¶‰å‹çº¢å¤–æ»¤å…‰ç‰‡ï¼ˆIR-Filterï¼‰å¯¹ä¸åŒå…¥å°„è§’åº¦çš„çº¢å¤–å…‰çš„é˜»éš”æ•ˆæœä¸åŒï¼Œä»è€Œå¯¼è‡´éƒ¨åˆ†å¤§è§’åº¦å…¥å°„çš„è¿‘çº¢å¤–å…‰æ²¡æœ‰è¢«é˜»éš”ï¼Œä»è€Œäº§ç”Ÿäº†ä»ä¸­å¿ƒå‘è¾¹ç¼˜çš„è‰²æ™•ã€‚</li></ol><p><img src=/articles/camera-isp/image-7.png width=1200 height=617 srcset="/articles/camera-isp/image-7_hu_1b09c7f8c60223cb.png 480w, /articles/camera-isp/image-7_hu_e9b3d4401fa4deb9.png 1024w" loading=lazy alt="å›¾15 ä¸åŒè‰²å…‰çš„ç„¦å¹³é¢ä¸é‡åˆ" class=gallery-image data-flex-grow=194 data-flex-basis=466px> <img src=/articles/camera-isp/image-9.png width=560 height=393 srcset="/articles/camera-isp/image-9_hu_12189aa4831e5459.png 480w, /articles/camera-isp/image-9_hu_67f340cc7f8ace83.png 1024w" loading=lazy alt="å›¾16 ä¸åŒè‰²å…‰ä¸åŒå…¥å°„è§’çš„IR-Filteré€šè¿‡ç‡" class=gallery-image data-flex-grow=142 data-flex-basis=341px></p><h4 id=æ ¡æ­£ç®—æ³•>æ ¡æ­£ç®—æ³•</h4><p>ç›®å‰å¸¸ç”¨çš„é•œå¤´é˜´å½±æ ¡æ­£ç®—æ³•æ˜¯å¢ç›Šæ³•ã€‚ç”±äºå­˜å‚¨æ¯ä¸ªåƒç´ ç‚¹çš„æ ¡æ­£ç³»æ•°ä¼šå ç”¨å¤§é‡å­˜å‚¨ç©ºé—´ï¼Œå®é™…å®ç°ä¸­é€šå¸¸å¯¹å›¾åƒè¿›è¡ŒnÃ—n ç½‘æ ¼åˆ’åˆ†ï¼ˆä¸€èˆ¬é€‰æ‹© 16Ã—16 çš„ç½‘æ ¼ï¼‰ï¼Œä»…å­˜å‚¨è¿™äº›ç½‘æ ¼ç‚¹å¤„çš„æ ¡æ­£ç³»æ•°ã€‚å¯¹äºç½‘æ ¼ä¹‹é—´çš„å…¶ä»–åƒç´ ç‚¹ï¼Œå…¶æ ¡æ­£ç³»æ•°é€šè¿‡å››æ¬¡ä½™å¼¦æ’å€¼è®¡ç®—å¾—åˆ°ã€‚</p><p>å››æ¬¡ä½™å¼¦å®šå¾‹ï¼š$I_\theta = I_0 \cos^4 \theta$ï¼Œå³å¯¹äºä¸€ä¸ªæˆåƒé•œå¤´ç³»ç»Ÿï¼Œç¦»å…‰è½´çš„åƒç´ äº®åº¦ä¼šéšç€ç¦»è½´è§†åœºè§’$\theta$çš„å¢å¤§æŒ‰$\cos^4\theta$çš„æ¯”ä¾‹ä¸‹é™ã€‚è¿™ç§å…‰å­¦ç°è±¡æ˜¯é•œå¤´é˜´å½±æ•ˆåº”çš„ç†è®ºåŸºç¡€ï¼Œæ ¡æ­£æ—¶éœ€è¦é€šè¿‡æ’å€¼è®¡ç®—æ¥è¡¥å¿äº®åº¦ã€‚</p><p>è€Œè¦å¾—åˆ°è¯¥nxnä¸ªæ ¼ç‚¹å¤„çš„æ ¡æ­£ç³»æ•°ï¼Œåœ¨å‡åŒ€å…‰æºä¸‹é‡‡é›†å‚è€ƒå›¾åƒï¼Œè®°å½•æ¯ä¸ªåƒç´ çš„å®é™…äº®åº¦å€¼ï¼Œå¹¶ä¸ç†æƒ³äº®åº¦è¿›è¡Œå¯¹æ¯”ï¼Œåè€…ä¸å‰è€…çš„æ¯”å€¼å³ä¸ºæ ¡æ­£ç³»æ•°ã€‚</p>$$G(i,j)=\frac{I_{\mathrm{ideal}}(i,j)}{I_{\mathrm{observed}}(i,j)}$$<p><img src=/articles/camera-isp/image-10.png width=1410 height=490 srcset="/articles/camera-isp/image-10_hu_bb0e02a8db0cea30.png 480w, /articles/camera-isp/image-10_hu_3534a449d14989e2.png 1024w" loading=lazy alt="å›¾17 é•œå¤´é˜´å½±æ ¡æ­£å‰åå¯¹æ¯”å›¾" class=gallery-image data-flex-grow=287 data-flex-basis=690px></p><details class=popup-details><summary>ç¤ºä¾‹ä»£ç ï¼šLuma Shading Correction</summary><div class=popup-content><button class=close-btn>âœ–</button><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>* @brief Performs lens shading correction (LSC) on RAW image data to compensate
</span></span></span><span class=line><span class=cl><span class=cm>* for brightness falloff towards the edges.
</span></span></span><span class=line><span class=cl><span class=cm>*
</span></span></span><span class=line><span class=cl><span class=cm>* @param raw       Reference to the input RAW image data.
</span></span></span><span class=line><span class=cl><span class=cm>* @param intensity Intensity of the lens shading correction. Higher values
</span></span></span><span class=line><span class=cl><span class=cm>* apply stronger correction.
</span></span></span><span class=line><span class=cl><span class=cm>* @param minR      Minimum radius (distance from the center) for applying
</span></span></span><span class=line><span class=cl><span class=cm>* correction. If less than 0, defaults to 0.
</span></span></span><span class=line><span class=cl><span class=cm>* @param maxR      Maximum radius (distance from the center) for applying
</span></span></span><span class=line><span class=cl><span class=cm>* correction. If less than 0, defaults to the distance from the center to the
</span></span></span><span class=line><span class=cl><span class=cm>* farthest corner of the image.
</span></span></span><span class=line><span class=cl><span class=cm>* @param clip      Maximum allowable pixel value after correction. Values
</span></span></span><span class=line><span class=cl><span class=cm>* exceeding this are clipped.
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>LSC</span><span class=p>(</span><span class=n>ImageRaw</span><span class=o>&amp;</span> <span class=n>raw</span><span class=p>,</span> <span class=kt>uint16_t</span> <span class=n>intensity</span><span class=p>,</span> <span class=kt>int</span> <span class=n>minR</span><span class=p>,</span> <span class=kt>int</span> <span class=n>maxR</span><span class=p>,</span> <span class=kt>uint16_t</span> <span class=n>clip</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>minR</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=n>minR</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>maxR</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=n>maxR</span> <span class=o>=</span> <span class=n>sqrt</span><span class=p>(</span><span class=n>pow</span><span class=p>(</span><span class=n>raw</span><span class=p>.</span><span class=n>getHeight</span><span class=p>()</span> <span class=o>/</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span> <span class=o>+</span> <span class=n>pow</span><span class=p>(</span><span class=n>raw</span><span class=p>.</span><span class=n>getWidth</span><span class=p>()</span> <span class=o>/</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>y</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>y</span> <span class=o>&lt;</span> <span class=n>raw</span><span class=p>.</span><span class=n>getHeight</span><span class=p>();</span> <span class=n>y</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>  	<span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>x</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>x</span> <span class=o>&lt;</span> <span class=n>raw</span><span class=p>.</span><span class=n>getWidth</span><span class=p>();</span> <span class=n>x</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  	<span class=p>{</span>
</span></span><span class=line><span class=cl>  		<span class=kt>int</span> <span class=n>r</span> <span class=o>=</span> <span class=n>sqrt</span><span class=p>(</span><span class=n>pow</span><span class=p>((</span><span class=n>y</span> <span class=o>-</span> <span class=n>raw</span><span class=p>.</span><span class=n>getHeight</span><span class=p>()</span> <span class=o>/</span> <span class=mi>2</span><span class=p>),</span> <span class=mi>2</span><span class=p>)</span> <span class=o>+</span> <span class=n>pow</span><span class=p>((</span><span class=n>x</span> <span class=o>-</span> <span class=n>raw</span><span class=p>.</span><span class=n>getWidth</span><span class=p>()</span> <span class=o>/</span> <span class=mi>2</span><span class=p>),</span> <span class=mi>2</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  		<span class=kt>float</span> <span class=n>factor</span> <span class=o>=</span> <span class=p>(</span><span class=n>r</span> <span class=o>-</span> <span class=n>minR</span><span class=p>)</span> <span class=o>/</span> <span class=p>(</span><span class=n>maxR</span> <span class=o>-</span> <span class=n>minR</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  		<span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span> <span class=o>=</span> <span class=n>raw</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=n>intensity</span> <span class=o>*</span> <span class=p>(</span><span class=n>factor</span> <span class=o>+</span> <span class=mf>0.5</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  	<span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=n>raw</span><span class=p>.</span><span class=n>clip</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>clip</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></details><details class=popup-details><summary>ç¤ºä¾‹ä»£ç ï¼šChroma Shading Correction</summary><div class=popup-content><button class=close-btn>âœ–</button><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>float</span> <span class=nf>__cnc</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>is_color</span><span class=p>,</span> <span class=kt>float</span> <span class=n>center</span><span class=p>,</span> <span class=kt>float</span> <span class=n>avgG</span><span class=p>,</span> <span class=kt>float</span> <span class=n>avgC1</span><span class=p>,</span> <span class=kt>float</span> <span class=n>avgC2</span><span class=p>,</span> <span class=kt>float</span> <span class=n>r_gain</span><span class=p>,</span> <span class=kt>float</span> <span class=n>gr_gain</span><span class=p>,</span> <span class=kt>float</span> <span class=n>gb_gain</span><span class=p>,</span> <span class=kt>float</span> <span class=n>b_gain</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>float</span> <span class=n>dampFactor</span> <span class=o>=</span> <span class=mf>1.0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>float</span> <span class=n>signalGap</span> <span class=o>=</span> <span class=n>center</span> <span class=o>-</span> <span class=n>MAX</span><span class=p>(</span><span class=n>avgG</span><span class=p>,</span> <span class=n>avgC2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>strcmp</span><span class=p>(</span><span class=n>is_color</span><span class=p>,</span> <span class=s>&#34;r&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>  	<span class=k>if</span> <span class=p>(</span><span class=n>r_gain</span> <span class=o>&lt;=</span> <span class=mf>1.0</span><span class=p>)</span> <span class=n>dampFactor</span> <span class=o>=</span> <span class=mf>1.0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  	<span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>r_gain</span> <span class=o>&gt;</span> <span class=mf>1.0</span> <span class=o>&amp;&amp;</span> <span class=n>r_gain</span> <span class=o>&lt;=</span> <span class=mf>1.2</span><span class=p>)</span> <span class=n>dampFactor</span> <span class=o>=</span> <span class=mf>0.5</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  	<span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>r_gain</span> <span class=o>&gt;</span> <span class=mf>1.2</span><span class=p>)</span> <span class=n>dampFactor</span> <span class=o>=</span> <span class=mf>0.3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>strcmp</span><span class=p>(</span><span class=n>is_color</span><span class=p>,</span> <span class=s>&#34;b&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>  	<span class=k>if</span> <span class=p>(</span><span class=n>b_gain</span> <span class=o>&lt;=</span> <span class=mf>1.0</span><span class=p>)</span> <span class=n>dampFactor</span> <span class=o>=</span> <span class=mf>1.0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  	<span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>b_gain</span> <span class=o>&gt;</span> <span class=mf>1.0</span> <span class=o>&amp;&amp;</span> <span class=n>b_gain</span> <span class=o>&lt;=</span> <span class=mf>1.2</span><span class=p>)</span> <span class=n>dampFactor</span> <span class=o>=</span> <span class=mf>0.5</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  	<span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>b_gain</span> <span class=o>&gt;</span> <span class=mf>1.2</span><span class=p>)</span> <span class=n>dampFactor</span> <span class=o>=</span> <span class=mf>0.3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kt>float</span> <span class=n>chromaCorrected</span> <span class=o>=</span> <span class=n>MAX</span><span class=p>(</span><span class=n>avgG</span><span class=p>,</span> <span class=n>avgC2</span><span class=p>)</span> <span class=o>+</span> <span class=n>dampFactor</span> <span class=o>*</span> <span class=n>signalGap</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>float</span> <span class=n>signalMeter</span> <span class=o>=</span> <span class=mf>0.299</span> <span class=o>*</span> <span class=n>avgC2</span> <span class=o>+</span> <span class=mf>0.587</span> <span class=o>*</span> <span class=n>avgG</span> <span class=o>+</span> <span class=mf>0.144</span> <span class=o>*</span> <span class=n>avgC1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>strcmp</span><span class=p>(</span><span class=n>is_color</span><span class=p>,</span> <span class=s>&#34;r&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=n>signalMeter</span> <span class=o>=</span> <span class=mf>0.299</span> <span class=o>*</span> <span class=n>avgC1</span> <span class=o>+</span> <span class=mf>0.587</span> <span class=o>*</span> <span class=n>avgG</span> <span class=o>+</span> <span class=mf>0.144</span> <span class=o>*</span> <span class=n>avgC2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>strcmp</span><span class=p>(</span><span class=n>is_color</span><span class=p>,</span> <span class=s>&#34;b&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=n>signalMeter</span> <span class=o>=</span> <span class=mf>0.299</span> <span class=o>*</span> <span class=n>avgC2</span> <span class=o>+</span> <span class=mf>0.587</span> <span class=o>*</span> <span class=n>avgG</span> <span class=o>+</span> <span class=mf>0.144</span> <span class=o>*</span> <span class=n>avgC1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>float</span> <span class=n>fade1</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>fade2</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>signalMeter</span> <span class=o>&lt;=</span> <span class=mi>30</span><span class=p>)</span> <span class=n>fade1</span> <span class=o>=</span> <span class=mf>1.0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>signalMeter</span> <span class=o>&gt;</span> <span class=mi>30</span> <span class=o>&amp;&amp;</span> <span class=n>signalMeter</span> <span class=o>&lt;=</span> <span class=mi>50</span><span class=p>)</span> <span class=n>fade1</span> <span class=o>=</span> <span class=mf>0.9</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>signalMeter</span> <span class=o>&gt;</span> <span class=mi>50</span> <span class=o>&amp;&amp;</span> <span class=n>signalMeter</span> <span class=o>&lt;=</span> <span class=mi>70</span><span class=p>)</span> <span class=n>fade1</span> <span class=o>=</span> <span class=mf>0.8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>signalMeter</span> <span class=o>&gt;</span> <span class=mi>70</span> <span class=o>&amp;&amp;</span> <span class=n>signalMeter</span> <span class=o>&lt;=</span> <span class=mi>100</span><span class=p>)</span> <span class=n>fade1</span> <span class=o>=</span> <span class=mf>0.7</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>signalMeter</span> <span class=o>&gt;</span> <span class=mi>100</span> <span class=o>&amp;&amp;</span> <span class=n>signalMeter</span> <span class=o>&lt;=</span> <span class=mi>150</span><span class=p>)</span> <span class=n>fade1</span> <span class=o>=</span> <span class=mf>0.6</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>signalMeter</span> <span class=o>&gt;</span> <span class=mi>150</span> <span class=o>&amp;&amp;</span> <span class=n>signalMeter</span> <span class=o>&lt;=</span> <span class=mi>200</span><span class=p>)</span> <span class=n>fade1</span> <span class=o>=</span> <span class=mf>0.3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>signalMeter</span> <span class=o>&gt;</span> <span class=mi>200</span> <span class=o>&amp;&amp;</span> <span class=n>signalMeter</span> <span class=o>&lt;=</span> <span class=mi>250</span><span class=p>)</span> <span class=n>fade1</span> <span class=o>=</span> <span class=mf>0.1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=n>fade1</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>avgC1</span> <span class=o>&lt;=</span> <span class=mi>30</span><span class=p>)</span> <span class=n>fade2</span> <span class=o>=</span> <span class=mf>1.0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>avgC1</span> <span class=o>&gt;</span> <span class=mi>30</span> <span class=o>&amp;&amp;</span> <span class=n>avgC1</span> <span class=o>&lt;=</span> <span class=mi>50</span><span class=p>)</span> <span class=n>fade2</span> <span class=o>=</span> <span class=mf>0.9</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>avgC1</span> <span class=o>&gt;</span> <span class=mi>50</span> <span class=o>&amp;&amp;</span> <span class=n>avgC1</span> <span class=o>&lt;=</span> <span class=mi>70</span><span class=p>)</span> <span class=n>fade2</span> <span class=o>=</span> <span class=mf>0.8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>avgC1</span> <span class=o>&gt;</span> <span class=mi>70</span> <span class=o>&amp;&amp;</span> <span class=n>avgC1</span> <span class=o>&lt;=</span> <span class=mi>100</span><span class=p>)</span> <span class=n>fade2</span> <span class=o>=</span> <span class=mf>0.6</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>avgC1</span> <span class=o>&gt;</span> <span class=mi>100</span> <span class=o>&amp;&amp;</span> <span class=n>avgC1</span> <span class=o>&lt;=</span> <span class=mi>150</span><span class=p>)</span> <span class=n>fade2</span> <span class=o>=</span> <span class=mf>0.5</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>avgC1</span> <span class=o>&gt;</span> <span class=mi>150</span> <span class=o>&amp;&amp;</span> <span class=n>avgC1</span> <span class=o>&lt;=</span> <span class=mi>200</span><span class=p>)</span> <span class=n>fade2</span> <span class=o>=</span> <span class=mf>0.3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=n>fade2</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>float</span> <span class=n>fadeTot</span> <span class=o>=</span> <span class=n>fade1</span> <span class=o>*</span> <span class=n>fade2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>fadeTot</span><span class=p>)</span> <span class=o>*</span> <span class=n>center</span> <span class=o>+</span> <span class=n>fadeTot</span> <span class=o>*</span> <span class=n>chromaCorrected</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>__cnd</span><span class=p>(</span><span class=kt>int</span> <span class=n>y</span><span class=p>,</span> <span class=kt>int</span> <span class=n>x</span><span class=p>,</span> <span class=n>ImageRaw</span><span class=o>*</span> <span class=n>img</span><span class=p>,</span> <span class=kt>float</span> <span class=n>thres</span><span class=p>,</span> <span class=kt>int</span><span class=o>&amp;</span> <span class=n>is_noise</span><span class=p>,</span> <span class=kt>float</span><span class=o>&amp;</span> <span class=n>avgG</span><span class=p>,</span> <span class=kt>float</span><span class=o>&amp;</span> <span class=n>avgC1</span><span class=p>,</span> <span class=kt>float</span><span class=o>&amp;</span> <span class=n>avgC2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>avgG</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>avgC1</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>avgC2</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>is_noise</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>y</span> <span class=o>-</span> <span class=mi>4</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>y</span> <span class=o>+</span> <span class=mi>4</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>  	<span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=n>x</span> <span class=o>-</span> <span class=mi>4</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>4</span><span class=p>;</span> <span class=n>j</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  	<span class=p>{</span>
</span></span><span class=line><span class=cl>  		<span class=k>if</span> <span class=p>((</span><span class=n>i</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>j</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>==</span> <span class=mi>0</span><span class=p>))</span>		<span class=n>avgG</span> <span class=o>=</span> <span class=n>avgG</span> <span class=o>+</span> <span class=n>img</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>j</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  		<span class=k>else</span> <span class=k>if</span> <span class=p>((</span><span class=n>i</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>j</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>==</span> <span class=mi>1</span><span class=p>))</span>	<span class=n>avgG</span> <span class=o>=</span> <span class=n>avgG</span> <span class=o>+</span> <span class=n>img</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>j</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  		<span class=k>else</span> <span class=k>if</span> <span class=p>((</span><span class=n>i</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>j</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>==</span> <span class=mi>0</span><span class=p>))</span>	<span class=n>avgC1</span> <span class=o>=</span> <span class=n>avgC1</span> <span class=o>+</span> <span class=n>img</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>j</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  		<span class=k>else</span> <span class=k>if</span> <span class=p>((</span><span class=n>i</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>j</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>==</span> <span class=mi>1</span><span class=p>))</span>	<span class=n>avgC2</span> <span class=o>=</span> <span class=n>avgC2</span> <span class=o>+</span> <span class=n>img</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>j</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  	<span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=n>avgG</span> <span class=o>=</span> <span class=n>avgG</span> <span class=o>/</span> <span class=mi>40</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>avgC1</span> <span class=o>=</span> <span class=n>avgC1</span> <span class=o>/</span> <span class=mi>25</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>avgC2</span> <span class=o>=</span> <span class=n>avgC2</span> <span class=o>/</span> <span class=mi>16</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>float</span> <span class=n>center</span> <span class=o>=</span> <span class=n>img</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>((</span><span class=n>center</span> <span class=o>&gt;</span> <span class=n>avgG</span> <span class=o>+</span> <span class=n>thres</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>center</span> <span class=o>&gt;</span> <span class=n>avgC2</span> <span class=o>+</span> <span class=n>thres</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>  	<span class=k>if</span> <span class=p>((</span><span class=n>avgC1</span> <span class=o>&gt;</span> <span class=n>avgG</span> <span class=o>+</span> <span class=n>thres</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>avgC1</span> <span class=o>&gt;</span> <span class=n>avgC2</span> <span class=o>+</span> <span class=n>thres</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  	<span class=p>{</span>
</span></span><span class=line><span class=cl>  		<span class=n>is_noise</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  	<span class=p>}</span>
</span></span><span class=line><span class=cl>  	<span class=k>else</span>
</span></span><span class=line><span class=cl>  	<span class=p>{</span>
</span></span><span class=line><span class=cl>  		<span class=n>is_noise</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  	<span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>  	<span class=n>is_noise</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>float</span> <span class=nf>__cnf</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>is_color</span><span class=p>,</span> <span class=kt>int</span> <span class=n>y</span><span class=p>,</span> <span class=kt>int</span> <span class=n>x</span><span class=p>,</span> <span class=n>ImageRaw</span><span class=o>*</span> <span class=n>img</span><span class=p>,</span> <span class=kt>float</span> <span class=n>thres</span><span class=p>,</span> <span class=kt>float</span> <span class=n>r_gain</span><span class=p>,</span> <span class=kt>float</span> <span class=n>gr_gain</span><span class=p>,</span> <span class=kt>float</span> <span class=n>gb_gain</span><span class=p>,</span> <span class=kt>float</span> <span class=n>b_gain</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>is_noise</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>float</span> <span class=n>avgG</span><span class=p>,</span> <span class=n>avgC1</span><span class=p>,</span> <span class=n>avgC2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>__cnd</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>img</span><span class=p>,</span> <span class=n>thres</span><span class=p>,</span> <span class=n>is_noise</span><span class=p>,</span> <span class=n>avgG</span><span class=p>,</span> <span class=n>avgC1</span><span class=p>,</span> <span class=n>avgC2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>float</span> <span class=n>pix_out</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>is_noise</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>  	<span class=n>pix_out</span> <span class=o>=</span> <span class=n>__cnc</span><span class=p>(</span><span class=n>is_color</span><span class=p>,</span> <span class=n>img</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>),</span> <span class=n>avgG</span><span class=p>,</span> <span class=n>avgC1</span><span class=p>,</span> <span class=n>avgC2</span><span class=p>,</span> <span class=n>r_gain</span><span class=p>,</span> <span class=n>gr_gain</span><span class=p>,</span> <span class=n>gb_gain</span><span class=p>,</span> <span class=n>b_gain</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>  	<span class=n>pix_out</span> <span class=o>=</span> <span class=n>img</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>pix_out</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>CNF</span><span class=p>(</span><span class=n>ImageRaw</span><span class=o>&amp;</span> <span class=n>img</span><span class=p>,</span> <span class=n>BAYER_PATTERN</span> <span class=n>bayer_pattern</span><span class=p>,</span> <span class=kt>float</span> <span class=n>threshold</span><span class=p>,</span> <span class=kt>float</span> <span class=n>r_gain</span><span class=p>,</span> <span class=kt>float</span> <span class=n>gr_gain</span><span class=p>,</span> <span class=kt>float</span> <span class=n>gb_gain</span><span class=p>,</span> <span class=kt>float</span> <span class=n>b_gain</span><span class=p>,</span> <span class=kt>uint16_t</span> <span class=n>clip</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>ImageRaw</span><span class=o>*</span> <span class=n>img_pad</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ImageRaw</span><span class=p>(</span><span class=n>img</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>img_pad</span><span class=o>-&gt;</span><span class=n>padding</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=n>PADDING_MODE_REFLECT</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>uint16_t</span> <span class=n>r</span><span class=p>,</span> <span class=n>gr</span><span class=p>,</span> <span class=n>gb</span><span class=p>,</span> <span class=n>b</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>y</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>y</span> <span class=o>&lt;</span> <span class=n>img_pad</span><span class=o>-&gt;</span><span class=n>getHeight</span><span class=p>()</span> <span class=o>-</span> <span class=mi>8</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span> <span class=n>y</span> <span class=o>+=</span> <span class=mi>2</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  	<span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>x</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>x</span> <span class=o>&lt;</span> <span class=n>img_pad</span><span class=o>-&gt;</span><span class=n>getWidth</span><span class=p>()</span> <span class=o>-</span> <span class=mi>8</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span> <span class=n>x</span> <span class=o>+=</span> <span class=mi>2</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  		<span class=k>switch</span> <span class=p>(</span><span class=n>bayer_pattern</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  		<span class=k>case</span> <span class=nl>BAYER_PATTERN_RGGB</span><span class=p>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  			<span class=n>r</span> <span class=o>=</span> <span class=n>img_pad</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>4</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  			<span class=n>gr</span> <span class=o>=</span> <span class=n>img_pad</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>4</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  			<span class=n>gb</span> <span class=o>=</span> <span class=n>img_pad</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>5</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  			<span class=n>b</span> <span class=o>=</span> <span class=n>img_pad</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>5</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  			<span class=n>img</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span> <span class=o>=</span> <span class=n>__cnf</span><span class=p>(</span><span class=s>&#34;r&#34;</span><span class=p>,</span> <span class=n>y</span> <span class=o>+</span> <span class=mi>4</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>4</span><span class=p>,</span> <span class=n>img_pad</span><span class=p>,</span> <span class=n>threshold</span><span class=p>,</span> <span class=n>r_gain</span><span class=p>,</span> <span class=n>gr_gain</span><span class=p>,</span> <span class=n>gb_gain</span><span class=p>,</span> <span class=n>b_gain</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  			<span class=n>img</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>=</span> <span class=n>gr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  			<span class=n>img</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span> <span class=o>=</span> <span class=n>gb</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  			<span class=n>img</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>=</span> <span class=n>__cnf</span><span class=p>(</span><span class=s>&#34;b&#34;</span><span class=p>,</span> <span class=n>y</span> <span class=o>+</span> <span class=mi>5</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>5</span><span class=p>,</span> <span class=n>img_pad</span><span class=p>,</span> <span class=n>threshold</span><span class=p>,</span> <span class=n>r_gain</span><span class=p>,</span> <span class=n>gr_gain</span><span class=p>,</span> <span class=n>gb_gain</span><span class=p>,</span> <span class=n>b_gain</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  			<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  		<span class=k>case</span> <span class=nl>BAYER_PATTERN_BGGR</span><span class=p>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  			<span class=n>b</span> <span class=o>=</span> <span class=n>img_pad</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>4</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  			<span class=n>gb</span> <span class=o>=</span> <span class=n>img_pad</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>4</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  			<span class=n>gr</span> <span class=o>=</span> <span class=n>img_pad</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>5</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  			<span class=n>r</span> <span class=o>=</span> <span class=n>img_pad</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>5</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  			<span class=n>img</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span> <span class=o>=</span> <span class=n>__cnf</span><span class=p>(</span><span class=s>&#34;b&#34;</span><span class=p>,</span> <span class=n>y</span> <span class=o>+</span> <span class=mi>4</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>4</span><span class=p>,</span> <span class=n>img_pad</span><span class=p>,</span> <span class=n>threshold</span><span class=p>,</span> <span class=n>r_gain</span><span class=p>,</span> <span class=n>gr_gain</span><span class=p>,</span> <span class=n>gb_gain</span><span class=p>,</span> <span class=n>b_gain</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  			<span class=n>img</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>=</span> <span class=n>gb</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  			<span class=n>img</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span> <span class=o>=</span> <span class=n>gr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  			<span class=n>img</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>=</span> <span class=n>__cnf</span><span class=p>(</span><span class=s>&#34;r&#34;</span><span class=p>,</span> <span class=n>y</span> <span class=o>+</span> <span class=mi>5</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>5</span><span class=p>,</span> <span class=n>img_pad</span><span class=p>,</span> <span class=n>threshold</span><span class=p>,</span> <span class=n>r_gain</span><span class=p>,</span> <span class=n>gr_gain</span><span class=p>,</span> <span class=n>gb_gain</span><span class=p>,</span> <span class=n>b_gain</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  			<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  		<span class=k>case</span> <span class=nl>BAYER_PATTERN_GBRG</span><span class=p>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  			<span class=n>gb</span> <span class=o>=</span> <span class=n>img_pad</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>4</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  			<span class=n>b</span> <span class=o>=</span> <span class=n>img_pad</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>4</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  			<span class=n>r</span> <span class=o>=</span> <span class=n>img_pad</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>5</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  			<span class=n>gr</span> <span class=o>=</span> <span class=n>img_pad</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>5</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  			<span class=n>img</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span> <span class=o>=</span> <span class=n>gb</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  			<span class=n>img</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>=</span> <span class=n>__cnf</span><span class=p>(</span><span class=s>&#34;b&#34;</span><span class=p>,</span> <span class=n>y</span> <span class=o>+</span> <span class=mi>4</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>5</span><span class=p>,</span> <span class=n>img_pad</span><span class=p>,</span> <span class=n>threshold</span><span class=p>,</span> <span class=n>r_gain</span><span class=p>,</span> <span class=n>gr_gain</span><span class=p>,</span> <span class=n>gb_gain</span><span class=p>,</span> <span class=n>b_gain</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  			<span class=n>img</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span> <span class=o>=</span> <span class=n>__cnf</span><span class=p>(</span><span class=s>&#34;r&#34;</span><span class=p>,</span> <span class=n>y</span> <span class=o>+</span> <span class=mi>5</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>4</span><span class=p>,</span> <span class=n>img_pad</span><span class=p>,</span> <span class=n>threshold</span><span class=p>,</span> <span class=n>r_gain</span><span class=p>,</span> <span class=n>gr_gain</span><span class=p>,</span> <span class=n>gb_gain</span><span class=p>,</span> <span class=n>b_gain</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  			<span class=n>img</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>=</span> <span class=n>gr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  			<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  		<span class=k>case</span> <span class=nl>BAYER_PATTERN_GRBG</span><span class=p>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  			<span class=n>gr</span> <span class=o>=</span> <span class=n>img_pad</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>4</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  			<span class=n>r</span> <span class=o>=</span> <span class=n>img_pad</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>4</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  			<span class=n>b</span> <span class=o>=</span> <span class=n>img_pad</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>5</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  			<span class=n>gb</span> <span class=o>=</span> <span class=n>img_pad</span><span class=o>-&gt;</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>5</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  			<span class=n>img</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span> <span class=o>=</span> <span class=n>gr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  			<span class=n>img</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>=</span> <span class=n>__cnf</span><span class=p>(</span><span class=s>&#34;r&#34;</span><span class=p>,</span> <span class=n>y</span> <span class=o>+</span> <span class=mi>4</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>5</span><span class=p>,</span> <span class=n>img_pad</span><span class=p>,</span> <span class=n>threshold</span><span class=p>,</span> <span class=n>r_gain</span><span class=p>,</span> <span class=n>gr_gain</span><span class=p>,</span> <span class=n>gb_gain</span><span class=p>,</span> <span class=n>b_gain</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  			<span class=n>img</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span> <span class=o>=</span> <span class=n>__cnf</span><span class=p>(</span><span class=s>&#34;b&#34;</span><span class=p>,</span> <span class=n>y</span> <span class=o>+</span> <span class=mi>5</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>4</span><span class=p>,</span> <span class=n>img_pad</span><span class=p>,</span> <span class=n>threshold</span><span class=p>,</span> <span class=n>r_gain</span><span class=p>,</span> <span class=n>gr_gain</span><span class=p>,</span> <span class=n>gb_gain</span><span class=p>,</span> <span class=n>b_gain</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  			<span class=n>img</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>y</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>x</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>=</span> <span class=n>gb</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  			<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  		<span class=k>case</span> <span class=nl>BAYER_PATTERN_UNKNOWN</span><span class=p>:</span>
</span></span><span class=line><span class=cl>  		<span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>  			<span class=n>TRACE_DEBUG_LOG_ERROR</span><span class=p>(</span><span class=s>&#34;Unknown Bayer Pattern:%s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>bayer_pattern</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  			<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  		<span class=p>}</span>
</span></span><span class=line><span class=cl>  	<span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>img</span><span class=p>.</span><span class=n>clip</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>clip</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>delete</span> <span class=n>img_pad</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></details><h3 id=æŠ—é”¯é½¿æ»¤æ³¢anti-aliasing-filteringaaf>æŠ—é”¯é½¿æ»¤æ³¢ï¼ˆAnti-aliasing Filteringï¼ŒAAFï¼‰</h3><p>å¦‚æœæ‹æ‘„çš„å›¾åƒä¸­å«æœ‰å¤§é‡é«˜é¢‘æˆåˆ†ï¼Œåœ¨é™é‡‡æ ·æ—¶å°±ä¼šäº§ç”Ÿé”¯é½¿ï¼ˆaliasingï¼‰ï¼Œè¦å»é™¤é”¯é½¿ï¼Œéœ€è¦å¯¹åŸå›¾åƒè¿›è¡Œå¹³æ»‘ã€‚å¸¸ç”¨çš„æ–¹æ³•æœ‰é«˜æ–¯æ»¤æ³¢å™¨ï¼ˆGaussian Filterï¼‰å’ŒåŒè¾¹æ»¤æ³¢å™¨ï¼ˆBilateral Filterï¼‰ã€‚</p><ol><li>é«˜æ–¯æ»¤æ³¢å™¨
$$G(x,y)=\frac1{2\pi\sigma^2}\exp\left(-\frac{x^2+y^2}{2\sigma^2}\right)$$<br>å…¶ä¸­:<br>$\bullet\quad G(x,y)$æ˜¯é«˜æ–¯æ ¸åœ¨åæ ‡(x,y)çš„å€¼;<br>$\bullet\quad \sigma$æ˜¯é«˜æ–¯åˆ†å¸ƒçš„æ ‡å‡†å·®,å†³å®šæ»¤æ³¢å™¨çš„å¹³æ»‘å¼ºåº¦;<br>$\bullet\quad x,y$æ˜¯è·ç¦»æ ¸ä¸­å¿ƒçš„åæ ‡ã€‚</li><li>åŒè¾¹æ»¤æ³¢å™¨
$$W(p,q)=\exp\left(-\frac{\|p-q\|^2}{2\sigma_s^2}\right)\cdot\exp\left(-\frac{|I(p)-I(q)|^2}{2\sigma_r^2}\right)$$<br>å…¶ä¸­:<br>$\bullet\quad W(p,q)$æ˜¯åƒç´ qå¯¹pçš„æƒé‡;<br>$\bullet\quad|p-q|$æ˜¯ä¸¤åƒç´ åœ¨ç©ºé—´ä¸Šçš„è·ç¦»;<br>$\bullet\quad|I(p)-I(q)|$æ˜¯ä¸¤åƒç´ ç°åº¦å€¼çš„å·®å¼‚;<br>$\bullet\quad\sigma_s$æ˜¯ç©ºé—´åŸŸé«˜æ–¯æ ‡å‡†å·®;<br>$\bullet\quad\sigma_r$æ˜¯å¼ºåº¦åŸŸé«˜æ–¯æ ‡å‡†å·®ã€‚<br>æ»¤æ³¢ç»“æœ:<br>$$I^{\prime} (p)=\frac{\sum_{q\in S}W(p,q)\cdot I(q)}{\sum_{q\in S}W(p,q)}$$<br>å…¶ä¸­:Sæ˜¯æ»¤æ³¢çª—å£,$I^{\prime}(p)$æ˜¯åƒç´ pçš„æ»¤æ³¢å€¼ã€‚</li></ol><p>ä¸¤è€…å¯¹æ¯”ï¼š</p><div class=table-wrapper><table><thead><tr><th>ç‰¹æ€§</th><th>é«˜æ–¯æ»¤æ³¢å™¨</th><th>åŒè¾¹æ»¤æ³¢å™¨</th></tr></thead><tbody><tr><td>æ€§è´¨</td><td>çº¿æ€§æ»¤æ³¢</td><td>éçº¿æ€§æ»¤æ³¢</td></tr><tr><td>è¾¹ç¼˜ä¿ç•™</td><td>ä¸ä¿ç•™è¾¹ç¼˜ï¼Œæ¨¡ç³Šè¾¹ç¼˜</td><td>ä¿ç•™è¾¹ç¼˜ï¼Œå¯¹è¾¹ç¼˜å½±å“è¾ƒå°</td></tr><tr><td>è®¡ç®—å¤æ‚åº¦</td><td>ä½</td><td>é«˜</td></tr><tr><td>å®ç°éš¾åº¦</td><td>ç®€å•</td><td>è¾ƒå¤æ‚</td></tr><tr><td>é€‚ç”¨åœºæ™¯</td><td>å¿«é€Ÿå¹³æ»‘ã€é«˜é¢‘å™ªå£°è¾ƒå°‘çš„åœºæ™¯</td><td>é«˜è´¨é‡æŠ—é”¯é½¿ï¼Œä¿ç•™çº¹ç†å’Œè¾¹ç¼˜</td></tr></tbody></table></div><p><img src=/articles/camera-isp/image-8.png width=579 height=377 srcset="/articles/camera-isp/image-8_hu_21ff595838d09d20.png 480w, /articles/camera-isp/image-8_hu_3e8c4bc12fca94b4.png 1024w" loading=lazy alt="å›¾18 é”¯é½¿æ»¤æ³¢å‰" class=gallery-image data-flex-grow=153 data-flex-basis=368px> <img src=/articles/camera-isp/image-11.png width=579 height=377 srcset="/articles/camera-isp/image-11_hu_50581154a7c93451.png 480w, /articles/camera-isp/image-11_hu_c010aec987189e7c.png 1024w" loading=lazy alt="å›¾19 é”¯é½¿æ»¤æ³¢å" class=gallery-image data-flex-grow=153 data-flex-basis=368px></p><details class=popup-details><summary>ç¤ºä¾‹ä»£ç ï¼ˆåŒè¾¹æ»¤æ³¢å™¨</summary><div class=popup-content><button class=close-btn>âœ–</button><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @brief Computes the Gaussian weight for a given difference.
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @param x The difference (distance in space or intensity).
</span></span></span><span class=line><span class=cl><span class=cm> * @param sigma The standard deviation of the Gaussian function.
</span></span></span><span class=line><span class=cl><span class=cm> * @return The computed Gaussian weight.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kt>double</span> <span class=nf>gaussian</span><span class=p>(</span><span class=kt>double</span> <span class=n>x</span><span class=p>,</span> <span class=kt>double</span> <span class=n>sigma</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>std</span><span class=o>::</span><span class=n>exp</span><span class=p>(</span><span class=o>-</span><span class=n>x</span> <span class=o>*</span> <span class=n>x</span> <span class=o>/</span> <span class=p>(</span><span class=mf>2.0</span> <span class=o>*</span> <span class=n>sigma</span> <span class=o>*</span> <span class=n>sigma</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @brief Applies a bilateral filter to an ImageRaw object.
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @param src Input image.
</span></span></span><span class=line><span class=cl><span class=cm> * @param dst Output image (should be pre-initialized to the same size as src).
</span></span></span><span class=line><span class=cl><span class=cm> * @param d The diameter of the filter kernel (must be an odd number).
</span></span></span><span class=line><span class=cl><span class=cm> * @param sigmaColor The standard deviation in the intensity space.
</span></span></span><span class=line><span class=cl><span class=cm> * @param sigmaSpace The standard deviation in the spatial space.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>applyBilateralFilter</span><span class=p>(</span><span class=k>const</span> <span class=n>ImageRaw</span><span class=o>&amp;</span> <span class=n>src</span><span class=p>,</span> <span class=n>ImageRaw</span><span class=o>&amp;</span> <span class=n>dst</span><span class=p>,</span> <span class=kt>int</span> <span class=n>d</span><span class=p>,</span> <span class=kt>double</span> <span class=n>sigmaColor</span><span class=p>,</span> <span class=kt>double</span> <span class=n>sigmaSpace</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>height</span> <span class=o>=</span> <span class=n>src</span><span class=p>.</span><span class=n>getHeight</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>width</span> <span class=o>=</span> <span class=n>src</span><span class=p>.</span><span class=n>getWidth</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// Ensure kernel size is odd
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>d</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=n>std</span><span class=o>::</span><span class=n>invalid_argument</span><span class=p>(</span><span class=s>&#34;Kernel size must be odd.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Precompute spatial Gaussian weights
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int</span> <span class=n>radius</span> <span class=o>=</span> <span class=n>d</span> <span class=o>/</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>double</span><span class=o>&gt;&gt;</span> <span class=n>spatialKernel</span><span class=p>(</span><span class=n>d</span><span class=p>,</span> <span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>double</span><span class=o>&gt;</span><span class=p>(</span><span class=n>d</span><span class=p>,</span> <span class=mf>0.0</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=o>-</span><span class=n>radius</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>radius</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=o>-</span><span class=n>radius</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;=</span> <span class=n>radius</span><span class=p>;</span> <span class=o>++</span><span class=n>j</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>spatialKernel</span><span class=p>[</span><span class=n>i</span> <span class=o>+</span> <span class=n>radius</span><span class=p>][</span><span class=n>j</span> <span class=o>+</span> <span class=n>radius</span><span class=p>]</span> <span class=o>=</span> <span class=n>gaussian</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>sqrt</span><span class=p>(</span><span class=n>i</span> <span class=o>*</span> <span class=n>i</span> <span class=o>+</span> <span class=n>j</span> <span class=o>*</span> <span class=n>j</span><span class=p>),</span> <span class=n>sigmaSpace</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Perform bilateral filtering
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>height</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>width</span><span class=p>;</span> <span class=o>++</span><span class=n>j</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>double</span> <span class=n>weightedSum</span> <span class=o>=</span> <span class=mf>0.0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=kt>double</span> <span class=n>normalizationFactor</span> <span class=o>=</span> <span class=mf>0.0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=kt>uint16_t</span> <span class=n>centerPixel</span> <span class=o>=</span> <span class=n>src</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>j</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>ki</span> <span class=o>=</span> <span class=o>-</span><span class=n>radius</span><span class=p>;</span> <span class=n>ki</span> <span class=o>&lt;=</span> <span class=n>radius</span><span class=p>;</span> <span class=o>++</span><span class=n>ki</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>kj</span> <span class=o>=</span> <span class=o>-</span><span class=n>radius</span><span class=p>;</span> <span class=n>kj</span> <span class=o>&lt;=</span> <span class=n>radius</span><span class=p>;</span> <span class=o>++</span><span class=n>kj</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=kt>int</span> <span class=n>ni</span> <span class=o>=</span> <span class=n>i</span> <span class=o>+</span> <span class=n>ki</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=kt>int</span> <span class=n>nj</span> <span class=o>=</span> <span class=n>j</span> <span class=o>+</span> <span class=n>kj</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=c1>// Skip out-of-bound pixels
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=k>if</span> <span class=p>(</span><span class=n>ni</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=o>||</span> <span class=n>ni</span> <span class=o>&gt;=</span> <span class=n>height</span> <span class=o>||</span> <span class=n>nj</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=o>||</span> <span class=n>nj</span> <span class=o>&gt;=</span> <span class=n>width</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=kt>uint16_t</span> <span class=n>neighborPixel</span> <span class=o>=</span> <span class=n>src</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>ni</span><span class=p>,</span> <span class=n>nj</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=c1>// Compute intensity Gaussian weight
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=kt>double</span> <span class=n>intensityWeight</span> <span class=o>=</span> <span class=n>gaussian</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>abs</span><span class=p>((</span><span class=kt>int</span><span class=p>)</span><span class=n>centerPixel</span> <span class=o>-</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=n>neighborPixel</span><span class=p>),</span> <span class=n>sigmaColor</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=c1>// Compute final weight
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=kt>double</span> <span class=n>weight</span> <span class=o>=</span> <span class=n>spatialKernel</span><span class=p>[</span><span class=n>ki</span> <span class=o>+</span> <span class=n>radius</span><span class=p>][</span><span class=n>kj</span> <span class=o>+</span> <span class=n>radius</span><span class=p>]</span> <span class=o>*</span> <span class=n>intensityWeight</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=c1>// Accumulate weighted sum and normalization factor
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=n>weightedSum</span> <span class=o>+=</span> <span class=n>neighborPixel</span> <span class=o>*</span> <span class=n>weight</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=n>normalizationFactor</span> <span class=o>+=</span> <span class=n>weight</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// Assign the filtered value to the destination image
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>dst</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>j</span><span class=p>)</span> <span class=o>=</span> <span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>uint16_t</span><span class=o>&gt;</span><span class=p>(</span><span class=n>weightedSum</span> <span class=o>/</span> <span class=n>normalizationFactor</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></details><h3 id=è‡ªåŠ¨ç™½å¹³è¡¡auto-white-balanceawb>è‡ªåŠ¨ç™½å¹³è¡¡ï¼ˆAuto White Balanceï¼ŒAWBï¼‰</h3><p>äººçš„è§†è§‰å’Œç¥ç»ç³»ç»Ÿå…·æœ‰è‰²å½©æ’å¸¸æ€§ï¼Œåœ¨çœ‹åˆ°ç™½è‰²ç‰©ä½“çš„æ—¶å€™åŸºæœ¬ä¸å—ç¯å¢ƒå…‰æºå˜åŒ–çš„å½±å“ã€‚ä½†æ˜¯image sensorå¹¶ä¸èƒ½åƒäººçš„è§†è§‰ç³»ç»Ÿä¸€æ ·è‡ªåŠ¨è°ƒèŠ‚ï¼Œåœ¨ä¸åŒè‰²æ¸©å…‰æºä¸‹ï¼Œæ‹å‡ºçš„ç…§ç‰‡ä¸­ç™½è‰²ä¼šå‡ºç°åè‰²çš„æƒ…å†µã€‚è‡ªåŠ¨ç™½å¹³è¡¡å°±æ˜¯ç”¨æ¥æ¨¡æ‹Ÿäººç±»çš„è‰²å½©æ’å¸¸èƒ½åŠ›ï¼Œåœ¨å›¾åƒä¸­å»é™¤å…‰æºå¼•èµ·çš„åè‰²ï¼Œä»è€Œè¿˜åŸè‡ªç„¶çš„è‰²å½©ã€‚</p><p>è‡ªåŠ¨ç™½å¹³è¡¡ç®—æ³•æ ¹æ®æŠ€æœ¯è·¯çº¿å¯ä»¥å½’ç»“ä¸ºå‡ å¤§ç±»ï¼Œåˆ†åˆ«æ˜¯ï¼š</p><ul><li>åœºæ™¯å‡è®¾æ¨¡å‹ï¼šç°åº¦ä¸–ç•Œã€å®Œç¾åå°„</li><li>ç‚¹ç»Ÿè®¡æ¨¡å‹ï¼šç™½è‰²ç‚¹ä¼°è®¡ã€åˆ†å—æƒé‡</li></ul><ol><li>ç°åº¦ä¸–ç•Œç®—æ³•<br>è¯¥ç®—æ³•å‡è®¾ï¼šå¯¹äºä¸€å‰¯æœ‰ç€ä¸°å¯Œè‰²å½©çš„å›¾ç‰‡ï¼Œå›¾åƒä¸ŠRã€Gã€Bä¸‰ä¸ªé€šé“çš„å¹³å‡å€¼åº”è¯¥ç­‰äºä¸€ä¸ªè¢«ç§°ä¸ºâ€œç°è‰²â€çš„å€¼$K$ã€‚è‡³äºâ€œç°è‰²â€å€¼Kçš„é€‰æ‹©ï¼Œä¸€ç§æ–¹æ³•æ˜¯å°†å¾…å¤„ç†å›¾ç‰‡ä¸‰ä¸ªé€šé“å‡å€¼çš„å‡å€¼ä½œä¸ºâ€œç°è‰²â€å€¼$K$ã€‚å½“ç¡®å®šäº†ç°è‰²å€¼Kä¹‹åï¼Œå¾…å¤„ç†å›¾ç‰‡å„ä¸ªé€šé“çš„æ ¡æ­£ç³»æ•°åˆ†åˆ«ä¸ºï¼š$k_r=K/R_{mean}ï¼Œk_g=K/G_{mean}ï¼Œk_b=K/B_{mean}$ï¼Œå…¶ä¸­$R_{mean}ï¼ŒG_{mean}å’ŒB_{mean}$åˆ†åˆ«ä¸ºå›¾åƒRã€Gã€Bé€šé“çš„å‡å€¼ã€‚</li></ol><details class=popup-details><summary>ç¤ºä¾‹ä»£ç </summary><div class=popup-content><button class=close-btn>âœ–</button><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;iostream&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;vector&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;numeric&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdexcept&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @brief Apply the Gray World Algorithm to an ImageRaw.
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * This algorithm adjusts the R, G, and B channels of the input image so that their
</span></span></span><span class=line><span class=cl><span class=cm> * mean values are equal to a common gray level \( K \). This corrects the overall
</span></span></span><span class=line><span class=cl><span class=cm> * color balance of the image.
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @param src Input image. Must have 3 channels (RGB format).
</span></span></span><span class=line><span class=cl><span class=cm> * @param dst Output image. Must have the same size as the input image.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>grayWorldAlgorithm</span><span class=p>(</span><span class=k>const</span> <span class=n>ImageRaw</span><span class=o>&amp;</span> <span class=n>src</span><span class=p>,</span> <span class=n>ImageRaw</span><span class=o>&amp;</span> <span class=n>dst</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Validate input image dimensions
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>src</span><span class=p>.</span><span class=n>getWidth</span><span class=p>()</span> <span class=o>!=</span> <span class=n>dst</span><span class=p>.</span><span class=n>getWidth</span><span class=p>()</span> <span class=o>||</span> <span class=n>src</span><span class=p>.</span><span class=n>getHeight</span><span class=p>()</span> <span class=o>!=</span> <span class=n>dst</span><span class=p>.</span><span class=n>getHeight</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=n>std</span><span class=o>::</span><span class=n>invalid_argument</span><span class=p>(</span><span class=s>&#34;Input and output images must have the same dimensions.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>width</span> <span class=o>=</span> <span class=n>src</span><span class=p>.</span><span class=n>getWidth</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>height</span> <span class=o>=</span> <span class=n>src</span><span class=p>.</span><span class=n>getHeight</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Accumulators for R, G, B channel sums
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>uint64_t</span> <span class=n>sumR</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>sumG</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>sumB</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>numPixels</span> <span class=o>=</span> <span class=n>width</span> <span class=o>*</span> <span class=n>height</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Compute channel-wise sums
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>height</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>width</span><span class=p>;</span> <span class=o>++</span><span class=n>j</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>uint16_t</span> <span class=n>r</span> <span class=o>=</span> <span class=n>src</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>j</span> <span class=o>*</span> <span class=mi>3</span><span class=p>);</span>     <span class=c1>// Assume RGB channels are stored in sequence
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=kt>uint16_t</span> <span class=n>g</span> <span class=o>=</span> <span class=n>src</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>j</span> <span class=o>*</span> <span class=mi>3</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=kt>uint16_t</span> <span class=n>b</span> <span class=o>=</span> <span class=n>src</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>j</span> <span class=o>*</span> <span class=mi>3</span> <span class=o>+</span> <span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>sumR</span> <span class=o>+=</span> <span class=n>r</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>sumG</span> <span class=o>+=</span> <span class=n>g</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>sumB</span> <span class=o>+=</span> <span class=n>b</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Compute mean values for each channel
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>double</span> <span class=n>meanR</span> <span class=o>=</span> <span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>double</span><span class=o>&gt;</span><span class=p>(</span><span class=n>sumR</span><span class=p>)</span> <span class=o>/</span> <span class=n>numPixels</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>double</span> <span class=n>meanG</span> <span class=o>=</span> <span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>double</span><span class=o>&gt;</span><span class=p>(</span><span class=n>sumG</span><span class=p>)</span> <span class=o>/</span> <span class=n>numPixels</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>double</span> <span class=n>meanB</span> <span class=o>=</span> <span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>double</span><span class=o>&gt;</span><span class=p>(</span><span class=n>sumB</span><span class=p>)</span> <span class=o>/</span> <span class=n>numPixels</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Compute the target gray value \( K \) as the average of all channel means
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>double</span> <span class=n>K</span> <span class=o>=</span> <span class=p>(</span><span class=n>meanR</span> <span class=o>+</span> <span class=n>meanG</span> <span class=o>+</span> <span class=n>meanB</span><span class=p>)</span> <span class=o>/</span> <span class=mf>3.0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Compute correction factors
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>double</span> <span class=n>kR</span> <span class=o>=</span> <span class=n>K</span> <span class=o>/</span> <span class=n>meanR</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>double</span> <span class=n>kG</span> <span class=o>=</span> <span class=n>K</span> <span class=o>/</span> <span class=n>meanG</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>double</span> <span class=n>kB</span> <span class=o>=</span> <span class=n>K</span> <span class=o>/</span> <span class=n>meanB</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Apply correction to each pixel
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>height</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>width</span><span class=p>;</span> <span class=o>++</span><span class=n>j</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>uint16_t</span> <span class=n>r</span> <span class=o>=</span> <span class=n>src</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>j</span> <span class=o>*</span> <span class=mi>3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=kt>uint16_t</span> <span class=n>g</span> <span class=o>=</span> <span class=n>src</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>j</span> <span class=o>*</span> <span class=mi>3</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=kt>uint16_t</span> <span class=n>b</span> <span class=o>=</span> <span class=n>src</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>j</span> <span class=o>*</span> <span class=mi>3</span> <span class=o>+</span> <span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// Adjust each channel and clip the values to the valid range
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>dst</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>j</span> <span class=o>*</span> <span class=mi>3</span><span class=p>)</span> <span class=o>=</span> <span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>uint16_t</span><span class=o>&gt;</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>min</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>max</span><span class=p>(</span><span class=n>r</span> <span class=o>*</span> <span class=n>kR</span><span class=p>,</span> <span class=mf>0.0</span><span class=p>),</span> <span class=mf>65535.0</span><span class=p>));</span>
</span></span><span class=line><span class=cl>            <span class=n>dst</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>j</span> <span class=o>*</span> <span class=mi>3</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>=</span> <span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>uint16_t</span><span class=o>&gt;</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>min</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>max</span><span class=p>(</span><span class=n>g</span> <span class=o>*</span> <span class=n>kG</span><span class=p>,</span> <span class=mf>0.0</span><span class=p>),</span> <span class=mf>65535.0</span><span class=p>));</span>
</span></span><span class=line><span class=cl>            <span class=n>dst</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>j</span> <span class=o>*</span> <span class=mi>3</span> <span class=o>+</span> <span class=mi>2</span><span class=p>)</span> <span class=o>=</span> <span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>uint16_t</span><span class=o>&gt;</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>min</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>max</span><span class=p>(</span><span class=n>b</span> <span class=o>*</span> <span class=n>kB</span><span class=p>,</span> <span class=mf>0.0</span><span class=p>),</span> <span class=mf>65535.0</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></details><ol start=2><li>å®Œç¾åå°„æ³•
è¯¥ç®—æ³•å‡è®¾ï¼šâ€œé•œé¢â€å¯ä»¥å®Œå…¨å‘å°„å…‰æºç…§å°„åœ¨ç‰©ä½“ä¸Šé¢çš„å…‰çº¿ã€‚å› æ­¤ï¼Œå¦‚æœå›¾åƒä¸­å­˜åœ¨ä¸€ä¸ªâ€œé•œé¢â€çš„è¯ï¼Œé‚£ä¹ˆåœ¨ç‰¹å®šå…‰æºä¸‹ï¼Œå¯ä»¥å°†æ‰€è·å¾—çš„â€œé•œé¢â€çš„è‰²å½©ä¿¡æ¯è®¤ä¸ºæ˜¯å½“å‰å…‰æºçš„ä¿¡æ¯ã€‚åœ¨è¿›è¡Œç™½å¹³è¡¡æ ¡å‡†çš„æ—¶å€™ï¼Œå‡è®¾å›¾ç‰‡ä¸Šå­˜åœ¨ä¸€ä¸ªå¯ä»¥å®Œå…¨åå°„å…‰æºçš„â€œé•œé¢â€ï¼Œé‚£ä¹ˆåœ¨ç»å…¸å…‰æºä¸‹å›¾ç‰‡ä¸­å°±åº”è¯¥å­˜åœ¨ä¸€ä¸ªä¸‰åˆºæ¿€å€¼ä¸º[255,255,255]çº¯ç™½è‰²åƒç´ ç‚¹ï¼ˆæœ‰å¤šç§ç™½è‰²ç‚¹å®šä¹‰ï¼Œè¿™æ˜¯ä¸€ç§ï¼‰ï¼Œæ­¤æ—¶å¾…å¤„ç†å›¾ç‰‡å„ä¸ªé€šé“çš„æ ¡æ­£ç³»æ•°åˆ†åˆ«ä¸ºï¼š$k_r=255/R_{max}ï¼Œk_g=255/G_{max}ï¼Œk_b=255/B_{max}$ï¼Œå…¶ä¸­$R_{max}ï¼ŒG_{max}å’ŒB_{max}$åˆ†åˆ«ä¸ºå›¾åƒRã€Gã€Bé€šé“çš„æœ€å¤§å€¼ã€‚</li></ol><details class=popup-details><summary>ç¤ºä¾‹ä»£ç -å®Œç¾åå°„æ³•</summary><div class=popup-content><button class=close-btn>âœ–</button><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp></code></pre></td></tr></table></div></div></div></details><ol start=3><li>ç»Ÿè®¡åŠ æƒç™½ç‚¹æ³•ï¼ˆé€šå¸¸åœ¨éœ€è¦æ¯”è¾ƒé«˜å›¾åƒè´¨é‡æ—¶ä½¿ç”¨ï¼‰
è¯¥ç®—æ³•é¦–å…ˆéœ€è¦å¯¹ä¼ æ„Ÿå™¨è¿›è¡Œå…‰æºæ ‡å®šå¾—åˆ°è‰²æ¸©æ›²çº¿ã€‚æŠ˜çº¿ä¸Šçš„ç‚¹æ˜¯åœ¨äº§çº¿ä¸Šé’ˆå¯¹ä¸åŒå…‰æº(D65, Aå…‰ï¼ŒHå…‰ç­‰)ä½¿ç”¨æ ‡å‡†ç™½/ç°å¡çº¸æ‹å‡ºç…§ç‰‡ç®—å‡ºæ¥çš„$R_{gain}=R_{mean}/G_{mean}$å’Œ$B_{gain}=B_{mean}/G_{mean}$åæ ‡ã€‚æ ¡å‡†æ—¶å°†å›¾ç‰‡åˆ†ä¸ºMå—ï¼Œåˆ†åˆ«è®¡ç®—æ¯å—çš„$R_{gain}$å’Œ$B_{gain}$å’Œï¼Œä½œä¸ºä¸€ä¸ªâ€œç™½ç‚¹â€ï¼Œå°†å€¼é è¿‘æŠ˜çº¿åŒºåŸŸ(çº¢è‰²)çš„â€œç™½ç‚¹â€æƒé‡åŠ é«˜ï¼Œè¿œç¦»çš„(è“è‰²)æƒé‡é™ä½ï¼Œå†è®¡ç®—å‡ºåŠ æƒå¹³å‡å€¼å¾—åˆ°æœ€ç»ˆâ€œç™½ç‚¹â€çš„$R_{gain}$å’Œ$B_{gain}$ï¼Œä½¿ç”¨æŠ˜çº¿ä¸Šçš„ä¸åŒç‚¹åšæ’å€¼è®¡ç®—å‡ºä¸€ä¸ªæœ€ç»ˆ$R_{gain}$å’Œ$B_{gain}$å€¼ã€‚</li></ol><p><img src=/articles/camera-isp/image-12.png width=640 height=371 srcset="/articles/camera-isp/image-12_hu_9ee28044553d68c9.png 480w, /articles/camera-isp/image-12_hu_9122bf4fa42403f5.png 1024w" loading=lazy alt="å›¾20 è‰²æ¸©å¢ç›Šæ›²çº¿" class=gallery-image data-flex-grow=172 data-flex-basis=414px></p><details class=popup-details><summary>ç¤ºä¾‹ä»£ç -ç»Ÿè®¡åŠ æƒç™½ç‚¹æ³•</summary><div class=popup-content><button class=close-btn>âœ–</button><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp></code></pre></td></tr></table></div></div></div></details><h3 id=å»é©¬èµ›å…‹demosaicing>å»é©¬èµ›å…‹ï¼ˆDemosaicingï¼‰</h3><p>ä¹‹å‰æåˆ°äº†æ™®é€šçš„CMOSå›¾åƒä¼ æ„Ÿå™¨æ— æ³•â€œæ•è·â€è‰²å½©ä¿¡æ¯ï¼Œè§£å†³æ–¹æ³•æ˜¯é€šè¿‡Bayeré˜µåˆ—çš„å¸¦æœ‰ä¸åŒé¢œè‰²æ»¤å…‰ç‰‡çš„åƒç´ ç‚¹è®°å½•å¯¹åº”é€šé“çš„äº®åº¦å€¼ï¼Œæœ€åæ’å€¼å¾—åˆ°æ¯ä¸ªåƒç´ ç‚¹çš„RGBä¸‰é€šé“å€¼ã€‚ç”±äºé€šè¿‡CMOSå¾—åˆ°çš„Bayeræ ¼å¼çš„RAWå›¾æ”¾å¤§çœ‹èµ·æ¥å°±åƒé©¬èµ›å…‹ï¼Œè¿™ä¸ªä»ç°åº¦å›¾ç‰‡è¿˜åŸå›¾ç‰‡è‰²å½©çš„è¿‡ç¨‹åˆå«å»é©¬èµ›å…‹ã€‚ï¼ˆDemosaicingï¼‰</p><p><img src=/articles/camera-isp/raw_mask.gif width=450 height=337 srcset="/articles/camera-isp/raw_mask_hu_8a4c574e3f433800.gif 480w, /articles/camera-isp/raw_mask_hu_e20c410c4cd3ec3e.gif 1024w" loading=lazy alt="å›¾21 RAWå›¾æ”¾å¤§" class=gallery-image data-flex-grow=133 data-flex-basis=320px> <img src=/articles/camera-isp/table.jpg width=4096 height=3072 srcset="/articles/camera-isp/table_hu_cfbebec0347767d.jpg 480w, /articles/camera-isp/table_hu_f197998cc7dc4988.jpg 1024w" loading=lazy alt="å›¾22 Jpegå›¾" class=gallery-image data-flex-grow=133 data-flex-basis=320px></p><p>Demosiacçš„æ’å€¼ä¸€èˆ¬éµå¾ªä»¥ä¸‹å‡ ä¸ªåŸåˆ™ï¼š<br>1.å…ˆå¯¹Gåˆ†é‡è¿›è¡Œæ’å€¼ï¼Œå› ä¸ºGé€šé“çš„åƒç´ æ•°é‡æ˜¯GBé€šé“çš„ä¸¤å€<br>2.æ’å€¼æ—¶é‡‡ç”¨æ–¹å‘æ€§æ’å€¼ï¼Œå³å¦‚æœæ˜¯å‚ç›´çš„è¾¹ç¼˜ï¼Œåˆ™é‡‡ç”¨ä¸Šä¸‹çš„åƒç´ æ’å€¼ï¼Œè€Œä¸é€‰ç”¨å·¦å³<br>3.å“ˆå¯†å°”é¡¿(Hamilton)è‰²å·®æ’å®šåŸç†ï¼Œ$R(i,j)-G(i,j)=R(i,j+1)-G(i,j+1)$ï¼Œå³ç›¸é‚»ç‚¹è‰²å·®ç›¸åŒ<br>4.å„ä¸ªé¢œè‰²åˆ†é‡åœ¨åŒä¸€åƒç´ ç‚¹å¤„çš„é«˜é¢‘åˆ†é‡å¯è®¤ä¸ºæ˜¯ç›¸åŒçš„</p><p>å…·ä½“è€Œè¨€ï¼Œä¸€ä¸ªç®€å•çš„å»é©¬èµ›å…‹æµç¨‹å¯ä»¥æ˜¯ï¼š<br>1.è·å–å›¾åƒä¸­çš„ç‰©ä½“çš„è¾¹ç¼˜
2.æ ¹æ®è¾¹ç¼˜ä¿¡æ¯æ’å€¼é‡å»ºGåˆ†é‡
3.æ ¹æ®å“ˆå¯†å°”é¡¿æå‡ºçš„è‰²å·®æ’å®šç†è®ºï¼Œæ ¹æ®è‰²å·®æ’å€¼é‡å»ºRå’ŒBåˆ†é‡
4.ä¸€äº›åå¤„ç†ï¼ŒåŒ…æ‹¬ä¼ªå½©è‰²æŠ‘åˆ¶ï¼ˆpseudocolor suppressionï¼‰å’Œæ‹‰é“¾æ•ˆåº”æŠ‘åˆ¶ï¼ˆzipper cancellingï¼‰ç­‰</p><p>æ‰©å±•é˜…è¯»ï¼š<a class=link href=https://zhuanlan.zhihu.com/p/563755436 target=_blank rel=noopener>ä½æˆæœ¬è¾¹ç¼˜ä¸è‰²å·®æ’å€¼å»é©¬èµ›å…‹ç®—æ³•ï¼ˆLEDï¼‰</a></p><details class=popup-details><summary>ç¤ºä¾‹ä»£ç -LEDæ³•</summary><div class=popup-content><button class=close-btn>âœ–</button><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>// ç¤ºä¾‹ä»£ç ï¼šå»é©¬èµ›å…‹ç®—æ³•å®ç°ï¼ˆåŸºäºæ–¹å‘æ€§æ’å€¼å’Œè‰²å·®æ’å®šç†è®ºï¼‰
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;vector&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;cmath&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;algorithm&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=k>using</span> <span class=k>namespace</span> <span class=n>std</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// è·å–æ¢¯åº¦ä¿¡æ¯
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=nf>compute_gradients</span><span class=p>(</span><span class=k>const</span> <span class=n>vector</span><span class=o>&lt;</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;&gt;&amp;</span> <span class=n>image</span><span class=p>,</span> <span class=n>vector</span><span class=o>&lt;</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;&gt;&amp;</span> <span class=n>grad_h</span><span class=p>,</span> <span class=n>vector</span><span class=o>&lt;</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;&gt;&amp;</span> <span class=n>grad_v</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>rows</span> <span class=o>=</span> <span class=n>image</span><span class=p>.</span><span class=n>size</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>cols</span> <span class=o>=</span> <span class=n>image</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>size</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>grad_h</span><span class=p>.</span><span class=n>resize</span><span class=p>(</span><span class=n>rows</span><span class=p>,</span> <span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=p>(</span><span class=n>cols</span><span class=p>,</span> <span class=mi>0</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=n>grad_v</span><span class=p>.</span><span class=n>resize</span><span class=p>(</span><span class=n>rows</span><span class=p>,</span> <span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=p>(</span><span class=n>cols</span><span class=p>,</span> <span class=mi>0</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>rows</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>cols</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span> <span class=o>++</span><span class=n>j</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>grad_h</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=n>abs</span><span class=p>(</span><span class=n>image</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span> <span class=o>+</span> <span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=n>image</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>            <span class=n>grad_v</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=n>abs</span><span class=p>(</span><span class=n>image</span><span class=p>[</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>-</span> <span class=n>image</span><span class=p>[</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>][</span><span class=n>j</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// æ–¹å‘æ€§æ’å€¼é‡å»ºGåˆ†é‡
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=nf>reconstruct_green</span><span class=p>(</span><span class=k>const</span> <span class=n>vector</span><span class=o>&lt;</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;&gt;&amp;</span> <span class=n>bayer</span><span class=p>,</span> <span class=n>vector</span><span class=o>&lt;</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;&gt;&amp;</span> <span class=n>green</span><span class=p>,</span> <span class=k>const</span> <span class=n>vector</span><span class=o>&lt;</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;&gt;&amp;</span> <span class=n>grad_h</span><span class=p>,</span> <span class=k>const</span> <span class=n>vector</span><span class=o>&lt;</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;&gt;&amp;</span> <span class=n>grad_v</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>rows</span> <span class=o>=</span> <span class=n>bayer</span><span class=p>.</span><span class=n>size</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>cols</span> <span class=o>=</span> <span class=n>bayer</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>size</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>green</span> <span class=o>=</span> <span class=n>bayer</span><span class=p>;</span> <span class=c1>// åˆå§‹ä¸º Bayer å›¾åƒ
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>rows</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>cols</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span> <span class=o>++</span><span class=n>j</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>((</span><span class=n>i</span> <span class=o>+</span> <span class=n>j</span><span class=p>)</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span> <span class=c1>// å½“å‰åƒç´ ä¸æ˜¯ G
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>if</span> <span class=p>(</span><span class=n>grad_h</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>grad_v</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>green</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>bayer</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]</span> <span class=o>+</span> <span class=n>bayer</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span> <span class=o>+</span> <span class=mi>1</span><span class=p>])</span> <span class=o>/</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>green</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>bayer</span><span class=p>[</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>+</span> <span class=n>bayer</span><span class=p>[</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>][</span><span class=n>j</span><span class=p>])</span> <span class=o>/</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// æ ¹æ®è‰²å·®æ’å®šç†è®ºé‡å»º R å’Œ B åˆ†é‡
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=nf>reconstruct_red_blue</span><span class=p>(</span><span class=k>const</span> <span class=n>vector</span><span class=o>&lt;</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;&gt;&amp;</span> <span class=n>bayer</span><span class=p>,</span> <span class=k>const</span> <span class=n>vector</span><span class=o>&lt;</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;&gt;&amp;</span> <span class=n>green</span><span class=p>,</span> <span class=n>vector</span><span class=o>&lt;</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;&gt;&amp;</span> <span class=n>red</span><span class=p>,</span> <span class=n>vector</span><span class=o>&lt;</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;&gt;&amp;</span> <span class=n>blue</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>rows</span> <span class=o>=</span> <span class=n>bayer</span><span class=p>.</span><span class=n>size</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>cols</span> <span class=o>=</span> <span class=n>bayer</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>size</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>red</span> <span class=o>=</span> <span class=n>bayer</span><span class=p>;</span> <span class=c1>// åˆå§‹ä¸º Bayer å›¾åƒ
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>blue</span> <span class=o>=</span> <span class=n>bayer</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>rows</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>cols</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span> <span class=o>++</span><span class=n>j</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>((</span><span class=n>i</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>j</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span> <span class=o>||</span> <span class=p>(</span><span class=n>i</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>==</span> <span class=mi>1</span> <span class=o>&amp;&amp;</span> <span class=n>j</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>==</span> <span class=mi>0</span><span class=p>))</span> <span class=p>{</span> <span class=c1>// å½“å‰åƒç´ æ˜¯ G
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>red</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=n>green</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>+</span> <span class=p>(</span><span class=n>bayer</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span> <span class=o>+</span> <span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=n>green</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span> <span class=o>+</span> <span class=mi>1</span><span class=p>]</span> <span class=o>+</span> <span class=n>bayer</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=n>green</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span> <span class=o>-</span> <span class=mi>1</span><span class=p>])</span> <span class=o>/</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>blue</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=n>green</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>+</span> <span class=p>(</span><span class=n>bayer</span><span class=p>[</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>-</span> <span class=n>green</span><span class=p>[</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>+</span> <span class=n>bayer</span><span class=p>[</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>-</span> <span class=n>green</span><span class=p>[</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>][</span><span class=n>j</span><span class=p>])</span> <span class=o>/</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>((</span><span class=n>i</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>j</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>==</span> <span class=mi>0</span><span class=p>))</span> <span class=p>{</span> <span class=c1>// å½“å‰åƒç´ æ˜¯ B
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>red</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=n>green</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>+</span> <span class=p>(</span><span class=n>bayer</span><span class=p>[</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>][</span><span class=n>j</span> <span class=o>+</span> <span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=n>green</span><span class=p>[</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>][</span><span class=n>j</span> <span class=o>+</span> <span class=mi>1</span><span class=p>]</span> <span class=o>+</span> <span class=n>bayer</span><span class=p>[</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>][</span><span class=n>j</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=n>green</span><span class=p>[</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>][</span><span class=n>j</span> <span class=o>-</span> <span class=mi>1</span><span class=p>])</span> <span class=o>/</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span> <span class=c1>// å½“å‰åƒç´ æ˜¯ R
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>blue</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=n>green</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>+</span> <span class=p>(</span><span class=n>bayer</span><span class=p>[</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>][</span><span class=n>j</span> <span class=o>+</span> <span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=n>green</span><span class=p>[</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>][</span><span class=n>j</span> <span class=o>+</span> <span class=mi>1</span><span class=p>]</span> <span class=o>+</span> <span class=n>bayer</span><span class=p>[</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>][</span><span class=n>j</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=n>green</span><span class=p>[</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>][</span><span class=n>j</span> <span class=o>-</span> <span class=mi>1</span><span class=p>])</span> <span class=o>/</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// ä¼ªå½©è‰²æŠ‘åˆ¶ä¸æ‹‰é“¾æ•ˆåº”å»é™¤çš„åå¤„ç†
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=nf>post_process</span><span class=p>(</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;&gt;&amp;</span> <span class=n>red</span><span class=p>,</span> <span class=n>vector</span><span class=o>&lt;</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;&gt;&amp;</span> <span class=n>green</span><span class=p>,</span> <span class=n>vector</span><span class=o>&lt;</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;&gt;&amp;</span> <span class=n>blue</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>rows</span> <span class=o>=</span> <span class=n>red</span><span class=p>.</span><span class=n>size</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>cols</span> <span class=o>=</span> <span class=n>red</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>size</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>rows</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>cols</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span> <span class=o>++</span><span class=n>j</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>red</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=n>min</span><span class=p>(</span><span class=n>max</span><span class=p>(</span><span class=n>red</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>],</span> <span class=mi>0</span><span class=p>),</span> <span class=mi>255</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>green</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=n>min</span><span class=p>(</span><span class=n>max</span><span class=p>(</span><span class=n>green</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>],</span> <span class=mi>0</span><span class=p>),</span> <span class=mi>255</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>blue</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=n>min</span><span class=p>(</span><span class=n>max</span><span class=p>(</span><span class=n>blue</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>],</span> <span class=mi>0</span><span class=p>),</span> <span class=mi>255</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// ä¸»å‡½æ•°ï¼šå»é©¬èµ›å…‹
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=nf>demosaic</span><span class=p>(</span><span class=k>const</span> <span class=n>vector</span><span class=o>&lt;</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;&gt;&amp;</span> <span class=n>bayer</span><span class=p>,</span> <span class=n>vector</span><span class=o>&lt;</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;&gt;&amp;</span> <span class=n>red</span><span class=p>,</span> <span class=n>vector</span><span class=o>&lt;</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;&gt;&amp;</span> <span class=n>green</span><span class=p>,</span> <span class=n>vector</span><span class=o>&lt;</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;&gt;&amp;</span> <span class=n>blue</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>vector</span><span class=o>&lt;</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;&gt;</span> <span class=n>grad_h</span><span class=p>,</span> <span class=n>grad_v</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>compute_gradients</span><span class=p>(</span><span class=n>bayer</span><span class=p>,</span> <span class=n>grad_h</span><span class=p>,</span> <span class=n>grad_v</span><span class=p>);</span> <span class=c1>// è®¡ç®—æ¢¯åº¦
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>reconstruct_green</span><span class=p>(</span><span class=n>bayer</span><span class=p>,</span> <span class=n>green</span><span class=p>,</span> <span class=n>grad_h</span><span class=p>,</span> <span class=n>grad_v</span><span class=p>);</span> <span class=c1>// é‡å»º G åˆ†é‡
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>reconstruct_red_blue</span><span class=p>(</span><span class=n>bayer</span><span class=p>,</span> <span class=n>green</span><span class=p>,</span> <span class=n>red</span><span class=p>,</span> <span class=n>blue</span><span class=p>);</span> <span class=c1>// é‡å»º R å’Œ B åˆ†é‡
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>post_process</span><span class=p>(</span><span class=n>red</span><span class=p>,</span> <span class=n>green</span><span class=p>,</span> <span class=n>blue</span><span class=p>);</span> <span class=c1>// åå¤„ç†
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></details><h3 id=è‰²å½©æ ¡æ­£color-correction>è‰²å½©æ ¡æ­£ï¼ˆColor Correctionï¼‰</h3>$$\begin{bmatrix}R'\\G'\\B'\end{bmatrix}=\begin{bmatrix}m_{11}&m_{12}&m_{13}\\m_{21}&m_{22}&m_{23}\\m_{31}&m_{32}&m_{33}\end{bmatrix}\begin{bmatrix}R\\G\\B\end{bmatrix}$$<p>å…¶ä¸­R&rsquo;G&rsquo;B&rsquo;æ˜¯æ ¡æ­£åçš„é¢œè‰²å€¼ï¼ŒRGBæ˜¯ä¼ æ„Ÿå™¨æ•è·çš„åŸå§‹é¢œè‰²å€¼ã€‚</p><p><img src=/articles/camera-isp/image-14.png width=671 height=237 srcset="/articles/camera-isp/image-14_hu_2063ad73fa5b9e16.png 480w, /articles/camera-isp/image-14_hu_87444d92213ff484.png 1024w" loading=lazy alt="å›¾23 è‰²å½©æ ¡æ­£ç¤ºä¾‹" class=gallery-image data-flex-grow=283 data-flex-basis=679px></p><details class=popup-details><summary>ç¤ºä¾‹ä»£ç </summary><div class=popup-content><button class=close-btn>âœ–</button><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;vector&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;array&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1>// è‰²å½©æ ¡æ­£çŸ©é˜µå®šä¹‰
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>const</span> <span class=n>std</span><span class=o>::</span><span class=n>array</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>array</span><span class=o>&lt;</span><span class=kt>float</span><span class=p>,</span> <span class=mi>3</span><span class=o>&gt;</span><span class=p>,</span> <span class=mi>3</span><span class=o>&gt;</span> <span class=n>CCM</span> <span class=o>=</span> <span class=p>{{</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=mf>1.2f</span><span class=p>,</span> <span class=o>-</span><span class=mf>0.1f</span><span class=p>,</span> <span class=o>-</span><span class=mf>0.1f</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=o>-</span><span class=mf>0.2f</span><span class=p>,</span> <span class=mf>1.3f</span><span class=p>,</span> <span class=o>-</span><span class=mf>0.1f</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=o>-</span><span class=mf>0.1f</span><span class=p>,</span> <span class=o>-</span><span class=mf>0.2f</span><span class=p>,</span> <span class=mf>1.4f</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// å¯¹å•ä¸ªåƒç´ ç‚¹è¿›è¡Œè‰²å½©æ ¡æ­£
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>std</span><span class=o>::</span><span class=n>array</span><span class=o>&lt;</span><span class=kt>float</span><span class=p>,</span> <span class=mi>3</span><span class=o>&gt;</span> <span class=n>colorCorrection</span><span class=p>(</span><span class=k>const</span> <span class=n>std</span><span class=o>::</span><span class=n>array</span><span class=o>&lt;</span><span class=kt>float</span><span class=p>,</span> <span class=mi>3</span><span class=o>&gt;&amp;</span> <span class=n>input</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>array</span><span class=o>&lt;</span><span class=kt>float</span><span class=p>,</span> <span class=mi>3</span><span class=o>&gt;</span> <span class=n>output</span> <span class=o>=</span> <span class=p>{</span><span class=mf>0.0f</span><span class=p>,</span> <span class=mf>0.0f</span><span class=p>,</span> <span class=mf>0.0f</span><span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>3</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=mi>3</span><span class=p>;</span> <span class=o>++</span><span class=n>j</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>output</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>+=</span> <span class=n>CCM</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>*</span> <span class=n>input</span><span class=p>[</span><span class=n>j</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>output</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></details><p>è‰²å½©æ ¡æ­£åï¼Œä¹Ÿå¯ä»¥æ ¹æ®éœ€æ±‚å¯¹æ ¡æ­£åçš„é¢œè‰²è¿›ä¸€æ­¥è°ƒèŠ‚,ä¾‹å¦‚è‰²å½©å¢å¼ºæˆ–é£æ ¼åŒ–</p><h3 id=ä¼½é©¬çŸ«æ­£gamma-correction>ä¼½é©¬çŸ«æ­£ï¼ˆGamma Correctionï¼‰</h3><p>äººç±»å¯¹äº®åº¦çš„æ„ŸçŸ¥å¹¶éçº¿æ€§ï¼Œè€Œæ˜¯æ¥è¿‘å¹‚å‡½æ•°$L\propto I^{0.43}$ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å¯¹æš—éƒ¨ç»†èŠ‚æ›´åŠ æ•æ„Ÿï¼Œå¯¹äº®éƒ¨å˜åŒ–çš„æ„ŸçŸ¥èƒ½åŠ›è¾ƒå¼±ã€‚ä¸ºäº†é«˜æ•ˆåˆ©ç”¨æœ‰é™çš„ä½æ·±ï¼ˆbitæ•°ï¼‰ï¼Œä¼˜åŒ–ç¼–ç æ•ˆç‡ï¼Œå›¾åƒç¼–ç ä¼šæŒ‰ç…§äººç±»çš„è§†è§‰ç‰¹æ€§è¿›è¡Œéçº¿æ€§å˜æ¢ï¼Œå°†æ›´å¤šçš„ç¼–ç ç²¾åº¦åˆ†é…åˆ°æš—éƒ¨ï¼ˆäººç±»æ›´æ•æ„Ÿçš„éƒ¨åˆ†ï¼‰ï¼Œå‡å°‘äº®éƒ¨ï¼ˆäººç±»è¾ƒä¸æ•æ„Ÿéƒ¨åˆ†ï¼‰çš„ç²¾åº¦ã€‚è¿™ç§éçº¿æ€§ç¼–ç é€šå¸¸è¢«ç§°ä¸ºgammaç¼–ç ã€‚åŸºäºè¿™ç§ç¼–ç ç‰¹æ€§ï¼Œæ˜¾ç¤ºè®¾å¤‡ï¼ˆå¦‚æ˜¾ç¤ºå™¨ï¼‰ä¸ºäº†ä½¿å›¾åƒåœ¨è§†è§‰ä¸Šçœ‹èµ·æ¥æ­£ç¡®ï¼Œä¼šæ‰§è¡Œâ€œåGammaâ€æ“ä½œ$I_{output}=I_{input}^{\frac1\gamma}ï¼Œ\gamma$å¸¸å–2.2ï¼Œå³å°†ç¼–ç å›¾åƒçš„éçº¿æ€§äº®åº¦è¿˜åŸä¸ºçº¿æ€§äº®åº¦ã€‚</p><p>ä¸ºä»€ä¹ˆéœ€è¦Gammaç¼–ç ï¼š<br>å¦‚æœç›´æ¥å¯¹å›¾åƒè¿›è¡Œçº¿æ€§ç¼–ç å¹¶å­˜å‚¨æˆ–ä¼ è¾“ï¼Œæš—éƒ¨ç»†èŠ‚ä¼šè¢«è¿‡åº¦å‹ç¼©ï¼Œé€ æˆé‡è¦çš„è§†è§‰ä¿¡æ¯ä¸¢å¤±ã€‚åŒæ—¶ï¼Œæ˜¾ç¤ºè®¾å¤‡çš„åGammaæ ¡æ­£ä¼šè¿›ä¸€æ­¥æ”¾å¤§è¿™ç§ç°è±¡ï¼Œä½¿å¾—å›¾åƒæš—éƒ¨æ˜¾ç¤ºæ›´å·®ã€‚å› æ­¤ï¼Œä¸ºäº†ä¿è¯åœ¨æ˜¾ç¤ºè®¾å¤‡ä¸Šä¿æŒé¢„æœŸçš„äº®åº¦å’Œå¯¹æ¯”åº¦ï¼Œæ‹æ‘„çš„å›¾åƒéœ€è¦åœ¨ç¼–ç é˜¶æ®µè¿›è¡ŒGammaç¼–ç ã€‚</p><p><img src=/articles/camera-isp/image-13.png width=1953 height=688 srcset="/articles/camera-isp/image-13_hu_d79d5363d6dc289b.png 480w, /articles/camera-isp/image-13_hu_63402a34e289d2ba.png 1024w" loading=lazy alt="å›¾24 å›¾åƒç¼–ç å‰ä¸ºä»€ä¹ˆè¦è¿›è¡Œgammaæ ¡æ­£" class=gallery-image data-flex-grow=283 data-flex-basis=681px></p><details class=popup-details><summary>ç¤ºä¾‹ä»£ç </summary><div class=popup-content><button class=close-btn>âœ–</button><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;cmath&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1>// ä¼½é©¬çŸ«æ­£å‡½æ•°
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>float</span> <span class=nf>gammaCorrection</span><span class=p>(</span><span class=kt>float</span> <span class=n>value</span><span class=p>,</span> <span class=kt>float</span> <span class=n>gamma</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>std</span><span class=o>::</span><span class=n>pow</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=n>gamma</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// å¯¹æ•´å¹…å›¾åƒè¿›è¡Œä¼½é©¬çŸ«æ­£
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=nf>processImageGammaCorrection</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>array</span><span class=o>&lt;</span><span class=kt>float</span><span class=p>,</span> <span class=mi>3</span><span class=o>&gt;&gt;&amp;</span> <span class=n>image</span><span class=p>,</span> <span class=kt>float</span> <span class=n>gamma</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=k>auto</span><span class=o>&amp;</span> <span class=nl>pixel</span> <span class=p>:</span> <span class=n>image</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>3</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>pixel</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>gammaCorrection</span><span class=p>(</span><span class=n>pixel</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>gamma</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></details><h2 id=å…¶ä»–å›¾åƒå¤„ç†ç®—æ³•>å…¶ä»–å›¾åƒå¤„ç†ç®—æ³•</h2><h3 id=ç›´æ–¹å›¾å‡è¡¡åŒ–histogram-equalization>ç›´æ–¹å›¾å‡è¡¡åŒ–ï¼ˆHistogram Equalizationï¼‰</h3><p>ç›´æ–¹å›¾å‡è¡¡åŒ–æ˜¯ä¸€ç§å›¾åƒå¤„ç†æŠ€æœ¯ï¼Œé€šè¿‡è°ƒæ•´å›¾åƒçš„ç°åº¦çº§åˆ†å¸ƒï¼Œä½¿å¾—å›¾åƒçš„å¯¹æ¯”åº¦å¾—åˆ°æ”¹å–„ï¼Œä½†å¦‚æœå¯¹é«˜å¯¹æ¯”åº¦å›¾åƒä½¿ç”¨æ—¶å¯èƒ½å¯¼è‡´ç»†èŠ‚ä¸¢å¤±æˆ–å™ªå£°å¢å¼ºã€‚ç›´æ–¹å›¾å‡è¡¡åŒ–æ›´é€‚ç”¨äºæ›å…‰ä¸è¶³ã€å¯¹æ¯”åº¦ä½çš„å›¾åƒï¼Œå¦‚åŒ»å­¦å½±åƒã€å«æ˜Ÿå›¾åƒæˆ–è®¡ç®—æœºè§†è§‰ä¸­çš„å›¾åƒé¢„å¤„ç†ã€‚</p><p><img src=/articles/camera-isp/image-18.png width=311 height=162 srcset="/articles/camera-isp/image-18_hu_b33a4b92a37a4667.png 480w, /articles/camera-isp/image-18_hu_19d2daf123450fc5.png 1024w" loading=lazy alt="å›¾25 ç›´æ–¹å›¾å‡è¡¡åŒ–" class=gallery-image data-flex-grow=191 data-flex-basis=460px><details class=popup-details><summary>ç¤ºä¾‹ä»£ç </summary><div class=popup-content><button class=close-btn>âœ–</button><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;vector&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;algorithm&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;numeric&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1>// è®¡ç®—ç´¯ç§¯åˆ†å¸ƒå‡½æ•°ï¼ˆCDFï¼‰
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>float</span><span class=o>&gt;</span> <span class=n>calculateCDF</span><span class=p>(</span><span class=k>const</span> <span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;&amp;</span> <span class=n>histogram</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>float</span><span class=o>&gt;</span> <span class=n>cdf</span><span class=p>(</span><span class=n>histogram</span><span class=p>.</span><span class=n>size</span><span class=p>(),</span> <span class=mf>0.0f</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>partial_sum</span><span class=p>(</span><span class=n>histogram</span><span class=p>.</span><span class=n>begin</span><span class=p>(),</span> <span class=n>histogram</span><span class=p>.</span><span class=n>end</span><span class=p>(),</span> <span class=n>cdf</span><span class=p>.</span><span class=n>begin</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>maxValue</span> <span class=o>=</span> <span class=n>cdf</span><span class=p>.</span><span class=n>back</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>float</span><span class=o>&amp;</span> <span class=nl>val</span> <span class=p>:</span> <span class=n>cdf</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>val</span> <span class=o>/=</span> <span class=n>maxValue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>cdf</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// åº”ç”¨ç›´æ–¹å›¾å‡è¡¡åŒ–
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=nf>histogramEqualization</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;&gt;&amp;</span> <span class=n>image</span><span class=p>,</span> <span class=kt>int</span> <span class=n>maxValue</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span> <span class=n>histogram</span><span class=p>(</span><span class=n>maxValue</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// ç»Ÿè®¡ç›´æ–¹å›¾
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=p>(</span><span class=k>const</span> <span class=k>auto</span><span class=o>&amp;</span> <span class=nl>row</span> <span class=p>:</span> <span class=n>image</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=nl>value</span> <span class=p>:</span> <span class=n>row</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=o>++</span><span class=n>histogram</span><span class=p>[</span><span class=n>value</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// è®¡ç®—CDF
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>float</span><span class=o>&gt;</span> <span class=n>cdf</span> <span class=o>=</span> <span class=n>calculateCDF</span><span class=p>(</span><span class=n>histogram</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// åº”ç”¨å‡è¡¡åŒ–
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=p>(</span><span class=k>auto</span><span class=o>&amp;</span> <span class=nl>row</span> <span class=p>:</span> <span class=n>image</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span><span class=o>&amp;</span> <span class=nl>value</span> <span class=p>:</span> <span class=n>row</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>value</span> <span class=o>=</span> <span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=p>(</span><span class=n>cdf</span><span class=p>[</span><span class=n>value</span><span class=p>]</span> <span class=o>*</span> <span class=n>maxValue</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></details></p><h3 id=é¢œè‰²ç©ºé—´è½¬æ¢color-space-conversion>é¢œè‰²ç©ºé—´è½¬æ¢ï¼ˆColor Space Conversionï¼‰</h3><p>â–  RGB(Red, Green, Blue)æ˜¯ä¸€ç§åŸºäºåŠ è‰²æ¨¡å‹çš„é¢œè‰²ç©ºé—´ï¼Œè¡¨ç¤ºçº¢è‰²ã€ç»¿è‰²å’Œè“è‰²ä¸‰ä¸ªé¢œè‰²é€šé“çš„å¼ºåº¦ã€‚RGBæ¨¡å‹å¹¿æ³›ç”¨äºæ˜¾ç¤ºè®¾å¤‡ï¼ˆå¦‚è®¡ç®—æœºæ˜¾ç¤ºå™¨ã€ç”µè§†ç­‰ï¼‰ï¼Œå®ƒé€šè¿‡ä¸åŒå¼ºåº¦çš„çº¢ã€ç»¿ã€è“å…‰çš„ç»„åˆæ¥ç”Ÿæˆå„ç§é¢œè‰²ã€‚é¢œè‰²çš„æ··åˆæ–¹å¼æ˜¯åŠ æ³•çš„ï¼Œå³æ‰€æœ‰é€šé“çš„å…‰å¼ºåº¦åŠ èµ·æ¥ä¼šä½¿é¢œè‰²å˜å¾—æ›´äº®ã€‚</p><p>â–  CMYK(Cyan, Magenta, Yellow, Black)è¡¨ç¤ºå°åˆ·ä¸Šç”¨çš„å››ç§é¢œè‰²ï¼Œæ˜¯RGBçš„è¡¥è‰²ã€‚ç”±äºåœ¨å®é™…åº”ç”¨ä¸­ï¼Œé’è‰²ã€æ´‹çº¢è‰²å’Œé»„è‰²å¾ˆéš¾å åŠ å½¢æˆçœŸæ­£çš„é»‘è‰²ï¼Œå› æ­¤å¼•å…¥äº†Kâ€”â€”é»‘è‰²ã€‚é»‘è‰²çš„ä½œç”¨æ˜¯å¼ºåŒ–æš—è°ƒï¼ŒåŠ æ·±æš—éƒ¨è‰²å½©ã€‚</p><p><img src=/articles/camera-isp/image-16.png width=558 height=333 srcset="/articles/camera-isp/image-16_hu_3aa56ef5a59f5d0.png 480w, /articles/camera-isp/image-16_hu_7b7afa7f710babd8.png 1024w" loading=lazy alt="å›¾26 RGBä¸CMYK" class=gallery-image data-flex-grow=167 data-flex-basis=402px></p><p>â–  YUV(Y, U, V)æ˜¯ä¸€ç§åŸºäºäº®åº¦å’Œè‰²åº¦åˆ†é‡çš„é¢œè‰²ç©ºé—´ï¼Œé€šå¸¸ç”¨äºè§†é¢‘å‹ç¼©å’Œå¹¿æ’­ä¸­ã€‚åœ¨YUVæ¨¡å‹ä¸­ï¼ŒYè¡¨ç¤ºäº®åº¦åˆ†é‡ï¼ˆå³ç°åº¦ä¿¡æ¯ï¼‰ï¼ŒUå’ŒVè¡¨ç¤ºè‰²åº¦åˆ†é‡ï¼ˆå³é¢œè‰²ä¿¡æ¯ï¼ŒUè¡¨ç¤ºè“è‰²æŠ•å½±ï¼ŒVè¡¨ç¤ºçº¢è‰²æŠ•å½±ï¼‰ã€‚YUVçš„å¥½å¤„åœ¨äºï¼Œå®ƒèƒ½å¤Ÿå°†äº®åº¦å’Œè‰²åº¦åˆ†å¼€å¤„ç†ï¼Œè¿™å¯¹äºå›¾åƒå’Œè§†é¢‘å‹ç¼©å¾ˆæœ‰å¸®åŠ©ï¼Œå› ä¸ºäººçœ¼å¯¹äº®åº¦çš„æ•æ„Ÿåº¦è¿œé«˜äºè‰²åº¦ï¼Œå› æ­¤å¯ä»¥å¯¹è‰²åº¦åˆ†é‡è¿›è¡Œè¾ƒé«˜çš„å‹ç¼©è€Œä¸æ˜¾è‘—å½±å“è§†è§‰è´¨é‡ã€‚</p><details class=popup-details><summary>RGB-YUV è½¬æ¢å…¬å¼</summary><div class=popup-content><button class=close-btn>âœ–</button>
$$\begin{aligned}
&Y=W_RR^{\prime}+W_GG^{\prime}+W_BB^{\prime}=0.299R^{\prime}+0.587G^{\prime}+0.114B^{\prime} \\
&U=U_{\mathrm{max}}\frac{B^{\prime}-Y^{\prime}}{1-W_{B}}\approx0.492(B^{\prime}-Y^{\prime}) \\
&V=V_{\mathrm{max}}\frac{R^{\prime}-Y^{\prime}}{1-W_{R}}\approx0.877(R^{\prime}-Y^{\prime}) \\
&\Rightarrow \begin{bmatrix}Y\\U\\V\end{bmatrix}=\begin{bmatrix}0.299&0.587&0.114\\-0.14713&-0.28886&0.436\\0.615&-0.51499&-0.10001\end{bmatrix}\begin{bmatrix}R'\\G'\\B'\end{bmatrix} \\
&R^{\prime}=Y^{\prime}+V\frac{1-W_{R}}{V_{\mathrm{max}}}=Y^{\prime}+\frac{V}{0.877}=Y^{\prime}+1.14V \\
&B^{\prime}=Y^{\prime}+U\frac{1-W_{B}}{U_{\max}}=Y^{\prime}+\frac{U}{0.492}=Y^{\prime}+2.033U \\
&G^{\prime}=\frac{Y'-W_RR'-W_BB'}{W_G} \\
&\Rightarrow \begin{bmatrix}R'\\G'\\B'\end{bmatrix}=\begin{bmatrix}1&0&1.13983\\1&-0.39465&-0.58060\\1&2.03211&0\end{bmatrix}\begin{bmatrix}Y\\U\\V\end{bmatrix}
\end{aligned}$$</div></details><p>â–  HSV(Hue, Saturation, Value)æ˜¯æ ¹æ®é¢œè‰²çš„ç›´è§‚ç‰¹æ€§ç”±A. R. Smithåœ¨1978å¹´åˆ›å»ºçš„ä¸€ç§é¢œè‰²ç©ºé—´, ä¹Ÿç§°å…­è§’é”¥ä½“æ¨¡å‹(Hexcone Model)ã€‚è¿™ä¸ªæ¨¡å‹ä¸­é¢œè‰²çš„å‚æ•°åˆ†åˆ«æ˜¯ï¼šè‰²è°ƒï¼ˆHï¼‰ï¼Œé¥±å’Œåº¦ï¼ˆSï¼‰ï¼Œæ˜åº¦ï¼ˆVï¼‰ã€‚</p><p>â–  HSL(Hue, Saturation, Lightness)æ˜¯HSVæ¨¡å‹çš„å˜ä½“ï¼Œä¹Ÿæ˜¯ç”±è‰²è°ƒã€é¥±å’Œåº¦å’Œäº®åº¦ä¸‰ä¸ªå‚æ•°æ¥æè¿°é¢œè‰²çš„ã€‚ä¸HSVä¸åŒï¼ŒHSLä¸­çš„äº®åº¦ï¼ˆLightnessï¼‰æŒ‡çš„æ˜¯ä»é»‘è‰²åˆ°ç™½è‰²çš„äº®åº¦ç¨‹åº¦ï¼Œä½äº0åˆ°100ä¹‹é—´ï¼Œè€ŒHSVä¸­çš„æ˜åº¦ï¼ˆValueï¼‰åˆ™æ˜¯ä»é»‘è‰²åˆ°æœ€äº®çš„é¢œè‰²çš„äº®åº¦ç¨‹åº¦ã€‚HSLæ¨¡å‹å¸¸ç”¨äºè®¡ç®—æœºå›¾å½¢å’Œå›¾åƒå¤„ç†é¢†åŸŸï¼Œå› ä¸ºå®ƒä¸äººçœ¼å¯¹é¢œè‰²çš„æ„ŸçŸ¥æ›´ä¸ºæ¥è¿‘ã€‚</p><p>RGBåˆ°HSVå’ŒHSLçš„è½¬æ¢æ¯”è¾ƒå¤æ‚ï¼Œå‚è€ƒwikiç™¾ç§‘<a class=link href=https://en.wikipedia.org/wiki/HSL_and_HSV target=_blank rel=noopener>HSL_and_HSV</a></p><p><img src=/articles/camera-isp/image-17.png width=2147 height=489 srcset="/articles/camera-isp/image-17_hu_c8fbd39b109031de.png 480w, /articles/camera-isp/image-17_hu_9d99160c08e5941e.png 1024w" loading=lazy alt="å›¾27 è‰²å½©ç©ºé—´æ¨¡å‹" class=gallery-image data-flex-grow=439 data-flex-basis=1053px></p><p><img src=/articles/camera-isp/image-15.png width=452 height=768 srcset="/articles/camera-isp/image-15_hu_efd744f546c2142d.png 480w, /articles/camera-isp/image-15_hu_5aaa7138faf304b3.png 1024w" loading=lazy alt="å›¾28 è‰²å½©ç©ºé—´æ¨¡å‹çš„å‡ ä½•å…³ç³»" class=gallery-image data-flex-grow=58 data-flex-basis=141px></p><details class=popup-details><summary>ç¤ºä¾‹ä»£ç </summary><div class=popup-content><button class=close-btn>âœ–</button><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>// RGB è½¬ YUV
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>std</span><span class=o>::</span><span class=n>array</span><span class=o>&lt;</span><span class=kt>float</span><span class=p>,</span> <span class=mi>3</span><span class=o>&gt;</span> <span class=n>rgbToYuv</span><span class=p>(</span><span class=k>const</span> <span class=n>std</span><span class=o>::</span><span class=n>array</span><span class=o>&lt;</span><span class=kt>float</span><span class=p>,</span> <span class=mi>3</span><span class=o>&gt;&amp;</span> <span class=n>rgb</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>y</span> <span class=o>=</span> <span class=mf>0.299f</span> <span class=o>*</span> <span class=n>rgb</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>+</span> <span class=mf>0.587f</span> <span class=o>*</span> <span class=n>rgb</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>+</span> <span class=mf>0.114f</span> <span class=o>*</span> <span class=n>rgb</span><span class=p>[</span><span class=mi>2</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>u</span> <span class=o>=</span> <span class=mf>0.492f</span> <span class=o>*</span> <span class=p>(</span><span class=n>rgb</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>-</span> <span class=n>y</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>v</span> <span class=o>=</span> <span class=mf>0.877f</span> <span class=o>*</span> <span class=p>(</span><span class=n>rgb</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>-</span> <span class=n>y</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=n>y</span><span class=p>,</span> <span class=n>u</span><span class=p>,</span> <span class=n>v</span><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// YUV è½¬ RGB
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>std</span><span class=o>::</span><span class=n>array</span><span class=o>&lt;</span><span class=kt>float</span><span class=p>,</span> <span class=mi>3</span><span class=o>&gt;</span> <span class=n>yuvToRgb</span><span class=p>(</span><span class=k>const</span> <span class=n>std</span><span class=o>::</span><span class=n>array</span><span class=o>&lt;</span><span class=kt>float</span><span class=p>,</span> <span class=mi>3</span><span class=o>&gt;&amp;</span> <span class=n>yuv</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>r</span> <span class=o>=</span> <span class=n>yuv</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>+</span> <span class=mf>1.14f</span> <span class=o>*</span> <span class=n>yuv</span><span class=p>[</span><span class=mi>2</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>g</span> <span class=o>=</span> <span class=n>yuv</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>-</span> <span class=mf>0.394f</span> <span class=o>*</span> <span class=n>yuv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=mf>0.581f</span> <span class=o>*</span> <span class=n>yuv</span><span class=p>[</span><span class=mi>2</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=n>b</span> <span class=o>=</span> <span class=n>yuv</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>+</span> <span class=mf>2.032f</span> <span class=o>*</span> <span class=n>yuv</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=n>r</span><span class=p>,</span> <span class=n>g</span><span class=p>,</span> <span class=n>b</span><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></details><blockquote><p><strong>Refferenceï¼š</strong></p><p><a class=link href=https://www.qinxing.xyz/posts/506138d8/ target=_blank rel=noopener>https://www.qinxing.xyz/posts/506138d8/</a></p><p><a class=link href=https://github.com/yuqing-liu-dut/ISPLab target=_blank rel=noopener>https://github.com/yuqing-liu-dut/ISPLab</a></p><p><a class=link href=https://www.bilibili.com/video/BV1LA4m1N78h target=_blank rel=noopener>https://www.bilibili.com/video/BV1LA4m1N78h</a></p><p><a class=link href=https://www.wpgdadatong.com.cn/blog/detail/42592 target=_blank rel=noopener>https://www.wpgdadatong.com.cn/blog/detail/42592</a></p><p><a class=link href=https://www.cnblogs.com/lanlancky/p/17498055.html#_label2_0 target=_blank rel=noopener>https://www.cnblogs.com/lanlancky/p/17498055.html#_label2_0</a></p><p><a class=link href=https://www.cnblogs.com/wnwin/p/11985194.html target=_blank rel=noopener>https://www.cnblogs.com/wnwin/p/11985194.html</a></p><p><a class=link href=https://www.cnblogs.com/sunny-li/p/8641767.html target=_blank rel=noopener>https://www.cnblogs.com/sunny-li/p/8641767.html</a></p><p><a class=link href=https://blog.csdn.net/hhy321/article/details/120896015 target=_blank rel=noopener>https://blog.csdn.net/hhy321/article/details/120896015</a></p></blockquote></section><footer class=article-footer><section class=article-tags><a href=/tags/isp/>ISP</a>
<a href=/tags/%E4%BC%A0%E6%84%9F%E5%99%A8/>ä¼ æ„Ÿå™¨</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css integrity=sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js integrity=sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8 crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{const e=document.querySelector(".main-article");renderMathInElement(e,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],ignoredClasses:["gist"]})})</script></article><footer class=site-footer><section class=copyright>&copy;
2024 -
2025 RoboticsChen's Blog</section><section class=powerby>ä¸€ä¸ªæœºå™¨äººå·¥ç¨‹å¸ˆçš„æˆé•¿ç¬”è®°<br>ä½¿ç”¨ <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> æ„å»º<br>ä¸»é¢˜ <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> ç”± <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> è®¾è®¡</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script type=text/javascript src=/ts/custom.ab98a087394b20c3627bde9d8672bce1b06ea80e7eb4746e409fccaa1c39dd7b.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>