<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Posts on RoboticsChen's Blog</title><link>https://RoboticsChen.github.io/post/</link><description>Recent content in Posts on RoboticsChen's Blog</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><lastBuildDate>Tue, 25 Mar 2025 06:34:20 +0000</lastBuildDate><atom:link href="https://RoboticsChen.github.io/post/index.xml" rel="self" type="application/rss+xml"/><item><title>Figure AI Helix System è®ºæ–‡æ€»ç»“</title><link>https://RoboticsChen.github.io/articles/figure-ai-helix-system-paper-reading/</link><pubDate>Tue, 25 Mar 2025 06:34:20 +0000</pubDate><guid>https://RoboticsChen.github.io/articles/figure-ai-helix-system-paper-reading/</guid><description>&lt;img src="https://RoboticsChen.github.io/articles/figure-ai-helix-system-paper-reading/assets/image.png" alt="Featured image of post Figure AI Helix System è®ºæ–‡æ€»ç»“" />&lt;h1 id="figure-ai-helix-ç³»ç»Ÿæ€»ç»“">Figure AI Helix ç³»ç»Ÿæ€»ç»“
&lt;/h1>&lt;h2 id="ç¡¬ä»¶ç»„æˆ">ç¡¬ä»¶ç»„æˆ
&lt;/h2>&lt;p>&lt;img src="https://RoboticsChen.github.io/articles/figure-ai-helix-system-paper-reading/assets/image-2.png"
width="753"
height="822"
srcset="https://RoboticsChen.github.io/articles/figure-ai-helix-system-paper-reading/assets/image-2_hu_a4795c140fc72dc6.png 480w, https://RoboticsChen.github.io/articles/figure-ai-helix-system-paper-reading/assets/image-2_hu_d64487326dfbd911.png 1024w"
loading="lazy"
alt="å¤´éƒ¨æ‘„åƒå¤´"
class="gallery-image"
data-flex-grow="91"
data-flex-basis="219px"
> &lt;img src="https://RoboticsChen.github.io/articles/figure-ai-helix-system-paper-reading/assets/image-1.png"
width="514"
height="425"
srcset="https://RoboticsChen.github.io/articles/figure-ai-helix-system-paper-reading/assets/image-1_hu_4534d8beb6940b26.png 480w, https://RoboticsChen.github.io/articles/figure-ai-helix-system-paper-reading/assets/image-1_hu_ed1385affa40c429.png 1024w"
loading="lazy"
alt="æœºå™¨äººæ•´ä½“ç…§ç‰‡"
class="gallery-image"
data-flex-grow="120"
data-flex-basis="290px"
>&lt;/p>
&lt;ol>
&lt;li>æ„ŸçŸ¥ç³»ç»Ÿï¼šFigure 02çš„å¤´éƒ¨ã€å‰èº¯å¹²å’Œåèº¯å¹²å…±é…å¤‡6ä¸ªRGBæ‘„åƒå¤´&lt;/li>
&lt;li>å†³ç­–ç³»ç»Ÿï¼šåµŒå…¥å¼æ§åˆ¶æ¿åŠ2å—æ¿è½½ä½åŠŸè€—GPUsï¼ˆNVIDIA RTX GPUï¼Œå…·ä½“å‹å·æš‚ä¸æ˜ç¡®ï¼‰&lt;a class="link" href="https://blogs.nvidia.com/blog/figure-humanoid-robot-autonomous/" target="_blank" rel="noopener"
>å‚è€ƒæ¥æº&lt;/a>&lt;/li>
&lt;li>æ‰§è¡Œç³»ç»Ÿï¼šäººå½¢ä¸Šèº«ï¼Œè…°éƒ¨+å¤´éƒ¨+åŒè‡‚å…±35ä¸ªå…³èŠ‚ï¼ˆä»ç…§ç‰‡æ¨æµ‹ï¼Œå¤´2 + è…°3 + è‡‚7x2 + æ‰‹16x2ï¼‰ï¼Œéƒ¨åˆ†æ‰‹éƒ¨è‡ªç”±åº¦åº”è¯¥æ²¡æœ‰ç”¨åˆ°&lt;/li>
&lt;/ol>
&lt;h2 id="ç½‘ç»œç»“æ„">ç½‘ç»œç»“æ„
&lt;/h2>&lt;p>&lt;img src="https://RoboticsChen.github.io/articles/figure-ai-helix-system-paper-reading/assets/image.png"
width="1448"
height="537"
srcset="https://RoboticsChen.github.io/articles/figure-ai-helix-system-paper-reading/assets/image_hu_3114dd015cc042f.png 480w, https://RoboticsChen.github.io/articles/figure-ai-helix-system-paper-reading/assets/image_hu_f773820ef4c3694b.png 1024w"
loading="lazy"
alt="Pipeline"
class="gallery-image"
data-flex-grow="269"
data-flex-basis="647px"
>&lt;/p>
&lt;p>VLAç½‘ç»œç”±è§£è€¦çš„ä¸¤ä¸ªç³»ç»Ÿâ€”â€”é¢„è®­ç»ƒè§†è§‰è¯­è¨€æ¨¡å‹ï¼ˆS2ï¼‰ + æ§åˆ¶å°æ¨¡å‹ï¼ˆS1ï¼‰ç»„æˆï¼Œä¸¤è€…åœ¨å„è‡ªçš„æ—¶é—´å°ºåº¦ä¸Šè¿è¡Œï¼Œç»“åˆVLMæ¨¡å‹å¹¿æ³›é€šç”¨ä½†ä¸å¤Ÿå¿«çš„ç‰¹ç‚¹å’Œè§†è§‰è¿åŠ¨ç­–ç•¥å¿«é€Ÿè€Œä¸å¹¿æ³›çš„ç‰¹ç‚¹ï¼Œå®ç°ä¸€ä¸ªæ—¢å¹¿æ³›åˆå¿«é€Ÿçš„VLAæ§åˆ¶æ¨¡å‹ã€‚&lt;/p>
&lt;h3 id="s2">S2
&lt;/h3>&lt;p>å‚æ•°é‡ï¼š7B&lt;br>
ç±»å‹ï¼šå¼€æºVLM&lt;br>
è¾“å…¥ï¼šRGBå›¾ç‰‡ã€å…³èŠ‚è§’ä¿¡æ¯&lt;br>
è¾“å‡ºï¼šæ½œç©ºé—´å‘é‡&lt;br>
è¾“å‡ºé¢‘ç‡ï¼š7-9Hz&lt;br>
ä½œç”¨ï¼šåœºæ™¯ç†è§£å’Œè¯­ä¹‰ç†è§£ï¼Œæä¾›è·¨ç‰©ä½“å’Œåœºæ™¯çš„æ³›åŒ–èƒ½åŠ›ï¼Œå°†æ‰€æœ‰ä¸è¯­ä¹‰ä»»åŠ¡ç›¸å…³çš„ä¿¡æ¯æç‚¼åˆ°ä¸€ä¸ªå•ä¸€çš„è¿ç»­æ½œåœ¨å‘é‡ä¸­ï¼Œå¹¶å°†å…¶ä¼ é€’ç»™S1&lt;/p>
&lt;h3 id="s1">S1
&lt;/h3>&lt;p>å‚æ•°é‡ï¼š80M&lt;br>
ç±»å‹ï¼šäº¤å‰æ³¨æ„åŠ›çš„ç¼–è§£ç Transformerç½‘ç»œï¼Œä¾èµ–ä¸€ä¸ªå¤šå°ºåº¦çš„å…¨å·ç§¯è§†è§‰éª¨å¹²è¿›è¡Œè§†è§‰å¤„ç†ï¼ˆåœ¨ä»¿çœŸå™¨ä¸­é¢„è®­ç»ƒåˆå§‹åŒ–*ï¼‰&lt;br>
è¾“å…¥ï¼šæ½œç©ºé—´å‘é‡ã€RGBå›¾ç‰‡ã€å…³èŠ‚è§’&lt;br>
è¾“å‡ºï¼šé«˜é¢‘æœºå™¨äººåŠ¨ä½œï¼ˆå…³èŠ‚è§’ï¼‰&lt;br>
è¾“å‡ºé¢‘ç‡ï¼š200Hz&lt;br>
ä½œç”¨ï¼šå¿«é€Ÿçµå·§çš„æ§åˆ¶ç­–ç•¥ï¼Œç»“åˆå›¾åƒç¼–ç å’Œå½“å‰å…³èŠ‚è§’ä¿¡æ¯ï¼Œå°†æ½œç©ºé—´å‘é‡è¡¨ç¤ºè½¬åŒ–æˆè¿ç»­çš„æœºå™¨äººåŠ¨ä½œï¼ˆç›®æ ‡å…³èŠ‚è§’ï¼‰&lt;/p>
&lt;h3 id="è®­ç»ƒç»†èŠ‚">è®­ç»ƒç»†èŠ‚ï¼š
&lt;/h3>&lt;p>è®­ç»ƒæ•°æ®ï¼šçº¦500hçš„é«˜è´¨é‡ã€å¤šæœºå™¨äººã€å¤šæ“ä½œå‘˜çš„å¤šæ ·åŒ–é¥æ“ä½œè¡Œä¸ºæ•°æ®é›†&lt;br>
è®­ç»ƒæ–¹æ³•ï¼šåŸºäºraw pixelå’Œæ–‡æœ¬æŒ‡ä»¤åˆ°è¿ç»­åŠ¨ä½œçš„æ˜ å°„ï¼Œåšç«¯åˆ°ç«¯çš„è®­ç»ƒï¼Œé‡‡ç”¨æ ‡å‡†çš„å›å½’æŸå¤±ã€‚æ¢¯åº¦ä»S1é€šè¿‡æ½œè¡¨ç¤ºå‘é‡ä¼ é€’åˆ°S2ï¼Œå®ç°ä¸¤è€…çš„ååŒä¼˜åŒ–ã€‚&lt;/p>
&lt;blockquote>
&lt;p>æ³¨æ„ï¼š&lt;/p>
&lt;ul>
&lt;li>S1å’ŒS2åœ¨è®­ç»ƒé˜¶æ®µæ˜¯è€¦åˆçš„&lt;/li>
&lt;li>ä¸ºäº†æ¨¡æ‹ŸçœŸå®çš„æ¨ç†å»¶è¿Ÿï¼Œåœ¨è®­ç»ƒé˜¶æ®µè®¤ä¸ºå¼•å…¥äº†S1å’ŒS2è¾“å…¥é‡çš„æ—¶é—´åç§»*&lt;/li>
&lt;/ul>&lt;/blockquote>
&lt;h3 id="è°ƒä¼˜çš„æµå¼æ¨ç†">è°ƒä¼˜çš„æµå¼æ¨ç†
&lt;/h3>&lt;p>S1å’ŒS2åˆ†åˆ«è¿è¡Œåœ¨ä¸€å—ä¸“é—¨çš„GPUä¸Šï¼ŒåŸºäºå…±äº«çš„å†…å­˜å½¢æˆä¸€ä¸ªç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹ã€‚&lt;br>
S2å¼‚æ­¥åœ°å¤„ç†æœ€æ–°çš„è§‚æµ‹ä¿¡æ¯å’Œè‡ªç„¶è¯­è¨€æŒ‡ä»¤ï¼Œ æŒç»­åœ°ç”Ÿæˆç¼–ç äº†é«˜ç»´æ„å›¾è¡Œä¸ºæ„å›¾çš„æ½œå‘é‡ï¼Œå¹¶æ›´æ–°åˆ°å…±äº«å†…å­˜ä¸­ã€‚&lt;br>
S1åœ¨ç‹¬ç«‹çº¿ç¨‹ä¸­ï¼Œç»“åˆæœ€æ–°è§‚æµ‹å’Œè‡ªç„¶è¯­è¨€æŒ‡ä»¤ï¼Œæ¶ˆè´¹å…±äº«å†…å­˜ä¸­çš„æ½œå‘é‡ç”Ÿæˆè¿ç»­çš„æœºå™¨äººåŠ¨ä½œã€‚ç”±äºS1æ¯”S2æœ‰æ›´é«˜çš„æ¨ç†é€Ÿåº¦ï¼Œå› æ­¤æœ‰æ›´é«˜çš„æ—¶é—´åˆ†è¾¨ç‡ï¼Œä»è€Œå¯ä»¥å®ç°æ›´ç´§å¯†çš„é—­ç¯å®æ—¶æ§åˆ¶ã€‚&lt;/p>
&lt;h2 id="æ•°æ®æµä¸ä¼ è¾“å¸¦å®½">æ•°æ®æµä¸ä¼ è¾“å¸¦å®½
&lt;/h2>&lt;h3 id="æ•°æ®æµ">æ•°æ®æµ
&lt;/h3>&lt;p>&lt;img src="https://RoboticsChen.github.io/articles/figure-ai-helix-system-paper-reading/assets/image-4.png"
width="1080"
height="315"
srcset="https://RoboticsChen.github.io/articles/figure-ai-helix-system-paper-reading/assets/image-4_hu_b4c9380bafbeb227.png 480w, https://RoboticsChen.github.io/articles/figure-ai-helix-system-paper-reading/assets/image-4_hu_3e4bb4a4fa05811.png 1024w"
loading="lazy"
alt="å›¾åƒç‰¹å¾èåˆ"
class="gallery-image"
data-flex-grow="342"
data-flex-basis="822px"
>&lt;br>
Sensorä»¥20Hzçš„é¢‘ç‡é‡‡é›†å›¾åƒå’Œå…³èŠ‚è§’ã€‚&lt;br>
Observationï¼ˆraw_imgï¼‰ â”€â”€â”€â”€ä¼ æ„Ÿå™¨å›¾åƒâ”€â”€â”€â”€&amp;gt;å¤šå°ºåº¦ç«‹ä½“è§†è§‰ç½‘ç»œ â”€â”€â”€â”€åˆå¹¶å›¾åƒç‰¹å¾â”€â”€â”€â”€&amp;gt; Observationï¼ˆcombind_img_tokenï¼‰&lt;br>
Observationï¼ˆcommand + state + combind_img_tokenï¼‰â”€â”€â”€â”€7&lt;del>9Hzè§‚æµ‹ä¿¡æ¯â”€â”€â”€â”€&amp;gt; S2 â”€â”€â”€â”€7&lt;/del>9Hzæ½œå‘é‡â”€â”€â”€â”€&amp;gt; S1 â”€â”€â”€â”€200HzåŠ¨ä½œâ”€â”€â”€â”€&amp;gt;æ‰§è¡Œå™¨&lt;br>
Observationï¼ˆcommand + state + combind_img_tokenï¼‰â”€â”€â”€â”€â”€20Hzè§‚æµ‹ä¿¡æ¯â”€â”€â”€â”€&amp;gt; S1&lt;/p>
&lt;h3 id="ä¼ è¾“å¸¦å®½">ä¼ è¾“å¸¦å®½
&lt;/h3>&lt;p>æœªæåŠ&lt;/p>
&lt;h2 id="ç‰¹è‰²">ç‰¹è‰²
&lt;/h2>&lt;p>&lt;a class="link" href="https://www.figure.ai/news/helix" target="_blank" rel="noopener"
>å®˜æ–¹è§‚ç‚¹&lt;/a>ï¼š&lt;/p>
&lt;ol>
&lt;li>å…¨èº«æ§åˆ¶ï¼šå®ƒæ˜¯å†å²ä¸Šç¬¬ä¸€ä¸ªç±»äººæœºå™¨äººä¸ŠåŠèº«çš„é«˜é€Ÿè¿ç»­æ§åˆ¶ VLA æ¨¡å‹ï¼Œè¦†ç›–æ‰‹è…•ã€èº¯å¹²ã€å¤´éƒ¨å’Œå•ä¸ªæ‰‹æŒ‡ï¼›&lt;/li>
&lt;li>å¤šæœºå™¨äººåä½œï¼šå¯ä»¥ä¸¤å°æœºå™¨äººç”¨åŒæ ·çš„æ¨¡å‹æ§åˆ¶åä½œï¼Œå®Œæˆå‰æ‰€æœªè§çš„ä»»åŠ¡ï¼›&lt;/li>
&lt;li>æŠ“å–ä»»ä½•ç‰©å“ï¼šå¯ä»¥æ¡èµ·ä»»ä½•å°å‹ç‰©ä½“ï¼ŒåŒ…æ‹¬æ•°åƒç§å®ƒä»¬ä»æœªé‡åˆ°è¿‡çš„ç‰©å“ï¼Œåªéœ€éµå¾ªè‡ªç„¶è¯­è¨€æŒ‡ä»¤å³å¯ï¼›&lt;/li>
&lt;li>å•ä¸€ç¥ç»ç½‘ç»œï¼šHelix ä½¿ç”¨ä¸€ç»„ç¥ç»ç½‘ç»œæƒé‡æ¥å­¦ä¹ æ‰€æœ‰è¡Œä¸ºï¼Œå¦‚æŠ“å–å’Œæ”¾ç½®ç‰©å“ã€ä½¿ç”¨æŠ½å±‰å’Œå†°ç®±ã€ä»¥åŠè·¨æœºå™¨äººäº¤äº’ï¼Œè€Œæ— éœ€ä»»ä½•ä»»åŠ¡ç‰¹å®šçš„å¾®è°ƒï¼›&lt;/li>
&lt;li>æœ¬åœ°åŒ–ï¼šHelix æ˜¯å²ä¸Šç¬¬ä¸€ä¸ªåœ¨æ¿ç«¯ GPU è¿è¡Œçš„æœºå™¨äºº VLA æ¨¡å‹ï¼Œå·²ç»å…·å¤‡äº†å•†ä¸šåŒ–è½åœ°èƒ½åŠ›ã€‚&lt;/li>
&lt;li>æ‰©å±•åˆ°å®¶ç”¨åœºæ™¯æˆæœ¬ä½ï¼šç›¸æ¯”äºä¼ ç»Ÿçš„ä¾æ®å•ä¸ªä»»åŠ¡ç”±æœºå™¨äººä¸“å®¶å®šåˆ¶åŒ–çš„æ§åˆ¶å’Œéœ€è¦é‡‡é›†å¤§é‡æ•°æ®çš„æ¨¡ä»¿å­¦ä¹ æ§åˆ¶ï¼Œå€ŸåŠ©VLMæ¨¡å‹å®ç°å¼ºå¤§æ³›åŒ–èƒ½åŠ›çš„ç«¯åˆ°ç«¯æ¨¡å‹æ›´æœ‰ä¼˜åŠ¿
&lt;img src="https://RoboticsChen.github.io/articles/figure-ai-helix-system-paper-reading/assets/image-3.png"
width="1920"
height="1081"
srcset="https://RoboticsChen.github.io/articles/figure-ai-helix-system-paper-reading/assets/image-3_hu_67e434179e12c82a.png 480w, https://RoboticsChen.github.io/articles/figure-ai-helix-system-paper-reading/assets/image-3_hu_51eb2eb58bdefd4f.png 1024w"
loading="lazy"
alt="æœºå™¨äººScaling Law"
class="gallery-image"
data-flex-grow="177"
data-flex-basis="426px"
>&lt;/li>
&lt;/ol>
&lt;p>&lt;a class="link" href="https://mp.weixin.qq.com/s/ZkY0IYETGXXDixuo-wKekA" target="_blank" rel="noopener"
>é‡å­ä½è§‚ç‚¹&lt;/a>&lt;/p>
&lt;ol>
&lt;li>ç©ºé—´æ„ŸçŸ¥ï¼šå¤šç›¸æœºå®ç°éšå¼ç«‹ä½“è§†è§‰ä¸å¤šå°ºåº¦è§†è§‰è¡¨ç¤ºï¼Œå¢å¼ºäº†3Dç©ºé—´æ„ŸçŸ¥å’Œåœºæ™¯ç†è§£ç²¾åº¦&lt;/li>
&lt;li>æ‰§è¡Œé€Ÿåº¦ä¸Šé™é«˜ï¼šåœ¨ç‰©æµåœºæ™¯çš„å¾®è°ƒåº”ç”¨ä¸­ä½¿ç”¨ç®€å•çš„test-timeåŠ é€ŸæŠ€æœ¯ï¼ˆåŒæ ·çš„waypointä»¥æ›´çŸ­çš„æ—¶é—´é—´éš”æ‰§è¡Œï¼‰ï¼Œä¿æŒé«˜æˆåŠŸç‡çš„åŒæ—¶å®ç°äº†æ›´å¿«çš„æ‰§è¡Œé€Ÿåº¦ã€‚&lt;/li>
&lt;li>å¾®è°ƒæˆæœ¬ä½ï¼šä»…ç”¨8å°æ—¶ç²¾å¿ƒæŒ‘é€‰çš„æ•°æ®å°±èƒ½è®­ç»ƒå‡ºä¸€ä¸ªçµæ´»ä¸”é€‚åº”æ€§å¼ºçš„ç­–ç•¥ã€‚&lt;/li>
&lt;li>å¼•å…¥è§†è§‰è‡ªæ ¡å‡†æ¨¡å‹ï¼šè¯¥æ¨¡å‹å¯ä»¥è®©æ¯ä¸ªæœºå™¨äººé€šè¿‡è‡ªèº«çš„è§†è§‰è¾“å…¥æ¥è‡ªæˆ‘æ ¡å‡†ï¼Œä¼°ç®—å‡ºæœºæ¢°è‡‚æœ«ç«¯çš„ç²¾ç¡®ä½ç½®å’Œå§¿æ€ï¼Œæé«˜è·¨æœºå™¨äººå®ä¾‹çš„æ³›åŒ–èƒ½åŠ›ã€‚&lt;/li>
&lt;li>å­˜åœ¨è‡ªçº æ­£èƒ½åŠ›ï¼šè®­ç»ƒè¿‡ç¨‹ä¸­ï¼ŒFigureæ’é™¤äº†é‚£äº›è¾ƒæ…¢çš„ã€é—æ¼çš„æˆ–å¤±è´¥çš„æ¡ˆä¾‹ï¼Œä¸è¿‡ç‰¹æ„ä¿ç•™äº†åŒ…å«çº æ­£è¡Œä¸ºçš„æ¡ˆä¾‹ã€‚&lt;/li>
&lt;li>é»˜è®¤äº¤äº’æ–¹å¼ä¸ºè¯­éŸ³äº¤äº’
&lt;img src="https://RoboticsChen.github.io/articles/figure-ai-helix-system-paper-reading/assets/image-5.gif"
width="640"
height="328"
srcset="https://RoboticsChen.github.io/articles/figure-ai-helix-system-paper-reading/assets/image-5_hu_9100231fc2360407.gif 480w, https://RoboticsChen.github.io/articles/figure-ai-helix-system-paper-reading/assets/image-5_hu_ec57953f01cb7d02.gif 1024w"
loading="lazy"
alt="è‡ªçº æ­£"
class="gallery-image"
data-flex-grow="195"
data-flex-basis="468px"
>&lt;/li>
&lt;/ol>
&lt;p>ä¸ªäººåˆ¤æ–­ï¼š&lt;/p>
&lt;ol>
&lt;li>é‡‡ç”¨ä¸ƒè‡ªç”±åº¦å†—ä½™æœºæ¢°è‡‚ï¼Œå·¥ä½œç©ºé—´æ›´å¤§ï¼Œç”±äºæ˜¯ç«¯åˆ°ç«¯çš„æ¨¡å‹ï¼Œä¸å­˜åœ¨FK/IKï¼Œå¤šä¸€ä¸ªè‡ªç”±åº¦å¯¹æ¨¡å‹æ¥è¯´åŒºåˆ«ä¸å¤§ï¼Œä½†æ•ˆæœä¼šå¥½å¾ˆå¤š&lt;/li>
&lt;li>æš‚ä¸èƒ½å®ç°è·¨æ„å‹çš„æ³›åŒ–èƒ½åŠ›ï¼Œä½†æ˜¯é’ˆå¯¹ä¸åŒçš„æ‰§è¡Œå™¨å’Œæœºå™¨äººæ„å‹ï¼Œä¸éœ€è¦æ”¹å˜æ¨¡å‹æ¶æ„ï¼Œåªéœ€è¦æ”¹å˜è¾“å‡ºå‚æ•°çš„æ•°é‡é‡æ–°é‡‡é›†æ•°æ®è®­ç»ƒæ¨¡å‹&lt;/li>
&lt;/ol></description></item><item><title>perfæ€§èƒ½åˆ†æå·¥å…·çš„ä½¿ç”¨</title><link>https://RoboticsChen.github.io/articles/perf%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%E7%9A%84%E4%BD%BF%E7%94%A8/</link><pubDate>Fri, 14 Mar 2025 01:40:52 +0000</pubDate><guid>https://RoboticsChen.github.io/articles/perf%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%E7%9A%84%E4%BD%BF%E7%94%A8/</guid><description>&lt;img src="https://RoboticsChen.github.io/articles/perf%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%E7%9A%84%E4%BD%BF%E7%94%A8/image.png" alt="Featured image of post perfæ€§èƒ½åˆ†æå·¥å…·çš„ä½¿ç”¨" />&lt;h2 id="å®‰è£…ä¾èµ–">å®‰è£…ä¾èµ–
&lt;/h2>&lt;p>&lt;strong>perf&lt;/strong>ï¼šé€šå¸¸å·²ç»å®‰è£…åœ¨å¤§å¤šæ•° Linux ç³»ç»Ÿä¸­ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">sudo apt-get install linux-tools-common linux-tools-generic
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>Flamegraph&lt;/strong>ï¼šç”± Brendan Gregg åˆ›å»ºçš„å·¥å…·é›†ï¼Œç”¨äºç”Ÿæˆç«ç„°å›¾ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">git clone https://github.com/brendangregg/Flamegraph.git &lt;span class="c1"># åœ¨åˆé€‚çš„ä½ç½®ä¿å­˜è„šæœ¬&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> Flamegraph
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo chmod +x *.pl
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s1">&amp;#39;export PATH=&amp;#34;$PATH&amp;#34;:&amp;#39;&lt;/span>&lt;span class="k">$(&lt;/span>&lt;span class="nb">pwd&lt;/span>&lt;span class="k">)&lt;/span> &amp;gt;&amp;gt; ~/.bashrc &lt;span class="c1"># æ·»åŠ ç¯å¢ƒå˜é‡&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">source&lt;/span> ~/.bashrc
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="perfä½¿ç”¨æ•™ç¨‹">perfä½¿ç”¨æ•™ç¨‹
&lt;/h2>&lt;ol>
&lt;li>ä½¿ç”¨ &lt;code>perf&lt;/code> å·¥å…·è¿›è¡Œæ€§èƒ½é‡‡æ ·ï¼Œ Ctrl+Cç»“æŸã€‚&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">sudo sysctl -w kernel.kptr_restrict&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> &lt;span class="c1"># æš‚æ—¶å…è®¸å¯¹å†…æ ¸ç¬¦å·çš„è®¿é—®&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo sysctl -w kernel.perf_event_paranoid&lt;span class="o">=&lt;/span>-1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">perf record -F &lt;span class="m">99&lt;/span> -a -g -- ./my_program
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;p>&lt;code>F 99&lt;/code> è®¾ç½®é‡‡æ ·é¢‘ç‡ä¸ºæ¯ç§’ 99 æ¬¡ã€‚
&lt;code>a&lt;/code> è¡¨ç¤ºå¯¹ç³»ç»Ÿä¸­çš„æ‰€æœ‰ CPU è¿›è¡Œé‡‡æ ·ã€‚
&lt;code>g&lt;/code> è¡¨ç¤ºå¯ç”¨è°ƒç”¨å›¾ï¼ˆcall graphï¼‰æ”¶é›†ã€‚&lt;/p>&lt;/blockquote>
&lt;ol start="2">
&lt;li>å°†è¿™äº›æ•°æ®è½¬æ¢ä¸ºç«ç„°å›¾æ ¼å¼,å†è½¬åŒ–ä¸ºæŠ˜å æ ¼å¼ï¼š&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">perf script &amp;gt; out.perf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol start="3">
&lt;li>è½¬åˆ° &lt;code>Flamegraph&lt;/code> çš„ç›®å½•ï¼Œå°† &lt;code>out.perf&lt;/code> ä¸­çš„æ€§èƒ½æ•°æ®è½¬æ¢ä¸ºæŠ˜å æ ¼å¼ï¼Œå¹¶è¾“å‡ºåˆ° &lt;code>out.folded&lt;/code> æ–‡ä»¶ã€‚&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">./stackcollapse-perf.pl out.perf &amp;gt; out.folded
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol start="4">
&lt;li>ç”Ÿæˆç«ç„°å›¾ï¼š&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">./flamegraph.pl out.folded &amp;gt; flamegraph.svg
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol start="5">
&lt;li>å°†ç«ç„°å›¾æ‹–æ‹½åˆ°æµè§ˆå™¨å³å¯æŸ¥çœ‹&lt;/li>
&lt;/ol>
&lt;h2 id="ä¸€é”®perfåˆ†æè„šæœ¬">ä¸€é”®perfåˆ†æè„šæœ¬
&lt;/h2>&lt;p>&lt;details class="popup-details">
&lt;summary>å±•å¼€å¤åˆ¶ä¿å­˜ä¸º`perf_it.sh`&lt;/summary>
&lt;div class="popup-content">
&lt;button class="close-btn">âœ–&lt;/button>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;span class="lnt">65
&lt;/span>&lt;span class="lnt">66
&lt;/span>&lt;span class="lnt">67
&lt;/span>&lt;span class="lnt">68
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># ç¡®ä¿ä¼ å…¥çš„å‘½ä»¤å‚æ•°&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> -z &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$1&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;Usage: &lt;/span>&lt;span class="nv">$0&lt;/span>&lt;span class="s2"> &amp;lt;command_to_profile&amp;gt;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">exit&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># æš‚æ—¶å…è®¸å¯¹å†…æ ¸ç¬¦å·çš„è®¿é—®&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo sysctl -w kernel.kptr_restrict&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo sysctl -w kernel.perf_event_paranoid&lt;span class="o">=&lt;/span>-1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># è®¾ç½®ä¿¡å·å¤„ç†ï¼šæ•è· Ctrl+C åç»§ç»­æ‰§è¡Œ&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cleanup&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> -f &lt;span class="s2">&amp;#34;perf.data&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> -e &lt;span class="s2">&amp;#34;\næ•è·åˆ°ä¸­æ–­ä¿¡å·ï¼Œæ­£åœ¨ç”Ÿæˆç«ç„°å›¾...&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> generate_flamegraph
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> -e &lt;span class="s2">&amp;#34;\næ•è·åˆ°ä¸­æ–­ä¿¡å·ï¼Œä½†æœªç”Ÿæˆ perf æ•°æ®ã€‚&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">exit&lt;/span> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">generate_flamegraph&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># ç”Ÿæˆæ—¶é—´æˆ³ç›®å½•&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">export&lt;/span> &lt;span class="nv">tmp_time&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>date +&lt;span class="s2">&amp;#34;%Y%m%d_%H%M%S&amp;#34;&lt;/span>&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">export&lt;/span> &lt;span class="nv">tmp_dir&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;flame_&lt;/span>&lt;span class="nv">$tmp_time&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mkdir -p &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$tmp_dir&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># ç§»åŠ¨ perf.data åˆ°ç›®æ ‡ç›®å½•&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> mv perf.data &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$tmp_dir&lt;/span>&lt;span class="s2">/&amp;#34;&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;é”™è¯¯: æœªæ‰¾åˆ° perf.data æ–‡ä»¶&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">exit&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">cd&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$tmp_dir&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nb">exit&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># ç”Ÿæˆ perf æ•°æ®&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;æ­£åœ¨å¤„ç† perf æ•°æ®...&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> perf script &amp;gt; &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$tmp_time&lt;/span>&lt;span class="s2">.perf&amp;#34;&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;é”™è¯¯: perf script æ‰§è¡Œå¤±è´¥&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">exit&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># ç”ŸæˆæŠ˜å æ•°æ®&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> stackcollapse-perf.pl &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$tmp_time&lt;/span>&lt;span class="s2">.perf&amp;#34;&lt;/span> &amp;gt; &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$tmp_time&lt;/span>&lt;span class="s2">.folded&amp;#34;&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;é”™è¯¯: stackcollapse-perf.pl æ‰§è¡Œå¤±è´¥&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">exit&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># ç”Ÿæˆç«ç„°å›¾&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> flamegraph.pl &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$tmp_time&lt;/span>&lt;span class="s2">.folded&amp;#34;&lt;/span> &amp;gt; &lt;span class="s2">&amp;#34;flamegraph_&lt;/span>&lt;span class="nv">$tmp_time&lt;/span>&lt;span class="s2">.svg&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;ğŸ”¥ ç«ç„°å›¾ç”Ÿæˆå®Œæ¯•ï¼š&lt;/span>&lt;span class="nv">$PWD&lt;/span>&lt;span class="s2">/flamegraph_&lt;/span>&lt;span class="nv">$tmp_time&lt;/span>&lt;span class="s2">.svg&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># æ³¨å†Œä¿¡å·å¤„ç†&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">trap&lt;/span> cleanup SIGINT SIGTERM
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># è¿è¡Œ perf record å¹¶æ£€æŸ¥é€€å‡ºçŠ¶æ€&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;å¼€å§‹æ€§èƒ½é‡‡é›† (æŒ‰ Ctrl+C åœæ­¢)...&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> perf record -F &lt;span class="m">99&lt;/span> -a -g -- &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$@&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># ä»…å½“ perf record æˆåŠŸæ—¶ç”Ÿæˆç«ç„°å›¾&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> generate_flamegraph
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;é”™è¯¯: ç›®æ ‡å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œè·³è¿‡ç«ç„°å›¾ç”Ÿæˆ&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> rm -f perf.data &lt;span class="c1"># æ¸…ç†å¯èƒ½çš„æ— æ•ˆæ•°æ®&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">exit&lt;/span> &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;/details>
ç”¨æ³•ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">./perf_it ./my_program &amp;lt;args...&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>Linux åˆ’è¯è°·æ­Œç¿»è¯‘è§£å†³æ–¹æ¡ˆ</title><link>https://RoboticsChen.github.io/articles/linux-ubuntu-wayland-google-translate/</link><pubDate>Sun, 01 Dec 2024 05:17:56 +0000</pubDate><guid>https://RoboticsChen.github.io/articles/linux-ubuntu-wayland-google-translate/</guid><description>&lt;img src="https://RoboticsChen.github.io/articles/linux-ubuntu-wayland-google-translate/translate.png" alt="Featured image of post Linux åˆ’è¯è°·æ­Œç¿»è¯‘è§£å†³æ–¹æ¡ˆ" />&lt;h2 id="0-åŸç†ä»‹ç»">0. åŸç†ä»‹ç»
&lt;/h2>&lt;p>è¯¥æ–¹æ¡ˆå…ˆé€šè¿‡xclipè·å–ç”¨æˆ·é€‰ä¸­çš„æ–‡æœ¬å†…å®¹ï¼Œå¯¹æ–‡æœ¬è¿›è¡Œæ¸…ç†ï¼ˆç§»é™¤éšè—å­—ç¬¦,htmlæ ‡ç­¾,æ¢è¡Œç¬¦ï¼‰ï¼Œç„¶åé€šè¿‡è°ƒç”¨ç¿»è¯‘ APIï¼ˆå¦‚è°·æ­Œç¿»è¯‘æˆ–å…¶ä»–æœåŠ¡ï¼‰å°†æ–‡æœ¬ç¿»è¯‘ä¸ºç›®æ ‡è¯­è¨€ï¼Œæœ€åä½¿ç”¨ç³»ç»Ÿé€šçŸ¥å·¥å…·ï¼ˆnotify-sendï¼‰å°†ç¿»è¯‘ç»“æœä»¥é€šçŸ¥çš„å½¢å¼æ˜¾ç¤ºç»™ç”¨æˆ·ã€‚&lt;/p>
&lt;h2 id="1-å®‰è£…ä¾èµ–">1. å®‰è£…ä¾èµ–
&lt;/h2>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">sudo apt install xcilp jq
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>xcilp ç”¨äºè·å–å‰ªè´´æ¿å†…å®¹
jq ç”¨äºå¯¹å­—ç¬¦ä¸²è¿›è¡Œ URL ç¼–ç ï¼ˆç™¾åˆ†å·ç¼–ç ï¼‰&lt;/p>
&lt;h2 id="2-ç¼–å†™è„šæœ¬">2. ç¼–å†™è„šæœ¬
&lt;/h2>&lt;p>åœ¨/optç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªåä¸ºmy_translate.shçš„è„šæœ¬æ–‡ä»¶&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">sudo nano /opt/my_translate.sh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ·»åŠ ä»¥ä¸‹å†…å®¹å¹¶ä¿å­˜é€€å‡ºï¼š&lt;/p>
&lt;details class="popup-details">
&lt;summary>ç‚¹å‡»å±•å¼€&lt;/summary>
&lt;div class="popup-content">
&lt;button class="close-btn">âœ–&lt;/button>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#!/bin/bash&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># ä»å‰ªè´´æ¿è·å–é€‰ä¸­çš„æ–‡å­—&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">selected_text&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>xclip -o&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">clean_text&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$selected_text&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> sed &lt;span class="s1">&amp;#39;s/&amp;lt;[^&amp;gt;]*&amp;gt;//g&amp;#39;&lt;/span> &lt;span class="p">|&lt;/span> tr -d &lt;span class="s1">&amp;#39;\n\r&amp;#39;&lt;/span> &lt;span class="p">|&lt;/span> tr -d &lt;span class="s1">&amp;#39;\t&amp;#39;&lt;/span> &lt;span class="p">|&lt;/span> tr -s &lt;span class="s1">&amp;#39; &amp;#39;&lt;/span>&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="nv">$clean_text&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># æ£€æŸ¥ç›®æ ‡è¯­è¨€å‚æ•°&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">target_language&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$1&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># è°·æ­Œç¿»è¯‘APIçš„URL&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">API_URL&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;https://translate.googleapis.com/translate_a/single?client=gtx&amp;amp;sl=auto&amp;amp;tl=&lt;/span>&lt;span class="nv">$target_language&lt;/span>&lt;span class="s2">&amp;amp;dt=t&amp;amp;q=&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">query&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>&lt;span class="nb">echo&lt;/span> -n &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$clean_text&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> jq -sRr @uri&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># è°ƒç”¨Google Translate API&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">response&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>curl -sL &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">API_URL&lt;/span>&lt;span class="si">}${&lt;/span>&lt;span class="nv">query&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## just for debug&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#echo &amp;#34;å®Œæ•´è¯·æ±‚ URL: ${API_URL}${query}&amp;#34; &amp;gt;&amp;gt; debug_log.txt&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#echo &amp;#34;API å“åº”: $response&amp;#34; &amp;gt;&amp;gt; debug_log.txt&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># æå–ç¿»è¯‘ç»“æœ&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">translation&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>&lt;span class="nb">echo&lt;/span> &lt;span class="nv">$response&lt;/span> &lt;span class="p">|&lt;/span> awk -F&lt;span class="s1">&amp;#39;&amp;#34;&amp;#39;&lt;/span> &lt;span class="s1">&amp;#39;{print $2}&amp;#39;&lt;/span>&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="nv">$translation&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># å‘é€é€šçŸ¥&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">notify-send &lt;span class="s2">&amp;#34;Translate Rerult (&lt;/span>&lt;span class="nv">$target_language&lt;/span>&lt;span class="s2">): &amp;#34;&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$translation&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;/details>
&lt;p>æ·»åŠ è¿è¡Œæƒé™&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">sudo chmod +x /opt/my_translate.sh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="3å¿«æ·é”®è®¾ç½®">3.å¿«æ·é”®è®¾ç½®
&lt;/h2>&lt;p>åœ¨&lt;code>è®¾ç½®/é”®ç›˜/é”®ç›˜å¿«æ·é”®&lt;/code>ä¸­æ·»åŠ ä¸¤ä¸ªè‡ªå®šä¹‰å¿«æ·é”®(en-&amp;gt;zh, zh-&amp;gt;en)ï¼š&lt;/p>
&lt;p>&lt;img src="https://RoboticsChen.github.io/articles/linux-ubuntu-wayland-google-translate/image.png"
width="522"
height="422"
srcset="https://RoboticsChen.github.io/articles/linux-ubuntu-wayland-google-translate/image_hu_be599b68654b9eda.png 480w, https://RoboticsChen.github.io/articles/linux-ubuntu-wayland-google-translate/image_hu_3a238f9476b10cb6.png 1024w"
loading="lazy"
alt="å›¾1 è‹±è¯‘ä¸­"
class="gallery-image"
data-flex-grow="123"
data-flex-basis="296px"
> &lt;img src="https://RoboticsChen.github.io/articles/linux-ubuntu-wayland-google-translate/image-1.png"
width="522"
height="422"
srcset="https://RoboticsChen.github.io/articles/linux-ubuntu-wayland-google-translate/image-1_hu_81933a45d5c4bd36.png 480w, https://RoboticsChen.github.io/articles/linux-ubuntu-wayland-google-translate/image-1_hu_83998731913ae9f1.png 1024w"
loading="lazy"
alt="å›¾2 ä¸­è¯‘è‹±"
class="gallery-image"
data-flex-grow="123"
data-flex-basis="296px"
>&lt;/p>
&lt;p>æ³¨æ„æ ¹æ®è„šæœ¬åç§°å¯¹åº”ä¿®æ”¹å‘½ä»¤&lt;/p></description></item><item><title>ç›¸æœºæˆåƒä¸ISP</title><link>https://RoboticsChen.github.io/articles/camera-isp/</link><pubDate>Mon, 11 Nov 2024 10:35:55 +0000</pubDate><guid>https://RoboticsChen.github.io/articles/camera-isp/</guid><description>&lt;img src="https://RoboticsChen.github.io/articles/camera-isp/raw_image.png" alt="Featured image of post ç›¸æœºæˆåƒä¸ISP" />&lt;h1 id="ç›¸æœºæˆåƒä¸isp">ç›¸æœºæˆåƒä¸ISP
&lt;/h1>&lt;h2 id="ç›¸æœºæˆåƒ">ç›¸æœºæˆåƒ
&lt;/h2>&lt;h3 id="ccd-vs-cmos">CCD vs CMOS
&lt;/h3>&lt;ul>
&lt;li>CCDï¼šå…¨ç§°Charge Coupled Deviceï¼Œå³ç”µè·è€¦åˆå™¨ä»¶&lt;/li>
&lt;li>CMOSï¼šå…¨ç§°Complementary Metal Oxide Semiconductorï¼Œå³äº’è¡¥é‡‘å±æ°§åŒ–ç‰©åŠå¯¼ä½“&lt;/li>
&lt;/ul>
&lt;p>è¿™ä¸¤ç§ä¼ æ„Ÿå™¨éƒ½ç”±å¤šä¸ªå…‰ç”µäºŒæç®¡ç»„æˆçš„é˜µåˆ—ï¼Œæ¯ä¸ªå…‰ç”µäºŒæç®¡çš„ä½œç”¨æ˜¯å°†æ¥æ”¶åˆ°çš„å…‰ä¿¡å·è½¬åŒ–ä¸ºç”µè·ã€‚ä¸¤è€…çš„åŸºæœ¬å·¥ä½œåŸç†ç›¸ä¼¼ï¼Œä¼ æ„Ÿå™¨æ¥æ”¶å…‰ä¿¡å·å¹¶é€šè¿‡ä¸€å®šæ—¶é—´çš„ç”µè·ç§¯ç´¯å®ç°æ›å…‰ï¼Œè¿›è€Œè·å¾—æ¯ä¸ªåƒç´ çš„å…‰å¼ºåº¦æ•°æ®ã€‚æœ€åï¼Œè¿™äº›ç”µè·ç»æ¨¡æ•°è½¬æ¢è¢«è½¬æ¢ä¸ºç”µå‹å¹¶ç»è¿‡æ”¾å¤§å¤„ç†ï¼Œæœ€ç»ˆç”ŸæˆåŸå§‹çš„RAWå›¾åƒæ•°æ®ã€‚&lt;/p>
&lt;p>åœ¨å…·ä½“çš„å®ç°æ–¹å¼ä¸Šï¼Œä¸¤è€…æœ‰ä¸€å®šçš„åŒºåˆ«ï¼š&lt;/p>
&lt;ul>
&lt;li>CCDï¼šæ¯ä¸ªåƒç´ ç‚¹çš„ç”µè·ä¼šè¢«ä¼ è¾“åˆ°ä¸€ä¸ªå•ç‹¬çš„è¾“å‡ºèŠ‚ç‚¹ï¼Œé€šè¿‡è¿™ä¸€èŠ‚ç‚¹å°†ç”µè·è½¬åŒ–ä¸ºç”µå‹ä¿¡å·ï¼Œå³ä¸€è¡Œè¡Œè¯»å‡ºã€‚è¿™ç§æ–¹å¼æœ‰åŠ©äºå®ç°è¾ƒä½çš„å™ªå£°å’Œè¾ƒé«˜çš„å›¾åƒè´¨é‡ï¼Œä½†ç”±äºä¼ è¾“è¿‡ç¨‹ä¸­éœ€è¦å¤§é‡çš„ç”µå­å…ƒä»¶å’Œå¤æ‚çš„ç”µè·¯è®¾è®¡ï¼ŒCCDä¼ æ„Ÿå™¨çš„åŠŸè€—è¾ƒé«˜ï¼Œä¸”è¯»å‡ºé€Ÿåº¦è¾ƒæ…¢ã€‚&lt;/li>
&lt;li>CMOSï¼šæ¯ä¸ªåƒç´ ç‚¹éƒ½å…·æœ‰ä¸€ä¸ªç‹¬ç«‹çš„æ”¾å¤§å™¨ï¼Œèƒ½å¤Ÿåœ¨ä¼ æ„Ÿå™¨å†…ç›´æ¥å°†ç”µè·è½¬åŒ–ä¸ºç”µå‹ä¿¡å·å¹¶è¿›è¡Œæ”¾å¤§å¤„ç†ã€‚è¿™ç§æ–¹å¼ä½¿å¾—æ¯ä¸ªåƒç´ çš„ç”µè·è½¬æ¢è¿‡ç¨‹ç›¸å¯¹ç‹¬ç«‹ï¼Œèƒ½æ›´å¿«é€Ÿåœ°è¯»å–å›¾åƒæ•°æ®ï¼Œé™ä½åŠŸè€—ï¼Œä½†åœ¨ä½å…‰ç…§ç¯å¢ƒä¸‹å¯èƒ½ä¼šäº§ç”Ÿè¾ƒå¤šå™ªå£°ã€‚&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://RoboticsChen.github.io/articles/camera-isp/CCD_vs_CMOS.gif"
width="477"
height="212"
srcset="https://RoboticsChen.github.io/articles/camera-isp/CCD_vs_CMOS_hu_7219fee36517f58e.gif 480w, https://RoboticsChen.github.io/articles/camera-isp/CCD_vs_CMOS_hu_b66332599cf6688f.gif 1024w"
loading="lazy"
alt="å›¾1 CDDvsCMOSå·¥ä½œåŸç†"
class="gallery-image"
data-flex-grow="225"
data-flex-basis="540px"
>&lt;/p>
&lt;p>æ€»çš„æ¥çœ‹ï¼ŒCMOSä¼ æ„Ÿå™¨ç›¸æ¯”äºCCDä¼ æ„Ÿå™¨ï¼Œå·¥è‰ºç®€å•ã€æˆæœ¬æ›´ä½ï¼Œéšç€CMOSæŠ€æœ¯çš„ä¸æ–­è¿›æ­¥ï¼Œå°¤å…¶æ˜¯åœ¨é™ä½å™ªå£°ã€æé«˜ä½å…‰ç…§æ€§èƒ½å’Œå¢å¼ºå›¾åƒè´¨é‡æ–¹é¢çš„æå‡ï¼ŒCMOSä¼ æ„Ÿå™¨å·²ç»é€æ¸å–ä»£äº†ä¼ ç»Ÿçš„CCDä¼ æ„Ÿå™¨ï¼Œæˆä¸ºä¸»æµé€‰æ‹©ã€‚å½“ä»ŠCCDä¼ æ„Ÿå™¨çš„åº”ç”¨ä¸»è¦å±€é™äºä¸€äº›å¯¹å›¾åƒè´¨é‡è¦æ±‚æé«˜çš„ä¸“ä¸šé¢†åŸŸã€‚&lt;/p>
&lt;h3 id="bayeré˜µåˆ—ä¸rawå›¾åƒ">Bayeré˜µåˆ—ä¸RAWå›¾åƒ
&lt;/h3>&lt;p>1.1èŠ‚ä¸­æåˆ°ï¼Œsensoré€šè¿‡å°†å…‰å¼ºä¿¡å·è½¬åŒ–ä¸ºç”µå‹ä¿¡å·ï¼Œä»è€Œå¾—åˆ°äº†RAWå›¾åƒï¼Œå› æ­¤ï¼Œå¦‚æœä¸åŠ ä»»ä½•å¤„ç†ï¼Œå¾—åˆ°çš„rawå›¾å°†æ˜¯åªæœ‰äº®åº¦çš„é»‘ç™½å›¾åƒã€‚&lt;/p>
&lt;p>ä¸ºäº†åˆæˆå½©è‰²å›¾åƒï¼Œåˆ™éœ€è¦å¾—åˆ°æ¯ä¸€ä¸ªåƒç´ ç‚¹å¤„çš„RGBä¸‰é€šé“çš„äº®åº¦å€¼ã€‚è¦è·å¾—æŸä¸ªé€šé“çš„äº®åº¦å€¼ï¼Œå¯ä»¥åœ¨å…‰ç”µäºŒæç®¡å‰åŠ ä¸Šåªå…è®¸çº¢/ç»¿/è“è‰²å…‰é€šè¿‡çš„æ»¤å…‰ç‰‡ã€‚äºæ˜¯æˆ‘ä»¬å¯ä»¥é‡‡ç”¨è¿™æ ·ä¸€ç§æ’åˆ—æ–¹å¼ï¼Œå››ä¸ªæ»¤å…‰ç‰‡ä¾æ¬¡æŒ‰Rã€Gã€Gã€Bæ’åˆ—ã€‚ä¸ºä»€ä¹ˆæ˜¯ä¸¤ä¸ªç»¿è‰²å‘¢ï¼Œå› ä¸ºäººçœ¼å¯¹ç»¿è‰²æ›´ä¸ºæ•æ„Ÿï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨ä¸¤ä¸ªç»¿è‰²æ¥å¢å¼ºç»¿è‰²çš„è§£æåŠ›ã€‚è¿™ç§æ’åˆ—æ–¹å¼åˆç§°Bayeré˜µåˆ—ï¼ˆBayer Patternï¼‰ï¼Œäº1974ç”±æŸ¯è¾¾çš„å·¥ç¨‹å¸ˆBayeræå‡ºã€‚&lt;/p>
&lt;p>&lt;img src="https://RoboticsChen.github.io/articles/camera-isp/bayer_pattern.jpg"
width="477"
height="401"
srcset="https://RoboticsChen.github.io/articles/camera-isp/bayer_pattern_hu_70fb1c15a1cdd384.jpg 480w, https://RoboticsChen.github.io/articles/camera-isp/bayer_pattern_hu_ab411708a6a4bbcd.jpg 1024w"
loading="lazy"
alt="å›¾2 Bayeré˜µåˆ—(å±€éƒ¨)"
class="gallery-image"
data-flex-grow="118"
data-flex-basis="285px"
> &lt;img src="https://RoboticsChen.github.io/articles/camera-isp/bayer_image.png"
width="899"
height="766"
srcset="https://RoboticsChen.github.io/articles/camera-isp/bayer_image_hu_f699a8f475338be6.png 480w, https://RoboticsChen.github.io/articles/camera-isp/bayer_image_hu_7cc7b7f88b29dedc.png 1024w"
loading="lazy"
alt="å›¾3 Bayeré˜µåˆ—(æ•´ä½“)"
class="gallery-image"
data-flex-grow="117"
data-flex-basis="281px"
>&lt;/p>
&lt;p>é™¤äº†æœ€å¸¸ç”¨çš„Bayeré˜µåˆ—ï¼Œä¸€äº›å‚å•†ä¹Ÿé‡‡ç”¨äº†å…¶ä»–çš„æ’åˆ—æ–¹å¼ï¼Œå¦‚ç´¢å°¼çš„REGB(çº¢é’ç»¿è“)ï¼Œåä¸ºçš„RYYB(çº¢é»„é»„è“)ï¼Œå¯Œå£«çš„ä¹±ä¸ƒå…«ç³Ÿæ’åˆ—ï¼ˆbushi&lt;/p>
&lt;p>&lt;img src="https://RoboticsChen.github.io/articles/camera-isp/sony_pattern.png"
width="1151"
height="629"
srcset="https://RoboticsChen.github.io/articles/camera-isp/sony_pattern_hu_3bb02ad4485c1f72.png 480w, https://RoboticsChen.github.io/articles/camera-isp/sony_pattern_hu_34ff9f7c8012b1d9.png 1024w"
loading="lazy"
alt="å›¾4 ç´¢å°¼REGB"
class="gallery-image"
data-flex-grow="182"
data-flex-basis="439px"
> &lt;img src="https://RoboticsChen.github.io/articles/camera-isp/huawei_pattern.png"
width="721"
height="659"
srcset="https://RoboticsChen.github.io/articles/camera-isp/huawei_pattern_hu_a6d58b1e763a578d.png 480w, https://RoboticsChen.github.io/articles/camera-isp/huawei_pattern_hu_87de3680480748c2.png 1024w"
loading="lazy"
alt="å›¾5 åä¸ºRYYB"
class="gallery-image"
data-flex-grow="109"
data-flex-basis="262px"
> &lt;img src="https://RoboticsChen.github.io/articles/camera-isp/fushi_pattern.png"
width="1212"
height="754"
srcset="https://RoboticsChen.github.io/articles/camera-isp/fushi_pattern_hu_dc30a2e08079202d.png 480w, https://RoboticsChen.github.io/articles/camera-isp/fushi_pattern_hu_49bce126439f69b5.png 1024w"
loading="lazy"
alt="å›¾6 å¯Œå£«æ’åˆ—"
class="gallery-image"
data-flex-grow="160"
data-flex-basis="385px"
>&lt;/p>
&lt;p>å¦‚æœæ­¤æ—¶ï¼Œæˆ‘ä»¬å°†è¿™äº›bayeræ’åˆ—çš„ç”µä¿¡å·è½¬æ¢æˆæ•°å­—ä¿¡å·ï¼Œå¹¶ä¿å­˜ä¸‹æ¥ï¼Œå°±å¯ä»¥å¾—åˆ°RAWå›¾åƒã€‚&lt;/p>
&lt;p>&lt;img src="https://RoboticsChen.github.io/articles/camera-isp/raw_image.png"
width="3070"
height="1227"
srcset="https://RoboticsChen.github.io/articles/camera-isp/raw_image_hu_16bc9f03463ec477.png 480w, https://RoboticsChen.github.io/articles/camera-isp/raw_image_hu_743a520db2515086.png 1024w"
loading="lazy"
alt="å›¾7 RAWå›¾åƒ"
class="gallery-image"
data-flex-grow="250"
data-flex-basis="600px"
>&lt;/p>
&lt;p>æ­¤æ—¶çš„å›¾åƒä¾æ—§æ˜¯é»‘ç™½çš„ï¼Œå¹¶ä¸”å¦‚æœæ”¾å¤§å±€éƒ¨ï¼Œä¼šå‘ç°å›¾åƒä¼šå‘ˆç°é©¬èµ›å…‹ä¸€æ ·çš„æ•ˆæœï¼Œä¸ºäº†å¾—åˆ°æœ€ç»ˆçš„å›¾åƒï¼Œéœ€è¦å®Œæˆä¸€ç³»åˆ—å›¾åƒä¿¡å·å¤„ç†ï¼Œå³Image Signal Processing(ISP)ã€‚&lt;/p>
&lt;h2 id="image-signal-processisp">Image Signal Processï¼ˆISPï¼‰
&lt;/h2>&lt;h3 id="åç‚¹æ ¡æ­£dead-pixel-correction-dpc">åç‚¹æ ¡æ­£ï¼ˆDead Pixel Correction, DPCï¼‰
&lt;/h3>&lt;p>æ ¹æ®æ˜¯å¦ä¼šå‘ç”Ÿå˜åŒ–ï¼Œåç‚¹å¯ä»¥åˆ†ä¸ºé™æ€åç‚¹å’ŒåŠ¨æ€åç‚¹ã€‚&lt;/p>
&lt;ul>
&lt;li>é™æ€åç‚¹ï¼šä¸éšç€æ—¶é—´ã€å¢ç›Šç­‰æ”¹å˜ï¼Œé€šå¸¸æ˜¯sensoråˆ¶é€ æ—¶å› å·¥è‰ºåŸå› äº§ç”Ÿçš„åç‚¹ã€‚&lt;/li>
&lt;li>åŠ¨æ€åç‚¹ï¼šå› ä¸ºå¢ç›Šã€æ¸©åº¦ç­‰å¼•èµ·çš„åç‚¹ï¼Œä¼šéšç€æ—¶é—´å˜åŒ–è€Œæ”¹å˜ã€‚&lt;/li>
&lt;/ul>
&lt;p>åœ¨ ISP å¤„ç†é˜¶æ®µï¼Œéœ€è¦å¯¹å›¾åƒä¸­çš„åç‚¹è¿›è¡Œæ ¡æ­£ã€‚é™æ€åç‚¹é€šå¸¸åœ¨ä¼ æ„Ÿå™¨ç”Ÿäº§çº¿ä¸Šæ ‡å®šï¼Œå…¶ä½ç½®ä¼šè¢«è®°å½•åˆ° OTPï¼ˆOne Time Programmableï¼‰å­˜å‚¨å™¨ä¸­ï¼Œç”¨äºåç»­æ ¡æ­£ã€‚&lt;/p>
&lt;p>åŠ¨æ€åç‚¹çš„æ ¡æ­£åˆ™å‘ç”Ÿåœ¨é™æ€åç‚¹æ ¡æ­£å®Œæˆä¹‹åã€‚æ ¡æ­£è¿‡ç¨‹ä¸­ï¼Œé€šè¿‡é€ä¸€æ£€æŸ¥æ¯ä¸ªåƒç´ ç‚¹ä¸å…¶å‘¨å›´ä¸€å®šèŒƒå›´å†…çš„åƒç´ å€¼ï¼Œå¦‚æœå‘ç°æŸä¸ªåƒç´ çš„å€¼ä¸å‘¨å›´åƒç´ çš„å€¼å·®å¼‚è¶…è¿‡è®¾å®šé˜ˆå€¼ï¼Œåˆ™åˆ¤å®šä¸ºåç‚¹ã€‚å¯¹äºè¿™äº›åç‚¹ï¼Œé€šå¸¸ä½¿ç”¨åŒé€šé“å†…å‘¨å›´åƒç´ çš„å¹³å‡å€¼æ¥æ›¿ä»£è¿›è¡Œæ ¡æ­£ï¼Œä»è€Œæ¢å¤å›¾åƒçš„å®Œæ•´æ€§å’Œè´¨é‡ã€‚&lt;/p>
&lt;p>&lt;img src="https://RoboticsChen.github.io/articles/camera-isp/image.png"
width="244"
height="120"
srcset="https://RoboticsChen.github.io/articles/camera-isp/image_hu_bee2f62f7221ee4d.png 480w, https://RoboticsChen.github.io/articles/camera-isp/image_hu_3bee4c8fd20ed109.png 1024w"
loading="lazy"
alt="å›¾8 åç‚¹æ ¡æ­£"
class="gallery-image"
data-flex-grow="203"
data-flex-basis="488px"
>&lt;/p>
&lt;details class="popup-details">
&lt;summary>ç¤ºä¾‹ä»£ç &lt;/summary>
&lt;div class="popup-content">
&lt;button class="close-btn">âœ–&lt;/button>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;span class="lnt">65
&lt;/span>&lt;span class="lnt">66
&lt;/span>&lt;span class="lnt">67
&lt;/span>&lt;span class="lnt">68
&lt;/span>&lt;span class="lnt">69
&lt;/span>&lt;span class="lnt">70
&lt;/span>&lt;span class="lnt">71
&lt;/span>&lt;span class="lnt">72
&lt;/span>&lt;span class="lnt">73
&lt;/span>&lt;span class="lnt">74
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-cpp" data-lang="cpp">&lt;span class="line">&lt;span class="cl">&lt;span class="cm">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * @brief Performs dead pixel correction (DPC) on RAW image data by identifying
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * and correcting pixels that differ significantly from their neighbors.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> *
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * @param raw Reference to the input RAW image data.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * @param thres Threshold value for detecting dead pixels. A pixel is
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * considered dead if it deviates from its neighboring pixels by more than this
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * threshold.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * @param mode DPC correction mode. Options are:
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * - DPC_MODE_MEAN: Replaces the dead pixel value with the
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * average of its immediate neighbors.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * - DPC_MODE_GRADIENT: Replaces the dead pixel based on the
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * smallest gradient among neighboring pixels.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * - DPC_MODE_UNKNOWN: Throws an error if the mode is
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * unrecognized.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * @param clip Maximum allowable pixel value after correction. Values
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * exceeding this are clipped.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm">**/&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kt">void&lt;/span> &lt;span class="nf">DPC&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ImageRaw&lt;/span>&lt;span class="o">&amp;amp;&lt;/span> &lt;span class="n">raw&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">uint16_t&lt;/span> &lt;span class="n">thres&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">DPC_MODE&lt;/span> &lt;span class="n">mode&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">uint16_t&lt;/span> &lt;span class="n">clip&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ImageRaw&lt;/span>&lt;span class="o">*&lt;/span> &lt;span class="n">raw_pad&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">ImageRaw&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">raw&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">raw_pad&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">padding&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">PADDING_MODE_REFLECT&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">y&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">y&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">raw_pad&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">getHeight&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">y&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">raw_pad&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">getWidth&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">uint16_t&lt;/span> &lt;span class="n">p0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">p1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">p2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">p3&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">p4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">p5&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">p6&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">p7&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">p8&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">uint16_t&lt;/span> &lt;span class="n">dv&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">dh&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ddl&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ddr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">minimal&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">p0&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">raw_pad&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">p1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">raw_pad&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">p2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">raw_pad&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">p3&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">raw_pad&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">p4&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">raw_pad&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">p5&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">raw_pad&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">p6&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">raw_pad&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">p7&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">raw_pad&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">p8&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">raw_pad&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="n">ABS&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">p1&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">p0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">thres&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">ABS&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">p2&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">p0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">thres&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">ABS&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">p3&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">p0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">thres&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">ABS&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">p4&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">p0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">thres&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="n">ABS&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">p5&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">p0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">thres&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">ABS&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">p6&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">p0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">thres&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">ABS&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">p7&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">p0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">thres&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">ABS&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">p8&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">p0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">thres&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">switch&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">mode&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">case&lt;/span> &lt;span class="nl">DPC_MODE_MEAN&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">p0&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">p2&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">p4&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">p5&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">p7&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">case&lt;/span> &lt;span class="nl">DPC_MODE_GRADIENT&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">dv&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ABS&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">p0&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">p2&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">p7&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">dh&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ABS&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">p0&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">p4&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">p5&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ddl&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ABS&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">p0&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">p1&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">p8&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ddr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ABS&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">p0&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">p3&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">p6&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">minimal&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">MIN&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">MIN&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">MIN&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">dv&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">dh&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="n">ddl&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="n">ddr&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">minimal&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">dv&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">p0&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">p2&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">p7&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// Adding +1 here helps prevent rounding errors in integer division.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">minimal&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">dh&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">p0&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">p4&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">p5&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">minimal&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">ddl&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">p0&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">p1&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">p8&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span> &lt;span class="n">p0&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">p3&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">p6&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">case&lt;/span> &lt;span class="nl">DPC_MODE_UNKNOWN&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">TRACE_DEBUG_LOG_ERROR&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Unknown DPC Mode:%s&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">mode&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">throw&lt;/span> &lt;span class="s">&amp;#34;Unknown DPC mode&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">default&lt;/span>&lt;span class="o">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">TRACE_DEBUG_LOG_ERROR&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Unknown DPC Mode:%s&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">mode&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">throw&lt;/span> &lt;span class="s">&amp;#34;Unknown DPC mode&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">raw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">p0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">raw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">clip&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">clip&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">delete&lt;/span> &lt;span class="n">raw_pad&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;/details>
&lt;h3 id="æš—ç”µæµæ ¡æ­£black-level-correctionblc">æš—ç”µæµæ ¡æ­£ï¼ˆBlack level Correctionï¼ŒBLCï¼‰
&lt;/h3>&lt;p>æš—ç”µæµæ ¡æ­£åˆç§°â€œé»‘åº¦æ ¡æ­£â€ã€‚åœ¨ç›¸æœºå·¥ä½œè¿‡ç¨‹ä¸­ï¼Œå³ä½¿æ²¡æœ‰æ¥æ”¶åˆ°å…‰ä¿¡å·ï¼Œä¼ æ„Ÿå™¨ä¹Ÿä¼šç”±äºæŸäº›å› ç´ äº§ç”Ÿä¸€å®šçš„æš—ç”µæµï¼Œä»è€Œå¯¼è‡´è¾“å‡ºçš„ç”µå‹ä¿¡å·å­˜åœ¨åç§»ï¼Œå›¾åƒçš„â€œé»‘åº¦â€ä¸çœŸå®æƒ…å†µå­˜åœ¨å·®å¼‚ã€‚è¿™ä¸ªåç§»å€¼çš„æ¥æºæœ‰ä¸¤æ–¹é¢ï¼Œå…¶ä¸€æ˜¯æ¨¡æ•°è½¬æ¢åƒçš„å¢ç›Šï¼Œå…¶äºŒæ˜¯æ¸©åº¦ç­‰ç‰©ç†åŸå› å¯¼è‡´çš„ä¼ æ„Ÿå™¨åç§»ã€‚é»‘ç”µå¹³æ ¡æ­£æ¨¡å—å°±æ˜¯é€šè¿‡æ ‡å®šçš„æ–¹å¼ï¼Œç¡®å®šè¿™ä¸ªåç§»é‡çš„å…·ä½“å€¼ã€‚åç»­çš„ ISP å¤„ç†æ¨¡å—ï¼Œéœ€è¦å…ˆå‡æ‰è¯¥åç§»å€¼ï¼Œæ‰èƒ½ä¿è¯å›¾åƒçš„å‡†ç¡®æ€§ã€‚&lt;/p>
&lt;ul>
&lt;li>&lt;em>æ¨¡æ‹Ÿä¿¡å·å¾ˆå¾®å¼±æ—¶ï¼Œæœ‰å¯èƒ½ä¸è¢« A/D è½¬æ¢å‡ºæ¥ï¼Œå¯¼è‡´å…‰çº¿å¾ˆæš—æ—¶ï¼Œå›¾åƒç»†èŠ‚ä¸¢å¤±ã€‚å› æ­¤ï¼ŒSesnor ä¼šåœ¨ A/D è½¬æ¢å‰ï¼Œç»™æ¨¡æ‹Ÿä¿¡å·ä¸€ä¸ªå›ºå®šçš„åç§»é‡ï¼Œä¿è¯è¾“å‡ºçš„æ•°å­—ä¿¡å·ä¿ç•™æ›´å¤šçš„å›¾åƒç»†èŠ‚ã€‚&lt;/em>&lt;/li>
&lt;/ul>
&lt;p>é€šå¸¸çš„æ ¡æ­£æ–¹æ³•æ˜¯åœ¨ä¼ æ„Ÿå™¨å®Œå…¨é®å…‰çš„æƒ…å†µä¸‹æ•è·â€œæš—å¸§â€ã€‚ç„¶åè®°å½•æ¯ä¸ªåƒç´ çš„æ•°å­—è¾“å‡ºï¼Œè®¡ç®—è¯¥å›¾åƒçš„å¹³å‡å€¼ï¼ˆæœ‰æ—¶ä½¿ç”¨ä¸­å€¼ï¼‰ã€‚è¿™ä¸ªå¹³å‡å€¼æˆ–ä¸­å€¼è¡¨ç¤ºä¼ æ„Ÿå™¨çš„æ•´ä½“é»‘ç”µå¹³åç§»ã€‚æ¥ä¸‹æ¥ï¼Œå°†è¯¥å€¼ä»ä¼ æ„Ÿå™¨ç”Ÿæˆçš„å›¾åƒä¸­çš„æ¯ä¸ªåƒç´ å€¼ä¸­å‡å»ï¼Œä»¥æ ¡æ­£æš—ç”µæµå¼•èµ·çš„åç§»ï¼Œæ¢å¤å›¾åƒçš„çœŸå®äº®åº¦ã€‚&lt;/p>
&lt;p>&lt;img src="https://RoboticsChen.github.io/articles/camera-isp/image-1.png"
width="510"
height="273"
srcset="https://RoboticsChen.github.io/articles/camera-isp/image-1_hu_9103516c5f35fb9.png 480w, https://RoboticsChen.github.io/articles/camera-isp/image-1_hu_d65cbbe4dd9e3ae4.png 1024w"
loading="lazy"
alt="å›¾9 æš—ç”µæµæ ¡æ­£"
class="gallery-image"
data-flex-grow="186"
data-flex-basis="448px"
>&lt;/p>
&lt;details class="popup-details">
&lt;summary>ç¤ºä¾‹ä»£ç &lt;/summary>
&lt;div class="popup-content">
&lt;button class="close-btn">âœ–&lt;/button>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;span class="lnt">65
&lt;/span>&lt;span class="lnt">66
&lt;/span>&lt;span class="lnt">67
&lt;/span>&lt;span class="lnt">68
&lt;/span>&lt;span class="lnt">69
&lt;/span>&lt;span class="lnt">70
&lt;/span>&lt;span class="lnt">71
&lt;/span>&lt;span class="lnt">72
&lt;/span>&lt;span class="lnt">73
&lt;/span>&lt;span class="lnt">74
&lt;/span>&lt;span class="lnt">75
&lt;/span>&lt;span class="lnt">76
&lt;/span>&lt;span class="lnt">77
&lt;/span>&lt;span class="lnt">78
&lt;/span>&lt;span class="lnt">79
&lt;/span>&lt;span class="lnt">80
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-cpp" data-lang="cpp">&lt;span class="line">&lt;span class="cl">&lt;span class="cm">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * @brief Performs black level correction (BLC) on RAW image data based on the
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * specified Bayer pattern.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> *
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * @param raw Reference to the input RAW image data.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * @param r Black level correction value for the red channel.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * @param gr Black level correction value for the green channel (red
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * row).
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * @param gb Black level correction value for the green channel (blue
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * row).
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * @param b Black level correction value for the blue channel.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * @param alpha Alpha coefficient for adjusting the green channel (red
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * row).
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * @param beta Beta coefficient for adjusting the green channel (blue
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * row).
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * @param bayer_pattern The Bayer pattern used in the RAW data (e.g., RGGB,
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * BGGR, GBRG, GRBG).
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * @param clip Maximum allowable pixel value after correction. Values
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * exceeding this are clipped.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kt">void&lt;/span> &lt;span class="nf">BLC&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ImageRaw&lt;/span>&lt;span class="o">&amp;amp;&lt;/span> &lt;span class="n">raw&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">uint16_t&lt;/span> &lt;span class="n">r&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">uint16_t&lt;/span> &lt;span class="n">gr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">uint16_t&lt;/span> &lt;span class="n">gb&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">uint16_t&lt;/span> &lt;span class="n">b&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">float&lt;/span> &lt;span class="n">alpha&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">float&lt;/span> &lt;span class="n">beta&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">BAYER_PATTERN&lt;/span> &lt;span class="n">bayer_pattern&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">uint16_t&lt;/span> &lt;span class="n">clip&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">switch&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">bayer_pattern&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">case&lt;/span> &lt;span class="nl">BAYER_PATTERN_RGGB&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">y&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">y&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">raw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">getHeight&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="n">y&lt;/span>&lt;span class="o">+=&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">raw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">getWidth&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="o">+=&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">raw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">r&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// r
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">raw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">b&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// b
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">raw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">gr&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">alpha&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">raw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// gr
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">raw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">gb&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">beta&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">raw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// gb
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">case&lt;/span> &lt;span class="nl">BAYER_PATTERN_BGGR&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">y&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">y&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">raw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">getHeight&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="n">y&lt;/span>&lt;span class="o">+=&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">raw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">getWidth&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="o">+=&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">raw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">b&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">raw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">r&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">raw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">gb&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">beta&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">raw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">raw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">gr&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">alpha&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">raw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">case&lt;/span> &lt;span class="nl">BAYER_PATTERN_GBRG&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">y&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">y&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">raw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">getHeight&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="n">y&lt;/span>&lt;span class="o">+=&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">raw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">getWidth&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="o">+=&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">raw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">b&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">raw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">r&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">raw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">gb&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">beta&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">raw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">raw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">gr&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">alpha&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">raw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">case&lt;/span> &lt;span class="nl">BAYER_PATTERN_GRBG&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">y&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">y&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">raw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">getHeight&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="n">y&lt;/span>&lt;span class="o">+=&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">raw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">getWidth&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="o">+=&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">raw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">b&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">raw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">r&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">raw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">gb&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">beta&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">raw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">raw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">gr&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">alpha&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">raw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">case&lt;/span> &lt;span class="nl">BAYER_PATTERN_UNKNOWN&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">default&lt;/span>&lt;span class="o">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">TRACE_DEBUG_LOG_ERROR&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Unknown Bayer Pattern:%s&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">bayer_pattern&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">throw&lt;/span> &lt;span class="s">&amp;#34;Unknown bayer pattern&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">raw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">clip&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">clip&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;/details>
&lt;h3 id="é•œå¤´é˜´å½±æ ¡æ­£lens-shading-correctionlsc">é•œå¤´é˜´å½±æ ¡æ­£ï¼ˆLens Shading Correctionï¼ŒLSCï¼‰
&lt;/h3>&lt;p>Lens Shading æ˜¯ç›¸æœºæˆåƒè¿‡ç¨‹ä¸­ä¸€ç§ç”±é•œå¤´ä¸å›¾åƒä¼ æ„Ÿå™¨çš„å…‰å­¦ç‰¹æ€§å¼•èµ·çš„ç°è±¡ã€‚å…·ä½“è¡¨ç°ä¸ºå›¾åƒäº®åº¦å’Œé¢œè‰²åœ¨è§†åœºï¼ˆField of Viewï¼ŒFOVï¼‰ä¸­çš„åˆ†å¸ƒä¸å‡åŒ€ï¼Œé€šå¸¸æ˜¯å›¾åƒä¸­å¿ƒäº®åº¦è¾ƒé«˜ï¼Œè€Œè¾¹ç¼˜äº®åº¦è¾ƒä½ï¼Œå¹¶å¯èƒ½ä¼´éšé¢œè‰²åç§»ã€‚å®ƒæ˜¯æš—è§’ç°è±¡ï¼ˆVignettingï¼‰çš„æ‰©å±•ï¼ŒåŒ…å«äº†äº®åº¦ï¼ˆLuma Shadingï¼‰å’Œè‰²å½©ï¼ˆChroma Shadingï¼‰çš„ä¸å‡åŒ€æ€§ã€‚&lt;/p>
&lt;h4 id="äº®åº¦lumaé˜´å½±">äº®åº¦ï¼ˆLumaï¼‰é˜´å½±
&lt;/h4>&lt;p>Luma Shading ä¹Ÿè¢«ç§°ä¸ºæ¸æ™•ï¼ˆVignettingï¼‰ï¼Œç”±äºé€é•œç»„çš„å…‰å­¦ç‰¹æ€§ï¼Œå…¥å°„å…‰åç¦»å…‰è½´è§’åº¦è¾ƒå¤§æ—¶ï¼Œéƒ¨åˆ†å…‰å°±ä¼šå—å…‰é˜‘çš„å½±å“è€Œæ— æ³•åœ¨æ„Ÿå…‰å¹³é¢ä¸Šæˆåƒï¼Œä»è€Œå¯¼è‡´è¶Šé è¿‘è¾¹ç¼˜çš„åƒç´ äº®åº¦è¶Šä½ã€‚&lt;/p>
&lt;p>&lt;img src="https://RoboticsChen.github.io/articles/camera-isp/image-3.png"
width="1204"
height="549"
srcset="https://RoboticsChen.github.io/articles/camera-isp/image-3_hu_a524348aa9407e67.png 480w, https://RoboticsChen.github.io/articles/camera-isp/image-3_hu_1c6e1c25e18069b9.png 1024w"
loading="lazy"
alt="å›¾10 é•œå¤´å…¥å°„å…‰ä¼ é€’è·¯å¾„å›¾"
class="gallery-image"
data-flex-grow="219"
data-flex-basis="526px"
> &lt;img src="https://RoboticsChen.github.io/articles/camera-isp/image-2.png"
width="373"
height="293"
srcset="https://RoboticsChen.github.io/articles/camera-isp/image-2_hu_19aa7f6afedb7342.png 480w, https://RoboticsChen.github.io/articles/camera-isp/image-2_hu_3365ea2281cd10db.png 1024w"
loading="lazy"
alt="å›¾11 Lens shadingå¯¼è‡´çš„æš—è§’ç°è±¡"
class="gallery-image"
data-flex-grow="127"
data-flex-basis="305px"
>&lt;/p>
&lt;p>æ­¤å¤–,å¯¹äºFSIå·¥è‰ºçš„sensorï¼ŒLuma shadingçš„ä¸»è¦æˆå› è¿˜åŒ…æ‹¬è¾¹ç¼˜åƒç´ ç„¦ç‚¹é”™ä½ï¼Œè§£å†³è¿™ä¸ªé—®é¢˜å¯ä»¥é€šè¿‡è¾¹ç¼˜å¾®é€é•œçš„åç§»æ¥ä¿®æ­£ï¼Œå³ä»ä¸­å¿ƒåƒç´ å¼€å§‹ï¼Œå¾®é€é•œçš„ç›´å¾„éƒ½ç•¥å°äºæˆåƒé¢ï¼Œè¿™æ ·è¶Šæ¥è¿‘è¾¹ç¼˜ï¼Œå¾®é€é•œä¸æˆåƒé¢ä¹‹é—´çš„åç§»å°±è¶Šå¤§ï¼Œä»è€Œå¯ä»¥è¡¥å¿å…¥å°„å…‰çº¿è§’åº¦è¿‡å¤§å¯¼è‡´çš„ç„¦ç‚¹åç§»ï¼Œä½¿å¾®é€é•œçš„CRAå¢å¤§ï¼Œä»è€Œå…‰çº¿å¯ä»¥æ›´å¥½åœ°æ±‡èšåˆ°æ„Ÿå…‰å¹³é¢ä¸Šã€‚&lt;/p>
&lt;p>&lt;img src="https://RoboticsChen.github.io/articles/camera-isp/image-4.png"
width="720"
height="624"
srcset="https://RoboticsChen.github.io/articles/camera-isp/image-4_hu_fdbded3af74685a1.png 480w, https://RoboticsChen.github.io/articles/camera-isp/image-4_hu_b4515cd166d56e81.png 1024w"
loading="lazy"
alt="å›¾12 ç„¦ç‚¹é”™ä½å¯¼è‡´èƒ½é‡æŸå¤±"
class="gallery-image"
data-flex-grow="115"
data-flex-basis="276px"
> &lt;img src="https://RoboticsChen.github.io/articles/camera-isp/image-5.png"
width="1874"
height="1537"
srcset="https://RoboticsChen.github.io/articles/camera-isp/image-5_hu_9b71dc9fbc484130.png 480w, https://RoboticsChen.github.io/articles/camera-isp/image-5_hu_6cb378edefb77766.png 1024w"
loading="lazy"
alt="å›¾13 è¾¹ç¼˜å¾®é€é•œä¸æˆåƒé¢åç§»è¡¥å¿ç„¦ç‚¹é”™ä½"
class="gallery-image"
data-flex-grow="121"
data-flex-basis="292px"
>&lt;/p>
&lt;p>æ‰©å±•é˜…è¯»ï¼š &lt;a class="link" href="https://www.voltrium.com.sg/en/bsi-vs-fsi-sensors-which-sensor-suits-your-needs/" target="_blank" rel="noopener"
>FSI vs BSI&lt;/a> ã€ &lt;a class="link" href="https://blog.csdn.net/weixin_39839293/article/details/82118991" target="_blank" rel="noopener"
>ä»€ä¹ˆæ˜¯CRA&lt;/a>&lt;/p>
&lt;h4 id="è‰²å½©chromaé˜´å½±">è‰²å½©ï¼ˆChromaï¼‰é˜´å½±
&lt;/h4>&lt;p>Chroma Shadingæ˜¯Lens Shadingçš„ä¸€ç§ç‰¹æ®Šæƒ…å†µï¼Œä¸»è¦è¡¨ç°ä¸ºä»ä¸­å¿ƒå‘è¾¹ç¼˜çš„è‰²æ™•ã€‚&lt;/p>
&lt;p>&lt;img src="https://RoboticsChen.github.io/articles/camera-isp/image-6.png"
width="416"
height="289"
srcset="https://RoboticsChen.github.io/articles/camera-isp/image-6_hu_de92d8c1d45423ec.png 480w, https://RoboticsChen.github.io/articles/camera-isp/image-6_hu_d1c55e22776b7ae.png 1024w"
loading="lazy"
alt="å›¾14 Chroma Shadingè‰²æ™•"
class="gallery-image"
data-flex-grow="143"
data-flex-basis="345px"
>&lt;/p>
&lt;p>Chroma Shadingçš„æˆå› ï¼Œçœ‹äº†å¾ˆå¤šåšå®¢ä»¥åŠæ–‡ç« ï¼Œä¼—è¯´çº·çº­ï¼Œæ€»ç»“èµ·æ¥ä¸»è¦ä¸¤ä¸ªåŸå› ï¼š&lt;/p>
&lt;ol>
&lt;li>å¯¹ä¸åŒæ³¢é•¿çš„å…‰å…·æœ‰ä¸åŒçš„æŠ˜å°„ç‡ï¼Œå› æ­¤åœ¨æˆåƒæ—¶ä¸åŒè‰²å…‰çš„ç„¦å¹³é¢å¹¶ä¸é‡åˆï¼Œä»è€Œäº§ç”Ÿäº†è‰²å·®ã€‚&lt;/li>
&lt;li>ç”±äºå¹²æ¶‰å‹çº¢å¤–æ»¤å…‰ç‰‡ï¼ˆIR-Filterï¼‰å¯¹ä¸åŒå…¥å°„è§’åº¦çš„çº¢å¤–å…‰çš„é˜»éš”æ•ˆæœä¸åŒï¼Œä»è€Œå¯¼è‡´éƒ¨åˆ†å¤§è§’åº¦å…¥å°„çš„è¿‘çº¢å¤–å…‰æ²¡æœ‰è¢«é˜»éš”ï¼Œä»è€Œäº§ç”Ÿäº†ä»ä¸­å¿ƒå‘è¾¹ç¼˜çš„è‰²æ™•ã€‚&lt;/li>
&lt;/ol>
&lt;p>&lt;img src="https://RoboticsChen.github.io/articles/camera-isp/image-7.png"
width="1200"
height="617"
srcset="https://RoboticsChen.github.io/articles/camera-isp/image-7_hu_1b09c7f8c60223cb.png 480w, https://RoboticsChen.github.io/articles/camera-isp/image-7_hu_e9b3d4401fa4deb9.png 1024w"
loading="lazy"
alt="å›¾15 ä¸åŒè‰²å…‰çš„ç„¦å¹³é¢ä¸é‡åˆ"
class="gallery-image"
data-flex-grow="194"
data-flex-basis="466px"
> &lt;img src="https://RoboticsChen.github.io/articles/camera-isp/image-9.png"
width="560"
height="393"
srcset="https://RoboticsChen.github.io/articles/camera-isp/image-9_hu_12189aa4831e5459.png 480w, https://RoboticsChen.github.io/articles/camera-isp/image-9_hu_67f340cc7f8ace83.png 1024w"
loading="lazy"
alt="å›¾16 ä¸åŒè‰²å…‰ä¸åŒå…¥å°„è§’çš„IR-Filteré€šè¿‡ç‡"
class="gallery-image"
data-flex-grow="142"
data-flex-basis="341px"
>&lt;/p>
&lt;h4 id="æ ¡æ­£ç®—æ³•">æ ¡æ­£ç®—æ³•
&lt;/h4>&lt;p>ç›®å‰å¸¸ç”¨çš„é•œå¤´é˜´å½±æ ¡æ­£ç®—æ³•æ˜¯å¢ç›Šæ³•ã€‚ç”±äºå­˜å‚¨æ¯ä¸ªåƒç´ ç‚¹çš„æ ¡æ­£ç³»æ•°ä¼šå ç”¨å¤§é‡å­˜å‚¨ç©ºé—´ï¼Œå®é™…å®ç°ä¸­é€šå¸¸å¯¹å›¾åƒè¿›è¡ŒnÃ—n ç½‘æ ¼åˆ’åˆ†ï¼ˆä¸€èˆ¬é€‰æ‹© 16Ã—16 çš„ç½‘æ ¼ï¼‰ï¼Œä»…å­˜å‚¨è¿™äº›ç½‘æ ¼ç‚¹å¤„çš„æ ¡æ­£ç³»æ•°ã€‚å¯¹äºç½‘æ ¼ä¹‹é—´çš„å…¶ä»–åƒç´ ç‚¹ï¼Œå…¶æ ¡æ­£ç³»æ•°é€šè¿‡å››æ¬¡ä½™å¼¦æ’å€¼è®¡ç®—å¾—åˆ°ã€‚&lt;/p>
&lt;p>å››æ¬¡ä½™å¼¦å®šå¾‹ï¼š$I_\theta = I_0 \cos^4 \theta$ï¼Œå³å¯¹äºä¸€ä¸ªæˆåƒé•œå¤´ç³»ç»Ÿï¼Œç¦»å…‰è½´çš„åƒç´ äº®åº¦ä¼šéšç€ç¦»è½´è§†åœºè§’$\theta$çš„å¢å¤§æŒ‰$\cos^4\theta$çš„æ¯”ä¾‹ä¸‹é™ã€‚è¿™ç§å…‰å­¦ç°è±¡æ˜¯é•œå¤´é˜´å½±æ•ˆåº”çš„ç†è®ºåŸºç¡€ï¼Œæ ¡æ­£æ—¶éœ€è¦é€šè¿‡æ’å€¼è®¡ç®—æ¥è¡¥å¿äº®åº¦ã€‚&lt;/p>
&lt;p>è€Œè¦å¾—åˆ°è¯¥nxnä¸ªæ ¼ç‚¹å¤„çš„æ ¡æ­£ç³»æ•°ï¼Œåœ¨å‡åŒ€å…‰æºä¸‹é‡‡é›†å‚è€ƒå›¾åƒï¼Œè®°å½•æ¯ä¸ªåƒç´ çš„å®é™…äº®åº¦å€¼ï¼Œå¹¶ä¸ç†æƒ³äº®åº¦è¿›è¡Œå¯¹æ¯”ï¼Œåè€…ä¸å‰è€…çš„æ¯”å€¼å³ä¸ºæ ¡æ­£ç³»æ•°ã€‚&lt;/p>
$$G(i,j)=\frac{I_{\mathrm{ideal}}(i,j)}{I_{\mathrm{observed}}(i,j)}$$&lt;p>&lt;img src="https://RoboticsChen.github.io/articles/camera-isp/image-10.png"
width="1410"
height="490"
srcset="https://RoboticsChen.github.io/articles/camera-isp/image-10_hu_bb0e02a8db0cea30.png 480w, https://RoboticsChen.github.io/articles/camera-isp/image-10_hu_3534a449d14989e2.png 1024w"
loading="lazy"
alt="å›¾17 é•œå¤´é˜´å½±æ ¡æ­£å‰åå¯¹æ¯”å›¾"
class="gallery-image"
data-flex-grow="287"
data-flex-basis="690px"
>&lt;/p>
&lt;details class="popup-details">
&lt;summary>ç¤ºä¾‹ä»£ç ï¼šLuma Shading Correction&lt;/summary>
&lt;div class="popup-content">
&lt;button class="close-btn">âœ–&lt;/button>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-cpp" data-lang="cpp">&lt;span class="line">&lt;span class="cl">&lt;span class="cm">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm">* @brief Performs lens shading correction (LSC) on RAW image data to compensate
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm">* for brightness falloff towards the edges.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm">*
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm">* @param raw Reference to the input RAW image data.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm">* @param intensity Intensity of the lens shading correction. Higher values
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm">* apply stronger correction.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm">* @param minR Minimum radius (distance from the center) for applying
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm">* correction. If less than 0, defaults to 0.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm">* @param maxR Maximum radius (distance from the center) for applying
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm">* correction. If less than 0, defaults to the distance from the center to the
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm">* farthest corner of the image.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm">* @param clip Maximum allowable pixel value after correction. Values
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm">* exceeding this are clipped.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm">*/&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kt">void&lt;/span> &lt;span class="nf">LSC&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ImageRaw&lt;/span>&lt;span class="o">&amp;amp;&lt;/span> &lt;span class="n">raw&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">uint16_t&lt;/span> &lt;span class="n">intensity&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">minR&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">maxR&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">uint16_t&lt;/span> &lt;span class="n">clip&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">minR&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">minR&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">maxR&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">maxR&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">sqrt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">pow&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">raw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">getHeight&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">pow&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">raw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">getWidth&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">));&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">y&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">y&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">raw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">getHeight&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="n">y&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">raw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">getWidth&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">r&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">sqrt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">pow&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="n">y&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">raw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">getHeight&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">pow&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="n">x&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">raw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">getWidth&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">));&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">float&lt;/span> &lt;span class="n">factor&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">r&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">minR&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">maxR&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">minR&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">raw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">raw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">intensity&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">factor&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mf">0.5&lt;/span>&lt;span class="p">));&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">raw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">clip&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">clip&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;/details>
&lt;details class="popup-details">
&lt;summary>ç¤ºä¾‹ä»£ç ï¼šChroma Shading Correction&lt;/summary>
&lt;div class="popup-content">
&lt;button class="close-btn">âœ–&lt;/button>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt"> 10
&lt;/span>&lt;span class="lnt"> 11
&lt;/span>&lt;span class="lnt"> 12
&lt;/span>&lt;span class="lnt"> 13
&lt;/span>&lt;span class="lnt"> 14
&lt;/span>&lt;span class="lnt"> 15
&lt;/span>&lt;span class="lnt"> 16
&lt;/span>&lt;span class="lnt"> 17
&lt;/span>&lt;span class="lnt"> 18
&lt;/span>&lt;span class="lnt"> 19
&lt;/span>&lt;span class="lnt"> 20
&lt;/span>&lt;span class="lnt"> 21
&lt;/span>&lt;span class="lnt"> 22
&lt;/span>&lt;span class="lnt"> 23
&lt;/span>&lt;span class="lnt"> 24
&lt;/span>&lt;span class="lnt"> 25
&lt;/span>&lt;span class="lnt"> 26
&lt;/span>&lt;span class="lnt"> 27
&lt;/span>&lt;span class="lnt"> 28
&lt;/span>&lt;span class="lnt"> 29
&lt;/span>&lt;span class="lnt"> 30
&lt;/span>&lt;span class="lnt"> 31
&lt;/span>&lt;span class="lnt"> 32
&lt;/span>&lt;span class="lnt"> 33
&lt;/span>&lt;span class="lnt"> 34
&lt;/span>&lt;span class="lnt"> 35
&lt;/span>&lt;span class="lnt"> 36
&lt;/span>&lt;span class="lnt"> 37
&lt;/span>&lt;span class="lnt"> 38
&lt;/span>&lt;span class="lnt"> 39
&lt;/span>&lt;span class="lnt"> 40
&lt;/span>&lt;span class="lnt"> 41
&lt;/span>&lt;span class="lnt"> 42
&lt;/span>&lt;span class="lnt"> 43
&lt;/span>&lt;span class="lnt"> 44
&lt;/span>&lt;span class="lnt"> 45
&lt;/span>&lt;span class="lnt"> 46
&lt;/span>&lt;span class="lnt"> 47
&lt;/span>&lt;span class="lnt"> 48
&lt;/span>&lt;span class="lnt"> 49
&lt;/span>&lt;span class="lnt"> 50
&lt;/span>&lt;span class="lnt"> 51
&lt;/span>&lt;span class="lnt"> 52
&lt;/span>&lt;span class="lnt"> 53
&lt;/span>&lt;span class="lnt"> 54
&lt;/span>&lt;span class="lnt"> 55
&lt;/span>&lt;span class="lnt"> 56
&lt;/span>&lt;span class="lnt"> 57
&lt;/span>&lt;span class="lnt"> 58
&lt;/span>&lt;span class="lnt"> 59
&lt;/span>&lt;span class="lnt"> 60
&lt;/span>&lt;span class="lnt"> 61
&lt;/span>&lt;span class="lnt"> 62
&lt;/span>&lt;span class="lnt"> 63
&lt;/span>&lt;span class="lnt"> 64
&lt;/span>&lt;span class="lnt"> 65
&lt;/span>&lt;span class="lnt"> 66
&lt;/span>&lt;span class="lnt"> 67
&lt;/span>&lt;span class="lnt"> 68
&lt;/span>&lt;span class="lnt"> 69
&lt;/span>&lt;span class="lnt"> 70
&lt;/span>&lt;span class="lnt"> 71
&lt;/span>&lt;span class="lnt"> 72
&lt;/span>&lt;span class="lnt"> 73
&lt;/span>&lt;span class="lnt"> 74
&lt;/span>&lt;span class="lnt"> 75
&lt;/span>&lt;span class="lnt"> 76
&lt;/span>&lt;span class="lnt"> 77
&lt;/span>&lt;span class="lnt"> 78
&lt;/span>&lt;span class="lnt"> 79
&lt;/span>&lt;span class="lnt"> 80
&lt;/span>&lt;span class="lnt"> 81
&lt;/span>&lt;span class="lnt"> 82
&lt;/span>&lt;span class="lnt"> 83
&lt;/span>&lt;span class="lnt"> 84
&lt;/span>&lt;span class="lnt"> 85
&lt;/span>&lt;span class="lnt"> 86
&lt;/span>&lt;span class="lnt"> 87
&lt;/span>&lt;span class="lnt"> 88
&lt;/span>&lt;span class="lnt"> 89
&lt;/span>&lt;span class="lnt"> 90
&lt;/span>&lt;span class="lnt"> 91
&lt;/span>&lt;span class="lnt"> 92
&lt;/span>&lt;span class="lnt"> 93
&lt;/span>&lt;span class="lnt"> 94
&lt;/span>&lt;span class="lnt"> 95
&lt;/span>&lt;span class="lnt"> 96
&lt;/span>&lt;span class="lnt"> 97
&lt;/span>&lt;span class="lnt"> 98
&lt;/span>&lt;span class="lnt"> 99
&lt;/span>&lt;span class="lnt">100
&lt;/span>&lt;span class="lnt">101
&lt;/span>&lt;span class="lnt">102
&lt;/span>&lt;span class="lnt">103
&lt;/span>&lt;span class="lnt">104
&lt;/span>&lt;span class="lnt">105
&lt;/span>&lt;span class="lnt">106
&lt;/span>&lt;span class="lnt">107
&lt;/span>&lt;span class="lnt">108
&lt;/span>&lt;span class="lnt">109
&lt;/span>&lt;span class="lnt">110
&lt;/span>&lt;span class="lnt">111
&lt;/span>&lt;span class="lnt">112
&lt;/span>&lt;span class="lnt">113
&lt;/span>&lt;span class="lnt">114
&lt;/span>&lt;span class="lnt">115
&lt;/span>&lt;span class="lnt">116
&lt;/span>&lt;span class="lnt">117
&lt;/span>&lt;span class="lnt">118
&lt;/span>&lt;span class="lnt">119
&lt;/span>&lt;span class="lnt">120
&lt;/span>&lt;span class="lnt">121
&lt;/span>&lt;span class="lnt">122
&lt;/span>&lt;span class="lnt">123
&lt;/span>&lt;span class="lnt">124
&lt;/span>&lt;span class="lnt">125
&lt;/span>&lt;span class="lnt">126
&lt;/span>&lt;span class="lnt">127
&lt;/span>&lt;span class="lnt">128
&lt;/span>&lt;span class="lnt">129
&lt;/span>&lt;span class="lnt">130
&lt;/span>&lt;span class="lnt">131
&lt;/span>&lt;span class="lnt">132
&lt;/span>&lt;span class="lnt">133
&lt;/span>&lt;span class="lnt">134
&lt;/span>&lt;span class="lnt">135
&lt;/span>&lt;span class="lnt">136
&lt;/span>&lt;span class="lnt">137
&lt;/span>&lt;span class="lnt">138
&lt;/span>&lt;span class="lnt">139
&lt;/span>&lt;span class="lnt">140
&lt;/span>&lt;span class="lnt">141
&lt;/span>&lt;span class="lnt">142
&lt;/span>&lt;span class="lnt">143
&lt;/span>&lt;span class="lnt">144
&lt;/span>&lt;span class="lnt">145
&lt;/span>&lt;span class="lnt">146
&lt;/span>&lt;span class="lnt">147
&lt;/span>&lt;span class="lnt">148
&lt;/span>&lt;span class="lnt">149
&lt;/span>&lt;span class="lnt">150
&lt;/span>&lt;span class="lnt">151
&lt;/span>&lt;span class="lnt">152
&lt;/span>&lt;span class="lnt">153
&lt;/span>&lt;span class="lnt">154
&lt;/span>&lt;span class="lnt">155
&lt;/span>&lt;span class="lnt">156
&lt;/span>&lt;span class="lnt">157
&lt;/span>&lt;span class="lnt">158
&lt;/span>&lt;span class="lnt">159
&lt;/span>&lt;span class="lnt">160
&lt;/span>&lt;span class="lnt">161
&lt;/span>&lt;span class="lnt">162
&lt;/span>&lt;span class="lnt">163
&lt;/span>&lt;span class="lnt">164
&lt;/span>&lt;span class="lnt">165
&lt;/span>&lt;span class="lnt">166
&lt;/span>&lt;span class="lnt">167
&lt;/span>&lt;span class="lnt">168
&lt;/span>&lt;span class="lnt">169
&lt;/span>&lt;span class="lnt">170
&lt;/span>&lt;span class="lnt">171
&lt;/span>&lt;span class="lnt">172
&lt;/span>&lt;span class="lnt">173
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-cpp" data-lang="cpp">&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kt">float&lt;/span> &lt;span class="nf">__cnc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="kt">char&lt;/span>&lt;span class="o">*&lt;/span> &lt;span class="n">is_color&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">float&lt;/span> &lt;span class="n">center&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">float&lt;/span> &lt;span class="n">avgG&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">float&lt;/span> &lt;span class="n">avgC1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">float&lt;/span> &lt;span class="n">avgC2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">float&lt;/span> &lt;span class="n">r_gain&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">float&lt;/span> &lt;span class="n">gr_gain&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">float&lt;/span> &lt;span class="n">gb_gain&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">float&lt;/span> &lt;span class="n">b_gain&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">float&lt;/span> &lt;span class="n">dampFactor&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mf">1.0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">float&lt;/span> &lt;span class="n">signalGap&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">center&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">MAX&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">avgG&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">avgC2&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">strcmp&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">is_color&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;r&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">r_gain&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="mf">1.0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">dampFactor&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mf">1.0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">r_gain&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mf">1.0&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">r_gain&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="mf">1.2&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">dampFactor&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mf">0.5&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">r_gain&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mf">1.2&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">dampFactor&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mf">0.3&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">strcmp&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">is_color&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;b&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">b_gain&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="mf">1.0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">dampFactor&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mf">1.0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">b_gain&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mf">1.0&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">b_gain&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="mf">1.2&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">dampFactor&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mf">0.5&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">b_gain&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mf">1.2&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">dampFactor&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mf">0.3&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">float&lt;/span> &lt;span class="n">chromaCorrected&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">MAX&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">avgG&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">avgC2&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">dampFactor&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">signalGap&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">float&lt;/span> &lt;span class="n">signalMeter&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mf">0.299&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">avgC2&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mf">0.587&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">avgG&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mf">0.144&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">avgC1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">strcmp&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">is_color&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;r&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">signalMeter&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mf">0.299&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">avgC1&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mf">0.587&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">avgG&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mf">0.144&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">avgC2&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">strcmp&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">is_color&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;b&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">signalMeter&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mf">0.299&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">avgC2&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mf">0.587&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">avgG&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mf">0.144&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">avgC1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">float&lt;/span> &lt;span class="n">fade1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">fade2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">signalMeter&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="mi">30&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">fade1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mf">1.0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">signalMeter&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mi">30&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">signalMeter&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="mi">50&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">fade1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mf">0.9&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">signalMeter&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mi">50&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">signalMeter&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="mi">70&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">fade1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mf">0.8&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">signalMeter&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mi">70&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">signalMeter&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="mi">100&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">fade1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mf">0.7&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">signalMeter&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mi">100&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">signalMeter&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="mi">150&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">fade1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mf">0.6&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">signalMeter&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mi">150&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">signalMeter&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="mi">200&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">fade1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mf">0.3&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">signalMeter&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mi">200&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">signalMeter&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="mi">250&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">fade1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mf">0.1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span> &lt;span class="n">fade1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">avgC1&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="mi">30&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">fade2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mf">1.0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">avgC1&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mi">30&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">avgC1&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="mi">50&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">fade2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mf">0.9&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">avgC1&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mi">50&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">avgC1&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="mi">70&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">fade2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mf">0.8&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">avgC1&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mi">70&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">avgC1&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="mi">100&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">fade2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mf">0.6&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">avgC1&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mi">100&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">avgC1&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="mi">150&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">fade2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mf">0.5&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">avgC1&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mi">150&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">avgC1&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="mi">200&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">fade2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mf">0.3&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span> &lt;span class="n">fade2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">float&lt;/span> &lt;span class="n">fadeTot&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">fade1&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">fade2&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">fadeTot&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">center&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">fadeTot&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">chromaCorrected&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kt">void&lt;/span> &lt;span class="nf">__cnd&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ImageRaw&lt;/span>&lt;span class="o">*&lt;/span> &lt;span class="n">img&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">float&lt;/span> &lt;span class="n">thres&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="o">&amp;amp;&lt;/span> &lt;span class="n">is_noise&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">float&lt;/span>&lt;span class="o">&amp;amp;&lt;/span> &lt;span class="n">avgG&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">float&lt;/span>&lt;span class="o">&amp;amp;&lt;/span> &lt;span class="n">avgC1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">float&lt;/span>&lt;span class="o">&amp;amp;&lt;/span> &lt;span class="n">avgC2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">avgG&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">avgC1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">avgC2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">is_noise&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">y&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">y&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">j&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">j&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">j&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">%&lt;/span> &lt;span class="mi">2&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">j&lt;/span> &lt;span class="o">%&lt;/span> &lt;span class="mi">2&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="n">avgG&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">avgG&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">img&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">j&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">%&lt;/span> &lt;span class="mi">2&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">j&lt;/span> &lt;span class="o">%&lt;/span> &lt;span class="mi">2&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="n">avgG&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">avgG&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">img&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">j&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">%&lt;/span> &lt;span class="mi">2&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">j&lt;/span> &lt;span class="o">%&lt;/span> &lt;span class="mi">2&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="n">avgC1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">avgC1&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">img&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">j&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">%&lt;/span> &lt;span class="mi">2&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">j&lt;/span> &lt;span class="o">%&lt;/span> &lt;span class="mi">2&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="n">avgC2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">avgC2&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">img&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">j&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">avgG&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">avgG&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="mi">40&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">avgC1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">avgC1&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="mi">25&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">avgC2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">avgC2&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="mi">16&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">float&lt;/span> &lt;span class="n">center&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">img&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="n">center&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">avgG&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">thres&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">center&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">avgC2&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">thres&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="n">avgC1&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">avgG&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">thres&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">avgC1&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">avgC2&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">thres&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">is_noise&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">is_noise&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">is_noise&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kt">float&lt;/span> &lt;span class="nf">__cnf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="kt">char&lt;/span>&lt;span class="o">*&lt;/span> &lt;span class="n">is_color&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ImageRaw&lt;/span>&lt;span class="o">*&lt;/span> &lt;span class="n">img&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">float&lt;/span> &lt;span class="n">thres&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">float&lt;/span> &lt;span class="n">r_gain&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">float&lt;/span> &lt;span class="n">gr_gain&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">float&lt;/span> &lt;span class="n">gb_gain&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">float&lt;/span> &lt;span class="n">b_gain&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">is_noise&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">float&lt;/span> &lt;span class="n">avgG&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">avgC1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">avgC2&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">__cnd&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">img&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">thres&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">is_noise&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">avgG&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">avgC1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">avgC2&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">float&lt;/span> &lt;span class="n">pix_out&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">is_noise&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">pix_out&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">__cnc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">is_color&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">img&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="n">avgG&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">avgC1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">avgC2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">r_gain&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">gr_gain&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">gb_gain&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">b_gain&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">pix_out&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">img&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">pix_out&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kt">void&lt;/span> &lt;span class="nf">CNF&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ImageRaw&lt;/span>&lt;span class="o">&amp;amp;&lt;/span> &lt;span class="n">img&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">BAYER_PATTERN&lt;/span> &lt;span class="n">bayer_pattern&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">float&lt;/span> &lt;span class="n">threshold&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">float&lt;/span> &lt;span class="n">r_gain&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">float&lt;/span> &lt;span class="n">gr_gain&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">float&lt;/span> &lt;span class="n">gb_gain&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">float&lt;/span> &lt;span class="n">b_gain&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">uint16_t&lt;/span> &lt;span class="n">clip&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ImageRaw&lt;/span>&lt;span class="o">*&lt;/span> &lt;span class="n">img_pad&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">ImageRaw&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">img&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">img_pad&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">padding&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">PADDING_MODE_REFLECT&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">uint16_t&lt;/span> &lt;span class="n">r&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">gr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">gb&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">b&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">y&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">y&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">img_pad&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">getHeight&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">8&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">y&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">img_pad&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">getWidth&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">8&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">switch&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">bayer_pattern&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">case&lt;/span> &lt;span class="nl">BAYER_PATTERN_RGGB&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">r&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">img_pad&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">gr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">img_pad&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">gb&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">img_pad&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">b&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">img_pad&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">img&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">__cnf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;r&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">y&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">img_pad&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">threshold&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">r_gain&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">gr_gain&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">gb_gain&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">b_gain&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">img&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">gr&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">img&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">gb&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">img&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">__cnf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;b&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">y&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">img_pad&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">threshold&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">r_gain&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">gr_gain&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">gb_gain&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">b_gain&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">case&lt;/span> &lt;span class="nl">BAYER_PATTERN_BGGR&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">b&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">img_pad&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">gb&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">img_pad&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">gr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">img_pad&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">r&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">img_pad&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">img&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">__cnf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;b&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">y&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">img_pad&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">threshold&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">r_gain&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">gr_gain&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">gb_gain&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">b_gain&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">img&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">gb&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">img&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">gr&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">img&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">__cnf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;r&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">y&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">img_pad&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">threshold&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">r_gain&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">gr_gain&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">gb_gain&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">b_gain&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">case&lt;/span> &lt;span class="nl">BAYER_PATTERN_GBRG&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">gb&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">img_pad&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">b&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">img_pad&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">r&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">img_pad&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">gr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">img_pad&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">img&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">gb&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">img&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">__cnf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;b&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">y&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">img_pad&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">threshold&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">r_gain&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">gr_gain&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">gb_gain&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">b_gain&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">img&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">__cnf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;r&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">y&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">img_pad&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">threshold&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">r_gain&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">gr_gain&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">gb_gain&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">b_gain&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">img&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">gr&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">case&lt;/span> &lt;span class="nl">BAYER_PATTERN_GRBG&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">gr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">img_pad&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">r&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">img_pad&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">b&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">img_pad&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">gb&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">img_pad&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">img&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">gr&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">img&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">__cnf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;r&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">y&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">img_pad&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">threshold&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">r_gain&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">gr_gain&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">gb_gain&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">b_gain&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">img&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">__cnf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;b&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">y&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">img_pad&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">threshold&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">r_gain&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">gr_gain&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">gb_gain&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">b_gain&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">img&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">gb&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">case&lt;/span> &lt;span class="nl">BAYER_PATTERN_UNKNOWN&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">default&lt;/span>&lt;span class="o">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">TRACE_DEBUG_LOG_ERROR&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Unknown Bayer Pattern:%s&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">bayer_pattern&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">img&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">clip&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">clip&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">delete&lt;/span> &lt;span class="n">img_pad&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;/details>
&lt;h3 id="æŠ—é”¯é½¿æ»¤æ³¢anti-aliasing-filteringaaf">æŠ—é”¯é½¿æ»¤æ³¢ï¼ˆAnti-aliasing Filteringï¼ŒAAFï¼‰
&lt;/h3>&lt;p>å¦‚æœæ‹æ‘„çš„å›¾åƒä¸­å«æœ‰å¤§é‡é«˜é¢‘æˆåˆ†ï¼Œåœ¨é™é‡‡æ ·æ—¶å°±ä¼šäº§ç”Ÿé”¯é½¿ï¼ˆaliasingï¼‰ï¼Œè¦å»é™¤é”¯é½¿ï¼Œéœ€è¦å¯¹åŸå›¾åƒè¿›è¡Œå¹³æ»‘ã€‚å¸¸ç”¨çš„æ–¹æ³•æœ‰é«˜æ–¯æ»¤æ³¢å™¨ï¼ˆGaussian Filterï¼‰å’ŒåŒè¾¹æ»¤æ³¢å™¨ï¼ˆBilateral Filterï¼‰ã€‚&lt;/p>
&lt;ol>
&lt;li>é«˜æ–¯æ»¤æ³¢å™¨
$$G(x,y)=\frac1{2\pi\sigma^2}\exp\left(-\frac{x^2+y^2}{2\sigma^2}\right)$$&lt;br>
å…¶ä¸­:&lt;br>
$\bullet\quad G(x,y)$æ˜¯é«˜æ–¯æ ¸åœ¨åæ ‡(x,y)çš„å€¼;&lt;br>
$\bullet\quad \sigma$æ˜¯é«˜æ–¯åˆ†å¸ƒçš„æ ‡å‡†å·®,å†³å®šæ»¤æ³¢å™¨çš„å¹³æ»‘å¼ºåº¦;&lt;br>
$\bullet\quad x,y$æ˜¯è·ç¦»æ ¸ä¸­å¿ƒçš„åæ ‡ã€‚&lt;/li>
&lt;li>åŒè¾¹æ»¤æ³¢å™¨
$$W(p,q)=\exp\left(-\frac{\|p-q\|^2}{2\sigma_s^2}\right)\cdot\exp\left(-\frac{|I(p)-I(q)|^2}{2\sigma_r^2}\right)$$&lt;br>
å…¶ä¸­:&lt;br>
$\bullet\quad W(p,q)$æ˜¯åƒç´ qå¯¹pçš„æƒé‡;&lt;br>
$\bullet\quad|p-q|$æ˜¯ä¸¤åƒç´ åœ¨ç©ºé—´ä¸Šçš„è·ç¦»;&lt;br>
$\bullet\quad|I(p)-I(q)|$æ˜¯ä¸¤åƒç´ ç°åº¦å€¼çš„å·®å¼‚;&lt;br>
$\bullet\quad\sigma_s$æ˜¯ç©ºé—´åŸŸé«˜æ–¯æ ‡å‡†å·®;&lt;br>
$\bullet\quad\sigma_r$æ˜¯å¼ºåº¦åŸŸé«˜æ–¯æ ‡å‡†å·®ã€‚&lt;br>
æ»¤æ³¢ç»“æœ:&lt;br>
$$I^{\prime} (p)=\frac{\sum_{q\in S}W(p,q)\cdot I(q)}{\sum_{q\in S}W(p,q)}$$&lt;br>
å…¶ä¸­:Sæ˜¯æ»¤æ³¢çª—å£,$I^{\prime}(p)$æ˜¯åƒç´ pçš„æ»¤æ³¢å€¼ã€‚&lt;/li>
&lt;/ol>
&lt;p>ä¸¤è€…å¯¹æ¯”ï¼š&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>ç‰¹æ€§&lt;/th>
&lt;th>é«˜æ–¯æ»¤æ³¢å™¨&lt;/th>
&lt;th>åŒè¾¹æ»¤æ³¢å™¨&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>æ€§è´¨&lt;/td>
&lt;td>çº¿æ€§æ»¤æ³¢&lt;/td>
&lt;td>éçº¿æ€§æ»¤æ³¢&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>è¾¹ç¼˜ä¿ç•™&lt;/td>
&lt;td>ä¸ä¿ç•™è¾¹ç¼˜ï¼Œæ¨¡ç³Šè¾¹ç¼˜&lt;/td>
&lt;td>ä¿ç•™è¾¹ç¼˜ï¼Œå¯¹è¾¹ç¼˜å½±å“è¾ƒå°&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>è®¡ç®—å¤æ‚åº¦&lt;/td>
&lt;td>ä½&lt;/td>
&lt;td>é«˜&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>å®ç°éš¾åº¦&lt;/td>
&lt;td>ç®€å•&lt;/td>
&lt;td>è¾ƒå¤æ‚&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>é€‚ç”¨åœºæ™¯&lt;/td>
&lt;td>å¿«é€Ÿå¹³æ»‘ã€é«˜é¢‘å™ªå£°è¾ƒå°‘çš„åœºæ™¯&lt;/td>
&lt;td>é«˜è´¨é‡æŠ—é”¯é½¿ï¼Œä¿ç•™çº¹ç†å’Œè¾¹ç¼˜&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>&lt;img src="https://RoboticsChen.github.io/articles/camera-isp/image-8.png"
width="579"
height="377"
srcset="https://RoboticsChen.github.io/articles/camera-isp/image-8_hu_21ff595838d09d20.png 480w, https://RoboticsChen.github.io/articles/camera-isp/image-8_hu_3e8c4bc12fca94b4.png 1024w"
loading="lazy"
alt="å›¾18 é”¯é½¿æ»¤æ³¢å‰"
class="gallery-image"
data-flex-grow="153"
data-flex-basis="368px"
> &lt;img src="https://RoboticsChen.github.io/articles/camera-isp/image-11.png"
width="579"
height="377"
srcset="https://RoboticsChen.github.io/articles/camera-isp/image-11_hu_50581154a7c93451.png 480w, https://RoboticsChen.github.io/articles/camera-isp/image-11_hu_c010aec987189e7c.png 1024w"
loading="lazy"
alt="å›¾19 é”¯é½¿æ»¤æ³¢å"
class="gallery-image"
data-flex-grow="153"
data-flex-basis="368px"
>&lt;/p>
&lt;details class="popup-details">
&lt;summary>ç¤ºä¾‹ä»£ç ï¼ˆåŒè¾¹æ»¤æ³¢å™¨&lt;/summary>
&lt;div class="popup-content">
&lt;button class="close-btn">âœ–&lt;/button>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;span class="lnt">65
&lt;/span>&lt;span class="lnt">66
&lt;/span>&lt;span class="lnt">67
&lt;/span>&lt;span class="lnt">68
&lt;/span>&lt;span class="lnt">69
&lt;/span>&lt;span class="lnt">70
&lt;/span>&lt;span class="lnt">71
&lt;/span>&lt;span class="lnt">72
&lt;/span>&lt;span class="lnt">73
&lt;/span>&lt;span class="lnt">74
&lt;/span>&lt;span class="lnt">75
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-cpp" data-lang="cpp">&lt;span class="line">&lt;span class="cl">&lt;span class="cm">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * @brief Computes the Gaussian weight for a given difference.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> *
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * @param x The difference (distance in space or intensity).
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * @param sigma The standard deviation of the Gaussian function.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * @return The computed Gaussian weight.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kt">double&lt;/span> &lt;span class="nf">gaussian&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">double&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">double&lt;/span> &lt;span class="n">sigma&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">exp&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">x&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="mf">2.0&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">sigma&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">sigma&lt;/span>&lt;span class="p">));&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * @brief Applies a bilateral filter to an ImageRaw object.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> *
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * @param src Input image.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * @param dst Output image (should be pre-initialized to the same size as src).
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * @param d The diameter of the filter kernel (must be an odd number).
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * @param sigmaColor The standard deviation in the intensity space.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * @param sigmaSpace The standard deviation in the spatial space.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kt">void&lt;/span> &lt;span class="nf">applyBilateralFilter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="n">ImageRaw&lt;/span>&lt;span class="o">&amp;amp;&lt;/span> &lt;span class="n">src&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ImageRaw&lt;/span>&lt;span class="o">&amp;amp;&lt;/span> &lt;span class="n">dst&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">d&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">double&lt;/span> &lt;span class="n">sigmaColor&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">double&lt;/span> &lt;span class="n">sigmaSpace&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">height&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">src&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">getHeight&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">width&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">src&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">getWidth&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Ensure kernel size is odd
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">d&lt;/span> &lt;span class="o">%&lt;/span> &lt;span class="mi">2&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">throw&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">invalid_argument&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Kernel size must be odd.&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Precompute spatial Gaussian weights
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">radius&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">d&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">double&lt;/span>&lt;span class="o">&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">spatialKernel&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">d&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">double&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">d&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mf">0.0&lt;/span>&lt;span class="p">));&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">radius&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="n">radius&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">j&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">radius&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">j&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="n">radius&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">spatialKernel&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">radius&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">j&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">radius&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">gaussian&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">sqrt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">j&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">j&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="n">sigmaSpace&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Perform bilateral filtering
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">height&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">j&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">j&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">width&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">double&lt;/span> &lt;span class="n">weightedSum&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mf">0.0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">double&lt;/span> &lt;span class="n">normalizationFactor&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mf">0.0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">uint16_t&lt;/span> &lt;span class="n">centerPixel&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">src&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">j&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">ki&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">radius&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">ki&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="n">radius&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">ki&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">kj&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">radius&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">kj&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="n">radius&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">kj&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">ni&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">ki&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">nj&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">j&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">kj&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Skip out-of-bound pixels
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">ni&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="n">ni&lt;/span> &lt;span class="o">&amp;gt;=&lt;/span> &lt;span class="n">height&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="n">nj&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="n">nj&lt;/span> &lt;span class="o">&amp;gt;=&lt;/span> &lt;span class="n">width&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">continue&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">uint16_t&lt;/span> &lt;span class="n">neighborPixel&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">src&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ni&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">nj&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Compute intensity Gaussian weight
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kt">double&lt;/span> &lt;span class="n">intensityWeight&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">gaussian&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">abs&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">centerPixel&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">neighborPixel&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="n">sigmaColor&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Compute final weight
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kt">double&lt;/span> &lt;span class="n">weight&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">spatialKernel&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">ki&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">radius&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">kj&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">radius&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">intensityWeight&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Accumulate weighted sum and normalization factor
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">weightedSum&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">neighborPixel&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">weight&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">normalizationFactor&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">weight&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Assign the filtered value to the destination image
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">dst&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">j&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">static_cast&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">uint16_t&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">weightedSum&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="n">normalizationFactor&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;/details>
&lt;h3 id="è‡ªåŠ¨ç™½å¹³è¡¡auto-white-balanceawb">è‡ªåŠ¨ç™½å¹³è¡¡ï¼ˆAuto White Balanceï¼ŒAWBï¼‰
&lt;/h3>&lt;p>äººçš„è§†è§‰å’Œç¥ç»ç³»ç»Ÿå…·æœ‰è‰²å½©æ’å¸¸æ€§ï¼Œåœ¨çœ‹åˆ°ç™½è‰²ç‰©ä½“çš„æ—¶å€™åŸºæœ¬ä¸å—ç¯å¢ƒå…‰æºå˜åŒ–çš„å½±å“ã€‚ä½†æ˜¯image sensorå¹¶ä¸èƒ½åƒäººçš„è§†è§‰ç³»ç»Ÿä¸€æ ·è‡ªåŠ¨è°ƒèŠ‚ï¼Œåœ¨ä¸åŒè‰²æ¸©å…‰æºä¸‹ï¼Œæ‹å‡ºçš„ç…§ç‰‡ä¸­ç™½è‰²ä¼šå‡ºç°åè‰²çš„æƒ…å†µã€‚è‡ªåŠ¨ç™½å¹³è¡¡å°±æ˜¯ç”¨æ¥æ¨¡æ‹Ÿäººç±»çš„è‰²å½©æ’å¸¸èƒ½åŠ›ï¼Œåœ¨å›¾åƒä¸­å»é™¤å…‰æºå¼•èµ·çš„åè‰²ï¼Œä»è€Œè¿˜åŸè‡ªç„¶çš„è‰²å½©ã€‚&lt;/p>
&lt;p>è‡ªåŠ¨ç™½å¹³è¡¡ç®—æ³•æ ¹æ®æŠ€æœ¯è·¯çº¿å¯ä»¥å½’ç»“ä¸ºå‡ å¤§ç±»ï¼Œåˆ†åˆ«æ˜¯ï¼š&lt;/p>
&lt;ul>
&lt;li>åœºæ™¯å‡è®¾æ¨¡å‹ï¼šç°åº¦ä¸–ç•Œã€å®Œç¾åå°„&lt;/li>
&lt;li>ç‚¹ç»Ÿè®¡æ¨¡å‹ï¼šç™½è‰²ç‚¹ä¼°è®¡ã€åˆ†å—æƒé‡&lt;/li>
&lt;/ul>
&lt;ol>
&lt;li>ç°åº¦ä¸–ç•Œç®—æ³•&lt;br>
è¯¥ç®—æ³•å‡è®¾ï¼šå¯¹äºä¸€å‰¯æœ‰ç€ä¸°å¯Œè‰²å½©çš„å›¾ç‰‡ï¼Œå›¾åƒä¸ŠRã€Gã€Bä¸‰ä¸ªé€šé“çš„å¹³å‡å€¼åº”è¯¥ç­‰äºä¸€ä¸ªè¢«ç§°ä¸ºâ€œç°è‰²â€çš„å€¼$K$ã€‚è‡³äºâ€œç°è‰²â€å€¼Kçš„é€‰æ‹©ï¼Œä¸€ç§æ–¹æ³•æ˜¯å°†å¾…å¤„ç†å›¾ç‰‡ä¸‰ä¸ªé€šé“å‡å€¼çš„å‡å€¼ä½œä¸ºâ€œç°è‰²â€å€¼$K$ã€‚å½“ç¡®å®šäº†ç°è‰²å€¼Kä¹‹åï¼Œå¾…å¤„ç†å›¾ç‰‡å„ä¸ªé€šé“çš„æ ¡æ­£ç³»æ•°åˆ†åˆ«ä¸ºï¼š$k_r=K/R_{mean}ï¼Œk_g=K/G_{mean}ï¼Œk_b=K/B_{mean}$ï¼Œå…¶ä¸­$R_{mean}ï¼ŒG_{mean}å’ŒB_{mean}$åˆ†åˆ«ä¸ºå›¾åƒRã€Gã€Bé€šé“çš„å‡å€¼ã€‚&lt;/li>
&lt;/ol>
&lt;details class="popup-details">
&lt;summary>ç¤ºä¾‹ä»£ç &lt;/summary>
&lt;div class="popup-content">
&lt;button class="close-btn">âœ–&lt;/button>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;span class="lnt">65
&lt;/span>&lt;span class="lnt">66
&lt;/span>&lt;span class="lnt">67
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-cpp" data-lang="cpp">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;iostream&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;vector&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;numeric&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;stdexcept&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * @brief Apply the Gray World Algorithm to an ImageRaw.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> *
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * This algorithm adjusts the R, G, and B channels of the input image so that their
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * mean values are equal to a common gray level \( K \). This corrects the overall
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * color balance of the image.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> *
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * @param src Input image. Must have 3 channels (RGB format).
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * @param dst Output image. Must have the same size as the input image.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kt">void&lt;/span> &lt;span class="nf">grayWorldAlgorithm&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="n">ImageRaw&lt;/span>&lt;span class="o">&amp;amp;&lt;/span> &lt;span class="n">src&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ImageRaw&lt;/span>&lt;span class="o">&amp;amp;&lt;/span> &lt;span class="n">dst&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Validate input image dimensions
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">src&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">getWidth&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="n">dst&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">getWidth&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="n">src&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">getHeight&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="n">dst&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">getHeight&lt;/span>&lt;span class="p">())&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">throw&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">invalid_argument&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Input and output images must have the same dimensions.&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">width&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">src&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">getWidth&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">height&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">src&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">getHeight&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Accumulators for R, G, B channel sums
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kt">uint64_t&lt;/span> &lt;span class="n">sumR&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">sumG&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">sumB&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">numPixels&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">width&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">height&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Compute channel-wise sums
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">height&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">j&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">j&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">width&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">uint16_t&lt;/span> &lt;span class="n">r&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">src&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">j&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// Assume RGB channels are stored in sequence
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kt">uint16_t&lt;/span> &lt;span class="n">g&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">src&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">j&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">3&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">uint16_t&lt;/span> &lt;span class="n">b&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">src&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">j&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">3&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sumR&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">r&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sumG&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">g&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sumB&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">b&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Compute mean values for each channel
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kt">double&lt;/span> &lt;span class="n">meanR&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">static_cast&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">double&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sumR&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="n">numPixels&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">double&lt;/span> &lt;span class="n">meanG&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">static_cast&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">double&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sumG&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="n">numPixels&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">double&lt;/span> &lt;span class="n">meanB&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">static_cast&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">double&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sumB&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="n">numPixels&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Compute the target gray value \( K \) as the average of all channel means
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kt">double&lt;/span> &lt;span class="n">K&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">meanR&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">meanG&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">meanB&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="mf">3.0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Compute correction factors
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kt">double&lt;/span> &lt;span class="n">kR&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">K&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="n">meanR&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">double&lt;/span> &lt;span class="n">kG&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">K&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="n">meanG&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">double&lt;/span> &lt;span class="n">kB&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">K&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="n">meanB&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Apply correction to each pixel
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">height&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">j&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">j&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">width&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">uint16_t&lt;/span> &lt;span class="n">r&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">src&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">j&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">uint16_t&lt;/span> &lt;span class="n">g&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">src&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">j&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">3&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">uint16_t&lt;/span> &lt;span class="n">b&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">src&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">j&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">3&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Adjust each channel and clip the values to the valid range
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">dst&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">j&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">static_cast&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">uint16_t&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">min&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">max&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">r&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">kR&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mf">0.0&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="mf">65535.0&lt;/span>&lt;span class="p">));&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">dst&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">j&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">3&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">static_cast&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">uint16_t&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">min&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">max&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">g&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">kG&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mf">0.0&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="mf">65535.0&lt;/span>&lt;span class="p">));&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">dst&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">at&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">j&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">3&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">static_cast&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">uint16_t&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">min&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">max&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">b&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">kB&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mf">0.0&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="mf">65535.0&lt;/span>&lt;span class="p">));&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;/details>
&lt;ol start="2">
&lt;li>å®Œç¾åå°„æ³•
è¯¥ç®—æ³•å‡è®¾ï¼šâ€œé•œé¢â€å¯ä»¥å®Œå…¨å‘å°„å…‰æºç…§å°„åœ¨ç‰©ä½“ä¸Šé¢çš„å…‰çº¿ã€‚å› æ­¤ï¼Œå¦‚æœå›¾åƒä¸­å­˜åœ¨ä¸€ä¸ªâ€œé•œé¢â€çš„è¯ï¼Œé‚£ä¹ˆåœ¨ç‰¹å®šå…‰æºä¸‹ï¼Œå¯ä»¥å°†æ‰€è·å¾—çš„â€œé•œé¢â€çš„è‰²å½©ä¿¡æ¯è®¤ä¸ºæ˜¯å½“å‰å…‰æºçš„ä¿¡æ¯ã€‚åœ¨è¿›è¡Œç™½å¹³è¡¡æ ¡å‡†çš„æ—¶å€™ï¼Œå‡è®¾å›¾ç‰‡ä¸Šå­˜åœ¨ä¸€ä¸ªå¯ä»¥å®Œå…¨åå°„å…‰æºçš„â€œé•œé¢â€ï¼Œé‚£ä¹ˆåœ¨ç»å…¸å…‰æºä¸‹å›¾ç‰‡ä¸­å°±åº”è¯¥å­˜åœ¨ä¸€ä¸ªä¸‰åˆºæ¿€å€¼ä¸º[255,255,255]çº¯ç™½è‰²åƒç´ ç‚¹ï¼ˆæœ‰å¤šç§ç™½è‰²ç‚¹å®šä¹‰ï¼Œè¿™æ˜¯ä¸€ç§ï¼‰ï¼Œæ­¤æ—¶å¾…å¤„ç†å›¾ç‰‡å„ä¸ªé€šé“çš„æ ¡æ­£ç³»æ•°åˆ†åˆ«ä¸ºï¼š$k_r=255/R_{max}ï¼Œk_g=255/G_{max}ï¼Œk_b=255/B_{max}$ï¼Œå…¶ä¸­$R_{max}ï¼ŒG_{max}å’ŒB_{max}$åˆ†åˆ«ä¸ºå›¾åƒRã€Gã€Bé€šé“çš„æœ€å¤§å€¼ã€‚&lt;/li>
&lt;/ol>
&lt;details class="popup-details">
&lt;summary>ç¤ºä¾‹ä»£ç -å®Œç¾åå°„æ³•&lt;/summary>
&lt;div class="popup-content">
&lt;button class="close-btn">âœ–&lt;/button>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-cpp" data-lang="cpp">&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;/details>
&lt;ol start="3">
&lt;li>ç»Ÿè®¡åŠ æƒç™½ç‚¹æ³•ï¼ˆé€šå¸¸åœ¨éœ€è¦æ¯”è¾ƒé«˜å›¾åƒè´¨é‡æ—¶ä½¿ç”¨ï¼‰
è¯¥ç®—æ³•é¦–å…ˆéœ€è¦å¯¹ä¼ æ„Ÿå™¨è¿›è¡Œå…‰æºæ ‡å®šå¾—åˆ°è‰²æ¸©æ›²çº¿ã€‚æŠ˜çº¿ä¸Šçš„ç‚¹æ˜¯åœ¨äº§çº¿ä¸Šé’ˆå¯¹ä¸åŒå…‰æº(D65, Aå…‰ï¼ŒHå…‰ç­‰)ä½¿ç”¨æ ‡å‡†ç™½/ç°å¡çº¸æ‹å‡ºç…§ç‰‡ç®—å‡ºæ¥çš„$R_{gain}=R_{mean}/G_{mean}$å’Œ$B_{gain}=B_{mean}/G_{mean}$åæ ‡ã€‚æ ¡å‡†æ—¶å°†å›¾ç‰‡åˆ†ä¸ºMå—ï¼Œåˆ†åˆ«è®¡ç®—æ¯å—çš„$R_{gain}$å’Œ$B_{gain}$å’Œï¼Œä½œä¸ºä¸€ä¸ªâ€œç™½ç‚¹â€ï¼Œå°†å€¼é è¿‘æŠ˜çº¿åŒºåŸŸ(çº¢è‰²)çš„â€œç™½ç‚¹â€æƒé‡åŠ é«˜ï¼Œè¿œç¦»çš„(è“è‰²)æƒé‡é™ä½ï¼Œå†è®¡ç®—å‡ºåŠ æƒå¹³å‡å€¼å¾—åˆ°æœ€ç»ˆâ€œç™½ç‚¹â€çš„$R_{gain}$å’Œ$B_{gain}$ï¼Œä½¿ç”¨æŠ˜çº¿ä¸Šçš„ä¸åŒç‚¹åšæ’å€¼è®¡ç®—å‡ºä¸€ä¸ªæœ€ç»ˆ$R_{gain}$å’Œ$B_{gain}$å€¼ã€‚&lt;/li>
&lt;/ol>
&lt;p>&lt;img src="https://RoboticsChen.github.io/articles/camera-isp/image-12.png"
width="640"
height="371"
srcset="https://RoboticsChen.github.io/articles/camera-isp/image-12_hu_9ee28044553d68c9.png 480w, https://RoboticsChen.github.io/articles/camera-isp/image-12_hu_9122bf4fa42403f5.png 1024w"
loading="lazy"
alt="å›¾20 è‰²æ¸©å¢ç›Šæ›²çº¿"
class="gallery-image"
data-flex-grow="172"
data-flex-basis="414px"
>&lt;/p>
&lt;details class="popup-details">
&lt;summary>ç¤ºä¾‹ä»£ç -ç»Ÿè®¡åŠ æƒç™½ç‚¹æ³•&lt;/summary>
&lt;div class="popup-content">
&lt;button class="close-btn">âœ–&lt;/button>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-cpp" data-lang="cpp">&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;/details>
&lt;h3 id="å»é©¬èµ›å…‹demosaicing">å»é©¬èµ›å…‹ï¼ˆDemosaicingï¼‰
&lt;/h3>&lt;p>ä¹‹å‰æåˆ°äº†æ™®é€šçš„CMOSå›¾åƒä¼ æ„Ÿå™¨æ— æ³•â€œæ•è·â€è‰²å½©ä¿¡æ¯ï¼Œè§£å†³æ–¹æ³•æ˜¯é€šè¿‡Bayeré˜µåˆ—çš„å¸¦æœ‰ä¸åŒé¢œè‰²æ»¤å…‰ç‰‡çš„åƒç´ ç‚¹è®°å½•å¯¹åº”é€šé“çš„äº®åº¦å€¼ï¼Œæœ€åæ’å€¼å¾—åˆ°æ¯ä¸ªåƒç´ ç‚¹çš„RGBä¸‰é€šé“å€¼ã€‚ç”±äºé€šè¿‡CMOSå¾—åˆ°çš„Bayeræ ¼å¼çš„RAWå›¾æ”¾å¤§çœ‹èµ·æ¥å°±åƒé©¬èµ›å…‹ï¼Œè¿™ä¸ªä»ç°åº¦å›¾ç‰‡è¿˜åŸå›¾ç‰‡è‰²å½©çš„è¿‡ç¨‹åˆå«å»é©¬èµ›å…‹ã€‚ï¼ˆDemosaicingï¼‰&lt;/p>
&lt;p>&lt;img src="https://RoboticsChen.github.io/articles/camera-isp/raw_mask.gif"
width="450"
height="337"
srcset="https://RoboticsChen.github.io/articles/camera-isp/raw_mask_hu_8a4c574e3f433800.gif 480w, https://RoboticsChen.github.io/articles/camera-isp/raw_mask_hu_e20c410c4cd3ec3e.gif 1024w"
loading="lazy"
alt="å›¾21 RAWå›¾æ”¾å¤§"
class="gallery-image"
data-flex-grow="133"
data-flex-basis="320px"
> &lt;img src="https://RoboticsChen.github.io/articles/camera-isp/table.jpg"
width="4096"
height="3072"
srcset="https://RoboticsChen.github.io/articles/camera-isp/table_hu_cfbebec0347767d.jpg 480w, https://RoboticsChen.github.io/articles/camera-isp/table_hu_f197998cc7dc4988.jpg 1024w"
loading="lazy"
alt="å›¾22 Jpegå›¾"
class="gallery-image"
data-flex-grow="133"
data-flex-basis="320px"
>&lt;/p>
&lt;p>Demosiacçš„æ’å€¼ä¸€èˆ¬éµå¾ªä»¥ä¸‹å‡ ä¸ªåŸåˆ™ï¼š&lt;br>
1.å…ˆå¯¹Gåˆ†é‡è¿›è¡Œæ’å€¼ï¼Œå› ä¸ºGé€šé“çš„åƒç´ æ•°é‡æ˜¯GBé€šé“çš„ä¸¤å€&lt;br>
2.æ’å€¼æ—¶é‡‡ç”¨æ–¹å‘æ€§æ’å€¼ï¼Œå³å¦‚æœæ˜¯å‚ç›´çš„è¾¹ç¼˜ï¼Œåˆ™é‡‡ç”¨ä¸Šä¸‹çš„åƒç´ æ’å€¼ï¼Œè€Œä¸é€‰ç”¨å·¦å³&lt;br>
3.å“ˆå¯†å°”é¡¿(Hamilton)è‰²å·®æ’å®šåŸç†ï¼Œ$R(i,j)-G(i,j)=R(i,j+1)-G(i,j+1)$ï¼Œå³ç›¸é‚»ç‚¹è‰²å·®ç›¸åŒ&lt;br>
4.å„ä¸ªé¢œè‰²åˆ†é‡åœ¨åŒä¸€åƒç´ ç‚¹å¤„çš„é«˜é¢‘åˆ†é‡å¯è®¤ä¸ºæ˜¯ç›¸åŒçš„&lt;/p>
&lt;p>å…·ä½“è€Œè¨€ï¼Œä¸€ä¸ªç®€å•çš„å»é©¬èµ›å…‹æµç¨‹å¯ä»¥æ˜¯ï¼š&lt;br>
1.è·å–å›¾åƒä¸­çš„ç‰©ä½“çš„è¾¹ç¼˜
2.æ ¹æ®è¾¹ç¼˜ä¿¡æ¯æ’å€¼é‡å»ºGåˆ†é‡
3.æ ¹æ®å“ˆå¯†å°”é¡¿æå‡ºçš„è‰²å·®æ’å®šç†è®ºï¼Œæ ¹æ®è‰²å·®æ’å€¼é‡å»ºRå’ŒBåˆ†é‡
4.ä¸€äº›åå¤„ç†ï¼ŒåŒ…æ‹¬ä¼ªå½©è‰²æŠ‘åˆ¶ï¼ˆpseudocolor suppressionï¼‰å’Œæ‹‰é“¾æ•ˆåº”æŠ‘åˆ¶ï¼ˆzipper cancellingï¼‰ç­‰&lt;/p>
&lt;p>æ‰©å±•é˜…è¯»ï¼š&lt;a class="link" href="https://zhuanlan.zhihu.com/p/563755436" target="_blank" rel="noopener"
>ä½æˆæœ¬è¾¹ç¼˜ä¸è‰²å·®æ’å€¼å»é©¬èµ›å…‹ç®—æ³•ï¼ˆLEDï¼‰&lt;/a>&lt;/p>
&lt;details class="popup-details">
&lt;summary>ç¤ºä¾‹ä»£ç -LEDæ³•&lt;/summary>
&lt;div class="popup-content">
&lt;button class="close-btn">âœ–&lt;/button>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;span class="lnt">65
&lt;/span>&lt;span class="lnt">66
&lt;/span>&lt;span class="lnt">67
&lt;/span>&lt;span class="lnt">68
&lt;/span>&lt;span class="lnt">69
&lt;/span>&lt;span class="lnt">70
&lt;/span>&lt;span class="lnt">71
&lt;/span>&lt;span class="lnt">72
&lt;/span>&lt;span class="lnt">73
&lt;/span>&lt;span class="lnt">74
&lt;/span>&lt;span class="lnt">75
&lt;/span>&lt;span class="lnt">76
&lt;/span>&lt;span class="lnt">77
&lt;/span>&lt;span class="lnt">78
&lt;/span>&lt;span class="lnt">79
&lt;/span>&lt;span class="lnt">80
&lt;/span>&lt;span class="lnt">81
&lt;/span>&lt;span class="lnt">82
&lt;/span>&lt;span class="lnt">83
&lt;/span>&lt;span class="lnt">84
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-cpp" data-lang="cpp">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ç¤ºä¾‹ä»£ç ï¼šå»é©¬èµ›å…‹ç®—æ³•å®ç°ï¼ˆåŸºäºæ–¹å‘æ€§æ’å€¼å’Œè‰²å·®æ’å®šç†è®ºï¼‰
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;vector&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;cmath&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;algorithm&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>&lt;span class="k">using&lt;/span> &lt;span class="k">namespace&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// è·å–æ¢¯åº¦ä¿¡æ¯
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kt">void&lt;/span> &lt;span class="nf">compute_gradients&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="o">&amp;gt;&amp;gt;&amp;amp;&lt;/span> &lt;span class="n">image&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="o">&amp;gt;&amp;gt;&amp;amp;&lt;/span> &lt;span class="n">grad_h&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="o">&amp;gt;&amp;gt;&amp;amp;&lt;/span> &lt;span class="n">grad_v&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">rows&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">image&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">size&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">cols&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">image&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">size&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">grad_h&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">resize&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">rows&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">cols&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">));&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">grad_v&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">resize&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">rows&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">cols&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">));&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">rows&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">j&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">j&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">cols&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">grad_h&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">abs&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">image&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">j&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">image&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">j&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">]);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">grad_v&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">abs&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">image&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">image&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">]);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// æ–¹å‘æ€§æ’å€¼é‡å»ºGåˆ†é‡
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kt">void&lt;/span> &lt;span class="nf">reconstruct_green&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="o">&amp;gt;&amp;gt;&amp;amp;&lt;/span> &lt;span class="n">bayer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="o">&amp;gt;&amp;gt;&amp;amp;&lt;/span> &lt;span class="n">green&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">const&lt;/span> &lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="o">&amp;gt;&amp;gt;&amp;amp;&lt;/span> &lt;span class="n">grad_h&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">const&lt;/span> &lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="o">&amp;gt;&amp;gt;&amp;amp;&lt;/span> &lt;span class="n">grad_v&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">rows&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">bayer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">size&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">cols&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">bayer&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">size&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">green&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">bayer&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// åˆå§‹ä¸º Bayer å›¾åƒ
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">rows&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">j&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">j&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">cols&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">j&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">%&lt;/span> &lt;span class="mi">2&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// å½“å‰åƒç´ ä¸æ˜¯ G
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">grad_h&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">grad_v&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">])&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">green&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">bayer&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">j&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">bayer&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">j&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">])&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">green&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">bayer&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">bayer&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">])&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// æ ¹æ®è‰²å·®æ’å®šç†è®ºé‡å»º R å’Œ B åˆ†é‡
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kt">void&lt;/span> &lt;span class="nf">reconstruct_red_blue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="o">&amp;gt;&amp;gt;&amp;amp;&lt;/span> &lt;span class="n">bayer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">const&lt;/span> &lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="o">&amp;gt;&amp;gt;&amp;amp;&lt;/span> &lt;span class="n">green&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="o">&amp;gt;&amp;gt;&amp;amp;&lt;/span> &lt;span class="n">red&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="o">&amp;gt;&amp;gt;&amp;amp;&lt;/span> &lt;span class="n">blue&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">rows&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">bayer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">size&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">cols&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">bayer&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">size&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">red&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">bayer&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// åˆå§‹ä¸º Bayer å›¾åƒ
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">blue&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">bayer&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">rows&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">j&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">j&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">cols&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">%&lt;/span> &lt;span class="mi">2&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">j&lt;/span> &lt;span class="o">%&lt;/span> &lt;span class="mi">2&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">%&lt;/span> &lt;span class="mi">2&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">j&lt;/span> &lt;span class="o">%&lt;/span> &lt;span class="mi">2&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// å½“å‰åƒç´ æ˜¯ G
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">red&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">green&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">bayer&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">j&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">green&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">j&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">bayer&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">j&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">green&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">j&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">])&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">blue&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">green&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">bayer&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">green&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">bayer&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">green&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">])&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">%&lt;/span> &lt;span class="mi">2&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">j&lt;/span> &lt;span class="o">%&lt;/span> &lt;span class="mi">2&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// å½“å‰åƒç´ æ˜¯ B
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">red&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">green&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">bayer&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">j&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">green&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">j&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">bayer&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">j&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">green&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">j&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">])&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">// å½“å‰åƒç´ æ˜¯ R
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">blue&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">green&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">bayer&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">j&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">green&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">j&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">bayer&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">j&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">green&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">j&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">])&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ä¼ªå½©è‰²æŠ‘åˆ¶ä¸æ‹‰é“¾æ•ˆåº”å»é™¤çš„åå¤„ç†
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kt">void&lt;/span> &lt;span class="nf">post_process&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="o">&amp;gt;&amp;gt;&amp;amp;&lt;/span> &lt;span class="n">red&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="o">&amp;gt;&amp;gt;&amp;amp;&lt;/span> &lt;span class="n">green&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="o">&amp;gt;&amp;gt;&amp;amp;&lt;/span> &lt;span class="n">blue&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">rows&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">red&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">size&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">cols&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">red&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="n">size&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">rows&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">j&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">j&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">cols&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">red&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">min&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">max&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">red&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="mi">255&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">green&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">min&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">max&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">green&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="mi">255&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">blue&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">min&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">max&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">blue&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="mi">255&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ä¸»å‡½æ•°ï¼šå»é©¬èµ›å…‹
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kt">void&lt;/span> &lt;span class="nf">demosaic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="o">&amp;gt;&amp;gt;&amp;amp;&lt;/span> &lt;span class="n">bayer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="o">&amp;gt;&amp;gt;&amp;amp;&lt;/span> &lt;span class="n">red&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="o">&amp;gt;&amp;gt;&amp;amp;&lt;/span> &lt;span class="n">green&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="o">&amp;gt;&amp;gt;&amp;amp;&lt;/span> &lt;span class="n">blue&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="o">&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">grad_h&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">grad_v&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">compute_gradients&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">bayer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">grad_h&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">grad_v&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// è®¡ç®—æ¢¯åº¦
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">reconstruct_green&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">bayer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">green&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">grad_h&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">grad_v&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// é‡å»º G åˆ†é‡
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">reconstruct_red_blue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">bayer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">green&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">red&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">blue&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// é‡å»º R å’Œ B åˆ†é‡
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">post_process&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">red&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">green&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">blue&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// åå¤„ç†
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;/details>
&lt;h3 id="è‰²å½©æ ¡æ­£color-correction">è‰²å½©æ ¡æ­£ï¼ˆColor Correctionï¼‰
&lt;/h3>$$\begin{bmatrix}R'\\G'\\B'\end{bmatrix}=\begin{bmatrix}m_{11}&amp;m_{12}&amp;m_{13}\\m_{21}&amp;m_{22}&amp;m_{23}\\m_{31}&amp;m_{32}&amp;m_{33}\end{bmatrix}\begin{bmatrix}R\\G\\B\end{bmatrix}$$&lt;p>
å…¶ä¸­R&amp;rsquo;G&amp;rsquo;B&amp;rsquo;æ˜¯æ ¡æ­£åçš„é¢œè‰²å€¼ï¼ŒRGBæ˜¯ä¼ æ„Ÿå™¨æ•è·çš„åŸå§‹é¢œè‰²å€¼ã€‚&lt;/p>
&lt;p>&lt;img src="https://RoboticsChen.github.io/articles/camera-isp/image-14.png"
width="671"
height="237"
srcset="https://RoboticsChen.github.io/articles/camera-isp/image-14_hu_2063ad73fa5b9e16.png 480w, https://RoboticsChen.github.io/articles/camera-isp/image-14_hu_87444d92213ff484.png 1024w"
loading="lazy"
alt="å›¾23 è‰²å½©æ ¡æ­£ç¤ºä¾‹"
class="gallery-image"
data-flex-grow="283"
data-flex-basis="679px"
>&lt;/p>
&lt;details class="popup-details">
&lt;summary>ç¤ºä¾‹ä»£ç &lt;/summary>
&lt;div class="popup-content">
&lt;button class="close-btn">âœ–&lt;/button>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-cpp" data-lang="cpp">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;vector&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;array&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// è‰²å½©æ ¡æ­£çŸ©é˜µå®šä¹‰
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">array&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">array&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">float&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">CCM&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>&lt;span class="mf">1.2f&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mf">0.1f&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mf">0.1f&lt;/span>&lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mf">0.2f&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mf">1.3f&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mf">0.1f&lt;/span>&lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mf">0.1f&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mf">0.2f&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mf">1.4f&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}};&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// å¯¹å•ä¸ªåƒç´ ç‚¹è¿›è¡Œè‰²å½©æ ¡æ­£
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">array&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">float&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">colorCorrection&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">array&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">float&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="o">&amp;gt;&amp;amp;&lt;/span> &lt;span class="n">input&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">array&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">float&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">output&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="mf">0.0f&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mf">0.0f&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mf">0.0f&lt;/span>&lt;span class="p">};&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">j&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">j&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">output&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">CCM&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">input&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">output&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;/details>
&lt;p>è‰²å½©æ ¡æ­£åï¼Œä¹Ÿå¯ä»¥æ ¹æ®éœ€æ±‚å¯¹æ ¡æ­£åçš„é¢œè‰²è¿›ä¸€æ­¥è°ƒèŠ‚,ä¾‹å¦‚è‰²å½©å¢å¼ºæˆ–é£æ ¼åŒ–&lt;/p>
&lt;h3 id="ä¼½é©¬çŸ«æ­£gamma-correction">ä¼½é©¬çŸ«æ­£ï¼ˆGamma Correctionï¼‰
&lt;/h3>&lt;p>äººç±»å¯¹äº®åº¦çš„æ„ŸçŸ¥å¹¶éçº¿æ€§ï¼Œè€Œæ˜¯æ¥è¿‘å¹‚å‡½æ•°$L\propto I^{0.43}$ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å¯¹æš—éƒ¨ç»†èŠ‚æ›´åŠ æ•æ„Ÿï¼Œå¯¹äº®éƒ¨å˜åŒ–çš„æ„ŸçŸ¥èƒ½åŠ›è¾ƒå¼±ã€‚ä¸ºäº†é«˜æ•ˆåˆ©ç”¨æœ‰é™çš„ä½æ·±ï¼ˆbitæ•°ï¼‰ï¼Œä¼˜åŒ–ç¼–ç æ•ˆç‡ï¼Œå›¾åƒç¼–ç ä¼šæŒ‰ç…§äººç±»çš„è§†è§‰ç‰¹æ€§è¿›è¡Œéçº¿æ€§å˜æ¢ï¼Œå°†æ›´å¤šçš„ç¼–ç ç²¾åº¦åˆ†é…åˆ°æš—éƒ¨ï¼ˆäººç±»æ›´æ•æ„Ÿçš„éƒ¨åˆ†ï¼‰ï¼Œå‡å°‘äº®éƒ¨ï¼ˆäººç±»è¾ƒä¸æ•æ„Ÿéƒ¨åˆ†ï¼‰çš„ç²¾åº¦ã€‚è¿™ç§éçº¿æ€§ç¼–ç é€šå¸¸è¢«ç§°ä¸ºgammaç¼–ç ã€‚åŸºäºè¿™ç§ç¼–ç ç‰¹æ€§ï¼Œæ˜¾ç¤ºè®¾å¤‡ï¼ˆå¦‚æ˜¾ç¤ºå™¨ï¼‰ä¸ºäº†ä½¿å›¾åƒåœ¨è§†è§‰ä¸Šçœ‹èµ·æ¥æ­£ç¡®ï¼Œä¼šæ‰§è¡Œâ€œåGammaâ€æ“ä½œ$I_{output}=I_{input}^{\frac1\gamma}ï¼Œ\gamma$å¸¸å–2.2ï¼Œå³å°†ç¼–ç å›¾åƒçš„éçº¿æ€§äº®åº¦è¿˜åŸä¸ºçº¿æ€§äº®åº¦ã€‚&lt;/p>
&lt;p>ä¸ºä»€ä¹ˆéœ€è¦Gammaç¼–ç ï¼š&lt;br>
å¦‚æœç›´æ¥å¯¹å›¾åƒè¿›è¡Œçº¿æ€§ç¼–ç å¹¶å­˜å‚¨æˆ–ä¼ è¾“ï¼Œæš—éƒ¨ç»†èŠ‚ä¼šè¢«è¿‡åº¦å‹ç¼©ï¼Œé€ æˆé‡è¦çš„è§†è§‰ä¿¡æ¯ä¸¢å¤±ã€‚åŒæ—¶ï¼Œæ˜¾ç¤ºè®¾å¤‡çš„åGammaæ ¡æ­£ä¼šè¿›ä¸€æ­¥æ”¾å¤§è¿™ç§ç°è±¡ï¼Œä½¿å¾—å›¾åƒæš—éƒ¨æ˜¾ç¤ºæ›´å·®ã€‚å› æ­¤ï¼Œä¸ºäº†ä¿è¯åœ¨æ˜¾ç¤ºè®¾å¤‡ä¸Šä¿æŒé¢„æœŸçš„äº®åº¦å’Œå¯¹æ¯”åº¦ï¼Œæ‹æ‘„çš„å›¾åƒéœ€è¦åœ¨ç¼–ç é˜¶æ®µè¿›è¡ŒGammaç¼–ç ã€‚&lt;/p>
&lt;p>&lt;img src="https://RoboticsChen.github.io/articles/camera-isp/image-13.png"
width="1953"
height="688"
srcset="https://RoboticsChen.github.io/articles/camera-isp/image-13_hu_d79d5363d6dc289b.png 480w, https://RoboticsChen.github.io/articles/camera-isp/image-13_hu_63402a34e289d2ba.png 1024w"
loading="lazy"
alt="å›¾24 å›¾åƒç¼–ç å‰ä¸ºä»€ä¹ˆè¦è¿›è¡Œgammaæ ¡æ­£"
class="gallery-image"
data-flex-grow="283"
data-flex-basis="681px"
>&lt;/p>
&lt;details class="popup-details">
&lt;summary>ç¤ºä¾‹ä»£ç &lt;/summary>
&lt;div class="popup-content">
&lt;button class="close-btn">âœ–&lt;/button>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-cpp" data-lang="cpp">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;cmath&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ä¼½é©¬çŸ«æ­£å‡½æ•°
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kt">float&lt;/span> &lt;span class="nf">gammaCorrection&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">float&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">float&lt;/span> &lt;span class="n">gamma&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">pow&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">gamma&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// å¯¹æ•´å¹…å›¾åƒè¿›è¡Œä¼½é©¬çŸ«æ­£
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kt">void&lt;/span> &lt;span class="nf">processImageGammaCorrection&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">array&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">float&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="o">&amp;gt;&amp;gt;&amp;amp;&lt;/span> &lt;span class="n">image&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">float&lt;/span> &lt;span class="n">gamma&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="k">auto&lt;/span>&lt;span class="o">&amp;amp;&lt;/span> &lt;span class="nl">pixel&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="n">image&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">pixel&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">gammaCorrection&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">pixel&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="n">gamma&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;/details>
&lt;h2 id="å…¶ä»–å›¾åƒå¤„ç†ç®—æ³•">å…¶ä»–å›¾åƒå¤„ç†ç®—æ³•
&lt;/h2>&lt;h3 id="ç›´æ–¹å›¾å‡è¡¡åŒ–histogram-equalization">ç›´æ–¹å›¾å‡è¡¡åŒ–ï¼ˆHistogram Equalizationï¼‰
&lt;/h3>&lt;p>ç›´æ–¹å›¾å‡è¡¡åŒ–æ˜¯ä¸€ç§å›¾åƒå¤„ç†æŠ€æœ¯ï¼Œé€šè¿‡è°ƒæ•´å›¾åƒçš„ç°åº¦çº§åˆ†å¸ƒï¼Œä½¿å¾—å›¾åƒçš„å¯¹æ¯”åº¦å¾—åˆ°æ”¹å–„ï¼Œä½†å¦‚æœå¯¹é«˜å¯¹æ¯”åº¦å›¾åƒä½¿ç”¨æ—¶å¯èƒ½å¯¼è‡´ç»†èŠ‚ä¸¢å¤±æˆ–å™ªå£°å¢å¼ºã€‚ç›´æ–¹å›¾å‡è¡¡åŒ–æ›´é€‚ç”¨äºæ›å…‰ä¸è¶³ã€å¯¹æ¯”åº¦ä½çš„å›¾åƒï¼Œå¦‚åŒ»å­¦å½±åƒã€å«æ˜Ÿå›¾åƒæˆ–è®¡ç®—æœºè§†è§‰ä¸­çš„å›¾åƒé¢„å¤„ç†ã€‚&lt;/p>
&lt;p>&lt;img src="https://RoboticsChen.github.io/articles/camera-isp/image-18.png"
width="311"
height="162"
srcset="https://RoboticsChen.github.io/articles/camera-isp/image-18_hu_b33a4b92a37a4667.png 480w, https://RoboticsChen.github.io/articles/camera-isp/image-18_hu_19d2daf123450fc5.png 1024w"
loading="lazy"
alt="å›¾25 ç›´æ–¹å›¾å‡è¡¡åŒ–"
class="gallery-image"
data-flex-grow="191"
data-flex-basis="460px"
>
&lt;details class="popup-details">
&lt;summary>ç¤ºä¾‹ä»£ç &lt;/summary>
&lt;div class="popup-content">
&lt;button class="close-btn">âœ–&lt;/button>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-cpp" data-lang="cpp">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;vector&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;algorithm&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;numeric&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// è®¡ç®—ç´¯ç§¯åˆ†å¸ƒå‡½æ•°ï¼ˆCDFï¼‰
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">float&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">calculateCDF&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="o">&amp;gt;&amp;amp;&lt;/span> &lt;span class="n">histogram&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">float&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">cdf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">histogram&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">size&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="mf">0.0f&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">partial_sum&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">histogram&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">begin&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="n">histogram&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">end&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="n">cdf&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">begin&lt;/span>&lt;span class="p">());&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">float&lt;/span> &lt;span class="n">maxValue&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">cdf&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">back&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">float&lt;/span>&lt;span class="o">&amp;amp;&lt;/span> &lt;span class="nl">val&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="n">cdf&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">val&lt;/span> &lt;span class="o">/=&lt;/span> &lt;span class="n">maxValue&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">cdf&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// åº”ç”¨ç›´æ–¹å›¾å‡è¡¡åŒ–
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kt">void&lt;/span> &lt;span class="nf">histogramEqualization&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="o">&amp;gt;&amp;gt;&amp;amp;&lt;/span> &lt;span class="n">image&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">maxValue&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">histogram&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">maxValue&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ç»Ÿè®¡ç›´æ–¹å›¾
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="k">auto&lt;/span>&lt;span class="o">&amp;amp;&lt;/span> &lt;span class="nl">row&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="n">image&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="nl">value&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="n">row&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">++&lt;/span>&lt;span class="n">histogram&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// è®¡ç®—CDF
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">vector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">float&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">cdf&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">calculateCDF&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">histogram&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// åº”ç”¨å‡è¡¡åŒ–
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="k">auto&lt;/span>&lt;span class="o">&amp;amp;&lt;/span> &lt;span class="nl">row&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="n">image&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="o">&amp;amp;&lt;/span> &lt;span class="nl">value&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="n">row&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">value&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">static_cast&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">cdf&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">maxValue&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;/details>
&lt;/p>
&lt;h3 id="é¢œè‰²ç©ºé—´è½¬æ¢color-space-conversion">é¢œè‰²ç©ºé—´è½¬æ¢ï¼ˆColor Space Conversionï¼‰
&lt;/h3>&lt;p>â–  RGB(Red, Green, Blue)æ˜¯ä¸€ç§åŸºäºåŠ è‰²æ¨¡å‹çš„é¢œè‰²ç©ºé—´ï¼Œè¡¨ç¤ºçº¢è‰²ã€ç»¿è‰²å’Œè“è‰²ä¸‰ä¸ªé¢œè‰²é€šé“çš„å¼ºåº¦ã€‚RGBæ¨¡å‹å¹¿æ³›ç”¨äºæ˜¾ç¤ºè®¾å¤‡ï¼ˆå¦‚è®¡ç®—æœºæ˜¾ç¤ºå™¨ã€ç”µè§†ç­‰ï¼‰ï¼Œå®ƒé€šè¿‡ä¸åŒå¼ºåº¦çš„çº¢ã€ç»¿ã€è“å…‰çš„ç»„åˆæ¥ç”Ÿæˆå„ç§é¢œè‰²ã€‚é¢œè‰²çš„æ··åˆæ–¹å¼æ˜¯åŠ æ³•çš„ï¼Œå³æ‰€æœ‰é€šé“çš„å…‰å¼ºåº¦åŠ èµ·æ¥ä¼šä½¿é¢œè‰²å˜å¾—æ›´äº®ã€‚&lt;/p>
&lt;p>â–  CMYK(Cyan, Magenta, Yellow, Black)è¡¨ç¤ºå°åˆ·ä¸Šç”¨çš„å››ç§é¢œè‰²ï¼Œæ˜¯RGBçš„è¡¥è‰²ã€‚ç”±äºåœ¨å®é™…åº”ç”¨ä¸­ï¼Œé’è‰²ã€æ´‹çº¢è‰²å’Œé»„è‰²å¾ˆéš¾å åŠ å½¢æˆçœŸæ­£çš„é»‘è‰²ï¼Œå› æ­¤å¼•å…¥äº†Kâ€”â€”é»‘è‰²ã€‚é»‘è‰²çš„ä½œç”¨æ˜¯å¼ºåŒ–æš—è°ƒï¼ŒåŠ æ·±æš—éƒ¨è‰²å½©ã€‚&lt;/p>
&lt;p>&lt;img src="https://RoboticsChen.github.io/articles/camera-isp/image-16.png"
width="558"
height="333"
srcset="https://RoboticsChen.github.io/articles/camera-isp/image-16_hu_3aa56ef5a59f5d0.png 480w, https://RoboticsChen.github.io/articles/camera-isp/image-16_hu_7b7afa7f710babd8.png 1024w"
loading="lazy"
alt="å›¾26 RGBä¸CMYK"
class="gallery-image"
data-flex-grow="167"
data-flex-basis="402px"
>&lt;/p>
&lt;p>â–  YUV(Y, U, V)æ˜¯ä¸€ç§åŸºäºäº®åº¦å’Œè‰²åº¦åˆ†é‡çš„é¢œè‰²ç©ºé—´ï¼Œé€šå¸¸ç”¨äºè§†é¢‘å‹ç¼©å’Œå¹¿æ’­ä¸­ã€‚åœ¨YUVæ¨¡å‹ä¸­ï¼ŒYè¡¨ç¤ºäº®åº¦åˆ†é‡ï¼ˆå³ç°åº¦ä¿¡æ¯ï¼‰ï¼ŒUå’ŒVè¡¨ç¤ºè‰²åº¦åˆ†é‡ï¼ˆå³é¢œè‰²ä¿¡æ¯ï¼ŒUè¡¨ç¤ºè“è‰²æŠ•å½±ï¼ŒVè¡¨ç¤ºçº¢è‰²æŠ•å½±ï¼‰ã€‚YUVçš„å¥½å¤„åœ¨äºï¼Œå®ƒèƒ½å¤Ÿå°†äº®åº¦å’Œè‰²åº¦åˆ†å¼€å¤„ç†ï¼Œè¿™å¯¹äºå›¾åƒå’Œè§†é¢‘å‹ç¼©å¾ˆæœ‰å¸®åŠ©ï¼Œå› ä¸ºäººçœ¼å¯¹äº®åº¦çš„æ•æ„Ÿåº¦è¿œé«˜äºè‰²åº¦ï¼Œå› æ­¤å¯ä»¥å¯¹è‰²åº¦åˆ†é‡è¿›è¡Œè¾ƒé«˜çš„å‹ç¼©è€Œä¸æ˜¾è‘—å½±å“è§†è§‰è´¨é‡ã€‚&lt;/p>
&lt;details class="popup-details">
&lt;summary>RGB-YUV è½¬æ¢å…¬å¼&lt;/summary>
&lt;div class="popup-content">
&lt;button class="close-btn">âœ–&lt;/button>
$$\begin{aligned}
&amp;Y=W_RR^{\prime}+W_GG^{\prime}+W_BB^{\prime}=0.299R^{\prime}+0.587G^{\prime}+0.114B^{\prime} \\
&amp;U=U_{\mathrm{max}}\frac{B^{\prime}-Y^{\prime}}{1-W_{B}}\approx0.492(B^{\prime}-Y^{\prime}) \\
&amp;V=V_{\mathrm{max}}\frac{R^{\prime}-Y^{\prime}}{1-W_{R}}\approx0.877(R^{\prime}-Y^{\prime}) \\
&amp;\Rightarrow \begin{bmatrix}Y\\U\\V\end{bmatrix}=\begin{bmatrix}0.299&amp;0.587&amp;0.114\\-0.14713&amp;-0.28886&amp;0.436\\0.615&amp;-0.51499&amp;-0.10001\end{bmatrix}\begin{bmatrix}R'\\G'\\B'\end{bmatrix} \\
&amp;R^{\prime}=Y^{\prime}+V\frac{1-W_{R}}{V_{\mathrm{max}}}=Y^{\prime}+\frac{V}{0.877}=Y^{\prime}+1.14V \\
&amp;B^{\prime}=Y^{\prime}+U\frac{1-W_{B}}{U_{\max}}=Y^{\prime}+\frac{U}{0.492}=Y^{\prime}+2.033U \\
&amp;G^{\prime}=\frac{Y'-W_RR'-W_BB'}{W_G} \\
&amp;\Rightarrow \begin{bmatrix}R'\\G'\\B'\end{bmatrix}=\begin{bmatrix}1&amp;0&amp;1.13983\\1&amp;-0.39465&amp;-0.58060\\1&amp;2.03211&amp;0\end{bmatrix}\begin{bmatrix}Y\\U\\V\end{bmatrix}
\end{aligned}$$
&lt;/div>
&lt;/details>
&lt;p>â–  HSV(Hue, Saturation, Value)æ˜¯æ ¹æ®é¢œè‰²çš„ç›´è§‚ç‰¹æ€§ç”±A. R. Smithåœ¨1978å¹´åˆ›å»ºçš„ä¸€ç§é¢œè‰²ç©ºé—´, ä¹Ÿç§°å…­è§’é”¥ä½“æ¨¡å‹(Hexcone Model)ã€‚è¿™ä¸ªæ¨¡å‹ä¸­é¢œè‰²çš„å‚æ•°åˆ†åˆ«æ˜¯ï¼šè‰²è°ƒï¼ˆHï¼‰ï¼Œé¥±å’Œåº¦ï¼ˆSï¼‰ï¼Œæ˜åº¦ï¼ˆVï¼‰ã€‚&lt;/p>
&lt;p>â–  HSL(Hue, Saturation, Lightness)æ˜¯HSVæ¨¡å‹çš„å˜ä½“ï¼Œä¹Ÿæ˜¯ç”±è‰²è°ƒã€é¥±å’Œåº¦å’Œäº®åº¦ä¸‰ä¸ªå‚æ•°æ¥æè¿°é¢œè‰²çš„ã€‚ä¸HSVä¸åŒï¼ŒHSLä¸­çš„äº®åº¦ï¼ˆLightnessï¼‰æŒ‡çš„æ˜¯ä»é»‘è‰²åˆ°ç™½è‰²çš„äº®åº¦ç¨‹åº¦ï¼Œä½äº0åˆ°100ä¹‹é—´ï¼Œè€ŒHSVä¸­çš„æ˜åº¦ï¼ˆValueï¼‰åˆ™æ˜¯ä»é»‘è‰²åˆ°æœ€äº®çš„é¢œè‰²çš„äº®åº¦ç¨‹åº¦ã€‚HSLæ¨¡å‹å¸¸ç”¨äºè®¡ç®—æœºå›¾å½¢å’Œå›¾åƒå¤„ç†é¢†åŸŸï¼Œå› ä¸ºå®ƒä¸äººçœ¼å¯¹é¢œè‰²çš„æ„ŸçŸ¥æ›´ä¸ºæ¥è¿‘ã€‚&lt;/p>
&lt;p>RGBåˆ°HSVå’ŒHSLçš„è½¬æ¢æ¯”è¾ƒå¤æ‚ï¼Œå‚è€ƒwikiç™¾ç§‘&lt;a class="link" href="https://en.wikipedia.org/wiki/HSL_and_HSV" target="_blank" rel="noopener"
>HSL_and_HSV&lt;/a>&lt;/p>
&lt;p>&lt;img src="https://RoboticsChen.github.io/articles/camera-isp/image-17.png"
width="2147"
height="489"
srcset="https://RoboticsChen.github.io/articles/camera-isp/image-17_hu_c8fbd39b109031de.png 480w, https://RoboticsChen.github.io/articles/camera-isp/image-17_hu_9d99160c08e5941e.png 1024w"
loading="lazy"
alt="å›¾27 è‰²å½©ç©ºé—´æ¨¡å‹"
class="gallery-image"
data-flex-grow="439"
data-flex-basis="1053px"
>&lt;/p>
&lt;p>&lt;img src="https://RoboticsChen.github.io/articles/camera-isp/image-15.png"
width="452"
height="768"
srcset="https://RoboticsChen.github.io/articles/camera-isp/image-15_hu_efd744f546c2142d.png 480w, https://RoboticsChen.github.io/articles/camera-isp/image-15_hu_5aaa7138faf304b3.png 1024w"
loading="lazy"
alt="å›¾28 è‰²å½©ç©ºé—´æ¨¡å‹çš„å‡ ä½•å…³ç³»"
class="gallery-image"
data-flex-grow="58"
data-flex-basis="141px"
>&lt;/p>
&lt;details class="popup-details">
&lt;summary>ç¤ºä¾‹ä»£ç &lt;/summary>
&lt;div class="popup-content">
&lt;button class="close-btn">âœ–&lt;/button>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-cpp" data-lang="cpp">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// RGB è½¬ YUV
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">array&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">float&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">rgbToYuv&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">array&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">float&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="o">&amp;gt;&amp;amp;&lt;/span> &lt;span class="n">rgb&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">float&lt;/span> &lt;span class="n">y&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mf">0.299f&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">rgb&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mf">0.587f&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">rgb&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mf">0.114f&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">rgb&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">float&lt;/span> &lt;span class="n">u&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mf">0.492f&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">rgb&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">y&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">float&lt;/span> &lt;span class="n">v&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mf">0.877f&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">rgb&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">y&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="n">y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">u&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">v&lt;/span>&lt;span class="p">};&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// YUV è½¬ RGB
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">array&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">float&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">yuvToRgb&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="n">std&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="n">array&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="kt">float&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="o">&amp;gt;&amp;amp;&lt;/span> &lt;span class="n">yuv&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">float&lt;/span> &lt;span class="n">r&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">yuv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mf">1.14f&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">yuv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">float&lt;/span> &lt;span class="n">g&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">yuv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mf">0.394f&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">yuv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mf">0.581f&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">yuv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">float&lt;/span> &lt;span class="n">b&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">yuv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mf">2.032f&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">yuv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="n">r&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">g&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">b&lt;/span>&lt;span class="p">};&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;/details>
&lt;blockquote>
&lt;p>&lt;strong>Refferenceï¼š&lt;/strong>&lt;/p>
&lt;p>&lt;a class="link" href="https://www.qinxing.xyz/posts/506138d8/" target="_blank" rel="noopener"
>https://www.qinxing.xyz/posts/506138d8/&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://github.com/yuqing-liu-dut/ISPLab" target="_blank" rel="noopener"
>https://github.com/yuqing-liu-dut/ISPLab&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://www.bilibili.com/video/BV1LA4m1N78h" target="_blank" rel="noopener"
>https://www.bilibili.com/video/BV1LA4m1N78h&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://www.wpgdadatong.com.cn/blog/detail/42592" target="_blank" rel="noopener"
>https://www.wpgdadatong.com.cn/blog/detail/42592&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://www.cnblogs.com/lanlancky/p/17498055.html#_label2_0" target="_blank" rel="noopener"
>https://www.cnblogs.com/lanlancky/p/17498055.html#_label2_0&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://www.cnblogs.com/wnwin/p/11985194.html" target="_blank" rel="noopener"
>https://www.cnblogs.com/wnwin/p/11985194.html&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://www.cnblogs.com/sunny-li/p/8641767.html" target="_blank" rel="noopener"
>https://www.cnblogs.com/sunny-li/p/8641767.html&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://blog.csdn.net/hhy321/article/details/120896015" target="_blank" rel="noopener"
>https://blog.csdn.net/hhy321/article/details/120896015&lt;/a>&lt;/p>&lt;/blockquote></description></item></channel></rss>